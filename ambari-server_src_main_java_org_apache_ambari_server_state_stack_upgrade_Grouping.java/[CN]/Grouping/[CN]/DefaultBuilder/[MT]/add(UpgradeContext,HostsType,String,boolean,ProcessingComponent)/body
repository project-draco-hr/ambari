{
  boolean forUpgrade=ctx.getDirection().isUpgrade();
  List<TaskBucket> buckets=buckets(resolveTasks(forUpgrade,true,pc));
  for (  TaskBucket bucket : buckets) {
    List<TaskWrapper> preTasks=TaskWrapperBuilder.getTaskList(service,pc.name,hostsType,bucket.tasks);
    Set<String> preTasksEffectiveHosts=TaskWrapperBuilder.getEffectiveHosts(preTasks);
    StageWrapper stage=new StageWrapper(bucket.type,getStageText("Preparing",ctx.getComponentDisplay(service,pc.name),preTasksEffectiveHosts),preTasks);
    m_stages.add(stage);
  }
  if (null != pc.tasks && 1 == pc.tasks.size()) {
    Task t=pc.tasks.get(0);
    if (RestartTask.class.isInstance(t)) {
      for (      String hostName : hostsType.hosts) {
        StageWrapper stage=new StageWrapper(StageWrapper.Type.RESTART,getStageText("Restarting",ctx.getComponentDisplay(service,pc.name),Collections.singleton(hostName)),new TaskWrapper(service,pc.name,Collections.singleton(hostName),t));
        m_stages.add(stage);
      }
    }
  }
  buckets=buckets(resolveTasks(forUpgrade,false,pc));
  for (  TaskBucket bucket : buckets) {
    List<TaskWrapper> postTasks=TaskWrapperBuilder.getTaskList(service,pc.name,hostsType,bucket.tasks);
    Set<String> postTasksEffectiveHosts=TaskWrapperBuilder.getEffectiveHosts(postTasks);
    StageWrapper stage=new StageWrapper(bucket.type,getStageText("Completing",ctx.getComponentDisplay(service,pc.name),postTasksEffectiveHosts),postTasks);
    m_stages.add(stage);
  }
  if (!clientOnly) {
    m_servicesToCheck.add(service);
  }
}

{
  List<TaskBucket> buckets=buckets(pc.preTasks);
  for (  TaskBucket bucket : buckets) {
    List<TaskWrapper> preTasks=TaskWrapperBuilder.getTaskList(service,pc.name,hostsType,bucket.tasks);
    Set<String> preTasksEffectiveHosts=TaskWrapperBuilder.getEffectiveHosts(preTasks);
    StageWrapper stage=new StageWrapper(bucket.type,getStageText("Preparing",pc.name,preTasksEffectiveHosts),preTasks);
    stages.add(stage);
  }
  if (null != pc.tasks && 1 == pc.tasks.size()) {
    Task t=pc.tasks.get(0);
    if (RestartTask.class.isInstance(t)) {
      for (      String hostName : hostsType.hosts) {
        StageWrapper stage=new StageWrapper(StageWrapper.Type.RESTART,getStageText("Restarting",pc.name,Collections.singleton(hostName)),new TaskWrapper(service,pc.name,Collections.singleton(hostName),t));
        stages.add(stage);
      }
    }
  }
  buckets=buckets(pc.postTasks);
  for (  TaskBucket bucket : buckets) {
    List<TaskWrapper> preTasks=TaskWrapperBuilder.getTaskList(service,pc.name,hostsType,bucket.tasks);
    Set<String> preTasksEffectiveHosts=TaskWrapperBuilder.getEffectiveHosts(preTasks);
    StageWrapper stage=new StageWrapper(bucket.type,getStageText("Completing",pc.name,preTasksEffectiveHosts),preTasks);
    stages.add(stage);
  }
  if (!clientOnly) {
    serviceChecks.add(service);
  }
}

{
  boolean forUpgrade=ctx.getDirection().isUpgrade();
  List<TaskBucket> buckets=buckets(resolveTasks(forUpgrade,true,pc));
  for (  TaskBucket bucket : buckets) {
    List<TaskWrapper> preTasks=TaskWrapperBuilder.getTaskList(service,pc.name,hostsType,bucket.tasks,params);
    List<List<TaskWrapper>> organizedTasks=organizeTaskWrappersBySyncRules(preTasks);
    for (    List<TaskWrapper> tasks : organizedTasks) {
      addTasksToStageInBatches(tasks,"Preparing",ctx,service,pc,params);
    }
  }
  if (null != pc.tasks && 1 == pc.tasks.size()) {
    Task t=pc.tasks.get(0);
    TaskWrapper tw=new TaskWrapper(service,pc.name,hostsType.hosts,params,Collections.singletonList(t));
    addTasksToStageInBatches(Collections.singletonList(tw),t.getActionVerb(),ctx,service,pc,params);
  }
  buckets=buckets(resolveTasks(forUpgrade,false,pc));
  for (  TaskBucket bucket : buckets) {
    List<TaskWrapper> postTasks=TaskWrapperBuilder.getTaskList(service,pc.name,hostsType,bucket.tasks,params);
    List<List<TaskWrapper>> organizedTasks=organizeTaskWrappersBySyncRules(postTasks);
    for (    List<TaskWrapper> tasks : organizedTasks) {
      addTasksToStageInBatches(tasks,"Completing",ctx,service,pc,params);
    }
  }
  if (m_serviceCheck && !clientOnly) {
    m_servicesToCheck.add(service);
  }
}

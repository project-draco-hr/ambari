@patch.object(main, 'setup_logging')
@patch.object(main, 'bind_signal_handlers')
@patch.object(main, 'stop_agent')
@patch.object(main, 'resolve_ambari_config')
@patch.object(main, 'perform_prestart_checks')
@patch.object(main, 'daemonize')
@patch.object(main, 'update_log_level')
@patch.object(NetUtil.NetUtil, 'try_to_connect')
@patch.object(Controller, '__init__')
@patch.object(Controller, 'start')
@patch.object(Controller, 'join')
@patch('optparse.OptionParser.parse_args')
@patch.object(DataCleaner, 'start')
@patch.object(DataCleaner, '__init__')
@patch.object(PingPortListener, 'start')
@patch.object(PingPortListener, '__init__')
def test_main(self, ping_port_init_mock, ping_port_start_mock, data_clean_init_mock, data_clean_start_mock, parse_args_mock, join_mock, start_mock, Controller_init_mock, try_to_connect_mock, update_log_level_mock, daemonize_mock, perform_prestart_checks_mock, resolve_ambari_config_mock, stop_mock, bind_signal_handlers_mock, setup_logging_mock):
    data_clean_init_mock.return_value = None
    Controller_init_mock.return_value = None
    ping_port_init_mock.return_value = None
    options = MagicMock()
    parse_args_mock.return_value = (options, MagicMock)
    main.main()
    self.assertTrue(setup_logging_mock.called)
    self.assertTrue(bind_signal_handlers_mock.called)
    self.assertTrue(stop_mock.called)
    self.assertTrue(resolve_ambari_config_mock.called)
    self.assertTrue(perform_prestart_checks_mock.called)
    self.assertTrue(daemonize_mock.called)
    self.assertTrue(update_log_level_mock.called)
    try_to_connect_mock.assert_called_once_with(ANY, (-1), ANY)
    self.assertTrue(start_mock.called)
    self.assertTrue(data_clean_init_mock.called)
    self.assertTrue(data_clean_start_mock.called)
    self.assertTrue(ping_port_init_mock.called)
    self.assertTrue(ping_port_start_mock.called)
    perform_prestart_checks_mock.reset_mock()
    options.expected_hostname = 'test.hst'
    main.main()
    perform_prestart_checks_mock.assert_called_once_with(options.expected_hostname)

{
  HttpServletRequest httpRequest=(HttpServletRequest)request;
  HttpServletResponse httpResponse=(HttpServletResponse)response;
  String requestURI=httpRequest.getRequestURI();
  SecurityContext context=getSecurityContext();
  Authentication authentication=context.getAuthentication();
  if (authentication == null || !authentication.isAuthenticated()) {
    String token=httpRequest.getHeader(INTERNAL_TOKEN_HEADER);
    if (token != null) {
      context.setAuthentication(new InternalAuthenticationToken(token));
    }
  }
 else {
    boolean authorized=false;
    for (    GrantedAuthority grantedAuthority : authentication.getAuthorities()) {
      if (grantedAuthority instanceof AmbariGrantedAuthority) {
        AmbariGrantedAuthority ambariGrantedAuthority=(AmbariGrantedAuthority)grantedAuthority;
        PrivilegeEntity privilegeEntity=ambariGrantedAuthority.getPrivilegeEntity();
        Integer permissionId=privilegeEntity.getPermission().getId();
        if (permissionId.equals(PermissionEntity.AMBARI_ADMIN_PERMISSION)) {
          authorized=true;
          break;
        }
        if (requestURI.matches("/api/v[0-9]+/clusters.*")) {
          if (permissionId.equals(PermissionEntity.CLUSTER_READ_PERMISSION) || permissionId.equals(PermissionEntity.CLUSTER_OPERATE_PERMISSION)) {
            authorized=true;
            break;
          }
        }
 else         if (requestURI.matches("/api/v[0-9]+/views.*")) {
          if (permissionId.equals(PermissionEntity.VIEW_USE_PERMISSION)) {
            authorized=true;
            break;
          }
        }
 else         if (requestURI.matches("/api/v[0-9]+/persist.*")) {
          if (permissionId.equals(PermissionEntity.CLUSTER_OPERATE_PERMISSION)) {
            authorized=true;
            break;
          }
        }
      }
    }
    if (!authorized && requestURI.matches(ViewInstanceEntity.VIEWS_CONTEXT_PATH_PATTERN)) {
      final ViewInstanceVersionDTO dto=ViewInstanceEntity.parseContextPath(requestURI);
      authorized=ViewRegistry.getInstance().checkPermission(dto.getViewName(),dto.getVersion(),dto.getInstanceName(),true);
    }
    if (!authorized && (!httpRequest.getMethod().equals("GET") || requestURI.matches("/views.*"))) {
      httpResponse.setHeader("WWW-Authenticate","Basic realm=\"" + realm + "\"");
      httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN,"You do not have permissions to access this resource.");
      httpResponse.flushBuffer();
      return;
    }
  }
  chain.doFilter(request,response);
}

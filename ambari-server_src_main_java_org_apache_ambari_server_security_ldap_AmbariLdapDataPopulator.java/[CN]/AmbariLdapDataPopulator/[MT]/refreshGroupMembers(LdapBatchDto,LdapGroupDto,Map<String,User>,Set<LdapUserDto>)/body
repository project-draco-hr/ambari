{
  final Set<String> externalMembers=new HashSet<String>();
  for (  String memberAttribute : group.getMemberAttributes()) {
    for (    LdapUserDto externalUser : externalUsers) {
      if (externalUser.getDn().equals(memberAttribute) || externalUser.getUid().equals(memberAttribute)) {
        externalMembers.add(externalUser.getUserName());
        break;
      }
    }
  }
  final Map<String,User> internalMembers=getInternalMembers(group.getGroupName());
  for (  String externalMember : externalMembers) {
    if (internalUsers.containsKey(externalMember)) {
      final User user=internalUsers.get(externalMember);
      if (user == null) {
        if (!internalMembers.containsKey(externalMember)) {
          batchInfo.getMembershipToAdd().add(new LdapUserGroupMemberDto(group.getGroupName(),externalMember));
        }
        continue;
      }
      if (!user.isLdapUser()) {
        batchInfo.getUsersToBecomeLdap().add(externalMember);
      }
      if (!internalMembers.containsKey(externalMember)) {
        batchInfo.getMembershipToAdd().add(new LdapUserGroupMemberDto(group.getGroupName(),externalMember));
      }
      internalMembers.remove(externalMember);
    }
 else {
      batchInfo.getUsersToBeCreated().add(externalMember);
      batchInfo.getMembershipToAdd().add(new LdapUserGroupMemberDto(group.getGroupName(),externalMember));
      internalUsers.put(externalMember,null);
    }
  }
  for (  Entry<String,User> userToBeUnsynced : internalMembers.entrySet()) {
    final User user=userToBeUnsynced.getValue();
    batchInfo.getMembershipToRemove().add(new LdapUserGroupMemberDto(group.getGroupName(),user.getUserName()));
  }
}

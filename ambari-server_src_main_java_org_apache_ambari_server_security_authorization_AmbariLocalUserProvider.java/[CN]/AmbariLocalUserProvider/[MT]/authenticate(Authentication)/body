{
  String userName=authentication.getName().trim();
  LOG.info("Loading user by name: " + userName);
  UserEntity userEntity=userDAO.findLocalUserByName(userName);
  if (userEntity == null || !StringUtils.equals(userEntity.getUserName(),userName)) {
    LOG.info("user not found ");
    throw new UsernameNotFoundException("Username " + userName + " not found");
  }
  if (!userEntity.getActive()) {
    logger.debug("User account is disabled");
    throw new DisabledException(messages.getMessage("AbstractUserDetailsAuthenticationProvider.disabled","User is disabled"));
  }
  if (authentication.getCredentials() == null) {
    logger.debug("Authentication failed: no credentials provided");
    throw new BadCredentialsException(messages.getMessage("AbstractUserDetailsAuthenticationProvider.badCredentials","Bad credentials"));
  }
  String password=userEntity.getUserPassword();
  String presentedPassword=authentication.getCredentials().toString();
  if (!passwordEncoder.matches(presentedPassword,password)) {
    logger.debug("Authentication failed: password does not match stored value");
    throw new BadCredentialsException(messages.getMessage("AbstractUserDetailsAuthenticationProvider.badCredentials","Bad credentials"));
  }
  Collection<AmbariGrantedAuthority> userAuthorities=users.getUserAuthorities(userEntity.getUserName(),userEntity.getUserType());
  User user=new User(userEntity);
  Authentication auth=new AmbariUserAuthentication(userEntity.getUserPassword(),user,userAuthorities);
  auth.setAuthenticated(true);
  return auth;
}

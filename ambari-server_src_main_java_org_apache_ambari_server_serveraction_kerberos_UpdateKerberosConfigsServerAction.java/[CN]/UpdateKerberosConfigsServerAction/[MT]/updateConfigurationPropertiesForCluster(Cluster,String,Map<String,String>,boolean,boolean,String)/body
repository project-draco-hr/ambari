{
  String newTag="version" + System.currentTimeMillis();
  String message;
  if ((properties != null) && (properties.size() > 0)) {
    Map<String,Config> all=cluster.getConfigsByType(configType);
    if (all == null || !all.containsKey(newTag)) {
      Map<String,String> oldConfigProperties;
      Config oldConfig=cluster.getDesiredConfigByType(configType);
      if (oldConfig == null && !createNewConfigType) {
        message=String.format("Config %s not found. Assuming service not installed. " + "Skipping configuration properties update",configType);
        actionLog.writeStdOut(message);
        LOG.info(message);
        return;
      }
 else       if (oldConfig == null) {
        oldConfigProperties=new HashMap<String,String>();
        newTag="version1";
      }
 else {
        oldConfigProperties=oldConfig.getProperties();
      }
      Map<String,String> mergedProperties=mergeProperties(oldConfigProperties,properties,updateIfExists);
      if (!Maps.difference(oldConfigProperties,mergedProperties).areEqual()) {
        message=String.format("Applying configuration with tag '%s' to " + "cluster '%s'",newTag,cluster.getClusterName());
        actionLog.writeStdOut(message);
        LOG.info(message);
        ConfigurationRequest cr=new ConfigurationRequest();
        cr.setClusterName(cluster.getClusterName());
        cr.setVersionTag(newTag);
        cr.setType(configType);
        cr.setProperties(mergedProperties);
        cr.setServiceConfigVersionNote(note);
        controller.createConfiguration(cr);
        Config baseConfig=cluster.getConfig(cr.getType(),cr.getVersionTag());
        if (baseConfig != null) {
          String authName="kerberization";
          if (cluster.addDesiredConfig(authName,Collections.singleton(baseConfig)) != null) {
            String oldConfigString=(oldConfig != null) ? " from='" + oldConfig.getTag() + "'" : "";
            message="cluster '" + cluster.getClusterName() + "' "+ "changed by: '"+ authName+ "'; "+ "type='"+ baseConfig.getType()+ "' "+ "tag='"+ baseConfig.getTag()+ "'"+ oldConfigString;
            LOG.info(message);
            actionLog.writeStdOut(message);
          }
        }
      }
 else {
        message="No changes detected to config " + configType + ". Skipping configuration properties update";
        LOG.info(message);
        actionLog.writeStdOut(message);
      }
    }
  }
}

{
  CommandReport commandReport=null;
  String clusterName=getExecutionCommand().getClusterName();
  Clusters clusters=controller.getClusters();
  Cluster cluster=clusters.getCluster(clusterName);
  String authenticatedUserName=getCommandParameterValue(getCommandParameters(),KerberosServerAction.AUTHENTICATED_USER_NAME);
  String dataDirectoryPath=getCommandParameterValue(getCommandParameters(),KerberosServerAction.DATA_DIRECTORY);
  HashMap<String,Map<String,String>> propertiesToSet=new HashMap<String,Map<String,String>>();
  HashMap<String,Collection<String>> propertiesToRemove=new HashMap<String,Collection<String>>();
  if (dataDirectoryPath != null) {
    File dataDirectory=new File(dataDirectoryPath);
    if (dataDirectory.exists()) {
      KerberosActionDataFileReader indexReader=null;
      KerberosConfigDataFileReader configReader=null;
      try {
        File indexFile=new File(dataDirectory,KerberosActionDataFile.DATA_FILE_NAME);
        if (indexFile.exists()) {
          indexReader=new KerberosActionDataFileReader(indexFile);
          for (          Map<String,String> record : indexReader) {
            String principal=record.get(KerberosActionDataFile.PRINCIPAL);
            String principalConfig=record.get(KerberosActionDataFile.PRINCIPAL_CONFIGURATION);
            String[] principalTokens=principalConfig.split("/");
            if (principalTokens.length == 2) {
              String principalConfigType=principalTokens[0];
              String principalConfigProp=principalTokens[1];
              addConfigTypePropVal(propertiesToSet,principalConfigType,principalConfigProp,principal);
            }
            String keytabPath=record.get(KerberosActionDataFile.KEYTAB_FILE_PATH);
            String keytabConfig=record.get(KerberosActionDataFile.KEYTAB_FILE_CONFIGURATION);
            String[] keytabTokens=keytabConfig.split("/");
            if (keytabTokens.length == 2) {
              String keytabConfigType=keytabTokens[0];
              String keytabConfigProp=keytabTokens[1];
              addConfigTypePropVal(propertiesToSet,keytabConfigType,keytabConfigProp,keytabPath);
            }
          }
        }
        File configFile=new File(dataDirectory,KerberosConfigDataFile.DATA_FILE_NAME);
        if (configFile.exists()) {
          configReader=new KerberosConfigDataFileReader(configFile);
          for (          Map<String,String> record : configReader) {
            String configType=record.get(KerberosConfigDataFile.CONFIGURATION_TYPE);
            String configKey=record.get(KerberosConfigDataFile.KEY);
            String configVal=record.get(KerberosConfigDataFile.VALUE);
            String configOp=record.get(KerberosConfigDataFile.OPERATION);
            if (KerberosConfigDataFile.OPERATION_TYPE_REMOVE.equals(configOp)) {
              removeConfigTypeProp(propertiesToRemove,configType,configKey);
            }
 else {
              addConfigTypePropVal(propertiesToSet,configType,configKey,configVal);
            }
          }
        }
        if (!propertiesToSet.isEmpty()) {
          String configNote=cluster.getSecurityType() == SecurityType.KERBEROS ? "Enabling Kerberos" : "Disabling Kerberos";
          for (          Map.Entry<String,Map<String,String>> entry : propertiesToSet.entrySet()) {
            String type=entry.getKey();
            configHelper.updateConfigType(cluster,controller,type,entry.getValue(),propertiesToRemove.get(type),authenticatedUserName,configNote);
          }
        }
      }
 catch (      IOException e) {
        String message="Could not update services configs to enable kerberos";
        actionLog.writeStdErr(message);
        LOG.error(message,e);
        commandReport=createCommandReport(1,HostRoleStatus.FAILED,"{}",actionLog.getStdOut(),actionLog.getStdErr());
      }
 finally {
        if (indexReader != null && !indexReader.isClosed()) {
          try {
            indexReader.close();
          }
 catch (          Throwable t) {
          }
        }
        if (configReader != null && !configReader.isClosed()) {
          try {
            configReader.close();
          }
 catch (          Throwable t) {
          }
        }
      }
    }
  }
  return (commandReport == null) ? createCommandReport(0,HostRoleStatus.COMPLETED,"{}",actionLog.getStdOut(),actionLog.getStdErr()) : commandReport;
}

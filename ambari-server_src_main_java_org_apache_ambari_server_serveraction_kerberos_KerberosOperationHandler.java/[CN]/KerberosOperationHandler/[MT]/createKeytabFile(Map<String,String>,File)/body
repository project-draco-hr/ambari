{
  boolean success=false;
  if (credentials == null) {
    throw new AmbariException("Failed to create keytab file, missing credentials");
  }
 else   if (keytabFile == null) {
    throw new AmbariException("Failed to create keytab file, missing file path");
  }
 else {
    List<KeytabEntry> keytabEntries=new ArrayList<KeytabEntry>();
    KerberosTime timestamp=new KerberosTime();
    for (    Map.Entry<String,String> entry : credentials.entrySet()) {
      String principal=entry.getKey();
      String password=entry.getValue();
      if (principal == null) {
        LOG.warn("Missing principal, skipping entry");
      }
 else       if (password == null) {
        LOG.warn("Missing password, skipping entry");
      }
 else {
        Map<EncryptionType,EncryptionKey> keys=KerberosKeyFactory.getKerberosKeys(principal,password);
        for (        EncryptionKey encryptionKey : keys.values()) {
          keytabEntries.add(new KeytabEntry(principal,1,timestamp,(byte)0,encryptionKey));
        }
      }
    }
    if (!keytabEntries.isEmpty()) {
      Keytab keytab=new Keytab();
      keytab.setEntries(keytabEntries);
      try {
        keytab.write(keytabFile);
        success=true;
      }
 catch (      IOException e) {
        String message=String.format("Failed to export keytab file");
        LOG.error(message,e);
        if (!keytabFile.delete()) {
          keytabFile.deleteOnExit();
        }
        throw new AmbariException(message,e);
      }
    }
  }
  return success;
}

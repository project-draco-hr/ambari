{
  InstanceConfig instanceConfig=createNiceMock(InstanceConfig.class);
  expect(instanceConfig.getName()).andReturn("Instance").anyTimes();
  replay(instanceConfig);
  ViewEntity viewDefinition=createNiceMock(ViewEntity.class);
  expect(viewDefinition.getName()).andReturn("View").anyTimes();
  expect(viewDefinition.getCommonName()).andReturn("View").times(2);
  expect(viewDefinition.getClassLoader()).andReturn(ViewContextImplTest.class.getClassLoader()).anyTimes();
  expect(viewDefinition.getConfiguration()).andReturn(ViewConfigTest.getConfig()).anyTimes();
  ViewParameterEntity parameter1=createNiceMock(ViewParameterEntity.class);
  expect(parameter1.getName()).andReturn("p1").anyTimes();
  ViewParameterEntity parameter2=createNiceMock(ViewParameterEntity.class);
  expect(parameter2.getName()).andReturn("p2").anyTimes();
  expect(viewDefinition.getParameters()).andReturn(Arrays.asList(parameter1,parameter2)).anyTimes();
  replay(viewDefinition,parameter1,parameter2);
  ViewInstanceEntity viewInstanceDefinition=createMockBuilder(ViewInstanceEntity.class).addMockedMethod("getUsername").addMockedMethod("getName").addMockedMethod("getViewEntity").withConstructor(viewDefinition,instanceConfig).createMock();
  expect(viewInstanceDefinition.getUsername()).andReturn("User").times(1);
  expect(viewInstanceDefinition.getUsername()).andReturn("User2").times(1);
  expect(viewInstanceDefinition.getName()).andReturn("Instance").anyTimes();
  expect(viewInstanceDefinition.getViewEntity()).andReturn(viewDefinition).anyTimes();
  replay(viewInstanceDefinition);
  ViewRegistry viewRegistry=createNiceMock(ViewRegistry.class);
  expect(viewRegistry.getCluster(viewInstanceDefinition)).andReturn(null).anyTimes();
  replay(viewRegistry);
  viewInstanceDefinition.putProperty("p1","/tmp/some/path/${username}");
  viewInstanceDefinition.putProperty("p2",new DefaultMasker().mask("/tmp/path/$viewName"));
  viewInstanceDefinition.putProperty("p3","/path/$instanceName");
  viewInstanceDefinition.putProperty("p4","/path/to/${unspecified_parameter}");
  viewInstanceDefinition.putProperty("p5","/path/to/${incorrect_parameter");
  viewInstanceDefinition.putProperty("p6","/path/to/\\${username}");
  viewInstanceDefinition.putProperty("p7","/path/to/\\$viewName");
  viewInstanceDefinition.putProperty("p8",null);
  ViewContextImpl viewContext=new ViewContextImpl(viewInstanceDefinition,viewRegistry);
  Map<String,String> properties=viewContext.getProperties();
  Assert.assertEquals(8,properties.size());
  Assert.assertEquals("/tmp/some/path/User",properties.get("p1"));
  Assert.assertEquals("/tmp/path/View",properties.get("p2"));
  Assert.assertEquals("/path/Instance",properties.get("p3"));
  Assert.assertEquals("/path/to/${unspecified_parameter}",properties.get("p4"));
  Assert.assertEquals("/path/to/${incorrect_parameter",properties.get("p5"));
  Assert.assertEquals("/path/to/${username}",properties.get("p6"));
  Assert.assertEquals("/path/to/$viewName",properties.get("p7"));
  Assert.assertNull(properties.get("p8"));
  properties=viewContext.getProperties();
  Assert.assertEquals(8,properties.size());
  Assert.assertEquals("/tmp/some/path/User2",properties.get("p1"));
  Assert.assertEquals("/tmp/path/View",properties.get("p2"));
  Assert.assertEquals("/path/Instance",properties.get("p3"));
  Assert.assertEquals("/path/to/${unspecified_parameter}",properties.get("p4"));
  Assert.assertEquals("/path/to/${incorrect_parameter",properties.get("p5"));
  Assert.assertEquals("/path/to/${username}",properties.get("p6"));
  Assert.assertEquals("/path/to/$viewName",properties.get("p7"));
  Assert.assertNull(properties.get("p8"));
}

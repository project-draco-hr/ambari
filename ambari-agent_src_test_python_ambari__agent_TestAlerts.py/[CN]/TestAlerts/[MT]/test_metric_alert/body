@patch.object(MetricAlert, '_load_jmx')
def test_metric_alert(self, ma_load_jmx_mock):
    json = {'name': 'cpu_check', 'service': 'HDFS', 'component': 'NAMENODE', 'label': 'NameNode process', 'interval': 6, 'scope': 'host', 'enabled': True, 'uuid': 'c1f73191-4481-4435-8dae-fd380e4c0be1', 'source': {'type': 'METRIC', 'uri': {'http': '{{hdfs-site/dfs.datanode.http.address}}', }, 'jmx': {'property_list': ['someJmxObject/value', 'someOtherJmxObject/value'], 'value': '{0} * 100 + 123', }, 'reporting': {'ok': {'text': 'ok_arr: {0} {1} {2}', }, 'warning': {'text': '', 'value': 13, }, 'critical': {'text': 'crit_arr: {0} {1} {2}', 'value': 72, }, }, }, }
    ma_load_jmx_mock.return_value = [1, 3]
    collector = AlertCollector()
    ma = MetricAlert(json, json['source'])
    ma.set_helpers(collector, {'hdfs-site/dfs.datanode.http.address': '1.2.3.4:80', })
    ma.collect()
    alerts = collector.alerts()
    self.assertEquals(0, len(collector.alerts()))
    self.assertEquals('CRITICAL', alerts[0]['state'])
    self.assertEquals('crit_arr: 1 3 223', alerts[0]['text'])
    del json['source']['jmx']['value']
    collector = AlertCollector()
    ma = MetricAlert(json, json['source'])
    ma.set_helpers(collector, {'hdfs-site/dfs.datanode.http.address': '1.2.3.4:80', })
    ma.collect()
    alerts = collector.alerts()
    self.assertEquals(0, len(collector.alerts()))
    self.assertEquals('OK', alerts[0]['state'])
    self.assertEquals('ok_arr: 1 3 None', alerts[0]['text'])

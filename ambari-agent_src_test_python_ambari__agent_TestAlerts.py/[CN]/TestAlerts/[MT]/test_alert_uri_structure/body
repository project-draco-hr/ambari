@patch.object(MetricAlert, '_load_jmx')
def test_alert_uri_structure(self, ma_load_jmx_mock):
    definition_json = self._get_metric_alert_definition()
    ma_load_jmx_mock.return_value = ([0, 0], None)
    collector = AlertCollector()
    cluster_configuration = self.__get_cluster_configuration()
    alert = MetricAlert(definition_json, definition_json['source'], self.config)
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('UNKNOWN', collector.alerts()[0]['state'])
    configuration = {'hdfs-site': {'dfs.http.policy': 'HTTP_ONLY', }, }
    collector = AlertCollector()
    cluster_configuration = self.__get_cluster_configuration()
    self.__update_cluster_configuration(cluster_configuration, configuration)
    alert = MetricAlert(definition_json, definition_json['source'], self.config)
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('UNKNOWN', collector.alerts()[0]['state'])
    configuration = {'hdfs-site': {'dfs.http.policy': 'HTTP_ONLY', 'dfs.datanode.http.address': 'c6401.ambari.apache.org:80', }, }
    self.__update_cluster_configuration(cluster_configuration, configuration)
    collector = AlertCollector()
    alert = MetricAlert(definition_json, definition_json['source'], self.config)
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('OK', collector.alerts()[0]['state'])
    configuration = {'hdfs-site': {'dfs.http.policy': 'HTTP_ONLY', 'dfs.datanode.https.address': 'c6401.ambari.apache.org:443', }, }
    self.__update_cluster_configuration(cluster_configuration, configuration)
    collector = AlertCollector()
    alert = MetricAlert(definition_json, definition_json['source'], self.config)
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('OK', collector.alerts()[0]['state'])
    configuration = {'hdfs-site': {'dfs.http.policy': 'HTTP_ONLY', 'dfs.datanode.http.address': 'c6401.ambari.apache.org:80', 'dfs.datanode.https.address': 'c6401.ambari.apache.org:443', }, }
    self.__update_cluster_configuration(cluster_configuration, configuration)
    collector = AlertCollector()
    alert = MetricAlert(definition_json, definition_json['source'], self.config)
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('OK', collector.alerts()[0]['state'])

@patch.object(MetricAlert, '_load_jmx')
def test_alert_uri_structure(self, ma_load_jmx_mock):
    definition_json = {'name': 'cpu_check', 'service': 'HDFS', 'component': 'NAMENODE', 'label': 'NameNode process', 'interval': 6, 'scope': 'host', 'enabled': True, 'uuid': 'c1f73191-4481-4435-8dae-fd380e4c0be1', 'source': {'type': 'METRIC', 'uri': {'http': '{{hdfs-site/dfs.datanode.http.address}}', 'https': '{{hdfs-site/dfs.datanode.https.address}}', 'https_property': '{{hdfs-site/dfs.http.policy}}', 'https_property_value': 'HTTPS_ONLY', }, 'jmx': {'property_list': ['someJmxObject/value', 'someOtherJmxObject/value'], 'value': '{0}', }, 'reporting': {'ok': {'text': '(Unit Tests) ok_arr: {0} {1} {2}', }, 'warning': {'text': '', 'value': 10, }, 'critical': {'text': '(Unit Tests) crit_arr: {0} {1} {2}', 'value': 20, }, }, }, }
    ma_load_jmx_mock.return_value = [1, 1]
    collector = AlertCollector()
    cluster_configuration = self.__get_cluster_configuration()
    alert = MetricAlert(definition_json, definition_json['source'])
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('UNKNOWN', collector.alerts()[0]['state'])
    configuration = {'hdfs-site': {'dfs.http.policy': 'HTTP_ONLY', }, }
    collector = AlertCollector()
    cluster_configuration = self.__get_cluster_configuration()
    self.__update_cluster_configuration(cluster_configuration, configuration)
    alert = MetricAlert(definition_json, definition_json['source'])
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('UNKNOWN', collector.alerts()[0]['state'])
    configuration = {'hdfs-site': {'dfs.http.policy': 'HTTP_ONLY', 'dfs.datanode.http.address': '1.2.3.4:80', }, }
    self.__update_cluster_configuration(cluster_configuration, configuration)
    collector = AlertCollector()
    alert = MetricAlert(definition_json, definition_json['source'])
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('OK', collector.alerts()[0]['state'])
    configuration = {'hdfs-site': {'dfs.http.policy': 'HTTP_ONLY', 'dfs.datanode.https.address': '1.2.3.4:443', }, }
    self.__update_cluster_configuration(cluster_configuration, configuration)
    collector = AlertCollector()
    alert = MetricAlert(definition_json, definition_json['source'])
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('OK', collector.alerts()[0]['state'])
    configuration = {'hdfs-site': {'dfs.http.policy': 'HTTP_ONLY', 'dfs.datanode.http.address': '1.2.3.4:80', 'dfs.datanode.https.address': '1.2.3.4:443', }, }
    self.__update_cluster_configuration(cluster_configuration, configuration)
    collector = AlertCollector()
    alert = MetricAlert(definition_json, definition_json['source'])
    alert.set_helpers(collector, cluster_configuration)
    alert.set_cluster('c1', 'c6401.ambari.apache.org')
    alert.collect()
    self.assertEquals('OK', collector.alerts()[0]['state'])

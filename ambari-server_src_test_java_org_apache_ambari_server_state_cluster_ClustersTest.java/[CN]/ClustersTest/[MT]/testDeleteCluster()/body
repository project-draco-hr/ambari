{
  String c1="c1";
  final String h1="h1";
  final String h2="h2";
  clusters.addCluster(c1);
  Cluster cluster=clusters.getCluster(c1);
  cluster.setDesiredStackVersion(new StackId("HDP-0.1"));
  cluster.setCurrentStackVersion(new StackId("HDP-0.1"));
  final Config config1=injector.getInstance(ConfigFactory.class).createNew(cluster,"t1",new HashMap<String,String>(){
{
      put("prop1","val1");
    }
  }
);
  config1.setVersionTag("1");
  config1.persist();
  Config config2=injector.getInstance(ConfigFactory.class).createNew(cluster,"t1",new HashMap<String,String>(){
{
      put("prop2","val2");
    }
  }
);
  config2.setVersionTag("2");
  config2.persist();
  cluster.addDesiredConfig("_test",config1);
  clusters.addHost(h1);
  clusters.addHost(h2);
  Host host1=clusters.getHost(h1);
  host1.setOsType("centos5");
  Host host2=clusters.getHost(h2);
  host2.setOsType("centos5");
  host1.persist();
  host2.persist();
  clusters.mapHostsToCluster(new HashSet<String>(){
{
      addAll(Arrays.asList(h1,h2));
    }
  }
,c1);
  host1.addDesiredConfig(cluster.getClusterId(),true,"_test",config2);
  host1.persist();
  Service hdfs=cluster.addService("HDFS");
  hdfs.persist();
  hdfs.updateDesiredConfigs(new HashMap<String,Config>(){
{
      put("t1",config1);
    }
  }
);
  hdfs.persist();
  Assert.assertNotNull(injector.getInstance(ClusterServiceDAO.class).findByClusterAndServiceNames(c1,"HDFS"));
  ServiceComponent nameNode=hdfs.addServiceComponent("NAMENODE");
  nameNode.persist();
  ServiceComponent dataNode=hdfs.addServiceComponent("DATANODE");
  dataNode.persist();
  ServiceComponent serviceCheckNode=hdfs.addServiceComponent("HDFS_CLIENT");
  serviceCheckNode.persist();
  ServiceComponentHost nameNodeHost=nameNode.addServiceComponentHost(h1);
  nameNodeHost.persist();
  ServiceComponentHost dataNodeHost=dataNode.addServiceComponentHost(h2);
  dataNodeHost.persist();
  ServiceComponentHost serviceCheckNodeHost=serviceCheckNode.addServiceComponentHost(h2);
  serviceCheckNodeHost.persist();
  serviceCheckNodeHost.setState(State.UNKNOWN);
  HostComponentStateEntityPK hkspk=new HostComponentStateEntityPK();
  HostComponentDesiredStateEntityPK hkdspk=new HostComponentDesiredStateEntityPK();
  hkspk.setClusterId(nameNodeHost.getClusterId());
  hkspk.setHostName(nameNodeHost.getHostName());
  hkspk.setServiceName(nameNodeHost.getServiceName());
  hkspk.setComponentName(nameNodeHost.getServiceComponentName());
  hkdspk.setClusterId(nameNodeHost.getClusterId());
  hkdspk.setHostName(nameNodeHost.getHostName());
  hkdspk.setServiceName(nameNodeHost.getServiceName());
  hkdspk.setComponentName(nameNodeHost.getServiceComponentName());
  Assert.assertNotNull(injector.getInstance(HostComponentStateDAO.class).findByPK(hkspk));
  Assert.assertNotNull(injector.getInstance(HostComponentDesiredStateDAO.class).findByPK(hkdspk));
  Assert.assertEquals(2,injector.getProvider(EntityManager.class).get().createQuery("SELECT config FROM ClusterConfigEntity config").getResultList().size());
  Assert.assertEquals(1,injector.getProvider(EntityManager.class).get().createQuery("SELECT state FROM ClusterStateEntity state").getResultList().size());
  Assert.assertEquals(1,injector.getProvider(EntityManager.class).get().createQuery("SELECT config FROM ClusterConfigMappingEntity config").getResultList().size());
  Assert.assertEquals(1,injector.getProvider(EntityManager.class).get().createQuery("SELECT config FROM ServiceConfigMappingEntity config").getResultList().size());
  clusters.deleteCluster(c1);
  Assert.assertEquals(2,injector.getInstance(HostDAO.class).findAll().size());
  Assert.assertNull(injector.getInstance(HostComponentStateDAO.class).findByPK(hkspk));
  Assert.assertNull(injector.getInstance(HostComponentDesiredStateDAO.class).findByPK(hkdspk));
  Assert.assertEquals(0,injector.getProvider(EntityManager.class).get().createQuery("SELECT config FROM ClusterConfigEntity config").getResultList().size());
  Assert.assertEquals(0,injector.getProvider(EntityManager.class).get().createQuery("SELECT state FROM ClusterStateEntity state").getResultList().size());
  Assert.assertEquals(0,injector.getProvider(EntityManager.class).get().createQuery("SELECT config FROM ClusterConfigMappingEntity config").getResultList().size());
  Assert.assertEquals(0,injector.getProvider(EntityManager.class).get().createQuery("SELECT config FROM ServiceConfigMappingEntity config").getResultList().size());
}

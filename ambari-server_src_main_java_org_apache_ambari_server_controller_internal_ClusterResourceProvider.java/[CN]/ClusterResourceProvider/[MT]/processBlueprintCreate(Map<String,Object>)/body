{
  String blueprintName=(String)properties.get(BLUEPRINT_PROPERTY_ID);
  LOG.info("Creating Cluster '" + properties.get(CLUSTER_NAME_PROPERTY_ID) + "' based on blueprint '"+ blueprintName+ "'.");
  BlueprintEntity blueprint=getBlueprint(blueprintName);
  Stack stack=parseStack(blueprint);
  Map<String,HostGroup> blueprintHostGroups=parseBlueprintHostGroups(blueprint,stack);
  applyRequestInfoToHostGroups(properties,blueprintHostGroups);
  processConfigurations(stack,blueprintHostGroups);
  String clusterName=(String)properties.get(CLUSTER_NAME_PROPERTY_ID);
  createClusterResource(buildClusterResourceProperties(stack,clusterName));
  setConfigurationsOnCluster(clusterName);
  Set<String> services=getServicesToDeploy(stack,blueprintHostGroups);
  createServiceAndComponentResources(blueprintHostGroups,clusterName,services);
  createHostAndComponentResources(blueprintHostGroups,clusterName);
  persistInstallStateForUI();
  return ((ServiceResourceProvider)getResourceProviderByType(Resource.Type.Service)).installAndStart(clusterName);
}

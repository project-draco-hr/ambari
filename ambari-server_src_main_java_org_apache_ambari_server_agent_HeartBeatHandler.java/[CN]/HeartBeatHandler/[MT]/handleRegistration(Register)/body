{
  String hostname=register.getHostname();
  int currentPingPort=register.getCurrentPingPort();
  long now=System.currentTimeMillis();
  String agentVersion=register.getAgentVersion();
  String serverVersion=ambariMetaInfo.getServerVersion();
  if (!VersionUtils.areVersionsEqual(serverVersion,agentVersion,true)) {
    LOG.warn("Received registration request from host with non compatible" + " agent version" + ", hostname=" + hostname + ", agentVersion="+ agentVersion+ ", serverVersion="+ serverVersion);
    throw new AmbariException("Cannot register host with non compatible" + " agent version" + ", hostname=" + hostname + ", agentVersion="+ agentVersion+ ", serverVersion="+ serverVersion);
  }
  String agentOsType=getOsType(register.getHardwareProfile().getOS(),register.getHardwareProfile().getOSRelease());
  LOG.info("agentOsType = " + agentOsType);
  if (!ambariMetaInfo.isOsSupported(agentOsType)) {
    LOG.warn("Received registration request from host with not supported" + " os type" + ", hostname=" + hostname + ", serverOsType="+ config.getServerOsType()+ ", agentOsType="+ agentOsType);
    throw new AmbariException("Cannot register host with not supported" + " os type" + ", hostname=" + hostname + ", serverOsType="+ config.getServerOsType()+ ", agentOsType="+ agentOsType);
  }
  Host hostObject;
  try {
    hostObject=clusterFsm.getHost(hostname);
  }
 catch (  HostNotFoundException ex) {
    clusterFsm.addHost(hostname);
    hostObject=clusterFsm.getHost(hostname);
  }
  hostObject.setState(HostState.INIT);
  hostObject.setCurrentPingPort(currentPingPort);
  List<StatusCommand> cmds=heartbeatMonitor.generateStatusCommands(hostname);
  for (  StatusCommand command : cmds) {
    command.getCommandParams().put("request_version",String.valueOf(true));
  }
  hostObject.setPrefix(register.getPrefix());
  hostObject.handleEvent(new HostRegistrationRequestEvent(hostname,null != register.getPublicHostname() ? register.getPublicHostname() : hostname,new AgentVersion(register.getAgentVersion()),now,register.getHardwareProfile(),register.getAgentEnv()));
  RegistrationResponse response=new RegistrationResponse();
  if (cmds.isEmpty()) {
    hostObject.handleEvent(new HostStatusUpdatesReceivedEvent(hostname,now));
  }
  configHelper.invalidateStaleConfigsCache(hostname);
  response.setStatusCommands(cmds);
  response.setResponseStatus(RegistrationStatus.OK);
  List<AlertDefinitionCommand> alertDefinitionCommands=getRegistrationAlertDefinitionCommands(hostname);
  response.setAlertDefinitionCommands(alertDefinitionCommands);
  response.setAgentConfig(config.getAgentConfigsMap());
  if (response.getAgentConfig() != null) {
    LOG.debug("Agent configuration map set to " + response.getAgentConfig());
  }
  Map<String,ServiceComponentHost> schFromComponentName=new HashMap<>();
  for (  Cluster cl : clusterFsm.getClustersForHost(hostname)) {
    List<ServiceComponentHost> scHosts=cl.getServiceComponentHosts(hostname);
    for (    ServiceComponentHost sch : scHosts) {
      schFromComponentName.put(sch.getServiceComponentName(),sch);
    }
  }
  List<String> enabledComponents=new ArrayList<>();
  String[] confEnabledComponents=config.getEnabledComponents().split(",");
  for (  String componentName : confEnabledComponents) {
    ServiceComponentHost sch=schFromComponentName.get(componentName);
    if (sch != null && sch.getMaintenanceState() == MaintenanceState.OFF) {
      enabledComponents.add(componentName);
    }
  }
  RecoveryConfig rc=RecoveryConfig.getRecoveryConfig(config);
  rc.setEnabledComponents(StringUtils.join(enabledComponents,','));
  response.setRecoveryConfig(rc);
  if (response.getRecoveryConfig() != null) {
    LOG.info("Recovery configuration set to " + response.getRecoveryConfig().toString());
  }
  Long requestId=0L;
  hostResponseIds.put(hostname,requestId);
  response.setResponseId(requestId);
  return response;
}

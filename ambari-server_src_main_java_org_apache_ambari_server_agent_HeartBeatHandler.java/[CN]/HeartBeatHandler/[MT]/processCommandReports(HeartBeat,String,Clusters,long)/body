{
  List<CommandReport> reports=heartbeat.getReports();
  for (  CommandReport report : reports) {
    LOG.debug("Received command report: " + report);
    Cluster cl=clusterFsm.getCluster(report.getClusterName());
    String service=report.getServiceName();
    if (service == null || "".equals(service)) {
      throw new AmbariException("Invalid command report, service: " + service);
    }
    if (actionMetadata.getActions(service.toLowerCase()).contains(report.getRole())) {
      LOG.debug(report.getRole() + " is an action - skip component lookup");
    }
 else {
      try {
        Service svc=cl.getService(service);
        ServiceComponent svcComp=svc.getServiceComponent(report.getRole());
        ServiceComponentHost scHost=svcComp.getServiceComponentHost(hostname);
        String schName=scHost.getServiceComponentName();
        State state=scHost.getState();
        if (report.getStatus().equals("COMPLETED")) {
          if (scHost.getState().equals(State.UPGRADING)) {
            scHost.setStackVersion(scHost.getDesiredStackVersion());
          }
 else           if (report.getRoleCommand().equals(RoleCommand.START.toString()) && null != report.getConfigurationTags() && !report.getConfigurationTags().isEmpty()) {
            LOG.info("Updating applied config on service " + scHost.getServiceName() + ", component "+ scHost.getServiceComponentName()+ ", host "+ scHost.getHostName());
            scHost.updateActualConfigs(report.getConfigurationTags());
          }
          if (RoleCommand.START.toString().equals(report.getRoleCommand())) {
            scHost.handleEvent(new ServiceComponentHostStartedEvent(schName,hostname,now));
          }
 else           if (RoleCommand.STOP.toString().equals(report.getRoleCommand())) {
            scHost.handleEvent(new ServiceComponentHostStoppedEvent(schName,hostname,now));
          }
 else {
            scHost.handleEvent(new ServiceComponentHostOpSucceededEvent(schName,hostname,now));
          }
        }
 else         if (report.getStatus().equals("FAILED")) {
          LOG.warn("Operation failed - may be retried. Service component host: " + schName + ", host: "+ hostname);
          scHost.handleEvent(new ServiceComponentHostOpFailedEvent(schName,hostname,now));
        }
 else         if (report.getStatus().equals("IN_PROGRESS")) {
          scHost.handleEvent(new ServiceComponentHostOpInProgressEvent(schName,hostname,now));
        }
      }
 catch (      ServiceComponentNotFoundException scnex) {
        LOG.warn("Service component not found ",scnex);
      }
catch (      InvalidStateTransitionException ex) {
        LOG.warn("State machine exception",ex);
      }
    }
  }
  actionManager.processTaskResponse(hostname,reports);
}

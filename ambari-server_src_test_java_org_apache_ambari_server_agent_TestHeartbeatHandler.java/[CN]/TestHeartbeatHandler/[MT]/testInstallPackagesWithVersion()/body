{
  EventBusSynchronizer.synchronizeAmbariEventPublisher(injector);
  final HostRoleCommand command=new HostRoleCommand(DummyHostname1,Role.DATANODE,null,null);
  ActionManager am=getMockActionManager();
  expect(am.getTasks(anyObject(List.class))).andReturn(Collections.singletonList(command)).anyTimes();
  replay(am);
  Cluster cluster=getDummyCluster();
  @SuppressWarnings("serial") Set<String> hostNames=new HashSet<String>(){
{
      add(DummyHostname1);
    }
  }
;
  clusters.mapHostsToCluster(hostNames,DummyCluster);
  HeartBeatHandler handler=getHeartBeatHandler(am,new ActionQueue());
  HeartBeat hb=new HeartBeat();
  JsonObject json=new JsonObject();
  json.addProperty("actual_version","2.2.1.0-2222");
  json.addProperty("package_installation_result","SUCCESS");
  json.addProperty("installed_repository_version","0.1");
  json.addProperty("stack_id",cluster.getDesiredStackVersion().getStackId());
  CommandReport cmdReport=new CommandReport();
  cmdReport.setActionId(StageUtils.getActionId(requestId,stageId));
  cmdReport.setTaskId(1);
  cmdReport.setCustomCommand("install_packages");
  cmdReport.setStructuredOut(json.toString());
  cmdReport.setRoleCommand(RoleCommand.ACTIONEXECUTE.name());
  cmdReport.setStatus(HostRoleStatus.COMPLETED.name());
  cmdReport.setRole("install_packages");
  cmdReport.setClusterName(DummyCluster);
  hb.setReports(Collections.singletonList(cmdReport));
  hb.setTimestamp(0L);
  hb.setResponseId(0);
  hb.setNodeStatus(new HostStatus(Status.HEALTHY,DummyHostStatus));
  hb.setHostname(DummyHostname1);
  hb.setComponentStatus(new ArrayList<ComponentStatus>());
  StackId stackId=new StackId("HDP","0.1");
  RepositoryVersionDAO dao=injector.getInstance(RepositoryVersionDAO.class);
  RepositoryVersionEntity entity=dao.findByStackAndVersion(stackId,"0.1");
  Assert.assertNotNull(entity);
  handler.handleHeartBeat(hb);
  entity=dao.findByStackAndVersion(stackId,"0.1");
  Assert.assertNull(entity);
  entity=dao.findByStackAndVersion(stackId,"2.2.1.0-2222");
  Assert.assertNotNull(entity);
}

{
  injector.getInstance(AmbariMetaInfo.class);
  ResourceTypeDAO resourceTypeDAO=injector.getInstance(ResourceTypeDAO.class);
  ResourceTypeEntity resourceTypeEntity=new ResourceTypeEntity();
  resourceTypeEntity.setId(ResourceType.CLUSTER.getId());
  resourceTypeEntity.setName(ResourceType.CLUSTER.name());
  resourceTypeEntity=resourceTypeDAO.merge(resourceTypeEntity);
  ResourceEntity resourceEntity=new ResourceEntity();
  resourceEntity.setResourceType(resourceTypeEntity);
  ClusterDAO clusterDAO=injector.getInstance(ClusterDAO.class);
  StackDAO stackDAO=injector.getInstance(StackDAO.class);
  StackEntity stackEntity=stackDAO.find("HDP","2.0.6");
  assertNotNull(stackEntity);
  ClusterEntity clusterEntity=new ClusterEntity();
  clusterEntity.setClusterName(clusterName);
  clusterEntity.setClusterInfo("test_cluster_info1");
  clusterEntity.setResource(resourceEntity);
  clusterEntity.setDesiredStack(stackEntity);
  clusterDAO.create(clusterEntity);
  ClusterStateEntity clusterStateEntity=new ClusterStateEntity();
  clusterStateEntity.setCurrentStack(stackEntity);
  clusterStateEntity.setClusterEntity(clusterEntity);
  getEntityManager().persist(clusterStateEntity);
  clusterEntity=clusterDAO.findByName(clusterEntity.getClusterName());
  assertNotNull(clusterEntity);
  assertTrue(clusterEntity.getClusterId() > 0);
  return clusterEntity.getClusterId();
}

{
  Capture<AlertGroupEntity> entityCapture=new Capture<AlertGroupEntity>();
  List<Long> definitionIds=new ArrayList<Long>();
  definitionIds.add(ALERT_DEF_ID);
  List<Long> targetIds=new ArrayList<Long>();
  targetIds.add(ALERT_TARGET_ID);
  List<AlertDefinitionEntity> definitionEntities=new ArrayList<AlertDefinitionEntity>();
  definitionEntities.addAll(getMockDefinitions());
  List<AlertTargetEntity> newTargetEntities=new ArrayList<AlertTargetEntity>();
  newTargetEntities.addAll(getMockTargets());
  Set<AlertTargetEntity> mockTargets2=getMockTargets();
  AlertTargetEntity target2=mockTargets2.iterator().next();
  target2.setTargetId(29L);
  newTargetEntities.add(target2);
  AlertGroupEntity group=new AlertGroupEntity();
  group.setDefault(true);
  group.setClusterId(1L);
  group.setGroupName(ALERT_GROUP_NAME);
  group.setAlertDefinitions(getMockDefinitions());
  group.setAlertTargets(getMockTargets());
  expect(m_dao.findGroupById(ALERT_GROUP_ID)).andReturn(group).times(1);
  expect(m_dao.merge(capture(entityCapture))).andReturn(group).once();
  List<Long> newTargets=Arrays.asList(28L,29L);
  expect(m_dao.findTargetsById(EasyMock.eq(newTargets))).andReturn(newTargetEntities).once();
  replay(m_dao,m_definitionDao,m_amc,m_clusters,m_cluster);
  SecurityContextHolder.getContext().setAuthentication(authentication);
  AlertGroupResourceProvider provider=createProvider(m_amc);
  Map<String,Object> requestProps=new HashMap<String,Object>();
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_ID,ALERT_GROUP_ID.toString());
  String newName=ALERT_GROUP_NAME + " Foo";
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_NAME,newName);
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_DEFINITIONS,new ArrayList<Long>());
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_TARGETS,newTargets);
  Predicate predicate=new PredicateBuilder().property(AlertGroupResourceProvider.ALERT_GROUP_CLUSTER_NAME).equals(ALERT_GROUP_CLUSTER_NAME).and().property(AlertGroupResourceProvider.ALERT_GROUP_ID).equals(ALERT_GROUP_ID.toString()).toPredicate();
  Request request=PropertyHelper.getUpdateRequest(requestProps,null);
  provider.updateResources(request,predicate);
  assertTrue(entityCapture.hasCaptured());
  AlertGroupEntity entity=entityCapture.getValue();
  assertEquals(ALERT_GROUP_NAME,entity.getGroupName());
  assertEquals(2,entity.getAlertTargets().size());
  assertEquals(1,entity.getAlertDefinitions().size());
  verify(m_dao,m_definitionDao);
}

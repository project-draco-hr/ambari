{
  Capture<AlertGroupEntity> entityCapture=new Capture<AlertGroupEntity>();
  List<Long> definitionIds=new ArrayList<Long>();
  definitionIds.add(ALERT_DEF_ID);
  List<Long> targetIds=new ArrayList<Long>();
  targetIds.add(ALERT_TARGET_ID);
  List<AlertDefinitionEntity> definitionEntities=new ArrayList<AlertDefinitionEntity>();
  definitionEntities.addAll(getMockDefinitions());
  List<AlertTargetEntity> targetEntities=new ArrayList<AlertTargetEntity>();
  targetEntities.addAll(getMockTargets());
  m_dao.createGroups(EasyMock.anyObject(List.class));
  expectLastCall().times(1);
  AlertGroupEntity group=new AlertGroupEntity();
  expect(m_dao.findGroupById(ALERT_GROUP_ID)).andReturn(group).times(1);
  expect(m_dao.merge(capture(entityCapture))).andReturn(group).once();
  expect(m_dao.findTargetsById(EasyMock.eq(targetIds))).andReturn(targetEntities).once();
  expect(m_definitionDao.findByIds(definitionIds)).andReturn(definitionEntities).once();
  replay(m_amc,m_clusters,m_cluster,m_dao,m_definitionDao);
  SecurityContextHolder.getContext().setAuthentication(authentication);
  AlertGroupResourceProvider provider=createProvider(m_amc);
  Map<String,Object> requestProps=new HashMap<String,Object>();
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_NAME,ALERT_GROUP_NAME);
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_CLUSTER_NAME,ALERT_GROUP_CLUSTER_NAME);
  Request request=PropertyHelper.getCreateRequest(Collections.singleton(requestProps),null);
  provider.createResources(request);
  requestProps=new HashMap<String,Object>();
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_ID,ALERT_GROUP_ID.toString());
  String newName=ALERT_GROUP_NAME + " Foo";
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_NAME,newName);
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_DEFINITIONS,definitionIds);
  requestProps.put(AlertGroupResourceProvider.ALERT_GROUP_TARGETS,targetIds);
  Predicate predicate=new PredicateBuilder().property(AlertGroupResourceProvider.ALERT_GROUP_CLUSTER_NAME).equals(ALERT_GROUP_CLUSTER_NAME).and().property(AlertGroupResourceProvider.ALERT_GROUP_ID).equals(ALERT_GROUP_ID.toString()).toPredicate();
  request=PropertyHelper.getUpdateRequest(requestProps,null);
  provider.updateResources(request,predicate);
  assertTrue(entityCapture.hasCaptured());
  AlertGroupEntity entity=entityCapture.getValue();
  assertEquals(newName,entity.getGroupName());
  verify(m_amc,m_clusters,m_cluster,m_dao,m_definitionDao);
}

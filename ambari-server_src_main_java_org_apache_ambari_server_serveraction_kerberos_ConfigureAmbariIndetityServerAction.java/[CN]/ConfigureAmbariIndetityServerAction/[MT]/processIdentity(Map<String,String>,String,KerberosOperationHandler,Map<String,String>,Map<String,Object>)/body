{
  CommandReport commandReport=null;
  if (identityRecord != null) {
    String message;
    String dataDirectory=getDataDirectoryPath();
    if (operationHandler == null) {
      message=String.format("Failed to create keytab file for %s, missing KerberosOperationHandler",evaluatedPrincipal);
      actionLog.writeStdErr(message);
      LOG.error(message);
      commandReport=createCommandReport(1,HostRoleStatus.FAILED,"{}",actionLog.getStdOut(),actionLog.getStdErr());
    }
 else     if (dataDirectory == null) {
      message="The data directory has not been set. Generated keytab files can not be stored.";
      LOG.error(message);
      commandReport=createCommandReport(1,HostRoleStatus.FAILED,"{}",actionLog.getStdOut(),actionLog.getStdErr());
    }
 else {
      String hostName=identityRecord.get(KerberosIdentityDataFileReader.HOSTNAME);
      if (hostName != null && hostName.equalsIgnoreCase(KerberosHelper.AMBARI_SERVER_HOST_NAME)) {
        String keytabFilePath=identityRecord.get(KerberosIdentityDataFileReader.KEYTAB_FILE_PATH);
        String keytabOwner=identityRecord.get(KerberosIdentityDataFileReader.KEYTAB_FILE_OWNER_NAME);
        String keytabAccess=identityRecord.get(KerberosIdentityDataFileReader.KEYTAB_FILE_OWNER_ACCESS);
        createAndConfigureAmbariKeytab(evaluatedPrincipal,operationHandler,keytabFilePath,keytabOwner,keytabAccess,actionLog);
      }
    }
  }
  return commandReport;
}

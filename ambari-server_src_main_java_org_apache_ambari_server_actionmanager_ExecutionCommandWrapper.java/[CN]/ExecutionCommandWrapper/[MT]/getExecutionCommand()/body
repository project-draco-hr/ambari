{
  if (executionCommand != null) {
    return executionCommand;
  }
 else   if (jsonExecutionCommand != null) {
    executionCommand=StageUtils.getGson().fromJson(jsonExecutionCommand,ExecutionCommand.class);
    if (injector == null) {
      throw new RuntimeException("Injector not found, configuration cannot be restored");
    }
 else     if (executionCommand.getConfigurationTags() != null && !executionCommand.getConfigurationTags().isEmpty()) {
      Clusters clusters=injector.getInstance(Clusters.class);
      HostRoleCommandDAO hostRoleCommandDAO=injector.getInstance(HostRoleCommandDAO.class);
      Long clusterId=hostRoleCommandDAO.findByPK(executionCommand.getTaskId()).getStage().getCluster().getClusterId();
      try {
        Cluster cluster=clusters.getClusterById(clusterId);
        for (        Map.Entry<String,Map<String,String>> entry : executionCommand.getConfigurationTags().entrySet()) {
          String type=entry.getKey();
          Map<String,String> tags=entry.getValue();
          String tag=tags.get("tag");
          if (tag != null) {
            Config config=cluster.getConfig(type,tag);
            Map<String,String> allLevelMergedConfig=new HashMap<String,String>();
            allLevelMergedConfig.putAll(config.getProperties());
            String serviceTag=tags.get("service_override_tag");
            if (serviceTag != null) {
              Config configService=cluster.getConfig(type,serviceTag);
              if (configService != null)               allLevelMergedConfig=getMergedConfig(allLevelMergedConfig,configService.getProperties());
            }
            String hostTag=tags.get("host_override_tag");
            if (hostTag != null) {
              Config configHost=cluster.getConfig(type,hostTag);
              if (configHost != null)               allLevelMergedConfig=getMergedConfig(allLevelMergedConfig,configHost.getProperties());
            }
            if (executionCommand.getConfigurations().containsKey(type)) {
              Map<String,String> mergedConfig=getMergedConfig(allLevelMergedConfig,executionCommand.getConfigurations().get(type));
              executionCommand.getConfigurations().get(type).clear();
              executionCommand.getConfigurations().get(type).putAll(mergedConfig);
            }
 else {
              executionCommand.getConfigurations().put(type,new HashMap<String,String>());
              executionCommand.getConfigurations().get(type).putAll(allLevelMergedConfig);
            }
          }
        }
      }
 catch (      AmbariException e) {
        throw new RuntimeException(e);
      }
    }
    return executionCommand;
  }
 else {
    throw new RuntimeException("Invalid ExecutionCommandWrapper, both object and string" + " representations are null");
  }
}

{
  ResourceProvider provider=ensureResourceProvider(type);
  ResourcePredicateEvaluator evaluator=provider instanceof ResourcePredicateEvaluator ? (ResourcePredicateEvaluator)provider : DEFAULT_RESOURCE_PREDICATE_EVALUATOR;
  int totalCount=0;
  Set<Resource> resources=providerResources;
  if (!providerResources.isEmpty()) {
    Request.PageInfo pageInfo=request.getPageInfo();
    Request.SortInfo sortInfo=request.getSortInfo();
    boolean providerAlreadyPaged=(null != pageInfo && pageInfo.isResponsePaged());
    boolean providerAlreadySorted=(null != sortInfo && sortInfo.isResponseSorted());
    Comparator<Resource> resourceComparator=comparator;
    if (null != sortRequest) {
      checkSortRequestProperties(sortRequest,type,provider);
      resourceComparator=new ResourceComparator(sortRequest);
    }
    if (!providerAlreadySorted) {
      TreeSet<Resource> sortedResources=new TreeSet<Resource>(resourceComparator);
      sortedResources.addAll(providerResources);
      resources=sortedResources;
    }
    totalCount=resources.size();
    if (null != pageRequest && !providerAlreadyPaged) {
switch (pageRequest.getStartingPoint()) {
case Beginning:
        return getPageFromOffset(pageRequest.getPageSize(),0,resources,predicate,evaluator);
case End:
      return getPageToOffset(pageRequest.getPageSize(),-1,resources,predicate,evaluator);
case OffsetStart:
    return getPageFromOffset(pageRequest.getPageSize(),pageRequest.getOffset(),resources,predicate,evaluator);
case OffsetEnd:
  return getPageToOffset(pageRequest.getPageSize(),pageRequest.getOffset(),resources,predicate,evaluator);
case PredicateStart:
case PredicateEnd:
break;
default :
break;
}
}
 else if (providerAlreadyPaged) {
totalCount=pageInfo.getTotalCount();
}
}
return new PageResponseImpl(new ResourceIterable(resources,predicate,evaluator),0,null,null,totalCount);
}

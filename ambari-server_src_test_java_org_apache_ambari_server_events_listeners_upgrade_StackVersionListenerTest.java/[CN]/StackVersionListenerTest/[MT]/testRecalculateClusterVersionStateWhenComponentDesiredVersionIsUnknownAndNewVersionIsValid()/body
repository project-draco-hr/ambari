{
  expect(serviceComponent.getDesiredVersion()).andReturn(UNKNOWN_VERSION);
  serviceComponent.setDesiredVersion(VALID_NEW_VERSION);
  expectLastCall().once();
  sch.setUpgradeState(UpgradeState.NONE);
  expectLastCall().once();
  sch.setVersion(VALID_NEW_VERSION);
  expectLastCall().once();
  expect(sch.recalculateHostVersionState()).andReturn(DUMMY_REPOSITORY_VERSION_ENTITY).once();
  cluster.recalculateClusterVersionState(DUMMY_REPOSITORY_VERSION_ENTITY);
  expectLastCall().once();
  replayAll();
  sendEventAndVerify(VALID_NEW_VERSION);
}

{
  VersionEventPublisher publisher=createNiceMock(VersionEventPublisher.class);
  Cluster cluster=createNiceMock(Cluster.class);
  ServiceComponentHost sch=createNiceMock(ServiceComponentHost.class);
  RepositoryVersionEntity repositoryVersionEntity=createNiceMock(RepositoryVersionEntity.class);
  expect(cluster.getClusterId()).andReturn(99L);
  expect(sch.recalculateHostVersionState()).andReturn(repositoryVersionEntity).atLeastOnce();
  cluster.recalculateClusterVersionState(repositoryVersionEntity);
  EasyMock.expectLastCall().atLeastOnce();
  replay(cluster,sch);
  HostComponentVersionEvent event=new HostComponentVersionEvent(cluster,sch);
  StackVersionListener listener=new StackVersionListener(publisher);
  listener.onAmbariEvent(event);
  verify(cluster,sch);
}

{
  String clusterName="c1";
  createCluster(clusterName);
  Cluster cluster=clusters.getCluster(clusterName);
  cluster.setDesiredStackVersion(new StackId("HDP-0.1"));
  ClusterRequest cr=new ClusterRequest(null,cluster.getClusterName(),null,null);
  cr.setDesiredConfig(new ConfigurationRequest(clusterName,"typeA","v1",null,null));
  controller.updateClusters(Collections.singleton(cr),new HashMap<String,String>());
  Config config=cluster.getDesiredConfigByType("typeA");
  Assert.assertNull(config);
  cr.setDesiredConfig(new ConfigurationRequest(clusterName,"typeA","v1",new HashMap<String,String>(),new HashMap<String,Map<String,String>>()));
  controller.updateClusters(Collections.singleton(cr),new HashMap<String,String>());
  config=cluster.getDesiredConfigByType("typeA");
  Assert.assertNotNull(config);
  cr.setDesiredConfig(new ConfigurationRequest(clusterName,"typeA","v2",new HashMap<String,String>(),new HashMap<String,Map<String,String>>()));
  controller.updateClusters(Collections.singleton(cr),new HashMap<String,String>());
  config=cluster.getDesiredConfigByType("typeA");
  Assert.assertNotNull(config);
  Assert.assertEquals(Integer.valueOf(0),Integer.valueOf(config.getProperties().size()));
  Map<String,String> map=new HashMap<String,String>();
  map.clear();
  map.put("c","d");
  Map<String,Map<String,String>> attributesMap=new HashMap<String,Map<String,String>>();
  attributesMap.put("final",new HashMap<String,String>());
  attributesMap.get("final").put("c","true");
  cr.setDesiredConfig(new ConfigurationRequest(clusterName,"typeA","v3",map,attributesMap));
  controller.updateClusters(Collections.singleton(cr),new HashMap<String,String>());
  config=cluster.getDesiredConfigByType("typeA");
  Assert.assertNotNull(config);
  Assert.assertTrue(config.getProperties().containsKey("c"));
  cr.setDesiredConfig(new ConfigurationRequest(clusterName,"typeA","v2",new HashMap<String,String>(),new HashMap<String,Map<String,String>>()));
  controller.updateClusters(Collections.singleton(cr),new HashMap<String,String>());
  config=cluster.getDesiredConfigByType("typeA");
  Assert.assertEquals("v2",config.getVersionTag());
  Assert.assertNotNull(config);
  Assert.assertEquals(Integer.valueOf(0),Integer.valueOf(config.getProperties().size()));
  cr.setDesiredConfig(new ConfigurationRequest(clusterName,"typeA","v2",new HashMap<String,String>(){
{
      put("a","b");
    }
  }
,new HashMap<String,Map<String,String>>(){
{
      put("final",new HashMap<String,String>(){
{
          put("a","true");
        }
      }
);
    }
  }
));
  try {
    controller.updateClusters(Collections.singleton(cr),new HashMap<String,String>());
    Assert.fail("Expect failure when creating a config that exists");
  }
 catch (  AmbariException e) {
  }
}

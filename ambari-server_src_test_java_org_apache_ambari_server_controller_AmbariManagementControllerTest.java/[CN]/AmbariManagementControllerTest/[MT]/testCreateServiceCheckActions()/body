{
  setupClusterWithHosts("c1","HDP-0.1",new ArrayList<String>(){
{
      add("h1");
      add("h2");
    }
  }
,"centos5");
  Cluster cluster=clusters.getCluster("c1");
  cluster.setDesiredStackVersion(new StackId("HDP-0.1"));
  cluster.setCurrentStackVersion(new StackId("HDP-0.1"));
  ConfigFactory cf=injector.getInstance(ConfigFactory.class);
  Config config1=cf.createNew(cluster,"global",new HashMap<String,String>(){
{
      put("key1","value1");
    }
  }
);
  config1.setVersionTag("version1");
  Config config2=cf.createNew(cluster,"core-site",new HashMap<String,String>(){
{
      put("key1","value1");
    }
  }
);
  config2.setVersionTag("version1");
  cluster.addConfig(config1);
  cluster.addConfig(config2);
  cluster.addDesiredConfig("_test",config1);
  cluster.addDesiredConfig("_test",config2);
  Service hdfs=cluster.addService("HDFS");
  Service mapReduce=cluster.addService("MAPREDUCE");
  hdfs.persist();
  mapReduce.persist();
  hdfs.addServiceComponent(Role.HDFS_CLIENT.name()).persist();
  mapReduce.addServiceComponent(Role.MAPREDUCE_CLIENT.name()).persist();
  hdfs.getServiceComponent(Role.HDFS_CLIENT.name()).addServiceComponentHost("h1").persist();
  mapReduce.getServiceComponent(Role.MAPREDUCE_CLIENT.name()).addServiceComponentHost("h2").persist();
  Map<String,String> params=new HashMap<String,String>(){
{
      put("test","test");
    }
  }
;
  ExecuteActionRequest actionRequest=new ExecuteActionRequest("c1",Role.HDFS_SERVICE_CHECK.name(),"HDFS",params);
  Map<String,String> requestProperties=new HashMap<String,String>();
  requestProperties.put(REQUEST_CONTEXT_PROPERTY,"Called from a test");
  RequestStatusResponse response=controller.createAction(actionRequest,requestProperties);
  assertEquals(1,response.getTasks().size());
  ShortTaskStatus task=response.getTasks().get(0);
  List<HostRoleCommand> storedTasks=actionDB.getRequestTasks(response.getRequestId());
  Stage stage=actionDB.getAllStages(response.getRequestId()).get(0);
  ExecutionCommandDAO executionCommandDAO=injector.getInstance(ExecutionCommandDAO.class);
  ExecutionCommandEntity commandEntity=executionCommandDAO.findByPK(task.getTaskId());
  ExecutionCommand executionCommand=StageUtils.fromJson(new String(commandEntity.getCommand()),ExecutionCommand.class);
  assertFalse(executionCommand.getConfigurationTags().isEmpty());
  assertTrue(executionCommand.getConfigurations() == null || executionCommand.getConfigurations().isEmpty());
  assertEquals(1,storedTasks.size());
  HostRoleCommand hostRoleCommand=storedTasks.get(0);
  assertEquals("SERVICE_CHECK HDFS",hostRoleCommand.getCommandDetail());
  assertNull(hostRoleCommand.getCustomCommandName());
  assertEquals(task.getTaskId(),hostRoleCommand.getTaskId());
  assertEquals(actionRequest.getServiceName(),hostRoleCommand.getExecutionCommandWrapper().getExecutionCommand().getServiceName());
  assertEquals(actionRequest.getClusterName(),hostRoleCommand.getExecutionCommandWrapper().getExecutionCommand().getClusterName());
  assertEquals(actionRequest.getCommandName(),hostRoleCommand.getExecutionCommandWrapper().getExecutionCommand().getRole());
  assertEquals(Role.HDFS_CLIENT.name(),hostRoleCommand.getEvent().getEvent().getServiceComponentName());
  assertEquals(actionRequest.getParameters(),hostRoleCommand.getExecutionCommandWrapper().getExecutionCommand().getRoleParams());
  assertNotNull(hostRoleCommand.getExecutionCommandWrapper().getExecutionCommand().getConfigurations());
  assertEquals(2,hostRoleCommand.getExecutionCommandWrapper().getExecutionCommand().getConfigurations().size());
  assertEquals(requestProperties.get(REQUEST_CONTEXT_PROPERTY),stage.getRequestContext());
  actionRequest=new ExecuteActionRequest("c1",Role.MAPREDUCE_SERVICE_CHECK.name(),"MAPREDUCE",null);
  response=controller.createAction(actionRequest,requestProperties);
  assertEquals(1,response.getTasks().size());
  List<HostRoleCommand> tasks=actionDB.getRequestTasks(response.getRequestId());
  assertEquals(1,tasks.size());
  requestProperties.put(REQUEST_CONTEXT_PROPERTY,null);
  response=controller.createAction(actionRequest,requestProperties);
  assertEquals(1,response.getTasks().size());
}

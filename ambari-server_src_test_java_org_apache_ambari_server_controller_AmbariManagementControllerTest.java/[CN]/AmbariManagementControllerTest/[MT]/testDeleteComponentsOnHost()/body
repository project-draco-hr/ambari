{
  String clusterName="foo1";
  createCluster(clusterName);
  Cluster cluster=clusters.getCluster(clusterName);
  cluster.setDesiredStackVersion(new StackId("HDP-0.1"));
  String serviceName="HDFS";
  createService(clusterName,serviceName,null);
  String componentName1="NAMENODE";
  String componentName2="DATANODE";
  String componentName3="HDFS_CLIENT";
  createServiceComponent(clusterName,serviceName,componentName1,State.INIT);
  createServiceComponent(clusterName,serviceName,componentName2,State.INIT);
  createServiceComponent(clusterName,serviceName,componentName3,State.INIT);
  String host1="h1";
  clusters.addHost(host1);
  clusters.getHost("h1").setOsType("centos5");
  clusters.getHost("h1").persist();
  clusters.mapHostToCluster(host1,clusterName);
  createServiceComponentHost(clusterName,null,componentName1,host1,null);
  createServiceComponentHost(clusterName,serviceName,componentName2,host1,null);
  createServiceComponentHost(clusterName,serviceName,componentName3,host1,null);
  installService(clusterName,serviceName,false,false);
  Map<String,ServiceComponentHost> hostComponents=cluster.getService(serviceName).getServiceComponent(componentName1).getServiceComponentHosts();
  for (  Map.Entry<String,ServiceComponentHost> entry : hostComponents.entrySet()) {
    ServiceComponentHost cHost=entry.getValue();
    cHost.handleEvent(new ServiceComponentHostInstallEvent(cHost.getServiceComponentName(),cHost.getHostName(),System.currentTimeMillis(),cluster.getDesiredStackVersion().getStackId()));
    cHost.handleEvent(new ServiceComponentHostOpSucceededEvent(cHost.getServiceComponentName(),cHost.getHostName(),System.currentTimeMillis()));
  }
  hostComponents=cluster.getService(serviceName).getServiceComponent(componentName2).getServiceComponentHosts();
  for (  Map.Entry<String,ServiceComponentHost> entry : hostComponents.entrySet()) {
    ServiceComponentHost cHost=entry.getValue();
    cHost.handleEvent(new ServiceComponentHostInstallEvent(cHost.getServiceComponentName(),cHost.getHostName(),System.currentTimeMillis(),cluster.getDesiredStackVersion().getStackId()));
    cHost.handleEvent(new ServiceComponentHostOpSucceededEvent(cHost.getServiceComponentName(),cHost.getHostName(),System.currentTimeMillis()));
  }
  ServiceComponentHost sch=cluster.getService(serviceName).getServiceComponent(componentName2).getServiceComponentHost(host1);
  Assert.assertNotNull(sch);
  sch.handleEvent(new ServiceComponentHostStartEvent(sch.getServiceComponentName(),sch.getHostName(),System.currentTimeMillis()));
  sch.handleEvent(new ServiceComponentHostStartedEvent(sch.getServiceComponentName(),sch.getHostName(),System.currentTimeMillis()));
  Set<ServiceComponentHostRequest> schRequests=new HashSet<ServiceComponentHostRequest>();
  schRequests.add(new ServiceComponentHostRequest(clusterName,null,null,host1,null));
  try {
    controller.deleteHostComponents(schRequests);
    fail("Expected exception while deleting all host components.");
  }
 catch (  AmbariException e) {
  }
  Assert.assertEquals(3,cluster.getServiceComponentHosts(host1).size());
  sch.handleEvent(new ServiceComponentHostStopEvent(sch.getServiceComponentName(),sch.getHostName(),System.currentTimeMillis()));
  sch.handleEvent(new ServiceComponentHostStoppedEvent(sch.getServiceComponentName(),sch.getHostName(),System.currentTimeMillis()));
  schRequests.clear();
  schRequests.add(new ServiceComponentHostRequest(clusterName,serviceName,componentName1,host1,"MAINTENANCE"));
  controller.updateHostComponents(schRequests,new HashMap<String,String>(),false);
  schRequests.clear();
  schRequests.add(new ServiceComponentHostRequest(clusterName,null,null,host1,null));
  controller.deleteHostComponents(schRequests);
  Assert.assertEquals(0,cluster.getServiceComponentHosts(host1).size());
}

{
  KerberosDescriptor oldValue=KERBEROS_DESCRIPTOR_FACTORY.createInstance("{" + "  \"identities\": [" + "    {"+ "      \"name\": \"spnego\","+ "      \"principal\": {"+ "        \"value\": \"HTTP/_HOST@${realm}\","+ "        \"type\": \"service\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"${keytab_dir}/spnego.service.keytab\","+ "        \"owner\": {"+ "          \"name\": \"root\","+ "          \"access\": \"r\""+ "        },"+ "        \"group\": {"+ "          \"name\": \"${cluster-env/user_group}\","+ "          \"access\": \"r\""+ "        }"+ "      }"+ "    },"+ "    {"+ "      \"name\": \"smokeuser\","+ "      \"principal\": {"+ "        \"value\": \"old_value@${realm}\","+ "        \"type\": \"user\","+ "        \"configuration\": \"cluster-env/smokeuser_principal_name\","+ "        \"local_username\": \"${cluster-env/smokeuser}\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"${keytab_dir}/smokeuser.headless.keytab\","+ "        \"owner\": {"+ "          \"name\": \"${cluster-env/smokeuser}\","+ "          \"access\": \"r\""+ "        },"+ "        \"group\": {"+ "          \"name\": \"${cluster-env/user_group}\","+ "          \"access\": \"r\""+ "        },"+ "        \"configuration\": \"cluster-env/smokeuser_keytab\""+ "      }"+ "    },"+ "    {"+ "      \"name\": \"old_identity\","+ "      \"principal\": {"+ "        \"value\": \"foobar-${cluster_name|toLower()}@${realm}\","+ "        \"type\": \"user\","+ "        \"configuration\": \"cluster-env/ambari_principal_name\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"${keytab_dir}/ambari.server.keytab\""+ "      }"+ "    }"+ "  ]"+ "}");
  KerberosDescriptor newValue=KERBEROS_DESCRIPTOR_FACTORY.createInstance("{" + "  \"identities\": [" + "    {"+ "      \"name\": \"spnego\","+ "      \"principal\": {"+ "        \"value\": \"HTTP/_HOST@${realm}\","+ "        \"type\": \"service\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"${keytab_dir}/spnego.service.keytab\","+ "        \"owner\": {"+ "          \"name\": \"root\","+ "          \"access\": \"r\""+ "        },"+ "        \"group\": {"+ "          \"name\": \"${cluster-env/user_group}\","+ "          \"access\": \"r\""+ "        }"+ "      }"+ "    },"+ "    {"+ "      \"name\": \"smokeuser\","+ "      \"principal\": {"+ "        \"value\": \"${cluster-env/smokeuser}-${cluster_name|toLower()}@${realm}\","+ "        \"type\": \"user\","+ "        \"configuration\": \"cluster-env/smokeuser_principal_name\","+ "        \"local_username\": \"${cluster-env/smokeuser}\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"updated_dir/smokeuser.headless.keytab\","+ "        \"owner\": {"+ "          \"name\": \"${cluster-env/smokeuser}\","+ "          \"access\": \"r\""+ "        },"+ "        \"group\": {"+ "          \"name\": \"${cluster-env/user_group}\","+ "          \"access\": \"r\""+ "        },"+ "        \"configuration\": \"cluster-env/smokeuser_keytab\""+ "      }"+ "    },"+ "    {"+ "      \"name\": \"ambari-server\","+ "      \"principal\": {"+ "        \"value\": \"ambari-server-${cluster_name|toLower()}@${realm}\","+ "        \"type\": \"user\","+ "        \"configuration\": \"cluster-env/ambari_principal_name\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"${keytab_dir}/ambari.server.keytab\""+ "      }"+ "    }"+ "  ]"+ "}");
  KerberosDescriptor userValue=KERBEROS_DESCRIPTOR_FACTORY.createInstance("{" + "  \"identities\": [" + "    {"+ "      \"name\": \"spnego\","+ "      \"principal\": {"+ "        \"value\": \"CHANGED_HTTP/_HOST@${realm}\","+ "        \"type\": \"service\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"${keytab_dir}/spnego.service.keytab\","+ "        \"owner\": {"+ "          \"name\": \"root\","+ "          \"access\": \"r\""+ "        },"+ "        \"group\": {"+ "          \"name\": \"${cluster-env/user_group}\","+ "          \"access\": \"r\""+ "        }"+ "      }"+ "    },"+ "    {"+ "      \"name\": \"smokeuser\","+ "      \"principal\": {"+ "        \"value\": \"old_value@${realm}\","+ "        \"type\": \"user\","+ "        \"configuration\": \"cluster-env/smokeuser_principal_name\","+ "        \"local_username\": \"${cluster-env/smokeuser}\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"custom_dir/smokeuser.headless.keytab\","+ "        \"owner\": {"+ "          \"name\": \"${cluster-env/smokeuser}\","+ "          \"access\": \"r\""+ "        },"+ "        \"group\": {"+ "          \"name\": \"${cluster-env/user_group}\","+ "          \"access\": \"r\""+ "        },"+ "        \"configuration\": \"cluster-env/smokeuser_keytab\""+ "      }"+ "    },"+ "    {"+ "      \"name\": \"old_identity\","+ "      \"principal\": {"+ "        \"value\": \"foobar-${cluster_name|toLower()}@${realm}\","+ "        \"type\": \"user\","+ "        \"configuration\": \"cluster-env/ambari_principal_name\""+ "      },"+ "      \"keytab\": {"+ "        \"file\": \"${keytab_dir}/ambari.server.keytab\""+ "      }"+ "    }"+ "  ]"+ "}");
  KerberosDescriptor updatedUserValue=KerberosDescriptorUpdateHelper.updateUserKerberosDescriptor(oldValue,newValue,userValue);
  Assert.assertEquals(GSON.toJson(KERBEROS_DESCRIPTOR_FACTORY.createInstance("{\n" + "  \"identities\": [\n" + "    {\n"+ "      \"name\": \"spnego\",\n"+ "      \"principal\": {\n"+ "        \"value\": \"CHANGED_HTTP/_HOST@${realm}\",\n"+ "        \"type\": \"service\"\n"+ "      },\n"+ "      \"keytab\": {\n"+ "        \"file\": \"${keytab_dir}/spnego.service.keytab\",\n"+ "        \"owner\": {\n"+ "          \"name\": \"root\",\n"+ "          \"access\": \"r\"\n"+ "        },\n"+ "        \"group\": {\n"+ "          \"name\": \"${cluster-env/user_group}\",\n"+ "          \"access\": \"r\"\n"+ "        }\n"+ "      }\n"+ "    },\n"+ "    {\n"+ "      \"name\": \"smokeuser\",\n"+ "      \"principal\": {\n"+ "        \"value\": \"${cluster-env/smokeuser}-${cluster_name|toLower()}@${realm}\",\n"+ "        \"local_username\": \"${cluster-env/smokeuser}\",\n"+ "        \"configuration\": \"cluster-env/smokeuser_principal_name\",\n"+ "        \"type\": \"user\"\n"+ "      },\n"+ "      \"keytab\": {\n"+ "        \"file\": \"custom_dir/smokeuser.headless.keytab\",\n"+ "        \"owner\": {\n"+ "          \"name\": \"${cluster-env/smokeuser}\",\n"+ "          \"access\": \"r\"\n"+ "        },\n"+ "        \"group\": {\n"+ "          \"name\": \"${cluster-env/user_group}\",\n"+ "          \"access\": \"r\"\n"+ "        },\n"+ "        \"configuration\": \"cluster-env/smokeuser_keytab\"\n"+ "      }\n"+ "    }\n"+ "  ]\n"+ "}").toMap()),GSON.toJson(updatedUserValue.toMap()));
  newValue.update(updatedUserValue);
  Assert.assertEquals(GSON.toJson(KERBEROS_DESCRIPTOR_FACTORY.createInstance("{\n" + "  \"identities\": [\n" + "    {\n"+ "      \"name\": \"ambari-server\",\n"+ "      \"principal\": {\n"+ "        \"value\": \"ambari-server-${cluster_name|toLower()}@${realm}\",\n"+ "        \"configuration\": \"cluster-env/ambari_principal_name\",\n"+ "        \"type\": \"user\"\n"+ "      },\n"+ "      \"keytab\": {\n"+ "        \"file\": \"${keytab_dir}/ambari.server.keytab\"\n"+ "      }\n"+ "    },\n"+ "    {\n"+ "      \"name\": \"spnego\",\n"+ "      \"principal\": {\n"+ "        \"value\": \"CHANGED_HTTP/_HOST@${realm}\",\n"+ "        \"type\": \"service\"\n"+ "      },\n"+ "      \"keytab\": {\n"+ "        \"file\": \"${keytab_dir}/spnego.service.keytab\",\n"+ "        \"owner\": {\n"+ "          \"name\": \"root\",\n"+ "          \"access\": \"r\"\n"+ "        },\n"+ "        \"group\": {\n"+ "          \"name\": \"${cluster-env/user_group}\",\n"+ "          \"access\": \"r\"\n"+ "        }\n"+ "      }\n"+ "    },\n"+ "    {\n"+ "      \"name\": \"smokeuser\",\n"+ "      \"principal\": {\n"+ "        \"value\": \"${cluster-env/smokeuser}-${cluster_name|toLower()}@${realm}\",\n"+ "        \"local_username\": \"${cluster-env/smokeuser}\",\n"+ "        \"configuration\": \"cluster-env/smokeuser_principal_name\",\n"+ "        \"type\": \"user\"\n"+ "      },\n"+ "      \"keytab\": {\n"+ "        \"file\": \"custom_dir/smokeuser.headless.keytab\",\n"+ "        \"owner\": {\n"+ "          \"name\": \"${cluster-env/smokeuser}\",\n"+ "          \"access\": \"r\"\n"+ "        },\n"+ "        \"group\": {\n"+ "          \"name\": \"${cluster-env/user_group}\",\n"+ "          \"access\": \"r\"\n"+ "        },\n"+ "        \"configuration\": \"cluster-env/smokeuser_keytab\"\n"+ "      }\n"+ "    }\n"+ "  ]\n"+ "}").toMap()),GSON.toJson(newValue.toMap()));
}

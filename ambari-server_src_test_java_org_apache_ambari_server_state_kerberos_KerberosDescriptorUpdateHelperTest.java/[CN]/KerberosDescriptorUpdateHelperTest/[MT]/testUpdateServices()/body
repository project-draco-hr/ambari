{
  KerberosDescriptor oldValue=KERBEROS_DESCRIPTOR_FACTORY.createInstance("{\n" + "  \"services\": [\n" + "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"secondary_namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"SECONDARY_NAMENODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"HDFS_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.datanode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"dn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"datanode_dn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/dn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.datanode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"configurations\": [\n"+ "            {\n"+ "              \"hdfs-site\": {\n"+ "                \"dfs.datanode.address\": \"0.0.0.0:1019\",\n"+ "                \"dfs.datanode.http.address\": \"0.0.0.0:1022\"\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"DATANODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/nfs.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nfs/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"nfsgateway\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nfs.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/nfs.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NFS_GATEWAY\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"jn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"journalnode_jn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/jn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"JOURNALNODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hadoop-env/hdfs_principal_name\",\n"+ "                \"type\": \"user\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"${hadoop-env/hdfs_user}-${cluster_name|toLower()}@${realm}\"\n"+ "              },\n"+ "              \"name\": \"hdfs\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/hdfs.headless.keytab\",\n"+ "                \"configuration\": \"hadoop-env/hdfs_user_keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"configurations\": [\n"+ "            {\n"+ "              \"hdfs-site\": {\n"+ "                \"dfs.block.access.token.enable\": \"true\"\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NAMENODE\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"principal\": {\n"+ "            \"configuration\": \"hdfs-site/dfs.web.authentication.kerberos.principal\",\n"+ "            \"type\": null,\n"+ "            \"local_username\": null,\n"+ "            \"value\": null\n"+ "          },\n"+ "          \"name\": \"/spnego\",\n"+ "          \"keytab\": {\n"+ "            \"owner\": {\n"+ "              \"access\": null,\n"+ "              \"name\": null\n"+ "            },\n"+ "            \"file\": null,\n"+ "            \"configuration\": \"hdfs-site/dfs.web.authentication.kerberos.keytab\",\n"+ "            \"group\": {\n"+ "              \"access\": null,\n"+ "              \"name\": null\n"+ "            }\n"+ "          }\n"+ "        },\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"auth_to_local_properties\": [\n"+ "        \"core-site/hadoop.security.auth_to_local\"\n"+ "      ],\n"+ "      \"configurations\": [\n"+ "        {\n"+ "          \"core-site\": {\n"+ "            \"hadoop.security.authorization\": \"true\",\n"+ "            \"hadoop.security.authentication\": \"kerberos\",\n"+ "            \"hadoop.proxyuser.HTTP.groups\": \"${hadoop-env/proxyuser_group}\"\n"+ "          }\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"HDFS\"\n"+ "    },\n"+ "    {\n"+ "      \"components\" : [\n"+ "        {\n"+ "          \"name\" : \"OLD_SERVICE_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\" : [\n"+ "            {\n"+ "              \"name\" : \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\" : \"OLD_SERVICE_FOOBAR\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\" : [\n"+ "            {\n"+ "              \"name\" : \"/HDFS/NAMENODE/hdfs\"\n"+ "            },\n"+ "            {\n"+ "              \"name\" : \"/HIVE/HIVE_SERVER/hive_server_hive\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\" : \"OLD_SERVICE_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\" : [\n"+ "        {\n"+ "          \"name\" : \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"name\" : \"OLD_SERVICE\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.authentication.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${atlas-env/metadata_user}\",\n"+ "                \"value\": \"atlas/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"atlas\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${atlas-env/metadata_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/atlas.service.keytab\",\n"+ "                \"configuration\": \"application-properties/atlas.authentication.keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.http.authentication.kerberos.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": \"HTTP/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"/spnego\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"application-properties/atlas.http.authentication.kerberos.keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"ATLAS_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"auth_to_local_properties\": [\n"+ "        \"application-properties/atlas.http.authentication.kerberos.name.rules|new_lines_escaped\"\n"+ "      ],\n"+ "      \"configurations\": [\n"+ "        {\n"+ "          \"application-properties\": {\n"+ "            \"atlas.authentication.method\": \"kerberos\",\n"+ "            \"atlas.http.authentication.enabled\": \"true\",\n"+ "            \"atlas.http.authentication.type\": \"kerberos\"\n"+ "          }\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"ATLAS\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"name\": \"EXISTING_SERVICE_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            },\n"+ "            {\n"+ "              \"name\": \"/HIVE/HIVE_SERVER/hive_server_hive\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"EXISTING_SERVICE_SERVER\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"EXISTING_SERVICE_ORIG_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"EXISTING_SERVICE\"\n"+ "    }\n"+ "  ]\n"+ "}\n");
  KerberosDescriptor newValue=KERBEROS_DESCRIPTOR_FACTORY.createInstance("{\n" + "  \"services\": [\n" + "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.jaas.KafkaClient.option.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${atlas-env/metadata_user}\",\n"+ "                \"value\": \"atlas/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"atlas\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${atlas-env/metadata_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/atlas.service.keytab\",\n"+ "                \"configuration\": \"application-properties/atlas.jaas.KafkaClient.option.keyTab\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"reference\": \"/ATLAS/ATLAS_SERVER/atlas\",\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.authentication.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"atlas_auth\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"application-properties/atlas.authentication.keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.authentication.method.kerberos.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": \"HTTP/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"/spnego\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"application-properties/atlas.authentication.method.kerberos.keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"reference\": \"/ATLAS/ATLAS_SERVER/atlas\",\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"ranger-atlas-audit/xasecure.audit.jaas.Client.option.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"ranger_atlas_audit\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"ranger-atlas-audit/xasecure.audit.jaas.Client.option.keyTab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"ATLAS_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"auth_to_local_properties\": [\n"+ "        \"application-properties/atlas.authentication.method.kerberos.name.rules|new_lines_escaped\"\n"+ "      ],\n"+ "      \"configurations\": [\n"+ "        {\n"+ "          \"ranger-atlas-audit\": {\n"+ "            \"xasecure.audit.jaas.Client.loginModuleControlFlag\": \"required\",\n"+ "            \"xasecure.audit.jaas.Client.option.serviceName\": \"solr\",\n"+ "            \"xasecure.audit.jaas.Client.loginModuleName\": \"com.sun.security.auth.module.Krb5LoginModule\",\n"+ "            \"xasecure.audit.jaas.Client.option.useKeyTab\": \"true\",\n"+ "            \"xasecure.audit.jaas.Client.option.storeKey\": \"false\",\n"+ "            \"xasecure.audit.destination.solr.force.use.inmemory.jaas.config\": \"true\"\n"+ "          }\n"+ "        },\n"+ "        {\n"+ "          \"application-properties\": {\n"+ "            \"atlas.kafka.security.protocol\": \"PLAINTEXTSASL\",\n"+ "            \"atlas.jaas.KafkaClient.option.storeKey\": \"true\",\n"+ "            \"atlas.solr.kerberos.enable\": \"true\",\n"+ "            \"atlas.jaas.KafkaClient.loginModuleControlFlag\": \"required\",\n"+ "            \"atlas.authentication.method.kerberos\": \"true\",\n"+ "            \"atlas.jaas.KafkaClient.option.useKeyTab\": \"true\",\n"+ "            \"atlas.kafka.sasl.kerberos.service.name\": \"${kafka-env/kafka_user}\",\n"+ "            \"atlas.jaas.KafkaClient.loginModuleName\": \"com.sun.security.auth.module.Krb5LoginModule\",\n"+ "            \"atlas.jaas.KafkaClient.option.serviceName\": \"${kafka-env/kafka_user}\"\n"+ "          }\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"ATLAS\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"secondary_namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"SECONDARY_NAMENODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"HDFS_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.datanode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"dn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"datanode_dn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/dn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.datanode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"configurations\": [\n"+ "            {\n"+ "              \"hdfs-site\": {\n"+ "                \"dfs.datanode.address\": \"0.0.0.0:1019\",\n"+ "                \"dfs.datanode.http.address\": \"0.0.0.0:1022\"\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"DATANODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/nfs.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nfs/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"nfsgateway\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nfs.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/nfs.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NFS_GATEWAY\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"jn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"journalnode_jn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/jn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"JOURNALNODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hadoop-env/hdfs_principal_name\",\n"+ "                \"type\": \"user\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"${hadoop-env/hdfs_user}-${cluster_name|toLower()}@${realm}\"\n"+ "              },\n"+ "              \"name\": \"hdfs\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/hdfs.headless.keytab\",\n"+ "                \"configuration\": \"hadoop-env/hdfs_user_keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"ranger-hdfs-audit/xasecure.audit.jaas.Client.option.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/HDFS/NAMENODE/namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"ranger-hdfs-audit/xasecure.audit.jaas.Client.option.keyTab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"configurations\": [\n"+ "            {\n"+ "              \"hdfs-site\": {\n"+ "                \"dfs.block.access.token.enable\": \"true\"\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NAMENODE\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"principal\": {\n"+ "            \"configuration\": \"hdfs-site/dfs.web.authentication.kerberos.principal\",\n"+ "            \"type\": null,\n"+ "            \"local_username\": null,\n"+ "            \"value\": null\n"+ "          },\n"+ "          \"name\": \"/spnego\",\n"+ "          \"keytab\": {\n"+ "            \"owner\": {\n"+ "              \"access\": null,\n"+ "              \"name\": null\n"+ "            },\n"+ "            \"file\": null,\n"+ "            \"configuration\": \"hdfs-site/dfs.web.authentication.kerberos.keytab\",\n"+ "            \"group\": {\n"+ "              \"access\": null,\n"+ "              \"name\": null\n"+ "            }\n"+ "          }\n"+ "        },\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"auth_to_local_properties\": [\n"+ "        \"core-site/hadoop.security.auth_to_local\"\n"+ "      ],\n"+ "      \"configurations\": [\n"+ "        {\n"+ "          \"ranger-hdfs-audit\": {\n"+ "            \"xasecure.audit.jaas.Client.loginModuleControlFlag\": \"required\",\n"+ "            \"xasecure.audit.jaas.Client.option.serviceName\": \"solr\",\n"+ "            \"xasecure.audit.jaas.Client.loginModuleName\": \"com.sun.security.auth.module.Krb5LoginModule\",\n"+ "            \"xasecure.audit.jaas.Client.option.useKeyTab\": \"true\",\n"+ "            \"xasecure.audit.jaas.Client.option.storeKey\": \"false\",\n"+ "            \"xasecure.audit.destination.solr.force.use.inmemory.jaas.config\": \"true\"\n"+ "          }\n"+ "        },\n"+ "        {\n"+ "          \"core-site\": {\n"+ "            \"hadoop.security.authorization\": \"true\",\n"+ "            \"hadoop.security.authentication\": \"kerberos\",\n"+ "            \"hadoop.proxyuser.HTTP.groups\": \"${hadoop-env/proxyuser_group}\"\n"+ "          }\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"HDFS\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"name\": \"NEW_SERVICE_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            },\n"+ "            {\n"+ "              \"name\": \"/HIVE/HIVE_SERVER/hive_server_hive\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NEW_SERVICE_FOO_BAR\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NEW_SERVICE_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"NEW_SERVICE\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"name\": \"EXISTING_SERVICE_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"EXISTING_SERVICE_SERVER\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"EXISTING_SERVICE_NEW_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        },\n"+ "        {\n"+ "          \"name\": \"/HIVE/HIVE_SERVER/hive_server_hive\"\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"EXISTING_SERVICE\"\n"+ "    }\n"+ "  ]\n"+ "}\n");
  KerberosDescriptor userValue=KERBEROS_DESCRIPTOR_FACTORY.createInstance(oldValue.toMap());
  KerberosDescriptor updatedUserValue=KerberosDescriptorUpdateHelper.updateUserKerberosDescriptor(oldValue,newValue,userValue);
  Assert.assertEquals(GSON.toJson(KERBEROS_DESCRIPTOR_FACTORY.createInstance("{\n" + "  \"services\": [\n" + "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.jaas.KafkaClient.option.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${atlas-env/metadata_user}\",\n"+ "                \"value\": \"atlas/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"atlas\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${atlas-env/metadata_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/atlas.service.keytab\",\n"+ "                \"configuration\": \"application-properties/atlas.jaas.KafkaClient.option.keyTab\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.authentication.method.kerberos.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": \"HTTP/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"/spnego\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"application-properties/atlas.authentication.method.kerberos.keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"ATLAS_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"auth_to_local_properties\": [\n"+ "        \"application-properties/atlas.authentication.method.kerberos.name.rules|new_lines_escaped\"\n"+ "      ],\n"+ "      \"configurations\": [\n"+ "        {\n"+ "          \"application-properties\": {\n"+ "            \"atlas.kafka.security.protocol\": \"PLAINTEXTSASL\",\n"+ "            \"atlas.jaas.KafkaClient.option.storeKey\": \"true\",\n"+ "            \"atlas.solr.kerberos.enable\": \"true\",\n"+ "            \"atlas.jaas.KafkaClient.loginModuleControlFlag\": \"required\",\n"+ "            \"atlas.authentication.method.kerberos\": \"true\",\n"+ "            \"atlas.jaas.KafkaClient.option.useKeyTab\": \"true\",\n"+ "            \"atlas.kafka.sasl.kerberos.service.name\": \"${kafka-env/kafka_user}\",\n"+ "            \"atlas.jaas.KafkaClient.loginModuleName\": \"com.sun.security.auth.module.Krb5LoginModule\",\n"+ "            \"atlas.jaas.KafkaClient.option.serviceName\": \"${kafka-env/kafka_user}\"\n"+ "          }\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"ATLAS\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"secondary_namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"SECONDARY_NAMENODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"HDFS_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.datanode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"dn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"datanode_dn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/dn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.datanode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"configurations\": [\n"+ "            {\n"+ "              \"hdfs-site\": {\n"+ "                \"dfs.datanode.address\": \"0.0.0.0:1019\",\n"+ "                \"dfs.datanode.http.address\": \"0.0.0.0:1022\"\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"DATANODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/nfs.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nfs/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"nfsgateway\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nfs.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/nfs.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NFS_GATEWAY\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"jn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"journalnode_jn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/jn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"JOURNALNODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hadoop-env/hdfs_principal_name\",\n"+ "                \"type\": \"user\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"${hadoop-env/hdfs_user}-${cluster_name|toLower()}@${realm}\"\n"+ "              },\n"+ "              \"name\": \"hdfs\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/hdfs.headless.keytab\",\n"+ "                \"configuration\": \"hadoop-env/hdfs_user_keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"configurations\": [\n"+ "            {\n"+ "              \"hdfs-site\": {\n"+ "                \"dfs.block.access.token.enable\": \"true\"\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NAMENODE\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"principal\": {\n"+ "            \"configuration\": \"hdfs-site/dfs.web.authentication.kerberos.principal\",\n"+ "            \"type\": null,\n"+ "            \"local_username\": null,\n"+ "            \"value\": null\n"+ "          },\n"+ "          \"name\": \"/spnego\",\n"+ "          \"keytab\": {\n"+ "            \"owner\": {\n"+ "              \"access\": null,\n"+ "              \"name\": null\n"+ "            },\n"+ "            \"file\": null,\n"+ "            \"configuration\": \"hdfs-site/dfs.web.authentication.kerberos.keytab\",\n"+ "            \"group\": {\n"+ "              \"access\": null,\n"+ "              \"name\": null\n"+ "            }\n"+ "          }\n"+ "        },\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"auth_to_local_properties\": [\n"+ "        \"core-site/hadoop.security.auth_to_local\"\n"+ "      ],\n"+ "      \"configurations\": [\n"+ "        {\n"+ "          \"core-site\": {\n"+ "            \"hadoop.security.authorization\": \"true\",\n"+ "            \"hadoop.security.authentication\": \"kerberos\",\n"+ "            \"hadoop.proxyuser.HTTP.groups\": \"${hadoop-env/proxyuser_group}\"\n"+ "          }\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"HDFS\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"name\": \"EXISTING_SERVICE_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"EXISTING_SERVICE_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"EXISTING_SERVICE\"\n"+ "    }\n"+ "  ]\n"+ "}\n").toMap()),GSON.toJson(updatedUserValue.toMap()));
  newValue.update(updatedUserValue);
  Assert.assertEquals(GSON.toJson(KERBEROS_DESCRIPTOR_FACTORY.createInstance("{\n" + "  \"services\": [\n" + "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.jaas.KafkaClient.option.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${atlas-env/metadata_user}\",\n"+ "                \"value\": \"atlas/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"atlas\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${atlas-env/metadata_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/atlas.service.keytab\",\n"+ "                \"configuration\": \"application-properties/atlas.jaas.KafkaClient.option.keyTab\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"reference\": \"/ATLAS/ATLAS_SERVER/atlas\",\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.authentication.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"atlas_auth\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"application-properties/atlas.authentication.keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"application-properties/atlas.authentication.method.kerberos.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": \"HTTP/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"/spnego\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"application-properties/atlas.authentication.method.kerberos.keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"reference\": \"/ATLAS/ATLAS_SERVER/atlas\",\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"ranger-atlas-audit/xasecure.audit.jaas.Client.option.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"ranger_atlas_audit\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"ranger-atlas-audit/xasecure.audit.jaas.Client.option.keyTab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"ATLAS_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"auth_to_local_properties\": [\n"+ "        \"application-properties/atlas.authentication.method.kerberos.name.rules|new_lines_escaped\"\n"+ "      ],\n"+ "      \"configurations\": [\n"+ "        {\n"+ "          \"ranger-atlas-audit\": {\n"+ "            \"xasecure.audit.jaas.Client.loginModuleControlFlag\": \"required\",\n"+ "            \"xasecure.audit.jaas.Client.option.serviceName\": \"solr\",\n"+ "            \"xasecure.audit.jaas.Client.loginModuleName\": \"com.sun.security.auth.module.Krb5LoginModule\",\n"+ "            \"xasecure.audit.jaas.Client.option.useKeyTab\": \"true\",\n"+ "            \"xasecure.audit.jaas.Client.option.storeKey\": \"false\",\n"+ "            \"xasecure.audit.destination.solr.force.use.inmemory.jaas.config\": \"true\"\n"+ "          }\n"+ "        },\n"+ "        {\n"+ "          \"application-properties\": {\n"+ "            \"atlas.kafka.security.protocol\": \"PLAINTEXTSASL\",\n"+ "            \"atlas.jaas.KafkaClient.option.storeKey\": \"true\",\n"+ "            \"atlas.solr.kerberos.enable\": \"true\",\n"+ "            \"atlas.jaas.KafkaClient.loginModuleControlFlag\": \"required\",\n"+ "            \"atlas.authentication.method.kerberos\": \"true\",\n"+ "            \"atlas.jaas.KafkaClient.option.useKeyTab\": \"true\",\n"+ "            \"atlas.kafka.sasl.kerberos.service.name\": \"${kafka-env/kafka_user}\",\n"+ "            \"atlas.jaas.KafkaClient.loginModuleName\": \"com.sun.security.auth.module.Krb5LoginModule\",\n"+ "            \"atlas.jaas.KafkaClient.option.serviceName\": \"${kafka-env/kafka_user}\"\n"+ "          }\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"ATLAS\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"secondary_namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.secondary.namenode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"SECONDARY_NAMENODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"HDFS_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.datanode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"dn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"datanode_dn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/dn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.datanode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"configurations\": [\n"+ "            {\n"+ "              \"hdfs-site\": {\n"+ "                \"dfs.datanode.address\": \"0.0.0.0:1019\",\n"+ "                \"dfs.datanode.http.address\": \"0.0.0.0:1022\"\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"DATANODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/nfs.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nfs/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"nfsgateway\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nfs.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/nfs.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NFS_GATEWAY\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"jn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"journalnode_jn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/jn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.journalnode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"JOURNALNODE\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hadoop-env/hdfs_principal_name\",\n"+ "                \"type\": \"user\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"${hadoop-env/hdfs_user}-${cluster_name|toLower()}@${realm}\"\n"+ "              },\n"+ "              \"name\": \"hdfs\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/hdfs.headless.keytab\",\n"+ "                \"configuration\": \"hadoop-env/hdfs_user_keytab\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.kerberos.principal\",\n"+ "                \"type\": \"service\",\n"+ "                \"local_username\": \"${hadoop-env/hdfs_user}\",\n"+ "                \"value\": \"nn/_HOST@${realm}\"\n"+ "              },\n"+ "              \"name\": \"namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": \"r\",\n"+ "                  \"name\": \"${hadoop-env/hdfs_user}\"\n"+ "                },\n"+ "                \"file\": \"${keytab_dir}/nn.service.keytab\",\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.keytab.file\",\n"+ "                \"group\": {\n"+ "                  \"access\": \"\",\n"+ "                  \"name\": \"${cluster-env/user_group}\"\n"+ "                }\n"+ "              }\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"hdfs-site/dfs.namenode.kerberos.internal.spnego.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/spnego\"\n"+ "            },\n"+ "            {\n"+ "              \"principal\": {\n"+ "                \"configuration\": \"ranger-hdfs-audit/xasecure.audit.jaas.Client.option.principal\",\n"+ "                \"type\": null,\n"+ "                \"local_username\": null,\n"+ "                \"value\": null\n"+ "              },\n"+ "              \"name\": \"/HDFS/NAMENODE/namenode_nn\",\n"+ "              \"keytab\": {\n"+ "                \"owner\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                },\n"+ "                \"file\": null,\n"+ "                \"configuration\": \"ranger-hdfs-audit/xasecure.audit.jaas.Client.option.keyTab\",\n"+ "                \"group\": {\n"+ "                  \"access\": null,\n"+ "                  \"name\": null\n"+ "                }\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"configurations\": [\n"+ "            {\n"+ "              \"hdfs-site\": {\n"+ "                \"dfs.block.access.token.enable\": \"true\"\n"+ "              }\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NAMENODE\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"principal\": {\n"+ "            \"configuration\": \"hdfs-site/dfs.web.authentication.kerberos.principal\",\n"+ "            \"type\": null,\n"+ "            \"local_username\": null,\n"+ "            \"value\": null\n"+ "          },\n"+ "          \"name\": \"/spnego\",\n"+ "          \"keytab\": {\n"+ "            \"owner\": {\n"+ "              \"access\": null,\n"+ "              \"name\": null\n"+ "            },\n"+ "            \"file\": null,\n"+ "            \"configuration\": \"hdfs-site/dfs.web.authentication.kerberos.keytab\",\n"+ "            \"group\": {\n"+ "              \"access\": null,\n"+ "              \"name\": null\n"+ "            }\n"+ "          }\n"+ "        },\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"auth_to_local_properties\": [\n"+ "        \"core-site/hadoop.security.auth_to_local\"\n"+ "      ],\n"+ "      \"configurations\": [\n"+ "        {\n"+ "          \"ranger-hdfs-audit\": {\n"+ "            \"xasecure.audit.jaas.Client.loginModuleControlFlag\": \"required\",\n"+ "            \"xasecure.audit.jaas.Client.option.serviceName\": \"solr\",\n"+ "            \"xasecure.audit.jaas.Client.loginModuleName\": \"com.sun.security.auth.module.Krb5LoginModule\",\n"+ "            \"xasecure.audit.jaas.Client.option.useKeyTab\": \"true\",\n"+ "            \"xasecure.audit.jaas.Client.option.storeKey\": \"false\",\n"+ "            \"xasecure.audit.destination.solr.force.use.inmemory.jaas.config\": \"true\"\n"+ "          }\n"+ "        },\n"+ "        {\n"+ "          \"core-site\": {\n"+ "            \"hadoop.security.authorization\": \"true\",\n"+ "            \"hadoop.security.authentication\": \"kerberos\",\n"+ "            \"hadoop.proxyuser.HTTP.groups\": \"${hadoop-env/proxyuser_group}\"\n"+ "          }\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"HDFS\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"name\": \"NEW_SERVICE_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            },\n"+ "            {\n"+ "              \"name\": \"/HIVE/HIVE_SERVER/hive_server_hive\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NEW_SERVICE_FOO_BAR\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"NEW_SERVICE_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"NEW_SERVICE\"\n"+ "    },\n"+ "    {\n"+ "      \"components\": [\n"+ "        {\n"+ "          \"name\": \"EXISTING_SERVICE_CLIENT\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"EXISTING_SERVICE_SERVER\"\n"+ "        },\n"+ "        {\n"+ "          \"identities\": [\n"+ "            {\n"+ "              \"name\": \"/HDFS/NAMENODE/hdfs\"\n"+ "            }\n"+ "          ],\n"+ "          \"name\": \"EXISTING_SERVICE_NEW_SERVER\"\n"+ "        }\n"+ "      ],\n"+ "      \"identities\": [\n"+ "        {\n"+ "          \"name\": \"/smokeuser\"\n"+ "        },\n"+ "        {\n"+ "          \"name\": \"/HIVE/HIVE_SERVER/hive_server_hive\"\n"+ "        }\n"+ "      ],\n"+ "      \"name\": \"EXISTING_SERVICE\"\n"+ "    }\n"+ "  ]\n"+ "}\n").toMap()),GSON.toJson(newValue.toMap()));
}

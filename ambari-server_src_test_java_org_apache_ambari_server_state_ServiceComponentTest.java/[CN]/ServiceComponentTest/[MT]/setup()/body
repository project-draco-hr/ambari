{
  injector=Guice.createInjector(new InMemoryDefaultTestModule());
  injector.getInstance(GuiceJpaInitializer.class);
  clusters=injector.getInstance(Clusters.class);
  serviceFactory=injector.getInstance(ServiceFactory.class);
  serviceComponentFactory=injector.getInstance(ServiceComponentFactory.class);
  serviceComponentHostFactory=injector.getInstance(ServiceComponentHostFactory.class);
  metaInfo=injector.getInstance(AmbariMetaInfo.class);
  metaInfo.init();
  clusterName="foo";
  serviceName="HDFS";
  clusters.addCluster(clusterName);
  cluster=clusters.getCluster(clusterName);
  StackId stackId=new StackId("HDP-0.1");
  cluster.setDesiredStackVersion(stackId);
  Assert.assertNotNull(cluster);
  cluster.createClusterVersion(stackId.getStackName(),stackId.getStackVersion(),"admin",RepositoryVersionState.CURRENT);
  Service s=serviceFactory.createNew(cluster,serviceName);
  cluster.addService(s);
  s.persist();
  service=cluster.getService(serviceName);
  Assert.assertNotNull(service);
}

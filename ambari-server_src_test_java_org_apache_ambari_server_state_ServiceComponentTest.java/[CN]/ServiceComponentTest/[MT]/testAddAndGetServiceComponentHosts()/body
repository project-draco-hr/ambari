{
  String componentName="NAMENODE";
  ServiceComponent component=serviceComponentFactory.createNew(service,componentName);
  service.addServiceComponent(component);
  component.persist();
  ServiceComponent sc=service.getServiceComponent(componentName);
  Assert.assertNotNull(sc);
  Assert.assertTrue(sc.getServiceComponentHosts().isEmpty());
  try {
    serviceComponentHostFactory.createNew(sc,"h1");
    fail("Expected error for invalid host");
  }
 catch (  Exception e) {
  }
  addHostToCluster("h1",service.getCluster().getClusterName());
  addHostToCluster("h2",service.getCluster().getClusterName());
  addHostToCluster("h3",service.getCluster().getClusterName());
  HostEntity hostEntity1=hostDAO.findByName("h1");
  assertNotNull(hostEntity1);
  ServiceComponentHost sch1=serviceComponentHostFactory.createNew(sc,"h1");
  ServiceComponentHost sch2=serviceComponentHostFactory.createNew(sc,"h2");
  ServiceComponentHost failSch=serviceComponentHostFactory.createNew(sc,"h2");
  Map<String,ServiceComponentHost> compHosts=new HashMap<String,ServiceComponentHost>();
  compHosts.put("h1",sch1);
  compHosts.put("h2",sch2);
  compHosts.put("h3",failSch);
  try {
    sc.addServiceComponentHosts(compHosts);
    fail("Expected error for dups");
  }
 catch (  Exception e) {
  }
  Assert.assertTrue(sc.getServiceComponentHosts().isEmpty());
  compHosts.remove("h3");
  sc.addServiceComponentHosts(compHosts);
  Assert.assertEquals(2,sc.getServiceComponentHosts().size());
  sch1.persist();
  sch2.persist();
  ServiceComponentHost schCheck=sc.getServiceComponentHost("h2");
  Assert.assertNotNull(schCheck);
  Assert.assertEquals("h2",schCheck.getHostName());
  ServiceComponentHost sch3=serviceComponentHostFactory.createNew(sc,"h3");
  sc.addServiceComponentHost(sch3);
  sch3.persist();
  Assert.assertNotNull(sc.getServiceComponentHost("h3"));
  sch1.setDesiredStackVersion(new StackId("HDP-1.2.0"));
  sch1.setState(State.STARTING);
  sch1.setStackVersion(new StackId("HDP-1.2.0"));
  sch1.setDesiredState(State.STARTED);
  HostComponentDesiredStateDAO desiredStateDAO=injector.getInstance(HostComponentDesiredStateDAO.class);
  HostComponentStateDAO liveStateDAO=injector.getInstance(HostComponentStateDAO.class);
  HostComponentDesiredStateEntityPK dPK=new HostComponentDesiredStateEntityPK();
  dPK.setClusterId(cluster.getClusterId());
  dPK.setComponentName(componentName);
  dPK.setHostId(hostEntity1.getHostId());
  dPK.setServiceName(serviceName);
  HostComponentDesiredStateEntity desiredStateEntity=desiredStateDAO.findByPK(dPK);
  HostComponentStateEntity stateEntity=liveStateDAO.findByIndex(cluster.getClusterId(),serviceName,componentName,hostEntity1.getHostId());
  ServiceComponentHost sch=serviceComponentHostFactory.createExisting(sc,stateEntity,desiredStateEntity);
  Assert.assertNotNull(sch);
  Assert.assertEquals(State.STARTING,sch.getState());
  Assert.assertEquals(State.STARTED,sch.getDesiredState());
  Assert.assertEquals("HDP-1.2.0",sch.getStackVersion().getStackId());
  Assert.assertEquals("HDP-1.2.0",sch.getDesiredStackVersion().getStackId());
}

{
  Request request=createMock(Request.class);
  Map<String,ServiceInfo> services=new HashMap<String,ServiceInfo>();
  ServiceInfo service=new ServiceInfo();
  service.setName("test-service");
  services.put("test-service",service);
  List<ComponentInfo> serviceComponents=new ArrayList<ComponentInfo>();
  ComponentInfo component1=new ComponentInfo();
  component1.setName("component1");
  ComponentInfo component2=new ComponentInfo();
  component2.setName("component2");
  serviceComponents.add(component1);
  serviceComponents.add(component2);
  Set<Map<String,Object>> setProperties=getTestProperties();
  ((HashSet<Map<String,String>>)((HashSet<Map<String,Object>>)setProperties.iterator().next().get(BlueprintResourceProvider.HOST_GROUP_PROPERTY_ID)).iterator().next().get("components")).iterator().next().put("name","AMBARI_SERVER");
  Capture<BlueprintEntity> entityCapture=new Capture<BlueprintEntity>();
  expect(request.getProperties()).andReturn(setProperties);
  expect(dao.findByName(BLUEPRINT_NAME)).andReturn(null);
  expect(metaInfo.getServices("test-stack-name","test-stack-version")).andReturn(services).anyTimes();
  expect(metaInfo.getComponentsByService("test-stack-name","test-stack-version","test-service")).andReturn(serviceComponents).anyTimes();
  expect(metaInfo.getComponentToService("test-stack-name","test-stack-version","component1")).andReturn("test-service").anyTimes();
  expect(metaInfo.getRequiredProperties("test-stack-name","test-stack-version","test-service")).andReturn(Collections.<String,org.apache.ambari.server.state.PropertyInfo>emptyMap()).anyTimes();
  dao.create(capture(entityCapture));
  replay(dao,metaInfo,request);
  ResourceProvider provider=createProvider();
  AbstractResourceProviderTest.TestObserver observer=new AbstractResourceProviderTest.TestObserver();
  ((ObservableResourceProvider)provider).addObserver(observer);
  provider.createResources(request);
  ResourceProviderEvent lastEvent=observer.getLastEvent();
  assertNotNull(lastEvent);
  assertEquals(Resource.Type.Blueprint,lastEvent.getResourceType());
  assertEquals(ResourceProviderEvent.Type.Create,lastEvent.getType());
  assertEquals(request,lastEvent.getRequest());
  assertNull(lastEvent.getPredicate());
  verify(dao,metaInfo,request);
}

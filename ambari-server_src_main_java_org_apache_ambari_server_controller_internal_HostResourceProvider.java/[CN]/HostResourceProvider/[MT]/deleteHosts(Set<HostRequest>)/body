{
  AmbariManagementController controller=getManagementController();
  Clusters clusters=controller.getClusters();
  List<HostRequest> okToRemove=new ArrayList<HostRequest>();
  for (  HostRequest hostRequest : requests) {
    String hostName=hostRequest.getHostname();
    if (null == hostName) {
      continue;
    }
    if (null != hostRequest.getClusterName()) {
      Cluster cluster=clusters.getCluster(hostRequest.getClusterName());
      List<ServiceComponentHost> list=cluster.getServiceComponentHosts(hostName);
      if (0 != list.size()) {
        StringBuilder reason=new StringBuilder("Cannot remove host ").append(hostName).append(" from ").append(hostRequest.getClusterName()).append(".  The following roles exist: ");
        int i=0;
        for (        ServiceComponentHost sch : list) {
          if ((i++) > 0) {
            reason.append(", ");
          }
          reason.append(sch.getServiceComponentName());
        }
        throw new AmbariException(reason.toString());
      }
      okToRemove.add(hostRequest);
    }
 else {
      clusters.getHost(hostName);
      Set<Cluster> clusterSet=clusters.getClustersForHost(hostName);
      if (0 != clusterSet.size()) {
        StringBuilder reason=new StringBuilder("Cannot remove host ").append(hostName).append(".  It belongs to clusters: ");
        int i=0;
        for (        Cluster c : clusterSet) {
          if ((i++) > 0) {
            reason.append(", ");
          }
          reason.append(c.getClusterName());
        }
        throw new AmbariException(reason.toString());
      }
      okToRemove.add(hostRequest);
    }
  }
  for (  HostRequest hostRequest : okToRemove) {
    if (null != hostRequest.getClusterName()) {
      clusters.unmapHostFromCluster(hostRequest.getHostname(),hostRequest.getClusterName());
      clusters.getCluster(hostRequest.getClusterName()).recalculateAllClusterVersionStates();
    }
 else {
      clusters.deleteHost(hostRequest.getHostname());
    }
  }
}

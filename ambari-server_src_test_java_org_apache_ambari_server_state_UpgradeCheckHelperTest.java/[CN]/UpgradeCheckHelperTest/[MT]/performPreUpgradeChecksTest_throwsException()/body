{
  final UpgradeCheckHelper helper=new UpgradeCheckHelper();
  helper.registry.clear();
  UpgradeCheckDescriptor descriptor=EasyMock.createNiceMock(UpgradeCheckDescriptor.class);
  descriptor.perform(EasyMock.<UpgradeCheck>anyObject(),EasyMock.<PreUpgradeCheckRequest>anyObject());
  EasyMock.expectLastCall().andThrow(new AmbariException("error"));
  EasyMock.expect(descriptor.isApplicable(EasyMock.<PreUpgradeCheckRequest>anyObject())).andReturn(true);
  EasyMock.replay(descriptor);
  helper.registry.add(descriptor);
  final List<UpgradeCheck> upgradeChecks=helper.performPreUpgradeChecks(new PreUpgradeCheckRequest("cluster"));
  EasyMock.verify(descriptor);
  Assert.assertEquals(UpgradeCheckStatus.FAIL,upgradeChecks.get(0).getStatus());
}

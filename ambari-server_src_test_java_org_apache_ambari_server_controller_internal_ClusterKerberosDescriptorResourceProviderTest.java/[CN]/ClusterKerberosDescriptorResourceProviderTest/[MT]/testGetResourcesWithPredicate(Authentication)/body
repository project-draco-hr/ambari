{
  Cluster cluster=createMock(Cluster.class);
  expect(cluster.getResourceId()).andReturn(4L).atLeastOnce();
  Clusters clusters=createMock(Clusters.class);
  expect(clusters.getCluster("c1")).andReturn(cluster).atLeastOnce();
  KerberosDescriptorFactory kerberosDescriptorFactory=injector.getInstance(KerberosDescriptorFactory.class);
  KerberosDescriptor stackKerberosDescriptor=kerberosDescriptorFactory.createInstance(STACK_MAP);
  KerberosDescriptor userKerberosDescriptor=kerberosDescriptorFactory.createInstance(USER_MAP);
  KerberosDescriptor compositeKerberosDescriptor=kerberosDescriptorFactory.createInstance(STACK_MAP);
  compositeKerberosDescriptor.update(userKerberosDescriptor);
  KerberosHelper kerberosHelper=createMock(KerberosHelper.class);
  expect(kerberosHelper.getKerberosDescriptor(eq(KerberosHelper.KerberosDescriptorType.STACK),eq(cluster),eq(false),anyObject(Collection.class))).andReturn(stackKerberosDescriptor).atLeastOnce();
  expect(kerberosHelper.getKerberosDescriptor(eq(KerberosHelper.KerberosDescriptorType.USER),eq(cluster),eq(false),anyObject(Collection.class))).andReturn(userKerberosDescriptor).atLeastOnce();
  expect(kerberosHelper.getKerberosDescriptor(eq(KerberosHelper.KerberosDescriptorType.COMPOSITE),eq(cluster),eq(false),anyObject(Collection.class))).andReturn(compositeKerberosDescriptor).atLeastOnce();
  AmbariManagementController managementController=createMock(AmbariManagementController.class);
  expect(managementController.getClusters()).andReturn(clusters).atLeastOnce();
  expect(managementController.getKerberosHelper()).andReturn(kerberosHelper).atLeastOnce();
  Request request=createMock(Request.class);
  expect(request.getPropertyIds()).andReturn(null).atLeastOnce();
  expect(request.getRequestInfoProperties()).andReturn(Collections.<String,String>emptyMap()).atLeastOnce();
  replayAll();
  SecurityContextHolder.getContext().setAuthentication(authentication);
  ResourceProvider provider=AbstractControllerResourceProvider.getResourceProvider(Resource.Type.ClusterKerberosDescriptor,PropertyHelper.getPropertyIds(Resource.Type.ClusterKerberosDescriptor),PropertyHelper.getKeyPropertyIds(Resource.Type.ClusterKerberosDescriptor),managementController);
  Predicate clusterPredicate=new PredicateBuilder().property(ClusterKerberosDescriptorResourceProvider.CLUSTER_KERBEROS_DESCRIPTOR_CLUSTER_NAME_PROPERTY_ID).equals("c1").toPredicate();
  Predicate typePredicate;
  Set<Resource> results;
  typePredicate=new PredicateBuilder().property(ClusterKerberosDescriptorResourceProvider.CLUSTER_KERBEROS_DESCRIPTOR_TYPE_PROPERTY_ID).equals("STACK").toPredicate();
  results=provider.getResources(request,new AndPredicate(clusterPredicate,typePredicate));
  Assert.assertEquals(1,results.size());
  testResults("STACK",STACK_MAP,results);
  typePredicate=new PredicateBuilder().property(ClusterKerberosDescriptorResourceProvider.CLUSTER_KERBEROS_DESCRIPTOR_TYPE_PROPERTY_ID).equals("USER").toPredicate();
  results=provider.getResources(request,new AndPredicate(clusterPredicate,typePredicate));
  Assert.assertEquals(1,results.size());
  testResults("USER",USER_MAP,results);
  typePredicate=new PredicateBuilder().property(ClusterKerberosDescriptorResourceProvider.CLUSTER_KERBEROS_DESCRIPTOR_TYPE_PROPERTY_ID).equals("COMPOSITE").toPredicate();
  results=provider.getResources(request,new AndPredicate(clusterPredicate,typePredicate));
  Assert.assertEquals(1,results.size());
  testResults("COMPOSITE",COMPOSITE_MAP,results);
  verifyAll();
}

def execute_db_connection_check(self, config, tmp_dir):
    print 'DB connection check started.'
    ambari_server_hostname = config['commandParams']['ambari_server_host']
    check_db_connection_jar_name = 'DBConnectionVerification.jar'
    jdk_location = config['commandParams']['jdk_location']
    java64_home = config['commandParams']['java_home']
    db_name = config['commandParams']['db_name']
    if (db_name == DB_MYSQL):
        jdbc_url = (jdk_location + JDBC_DRIVER_SYMLINK_MYSQL)
        jdbc_driver = JDBC_DRIVER_MYSQL
        jdbc_name = JDBC_DRIVER_SYMLINK_MYSQL
    elif (db_name == DB_ORACLE):
        jdbc_url = (jdk_location + JDBC_DRIVER_SYMLINK_ORACLE)
        jdbc_driver = JDBC_DRIVER_ORACLE
        jdbc_name = JDBC_DRIVER_SYMLINK_ORACLE
    elif (db_name == DB_POSTGRESQL):
        jdbc_url = (jdk_location + JDBC_DRIVER_SYMLINK_POSTGRESQL)
        jdbc_driver = JDBC_DRIVER_POSTGRESQL
        jdbc_name = JDBC_DRIVER_SYMLINK_POSTGRESQL
    elif (db_name == DB_MSSQL):
        jdbc_url = (jdk_location + JDBC_DRIVER_SYMLINK_MSSQL)
        jdbc_driver = JDBC_DRIVER_MSSQL
        jdbc_name = JDBC_DRIVER_SYMLINK_MSSQL
    db_connection_url = config['commandParams']['db_connection_url']
    user_name = config['commandParams']['user_name']
    user_passwd = config['commandParams']['user_passwd']
    agent_cache_dir = os.path.abspath(config['hostLevelParams']['agentCacheDir'])
    check_db_connection_url = (jdk_location + check_db_connection_jar_name)
    jdbc_path = os.path.join(agent_cache_dir, jdbc_name)
    check_db_connection_path = os.path.join(agent_cache_dir, check_db_connection_jar_name)
    class_path_delimiter = os.pathsep
    java_exec = os.path.join(java64_home, configDefaults.JAVA_EXE_SUBPATH)
    if ((('jdk_name' not in config['commandParams']) or (config['commandParams']['jdk_name'] == None) or (config['commandParams']['jdk_name'] == '')) and (not os.path.isfile(java_exec))):
        message = 'Custom java is not available on host. Please install it. Java home should be the same as on server. \n'
        print message
        db_connection_check_structured_output = {'exit_code': 1, 'message': message, }
        return db_connection_check_structured_output
    environment = {'no_proxy': format('{ambari_server_hostname}'), }
    if (not os.path.isfile(java_exec)):
        jdk_name = config['commandParams']['jdk_name']
        jdk_url = '{0}/{1}'.format(jdk_location, jdk_name)
        jdk_download_target = os.path.join(agent_cache_dir, jdk_name)
        java_dir = os.path.dirname(java64_home)
        try:
            download_file(jdk_url, jdk_download_target)
        except Exception as e:
            message = ('Error downloading JDK from Ambari Server resources. Check network access to Ambari Server.\n' + str(e))
            print message
            db_connection_check_structured_output = {'exit_code': 1, 'message': message, }
            return db_connection_check_structured_output
        if jdk_name.endswith('.bin'):
            install_cmd = format('mkdir -p {java_dir} ; chmod +x {jdk_download_target}; cd {java_dir} ; echo A | {jdk_curl_target} -noregister > /dev/null 2>&1')
            install_path = ['/bin', '/usr/bin/']
        elif jdk_name.endswith('.gz'):
            install_cmd = format('mkdir -p {java_dir} ; cd {java_dir} ; tar -xf {jdk_download_target} > /dev/null 2>&1')
            install_path = ['/bin', '/usr/bin/']
        elif jdk_name.endswith('.exe'):
            install_cmd = '{0} /s INSTALLDIR={1} STATIC=1 WEB_JAVA=0 /L \\var\\log\\ambari-agent'.format(quote_path(jdk_download_target), quote_path(java64_home))
            install_path = [java_dir]
        try:
            Execute(install_cmd, path=install_path)
        except Exception as e:
            message = ('Error installing java.\n' + str(e))
            print message
            db_connection_check_structured_output = {'exit_code': 1, 'message': message, }
            return db_connection_check_structured_output
    try:
        download_file(check_db_connection_url, check_db_connection_path)
    except Exception as e:
        message = ('Error downloading DBConnectionVerification.jar from Ambari Server resources. Check network access to Ambari Server.\n' + str(e))
        print message
        db_connection_check_structured_output = {'exit_code': 1, 'message': message, }
        return db_connection_check_structured_output
    try:
        download_file(jdbc_url, jdbc_path)
        if (db_name == DB_MSSQL):
            jdbc_auth_path = os.path.join(agent_cache_dir, JDBC_AUTH_SYMLINK_MSSQL)
            jdbc_auth_url = (jdk_location + JDBC_AUTH_SYMLINK_MSSQL)
            download_file(jdbc_auth_url, jdbc_auth_path)
    except Exception as e:
        message = (format('Error: Ambari Server cannot download the database JDBC driver and is unable to test the database connection. You must run ambari-server setup --jdbc-db={db_name} --jdbc-driver=/path/to/your/{db_name}/driver.jar on the Ambari Server host to make the JDBC driver available for download and to enable testing the database connection.\n') + str(e))
        print message
        db_connection_check_structured_output = {'exit_code': 1, 'message': message, }
        return db_connection_check_structured_output
    db_connection_check_command = format('{java_exec} -cp {check_db_connection_path}{class_path_delimiter}{jdbc_path} -Djava.library.path={agent_cache_dir} org.apache.ambari.server.DBConnectionVerification {db_connection_url} {user_name} {user_passwd!p} {jdbc_driver}')
    print ('INFO db_connection_check_command: ' + db_connection_check_command)
    process = subprocess.Popen(db_connection_check_command, stdout=subprocess.PIPE, stdin=subprocess.PIPE, stderr=subprocess.PIPE, shell=True)
    (stdoutdata, stderrdata) = process.communicate()
    print ('INFO stdoutdata: ' + stdoutdata)
    print ('INFO stderrdata: ' + stderrdata)
    print ('INFO returncode: ' + str(process.returncode))
    if (process.returncode == 0):
        db_connection_check_structured_output = {'exit_code': 0, 'message': 'DB connection check completed successfully!', }
    else:
        db_connection_check_structured_output = {'exit_code': 1, 'message': (stdoutdata + stderrdata), }
    return db_connection_check_structured_output

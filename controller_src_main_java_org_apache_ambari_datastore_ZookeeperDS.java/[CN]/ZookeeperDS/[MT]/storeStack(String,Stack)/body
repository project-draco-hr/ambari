{
  try {
    Stat stat=new Stat();
    String stackPath=ZOOKEEPER_STACKS_ROOT_PATH + "/" + stackName;
    int newRev=0;
    String stackRevisionPath=stackPath + "/" + newRev;
    String stackLatestRevisionNumberPath=stackPath + "/latestRevisionNumber";
    if (zk.exists(stackPath,false) == null) {
      createDirectory(stackPath,new byte[0],false);
      stack.setRevision(new Integer(newRev).toString());
      createDirectory(stackRevisionPath,JAXBUtil.write(stack),false);
      createDirectory(stackLatestRevisionNumberPath,(new Integer(newRev)).toString().getBytes(),false);
    }
 else {
      String latestRevision=new String(zk.getData(stackLatestRevisionNumberPath,false,stat));
      newRev=Integer.parseInt(latestRevision) + 1;
      stackRevisionPath=stackPath + "/" + newRev;
      stack.setRevision(new Integer(newRev).toString());
      createDirectory(stackRevisionPath,JAXBUtil.write(stack),false);
      zk.setData(stackLatestRevisionNumberPath,(new Integer(newRev)).toString().getBytes(),-1);
    }
    return newRev;
  }
 catch (  KeeperException e) {
    throw new IOException(e);
  }
catch (  InterruptedException e1) {
    throw new IOException(e1);
  }
}

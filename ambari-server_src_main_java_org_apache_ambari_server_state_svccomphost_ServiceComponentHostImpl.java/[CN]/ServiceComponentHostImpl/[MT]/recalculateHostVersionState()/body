{
  String version=getVersion();
  if (version == null || version.isEmpty() || version.equalsIgnoreCase(State.UNKNOWN.toString())) {
    return null;
  }
  final String hostName=getHostName();
  final Set<Cluster> clustersForHost=clusters.getClustersForHost(hostName);
  if (clustersForHost.size() != 1) {
    throw new AmbariException("Host " + hostName + " should be assigned only to one cluster");
  }
  final Cluster cluster=clustersForHost.iterator().next();
  final StackId stackId=cluster.getDesiredStackVersion();
  final StackInfo stackInfo=ambariMetaInfo.getStack(stackId.getStackName(),stackId.getStackVersion());
  writeLock.lock();
  try {
    RepositoryVersionEntity repositoryVersion=repositoryVersionDAO.findByStackAndVersion(stackId,version);
    if (repositoryVersion == null) {
      repositoryVersion=createRepositoryVersion(version,stackId,stackInfo);
    }
    final HostEntity host=hostDAO.findByName(hostName);
    cluster.transitionHostVersionState(host,repositoryVersion,stackId);
  }
  finally {
    writeLock.unlock();
  }
  return version;
}

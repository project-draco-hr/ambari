{
  writeLock.lock();
  try {
    if (!persisted) {
      persistEntities();
      persisted=true;
      refresh();
      StackId stackId=getDesiredStackVersion();
      ServiceComponentInstalledEvent event=new ServiceComponentInstalledEvent(getClusterId(),stackId.getStackName(),stackId.getStackVersion(),getServiceName(),getServiceComponentName(),getHostName(),isRecoveryEnabled());
      eventPublisher.publish(event);
    }
 else {
      saveComponentStateEntityIfPersisted();
      saveComponentDesiredStateEntityIfPersisted();
    }
  }
  finally {
    writeLock.unlock();
  }
}

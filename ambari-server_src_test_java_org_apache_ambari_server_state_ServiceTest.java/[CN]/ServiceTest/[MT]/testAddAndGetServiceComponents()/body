{
  String serviceName="s1";
  Service s=serviceFactory.createNew(cluster,serviceName);
  cluster.addService(s);
  s.persist();
  Service service=cluster.getService(serviceName);
  Assert.assertNotNull(service);
  Assert.assertTrue(s.getServiceComponents().isEmpty());
  ServiceComponent sc1=serviceComponentFactory.createNew(s,"sc1");
  ServiceComponent sc2=serviceComponentFactory.createNew(s,"sc2");
  ServiceComponent sc3=serviceComponentFactory.createNew(s,"sc3");
  Map<String,ServiceComponent> comps=new HashMap<String,ServiceComponent>();
  comps.put(sc1.getName(),sc1);
  comps.put(sc2.getName(),sc2);
  s.addServiceComponents(comps);
  Assert.assertEquals(2,s.getServiceComponents().size());
  Assert.assertNotNull(s.getServiceComponent(sc1.getName()));
  Assert.assertNotNull(s.getServiceComponent(sc2.getName()));
  try {
    s.getServiceComponent(sc3.getName());
    fail("Expected error when looking for invalid component");
  }
 catch (  Exception e) {
  }
  s.addServiceComponent(sc3);
  sc1.persist();
  sc2.persist();
  sc3.persist();
  Assert.assertNotNull(s.getServiceComponent(sc3.getName()));
  Assert.assertEquals(3,s.getServiceComponents().size());
  Assert.assertEquals(sc3.getName(),s.getServiceComponent(sc3.getName()).getName());
  Assert.assertEquals(s.getName(),s.getServiceComponent(sc3.getName()).getServiceName());
  Assert.assertEquals(cluster.getClusterName(),s.getServiceComponent(sc3.getName()).getClusterName());
}

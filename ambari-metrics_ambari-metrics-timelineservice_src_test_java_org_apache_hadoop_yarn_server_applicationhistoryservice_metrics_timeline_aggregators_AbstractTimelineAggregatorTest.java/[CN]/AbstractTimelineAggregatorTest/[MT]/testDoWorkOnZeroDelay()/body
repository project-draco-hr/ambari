{
  long currentTime=System.currentTimeMillis();
  long roundedOffAggregatorTime=AbstractTimelineAggregator.getRoundedCheckPointTimeMillis(currentTime,sleepIntervalMillis);
  checkPoint.set(-1);
  agg.runOnce(sleepIntervalMillis);
  assertEquals("startTime should be zero",0,startTimeInDoWork.get());
  assertEquals("endTime  should be zero",0,endTimeInDoWork.get());
  assertEquals(roundedOffAggregatorTime,checkPoint.get());
  assertEquals("Do not aggregate on first run",0,actualRuns);
  currentTime=System.currentTimeMillis();
  checkPoint.set(currentTime);
  agg.setSleepIntervalMillis(sleepIntervalMillis);
  agg.runOnce(sleepIntervalMillis);
  assertEquals("startTime should be zero",0,startTimeInDoWork.get());
  assertEquals("endTime  should be zero",0,endTimeInDoWork.get());
  assertEquals("Do not aggregate on first run",0,actualRuns);
  currentTime=System.currentTimeMillis();
  checkPoint.set(currentTime - 16 * 60 * 1000);
  agg.runOnce(sleepIntervalMillis);
  long checkPointTime=AbstractTimelineAggregator.getRoundedAggregateTimeMillis(sleepIntervalMillis);
  assertEquals("startTime should be zero",checkPointTime - sleepIntervalMillis,startTimeInDoWork.get());
  assertEquals("endTime  should be zero",checkPointTime,endTimeInDoWork.get());
  assertEquals(roundedOffAggregatorTime,checkPoint.get());
  assertEquals("Do not aggregate on first run",1,actualRuns);
  currentTime=System.currentTimeMillis();
  roundedOffAggregatorTime=AbstractTimelineAggregator.getRoundedCheckPointTimeMillis(currentTime,sleepIntervalMillis);
  checkPointTime=roundedOffAggregatorTime - sleepIntervalMillis;
  long expectedCheckPoint=AbstractTimelineAggregator.getRoundedCheckPointTimeMillis(checkPointTime,sleepIntervalMillis);
  checkPoint.set(checkPointTime);
  agg.runOnce(sleepIntervalMillis);
  assertEquals("startTime should the lower rounded time of the checkpoint time",expectedCheckPoint,startTimeInDoWork.get());
  assertEquals("endTime should the lower rounded time of the checkpoint time + sleepIntervalMillis",expectedCheckPoint + sleepIntervalMillis,endTimeInDoWork.get());
  assertEquals(expectedCheckPoint + sleepIntervalMillis,checkPoint.get());
  assertEquals("Aggregate on first run",2,actualRuns);
  currentTime=System.currentTimeMillis();
  checkPoint.set(currentTime - 2 * sleepIntervalMillis + 5000);
  agg.runOnce(sleepIntervalMillis);
  long expectedStartTime=AbstractTimelineAggregator.getRoundedCheckPointTimeMillis(currentTime - 2 * sleepIntervalMillis + 5000,sleepIntervalMillis);
  assertEquals("startTime should the lower rounded time of the checkpoint time",expectedStartTime,startTimeInDoWork.get());
  assertEquals("startTime should the lower rounded time of the checkpoint time + sleepIntervalMillis",expectedStartTime + sleepIntervalMillis,endTimeInDoWork.get());
  assertEquals(expectedStartTime + sleepIntervalMillis,checkPoint.get());
  assertEquals("Aggregate on second run",3,actualRuns);
}

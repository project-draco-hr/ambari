@patch('subprocess.Popen')
@patch.object(Hardware, '_chk_writable_mount', new=MagicMock(return_value=True))
@patch.object(FacterLinux, 'facterInfo', new=MagicMock(return_value={}))
@patch.object(FacterLinux, '__init__', new=MagicMock(return_value=None))
@patch('ambari_commons.firewall.run_os_command')
@patch.object(OSCheck, 'get_os_type')
@patch.object(OSCheck, 'get_os_version')
def test_registration_build(self, get_os_version_mock, get_os_type_mock, run_os_cmd_mock, Popen_mock):
    config = AmbariConfig().getConfig()
    tmpdir = tempfile.gettempdir()
    config.set('agent', 'prefix', tmpdir)
    config.set('agent', 'current_ping_port', '33777')
    get_os_type_mock.return_value = 'suse'
    get_os_version_mock.return_value = '11'
    run_os_cmd_mock.return_value = (3, '', '')
    register = Register(config)
    reference_version = '2.1.0'
    data = register.build(reference_version, 1)
    self.assertEquals((len(data['hardwareProfile']) > 0), True, 'hardwareProfile should contain content')
    self.assertEquals((data['hostname'] != ''), True, 'hostname should not be empty')
    self.assertEquals((data['publicHostname'] != ''), True, 'publicHostname should not be empty')
    self.assertEquals(data['responseId'], 1)
    self.assertEquals((data['timestamp'] > 1353678475465L), True, 'timestamp should not be empty')
    self.assertEquals((len(data['agentEnv']) > 0), True, 'agentEnv should not be empty')
    self.assertEquals(data['agentVersion'], reference_version, 'agentVersion should not be empty')
    print data['agentEnv']['umask']
    self.assertEquals((not (data['agentEnv']['umask'] == '')), True, 'agents umask should not be empty')
    self.assertEquals((data['currentPingPort'] == 33777), True, 'current ping port should be 33777')
    self.assertEquals(data['prefix'], config.get('agent', 'prefix'), 'The prefix path does not match')
    self.assertEquals(len(data), 9)

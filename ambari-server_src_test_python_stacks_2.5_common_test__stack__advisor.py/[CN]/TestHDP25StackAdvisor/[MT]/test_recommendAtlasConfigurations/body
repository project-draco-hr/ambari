def test_recommendAtlasConfigurations(self):
    self.maxDiff = None
    configurations = {'application-properties': {'properties': {'atlas.graph.index.search.solr.zookeeper-url': '', 'atlas.audit.hbase.zookeeper.quorum': '', 'atlas.graph.storage.hostname': '', 'atlas.kafka.bootstrap.servers': '', 'atlas.kafka.zookeeper.connect': '', }, }, 'infra-solr-env': {'properties': {'infra_solr_znode': '/infra-solr', }, }, 'ranger-atlas-plugin-properties': {'properties': {'ranger-atlas-plugin-enabled': 'No', }, }, }
    clusterData = {'cpu': 4, 'mapMemory': 3000, 'amMemory': 2000, 'reduceMemory': 2056, 'containers': 3, 'ramPerContainer': 256, }
    expected = {'application-properties': {'properties': {'atlas.graph.index.search.solr.zookeeper-url': 'c6401.ambari.apache.org:2181/infra-solr', 'atlas.audit.hbase.zookeeper.quorum': 'c6401.ambari.apache.org', 'atlas.graph.storage.hostname': 'c6401.ambari.apache.org', 'atlas.kafka.bootstrap.servers': 'c6401.ambari.apache.org:6667', 'atlas.kafka.zookeeper.connect': 'c6401.ambari.apache.org', 'atlas.authorizer.impl': 'ranger', 'atlas.rest.address': 'http://c6401.ambari.apache.org:21000', }, }, 'infra-solr-env': {'properties': {'infra_solr_znode': '/infra-solr', }, }, 'ranger-atlas-plugin-properties': {'properties': {'ranger-atlas-plugin-enabled': 'Yes', }, }, 'atlas-env': {'properties': {}, }, }
    services = {'Versions': {'parent_stack_version': '2.4', 'stack_name': 'HDP', 'stack_version': '2.5', 'stack_hierarchy': {'stack_name': 'HDP', 'stack_versions': ['2.4', '2.3', '2.2', '2.1', '2.0.6'], }, }, 'services': [{'href': '/api/v1/stacks/HDP/versions/2.2/services/AMBARI_INFRA', 'StackServices': {'service_name': 'AMBARI_INFRA', 'service_version': '2.6.0.2.2', 'stack_name': 'HDP', 'stack_version': '2.3', }, 'components': [{'StackServiceComponents': {'advertise_version': 'false', 'cardinality': '1', 'component_category': 'MASTER', 'component_name': 'INFRA_SOLR', 'display_name': 'solr', 'is_client': 'false', 'is_master': 'true', 'hostnames': ['c6401.ambari.apache.org'], }, 'dependencies': [], }], }, {'href': '/api/v1/stacks/HDP/versions/2.2/services/ZOOKEEPER', 'StackServices': {'service_name': 'ZOOKEEPER', 'service_version': '2.6.0.2.2', 'stack_name': 'HDP', 'stack_version': '2.3', }, 'components': [{'StackServiceComponents': {'advertise_version': 'false', 'cardinality': '1', 'component_category': 'MASTER', 'component_name': 'ZOOKEEPER_SERVER', 'display_name': 'zk', 'is_client': 'false', 'is_master': 'true', 'hostnames': ['c6401.ambari.apache.org'], }, 'dependencies': [], }], }, {'href': '/api/v1/stacks/HDP/versions/2.2/services/HBASE', 'StackServices': {'service_name': 'HBASE', 'service_version': '2.6.0.2.2', 'stack_name': 'HDP', 'stack_version': '2.3', }, 'components': [{'StackServiceComponents': {'advertise_version': 'false', 'cardinality': '1', 'component_category': 'MASTER', 'component_name': 'HBASE_MASTER', 'display_name': 'zk', 'is_client': 'false', 'is_master': 'true', 'hostnames': ['c6401.ambari.apache.org'], }, 'dependencies': [], }], }, {'href': '/api/v1/stacks/HDP/versions/2.2/services/ATLAS', 'StackServices': {'service_name': 'ATLAS', 'service_version': '2.6.0.2.2', 'stack_name': 'HDP', 'stack_version': '2.3', }, 'components': [{'StackServiceComponents': {'advertise_version': 'false', 'cardinality': '1', 'component_category': 'MASTER', 'component_name': 'ATLAS_SERVER', 'display_name': 'atlas', 'is_client': 'false', 'is_master': 'true', 'hostnames': ['c6401.ambari.apache.org'], }, 'dependencies': [], }], }, {'href': '/api/v1/stacks/HDP/versions/2.2/services/KAFKA', 'StackServices': {'service_name': 'KAFKA', 'service_version': '2.6.0.2.2', 'stack_name': 'HDP', 'stack_version': '2.3', }, 'components': [{'StackServiceComponents': {'advertise_version': 'false', 'cardinality': '1', 'component_category': 'MASTER', 'component_name': 'KAFKA_BROKER', 'display_name': 'atlas', 'is_client': 'false', 'is_master': 'true', 'hostnames': ['c6401.ambari.apache.org'], }, 'dependencies': [], }], }], 'configurations': {'application-properties': {'properties': {'atlas.graph.index.search.solr.zookeeper-url': '', 'atlas.audit.hbase.zookeeper.quorum': '', 'atlas.graph.storage.hostname': '', 'atlas.kafka.bootstrap.servers': '', 'atlas.kafka.zookeeper.connect': '', }, }, 'infra-solr-env': {'properties': {'infra_solr_znode': '/infra-solr', }, }, 'hbase-site': {'properties': {'hbase.zookeeper.quorum': 'c6401.ambari.apache.org', }, }, 'kafka-broker': {'properties': {'zookeeper.connect': 'c6401.ambari.apache.org', 'port': '6667', }, }, 'ranger-atlas-plugin-properties': {'properties': {'ranger-atlas-plugin-enabled': 'No', }, }, }, 'changed-configurations': [], }
    hosts = {'items': [{'href': '/api/v1/hosts/c6401.ambari.apache.org', 'Hosts': {'cpu_count': 1, 'host_name': 'c6401.ambari.apache.org', 'os_arch': 'x86_64', 'os_type': 'centos6', 'ph_cpu_count': 1, 'public_host_name': 'c6401.ambari.apache.org', 'rack_info': '/default-rack', 'total_mem': 1922680, }, }], }
    self.stackAdvisor.recommendAtlasConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations['application-properties']['properties']['atlas.authorizer.impl'], 'simple', 'Test atlas.authorizer.impl with Ranger Atlas plugin is disabled ')
    configurations['ranger-atlas-plugin-properties']['properties']['ranger-atlas-plugin-enabled'] = 'Yes'
    self.stackAdvisor.recommendAtlasConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)
    services['ambari-server-properties'] = {'java.home': '/usr/jdk64/jdk1.7.3_23', }
    self.stackAdvisor.recommendAtlasConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)

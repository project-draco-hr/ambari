def test_recommendAmsConfigurations(self):
    configurations = {}
    clusterData = {}
    services = {'services': [{'StackServices': {'service_name': 'AMBARI_METRICS', }, 'components': [{'StackServiceComponents': {'component_name': 'METRICS_COLLECTOR', 'hostnames': ['host1'], }, }, {'StackServiceComponents': {'component_name': 'METRICS_MONITOR', 'hostnames': ['host1'], }, }], }], 'configurations': [], }
    hosts = {'items': [{'Hosts': {'host_name': 'host1', }, }], }
    expected = {'ams-hbase-env': {'properties': {'hbase_master_heapsize': '540m', }, }, 'ams-env': {'properties': {'metrics_collector_heapsize': '512m', }, }, 'ams-hbase-site': {'properties': {'hbase.regionserver.global.memstore.lowerLimit': '0.3', 'hbase.regionserver.global.memstore.upperLimit': '0.35', 'hbase.hregion.memstore.flush.size': '134217728', 'hfile.block.cache.size': '0.3', 'hbase.rootdir': 'file:///var/lib/ambari-metrics-collector/hbase', 'hbase.tmp.dir': '/var/lib/ambari-metrics-collector/hbase-tmp', 'hbase_master_xmn_size': '128m', }, }, 'ams-site': {'properties': {'timeline.metrics.cluster.aggregate.splitpoints': ' ', 'timeline.metrics.host.aggregate.splitpoints': ' ', 'timeline.metrics.host.aggregator.ttl': '86400', }, }, }
    self.stackAdvisor.recommendAmsConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)
    for i in range(2, 101):
        hosts['items'].extend([{'Hosts': {'host_name': ('host' + str(i)), }, }])
    services['services'] = [{'StackServices': {'service_name': 'AMBARI_METRICS', }, 'components': [{'StackServiceComponents': {'component_name': 'METRICS_COLLECTOR', 'hostnames': ['host1'], }, }, {'StackServiceComponents': {'component_name': 'METRICS_MONITOR', 'hostnames': [('host' + str(i)) for i in range(1, 101)], }, }], }]
    expected['ams-hbase-env']['properties']['hbase_master_heapsize'] = '1034m'
    expected['ams-env']['properties']['metrics_collector_heapsize'] = '512m'
    self.stackAdvisor.recommendAmsConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)
    services['services'] = [{'StackServices': {'service_name': 'HDFS', }, 'components': [{'StackServiceComponents': {'component_name': 'NAMENODE', 'hostnames': ['host1'], }, }, {'StackServiceComponents': {'component_name': 'DATANODE', 'hostnames': [('host' + str(i)) for i in range(1, 101)], }, }], }, {'StackServices': {'service_name': 'YARN', }, 'components': [{'StackServiceComponents': {'component_name': 'RESOURCEMANAGER', 'hostnames': ['host1'], }, }, {'StackServiceComponents': {'component_name': 'NODEMANAGER', 'hostnames': [('host' + str(i)) for i in range(1, 101)], }, }], }, {'StackServices': {'service_name': 'AMBARI_METRICS', }, 'components': [{'StackServiceComponents': {'component_name': 'METRICS_COLLECTOR', 'hostnames': ['host1'], }, }, {'StackServiceComponents': {'component_name': 'METRICS_MONITOR', 'hostnames': [('host' + str(i)) for i in range(1, 101)], }, }], }]
    expected['ams-hbase-env']['properties']['hbase_master_heapsize'] = '1601m'
    expected['ams-env']['properties']['metrics_collector_heapsize'] = '512m'
    self.stackAdvisor.recommendAmsConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)

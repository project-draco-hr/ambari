def test_recommendHiveConfigurationAttributes(self):
    self.maxDiff = None
    configurations = {'yarn-site': {'properties': {'yarn.scheduler.minimum-allocation-mb': '256', 'yarn.scheduler.maximum-allocation-mb': '8192', }, }, }
    clusterData = {'cpu': 4, 'mapMemory': 3000, 'amMemory': 2000, 'reduceMemory': 2056, 'containers': 3, 'ramPerContainer': 256, }
    expected = {'yarn-site': {'properties': {'yarn.scheduler.minimum-allocation-mb': '256', 'yarn.scheduler.maximum-allocation-mb': '8192', }, }, 'hive-env': {'properties': {'hive_exec_orc_storage_strategy': 'SPEED', 'hive_security_authorization': 'None', 'hive_timeline_logging_enabled': 'true', 'hive_txn_acid': 'off', }, }, 'hive-site': {'properties': {'hive.server2.enable.doAs': 'true', 'hive.server2.tez.default.queues': 'queue1,queue2', 'hive.server2.tez.initialize.default.sessions': 'false', 'hive.server2.tez.sessions.per.default.queue': '1', 'hive.auto.convert.join.noconditionaltask.size': '214748364', 'hive.compactor.initiator.on': 'false', 'hive.compactor.worker.threads': '0', 'hive.compute.query.using.stats': 'true', 'hive.enforce.bucketing': 'false', 'hive.exec.dynamic.partition.mode': 'strict', 'hive.exec.failure.hooks': 'org.apache.hadoop.hive.ql.hooks.ATSHook', 'hive.exec.orc.compression.strategy': 'SPEED', 'hive.exec.orc.default.compress': 'ZLIB', 'hive.exec.orc.default.stripe.size': '67108864', 'hive.exec.orc.encoding.strategy': 'SPEED', 'hive.exec.post.hooks': 'org.apache.hadoop.hive.ql.hooks.ATSHook', 'hive.exec.pre.hooks': 'org.apache.hadoop.hive.ql.hooks.ATSHook', 'hive.exec.reducers.bytes.per.reducer': '67108864', 'hive.execution.engine': 'mr', 'hive.optimize.index.filter': 'true', 'hive.optimize.sort.dynamic.partition': 'false', 'hive.prewarm.enabled': 'false', 'hive.prewarm.numcontainers': '3', 'hive.security.authorization.enabled': 'false', 'hive.server2.use.SSL': 'false', 'hive.stats.fetch.column.stats': 'true', 'hive.stats.fetch.partition.stats': 'true', 'hive.support.concurrency': 'false', 'hive.tez.auto.reducer.parallelism': 'true', 'hive.tez.container.size': '768', 'hive.tez.dynamic.partition.pruning': 'true', 'hive.tez.java.opts': '-server -Xmx615m -Djava.net.preferIPv4Stack=true -XX:NewRatio=8 -XX:+UseNUMA -XX:+UseParallelGC -XX:+PrintGCDetails -verbose:gc -XX:+PrintGCTimeStamps', 'hive.txn.manager': 'org.apache.hadoop.hive.ql.lockmgr.DummyTxnManager', 'hive.vectorized.execution.enabled': 'true', 'hive.vectorized.execution.reduce.enabled': 'false', 'hive.security.metastore.authorization.manager': 'org.apache.hadoop.hive.ql.security.authorization.StorageBasedAuthorizationProvider', 'hive.security.authorization.manager': 'org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.SQLStdConfOnlyAuthorizerFactory', }, 'property_attributes': {'hive.auto.convert.join.noconditionaltask.size': {'maximum': '644245094', }, 'hive.tez.container.size': {'maximum': '8192', 'minimum': '256', }, 'hive.server2.authentication.pam.services': {'delete': 'true', }, 'hive.server2.custom.authentication.class': {'delete': 'true', }, 'hive.server2.authentication.kerberos.principal': {'delete': 'true', }, 'hive.server2.authentication.kerberos.keytab': {'delete': 'true', }, 'hive.server2.authentication.ldap.url': {'delete': 'true', }, 'hive.server2.tez.default.queues': {'entries': [{'value': 'queue1', 'label': 'queue1 queue', }, {'value': 'queue2', 'label': 'queue2 queue', }], }, }, }, 'hiveserver2-site': {'properties': {}, 'property_attributes': {'hive.security.authorization.manager': {'delete': 'true', }, 'hive.security.authenticator.manager': {'delete': 'true', }, 'hive.conf.restricted.list': {'delete': 'true', }, }, }, 'webhcat-site': {'properties': {'templeton.hadoop.queue.name': 'queue1', }, }, }
    services = {'services': [{'href': '/api/v1/stacks/HDP/versions/2.2/services/YARN', 'StackServices': {'service_name': 'YARN', 'service_version': '2.6.0.2.2', 'stack_name': 'HDP', 'stack_version': '2.2', }, 'components': [{'StackServiceComponents': {'advertise_version': 'false', 'cardinality': '1', 'component_category': 'MASTER', 'component_name': 'APP_TIMELINE_SERVER', 'display_name': 'App Timeline Server', 'is_client': 'false', 'is_master': 'true', 'hostnames': [], }, 'dependencies': [], }, {'StackServiceComponents': {'advertise_version': 'true', 'cardinality': '1+', 'component_category': 'SLAVE', 'component_name': 'NODEMANAGER', 'display_name': 'NodeManager', 'is_client': 'false', 'is_master': 'false', 'hostnames': ['c6403.ambari.apache.org'], }, 'dependencies': [], }, {'StackServiceComponents': {'advertise_version': 'true', 'cardinality': '1-2', 'component_category': 'MASTER', 'component_name': 'RESOURCEMANAGER', 'display_name': 'ResourceManager', 'is_client': 'false', 'is_master': 'true', 'hostnames': [], }, 'dependencies': [], }, {'StackServiceComponents': {'advertise_version': 'true', 'cardinality': '1+', 'component_category': 'CLIENT', 'component_name': 'YARN_CLIENT', 'display_name': 'YARN Client', 'is_client': 'true', 'is_master': 'false', 'hostnames': [], }, 'dependencies': [], }], }], 'configurations': {'capacity-scheduler': {'properties': {'yarn.scheduler.capacity.root.queues': 'queue1,queue2', }, }, 'hive-env': {'properties': {}, }, 'hive-site': {'properties': {'hive.server2.authentication': 'none', 'hive.server2.authentication.ldap.url': '', 'hive.server2.authentication.ldap.baseDN': '', 'hive.server2.authentication.kerberos.keytab': '', 'hive.server2.authentication.kerberos.principal': '', 'hive.server2.authentication.pam.services': '', 'hive.server2.custom.authentication.class': '', 'hive.cbo.enable': 'true', }, }, 'hiveserver2-site': {'properties': {'hive.security.authorization.manager': '', 'hive.security.authenticator.manager': '', 'hive.conf.restricted.list': '', }, }, }, 'changed-configurations': [], }
    hiveService = {'services': [{'href': '/api/v1/stacks/HDP/versions/2.2/services/HIVE', 'StackServices': {'service_name': 'HIVE', 'service_version': '2.6.0.2.2', 'stack_name': 'HDP', 'stack_version': '2.2', }, 'components': [{'StackServiceComponents': {'advertise_version': 'false', 'cardinality': '1', 'component_category': 'MASTER', 'component_name': 'HIVE_SERVER', 'display_name': 'HiveServer2', 'is_client': 'false', 'is_master': 'true', 'hostnames': ['c6402.ambari.apache.org'], }, 'dependencies': [], }, {'StackServiceComponents': {'advertise_version': 'true', 'cardinality': '1+', 'component_category': 'SLAVE', 'component_name': 'HIVE_CLIENT', 'display_name': 'Hive Client', 'is_client': 'true', 'is_master': 'false', 'hostnames': ['c6402.ambari.apache.org', 'c6403.ambari.apache.org'], }, 'dependencies': [], }], }], 'configurations': {'hive-env': {'properties': {'hive.heapsize': '200', 'hive.metastore.heapsize': '200', 'hive.client.heapsize': '200', }, }, 'hive-site': {'properties': {'hive.server2.authentication': 'none', 'hive.server2.authentication.ldap.url': '', 'hive.server2.authentication.ldap.baseDN': '', 'hive.server2.authentication.kerberos.keytab': '', 'hive.server2.authentication.kerberos.principal': '', 'hive.server2.authentication.pam.services': '', 'hive.server2.custom.authentication.class': '', 'hive.cbo.enable': 'true', }, }, 'hiveserver2-site': {'properties': {'hive.security.authorization.manager': '', 'hive.security.authenticator.manager': '', 'hive.conf.restricted.list': '', }, }, }, 'changed-configurations': [], }
    hosts = {'items': [{'href': '/api/v1/hosts/c6401.ambari.apache.org', 'Hosts': {'cpu_count': 1, 'host_name': 'c6401.ambari.apache.org', 'os_arch': 'x86_64', 'os_type': 'centos6', 'ph_cpu_count': 1, 'public_host_name': 'c6401.ambari.apache.org', 'rack_info': '/default-rack', 'total_mem': 1922680, }, }, {'href': '/api/v1/hosts/c6402.ambari.apache.org', 'Hosts': {'cpu_count': 1, 'host_name': 'c6402.ambari.apache.org', 'os_arch': 'x86_64', 'os_type': 'centos6', 'ph_cpu_count': 1, 'public_host_name': 'c6402.ambari.apache.org', 'rack_info': '/default-rack', 'total_mem': 1922680, }, }, {'href': '/api/v1/hosts/c6403.ambari.apache.org', 'Hosts': {'cpu_count': 1, 'host_name': 'c6403.ambari.apache.org', 'os_arch': 'x86_64', 'os_type': 'centos6', 'ph_cpu_count': 1, 'public_host_name': 'c6403.ambari.apache.org', 'rack_info': '/default-rack', 'total_mem': 1922680, }, }], }
    self.stackAdvisor.recommendHIVEConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)
    services['configurations']['hive-site']['properties']['hive.cbo.enable'] = 'false'
    services['configurations']['hive-env']['properties']['hive_security_authorization'] = 'sqlstdauth'
    services['changed-configurations'] = [{'type': 'hive-env', 'name': 'hive_security_authorization', }]
    expected['hive-env']['properties']['hive_security_authorization'] = 'sqlstdauth'
    expected['hive-site']['properties']['hive.stats.fetch.partition.stats'] = 'false'
    expected['hive-site']['properties']['hive.stats.fetch.column.stats'] = 'false'
    expected['hive-site']['properties']['hive.security.authorization.enabled'] = 'true'
    expected['hive-site']['properties']['hive.server2.enable.doAs'] = 'false'
    expected['hive-site']['properties']['hive.security.metastore.authorization.manager'] = 'org.apache.hadoop.hive.ql.security.authorization.StorageBasedAuthorizationProvider,org.apache.hadoop.hive.ql.security.authorization.MetaStoreAuthzAPIAuthorizerEmbedOnly'
    expected['hiveserver2-site']['properties']['hive.security.authorization.enabled'] = 'true'
    expected['hiveserver2-site']['properties']['hive.security.authorization.manager'] = 'org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.SQLStdHiveAuthorizerFactory'
    expected['hiveserver2-site']['properties']['hive.security.authenticator.manager'] = 'org.apache.hadoop.hive.ql.security.SessionStateUserAuthenticator'
    expected['hiveserver2-site']['properties']['hive.conf.restricted.list'] = 'hive.security.authenticator.manager,hive.security.authorization.manager,hive.users.in.admin.role'
    self.stackAdvisor.recommendHIVEConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)
    services['configurations']['hive-env']['properties']['hive_security_authorization'] = 'none'
    expected['hive-env']['properties']['hive_security_authorization'] = 'none'
    expected['hive-site']['properties']['hive.security.authorization.enabled'] = 'false'
    expected['hive-site']['properties']['hive.server2.enable.doAs'] = 'true'
    expected['hive-site']['properties']['hive.security.metastore.authorization.manager'] = 'org.apache.hadoop.hive.ql.security.authorization.StorageBasedAuthorizationProvider'
    self.stackAdvisor.recommendHIVEConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)
    services['configurations']['capacity-scheduler']['properties'] = {'capacity-scheduler': 'yarn.scheduler.capacity.maximum-am-resource-percent=0.2\nyarn.scheduler.capacity.maximum-applications=10000\nyarn.scheduler.capacity.node-locality-delay=40\nyarn.scheduler.capacity.queue-mappings-override.enable=false\nyarn.scheduler.capacity.resource-calculator=org.apache.hadoop.yarn.util.resource.DefaultResourceCalculator\nyarn.scheduler.capacity.root.accessible-node-labels=*\nyarn.scheduler.capacity.root.acl_administer_queue=*\nyarn.scheduler.capacity.root.capacity=100\nyarn.scheduler.capacity.root.default.a.a1.acl_administer_queue=*\nyarn.scheduler.capacity.root.default.a.a1.acl_submit_applications=*\nyarn.scheduler.capacity.root.default.a.a1.capacity=75\nyarn.scheduler.capacity.root.default.a.a1.maximum-capacity=100\nyarn.scheduler.capacity.root.default.a.a1.minimum-user-limit-percent=100\nyarn.scheduler.capacity.root.default.a.a1.ordering-policy=fifo\nyarn.scheduler.capacity.root.default.a.a1.state=RUNNING\nyarn.scheduler.capacity.root.default.a.a1.user-limit-factor=1\nyarn.scheduler.capacity.root.default.a.a2.acl_administer_queue=*\nyarn.scheduler.capacity.root.default.a.a2.acl_submit_applications=*\nyarn.scheduler.capacity.root.default.a.a2.capacity=25\nyarn.scheduler.capacity.root.default.a.a2.maximum-capacity=25\nyarn.scheduler.capacity.root.default.a.a2.minimum-user-limit-percent=100\nyarn.scheduler.capacity.root.default.a.a2.ordering-policy=fifo\nyarn.scheduler.capacity.root.default.a.a2.state=RUNNING\nyarn.scheduler.capacity.root.default.a.a2.user-limit-factor=1\nyarn.scheduler.capacity.root.default.a.acl_administer_queue=*\nyarn.scheduler.capacity.root.default.a.acl_submit_applications=*\nyarn.scheduler.capacity.root.default.a.capacity=50\nyarn.scheduler.capacity.root.default.a.maximum-capacity=100\nyarn.scheduler.capacity.root.default.a.minimum-user-limit-percent=100\nyarn.scheduler.capacity.root.default.a.ordering-policy=fifo\nyarn.scheduler.capacity.root.default.a.queues=a1,a2\nyarn.scheduler.capacity.root.default.a.state=RUNNING\nyarn.scheduler.capacity.root.default.a.user-limit-factor=1\nyarn.scheduler.capacity.root.default.acl_submit_applications=*\nyarn.scheduler.capacity.root.default.b.acl_administer_queue=*\nyarn.scheduler.capacity.root.default.b.acl_submit_applications=*\nyarn.scheduler.capacity.root.default.b.capacity=50\nyarn.scheduler.capacity.root.default.b.maximum-capacity=50\nyarn.scheduler.capacity.root.default.b.minimum-user-limit-percent=100\nyarn.scheduler.capacity.root.default.b.ordering-policy=fifo\nyarn.scheduler.capacity.root.default.b.state=RUNNING\nyarn.scheduler.capacity.root.default.b.user-limit-factor=1\nyarn.scheduler.capacity.root.default.capacity=100\nyarn.scheduler.capacity.root.default.maximum-capacity=100\nyarn.scheduler.capacity.root.default.queues=a,b\nyarn.scheduler.capacity.root.default.state=RUNNING\nyarn.scheduler.capacity.root.default.user-limit-factor=1\nyarn.scheduler.capacity.root.queues=default', }
    expected['hive-site']['properties']['hive.server2.tez.default.queues'] = 'a1,a2,b'
    expected['hive-site']['property_attributes']['hive.server2.tez.default.queues'] = {'entries': [{'value': 'a1', 'label': 'a1 queue', }, {'value': 'a2', 'label': 'a2 queue', }, {'value': 'b', 'label': 'b queue', }], }
    self.stackAdvisor.recommendHIVEConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations['hive-site']['property_attributes']['hive.server2.tez.default.queues'], expected['hive-site']['property_attributes']['hive.server2.tez.default.queues'])
    self.assertEquals(configurations['hive-site']['properties']['hive.server2.tez.default.queues'], expected['hive-site']['properties']['hive.server2.tez.default.queues'])
    self.stackAdvisor.recommendHIVEConfigurations(configurations, clusterData, hiveService, hosts)
    self.assertEquals(configurations['hive-env']['properties']['hive.metastore.heapsize'], '512')
    self.assertEquals(configurations['hive-env']['properties']['hive.heapsize'], '703')
    self.assertEquals(configurations['hive-env']['properties']['hive.client.heapsize'], '1024')
    self.assertEquals(configurations['hive-env']['property_attributes']['hive.heapsize']['maximum'], '1877')
    self.assertEquals(configurations['hive-env']['property_attributes']['hive.metastore.heapsize']['maximum'], '1877')
    self.assertEquals(configurations['hive-env']['property_attributes']['hive.client.heapsize']['maximum'], '1877')
    services['configurations']['hive-env']['properties']['hive_security_authorization'] = 'ranger'
    expected['hiveserver2-site']['properties']['hive.security.authenticator.manager'] = 'org.apache.hadoop.hive.ql.security.SessionStateUserAuthenticator'
    expected['hiveserver2-site']['properties']['hive.security.authorization.manager'] = 'com.xasecure.authorization.hive.authorizer.XaSecureHiveAuthorizerFactory'
    expected['hiveserver2-site']['properties']['hive.security.authorization.enabled'] = 'true'
    expected['hiveserver2-site']['properties']['hive.conf.restricted.list'] = 'hive.security.authorization.enabled,hive.security.authorization.manager,hive.security.authenticator.manager'
    self.stackAdvisor.recommendHIVEConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations['hiveserver2-site'], expected['hiveserver2-site'])

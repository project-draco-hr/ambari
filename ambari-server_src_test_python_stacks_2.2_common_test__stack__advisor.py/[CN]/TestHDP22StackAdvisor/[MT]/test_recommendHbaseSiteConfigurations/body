def test_recommendHbaseSiteConfigurations(self):
    servicesList = ['HBASE']
    configurations = {}
    components = []
    hosts = {'items': [{'Hosts': {'cpu_count': 6, 'total_mem': 50331648, 'disk_info': [{'mountpoint': '/', }, {'mountpoint': '/dev/shm', }, {'mountpoint': '/vagrant', }, {'mountpoint': '/', }, {'mountpoint': '/dev/shm', }, {'mountpoint': '/vagrant', }], }, }], }
    services = {'services': [], 'configurations': {'hbase-env': {'properties': {'phoenix_sql_enabled': 'true', }, }, }, }
    expected = {'hbase-site': {'properties': {'hbase.regionserver.wal.codec': 'org.apache.hadoop.hbase.regionserver.wal.IndexedWALEditCodec', 'hbase.regionserver.rpc.scheduler.factory.class': 'org.apache.hadoop.hbase.ipc.PhoenixRpcSchedulerFactory', 'hbase.rpc.controllerfactory.class': 'org.apache.hadoop.hbase.ipc.controller.ServerRpcControllerFactory', 'hbase.bucketcache.size': '', 'hbase.bucketcache.percentage.in.combinedcache': '', 'hbase.regionserver.global.memstore.upperLimit': '0.4', 'hbase.bucketcache.ioengine': '', }, }, 'hbase-env': {'properties': {'hbase_master_heapsize': '8192', 'hbase_regionserver_heapsize': '8192', 'hbase_max_direct_memory_size': '', }, }, }
    clusterData = self.stackAdvisor.getConfigurationClusterSummary(servicesList, hosts, components, None)
    self.assertEquals(clusterData['hbaseRam'], 8)
    self.stackAdvisor.recommendHBASEConfigurations(configurations, clusterData, services, None)
    self.assertEquals(configurations, expected)
    services['configurations']['hbase-env']['properties']['phoenix_sql_enabled'] = 'false'
    expected['hbase-site']['properties']['hbase.regionserver.wal.codec'] = 'org.apache.hadoop.hbase.regionserver.wal.WALCellCodec'
    expected['hbase-site']['property_attributes'] = {'hbase.regionserver.rpc.scheduler.factory.class': {'delete': 'true', }, 'hbase.rpc.controllerfactory.class': {'delete': 'true', }, }
    self.stackAdvisor.recommendHBASEConfigurations(configurations, clusterData, services, None)
    self.assertEquals(configurations, expected)
    hosts['items'][0]['Hosts']['host_name'] = 'host1'
    services['services'].append({'StackServices': {'service_name': 'HBASE', 'service_version': '2.6.0.2.2', }, 'components': [{'href': '/api/v1/stacks/HDP/versions/2.2/services/HBASE/components/HBASE_MASTER', 'StackServiceComponents': {'advertise_version': 'true', 'cardinality': '1+', 'component_name': 'HBASE_MASTER', 'custom_commands': [], 'display_name': 'DataNode', 'is_client': 'false', 'is_master': 'false', 'service_name': 'HBASE', 'stack_name': 'HDP', 'stack_version': '2.2', 'hostnames': ['host1'], }, 'dependencies': [], }], })
    services['configurations']['hbase-env']['properties']['phoenix_sql_enabled'] = 'false'
    expected['hbase-site']['properties']['hbase.regionserver.wal.codec'] = 'org.apache.hadoop.hbase.regionserver.wal.WALCellCodec'
    expected['hbase-site']['property_attributes'] = {'hbase.regionserver.rpc.scheduler.factory.class': {'delete': 'true', }, 'hbase.rpc.controllerfactory.class': {'delete': 'true', }, }
    expected['hbase-env']['property_attributes'] = {'hbase_master_heapsize': {'maximum': '49152', }, }
    self.stackAdvisor.recommendHBASEConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, expected)

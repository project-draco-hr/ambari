def test_command_in_progress(self):
    config = AmbariConfig().getConfig()
    tmpfile = tempfile.gettempdir()
    config.set('agent', 'prefix', tmpfile)
    actionQueue = ActionQueue(config)
    actionQueue.IDLE_SLEEP_TIME = 0.01
    executor_started_event = threading.Event()
    end_executor_event = threading.Event()
    actionQueue.executor = FakeExecutor(executor_started_event, end_executor_event)
    before_start_result = actionQueue.result()
    command = {'commandId': 17, 'role': 'role', 'taskId': 'taskId', 'clusterName': 'clusterName', 'serviceName': 'serviceName', 'status': 'IN_PROGRESS', 'hostname': 'localhost.localdomain', 'hostLevelParams': 'hostLevelParams', 'clusterHostInfo': 'clusterHostInfo', 'roleCommand': 'roleCommand', 'configurations': 'configurations', 'commandType': 'EXECUTION_COMMAND', 'configurations': {'global': {}, }, }
    actionQueue.put(command)
    actionQueue.start()
    executor_started_event.wait()
    in_progress_result = actionQueue.result()
    end_executor_event.set()
    actionQueue.stop()
    actionQueue.join()
    after_start_result = actionQueue.result()
    self.assertEquals(len(before_start_result['componentStatus']), 0)
    self.assertEquals(len(before_start_result['reports']), 0)
    self.assertEquals(len(in_progress_result['componentStatus']), 0)
    self.assertEquals(len(in_progress_result['reports']), 1)
    self.assertEquals(in_progress_result['reports'][0]['status'], 'IN_PROGRESS')
    self.assertEquals(in_progress_result['reports'][0]['stdout'], 'Dummy output')
    self.assertEquals(in_progress_result['reports'][0]['exitCode'], 777)
    self.assertEquals(in_progress_result['reports'][0]['stderr'], 'Dummy err')
    self.assertEquals(len(after_start_result['componentStatus']), 0)
    self.assertEquals(len(after_start_result['reports']), 1)
    self.assertEquals(after_start_result['reports'][0]['status'], 'COMPLETED')
    self.assertEquals(after_start_result['reports'][0]['stdout'], 'returned stdout')
    self.assertEquals(after_start_result['reports'][0]['exitCode'], 0)
    self.assertEquals(after_start_result['reports'][0]['stderr'], 'returned stderr')

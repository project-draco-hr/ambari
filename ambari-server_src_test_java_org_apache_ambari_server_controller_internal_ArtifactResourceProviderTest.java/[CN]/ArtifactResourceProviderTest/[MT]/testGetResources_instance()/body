{
  Set<String> propertyIds=new HashSet<String>();
  TreeMap<String,String> foreignKeys=new TreeMap<String,String>();
  foreignKeys.put("cluster","500");
  Map<String,Object> artifact_data=Collections.<String,Object>singletonMap("foo","bar");
  Map<String,String> responseForeignKeys=new HashMap<String,String>();
  responseForeignKeys.put("cluster","500");
  expect(controller.getClusters()).andReturn(clusters).anyTimes();
  expect(clusters.getCluster("test-cluster")).andReturn(cluster).anyTimes();
  expect(clusters.getClusterById(500L)).andReturn(cluster).anyTimes();
  expect(cluster.getClusterId()).andReturn(500L).anyTimes();
  expect(cluster.getClusterName()).andReturn("test-cluster").anyTimes();
  expect(request.getPropertyIds()).andReturn(propertyIds).anyTimes();
  expect(dao.findByNameAndForeignKeys(eq("test-artifact"),eq(foreignKeys))).andReturn(entity).once();
  expect(entity.getArtifactName()).andReturn("test-artifact").anyTimes();
  expect(entity.getForeignKeys()).andReturn(responseForeignKeys).anyTimes();
  expect(entity.getArtifactData()).andReturn(artifact_data).anyTimes();
  replay(dao,em,controller,request,clusters,cluster,entity,entity2);
  PredicateBuilder pb=new PredicateBuilder();
  Predicate predicate=pb.begin().property("Artifacts/cluster_name").equals("test-cluster").and().property("Artifacts/artifact_name").equals("test-artifact").end().toPredicate();
  Set<Resource> response=resourceProvider.getResources(request,predicate);
  assertEquals(1,response.size());
  Resource resource=response.iterator().next();
  assertEquals("test-artifact",resource.getPropertyValue("Artifacts/artifact_name"));
  assertEquals("test-cluster",resource.getPropertyValue("Artifacts/cluster_name"));
  assertEquals("bar",resource.getPropertyValue("artifact_data/foo"));
}

@patch('mm_wrapper.check_output')
@patch.dict(os.environ, {'NAGIOS_HOSTNAME': 'h2', }, clear=True)
def test_work_in_legacy_check_wrapper_mode(self, check_output_mock):
    command_line = ['prog', '-opt', 'yet', 'another', 'opt']
    ignored_hosts = []
    custom_env = {'MM_HOSTS': ignored_hosts, }
    ignored_hosts = []
    check_output_mock.return_value = 'Dummy message'
    result = mm_wrapper.work_in_legacy_check_wrapper_mode(ignored_hosts, command_line, custom_env)
    self.assertEquals(str(result), "{'message': 'Dummy message', 'real_retcode': None, 'retcode': 0}")
    self.assertEquals(check_output_mock.call_count, 1)
    self.assertEquals(check_output_mock.call_args[1]['env']['MM_HOSTS'], ignored_hosts)
    self.assertEquals(check_output_mock.call_args[0][0], ['prog', '-opt', 'yet', 'another', 'opt'])
    check_output_mock.reset_mock()
    ignored_hosts = ['h3']
    check_output_mock.side_effect = [subprocess.CalledProcessError(1, 'dummy cmd', output='dummy output1')]
    result = mm_wrapper.work_in_legacy_check_wrapper_mode(ignored_hosts, command_line, custom_env)
    self.assertEquals(check_output_mock.call_count, 1)
    self.assertEquals(str(result), "{'message': 'dummy output1', 'real_retcode': None, 'retcode': 1}")
    check_output_mock.reset_mock()
    ignored_hosts = ['h2']
    check_output_mock.side_effect = [subprocess.CalledProcessError(1, 'dummy cmd', output='dummy output1')]
    result = mm_wrapper.work_in_legacy_check_wrapper_mode(ignored_hosts, command_line, custom_env)
    self.assertEquals(check_output_mock.call_count, 1)
    self.assertEquals(str(result), "{'message': 'dummy output1', 'real_retcode': 1, 'retcode': 0}")
    check_output_mock.reset_mock()

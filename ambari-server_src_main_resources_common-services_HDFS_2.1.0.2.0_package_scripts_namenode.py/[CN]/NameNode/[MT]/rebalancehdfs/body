def rebalancehdfs(self, env):
    import params
    env.set_params(params)
    name_node_parameters = json.loads(params.name_node_params)
    threshold = name_node_parameters['threshold']
    _print(('Starting balancer with threshold = %s\n' % threshold))
    if params.security_enabled:
        Execute(format('{kinit_path_local} -kt {hdfs_user_keytab} {hdfs_principal_name}'), user=params.hdfs_user)

    def calculateCompletePercent(first, current):
        return (1.0 - (current.bytesLeftToMove / first.bytesLeftToMove))

    def startRebalancingProcess(threshold):
        rebalanceCommand = format('hdfs --config {hadoop_conf_dir} balancer -threshold {threshold}')
        return as_user(rebalanceCommand, params.hdfs_user, env={'PATH': params.hadoop_bin_dir, })
    command = startRebalancingProcess(threshold)
    basedir = os.path.join(env.config.basedir, 'scripts')
    if (threshold == 'DEBUG'):
        basedir = os.path.join(env.config.basedir, 'scripts', 'balancer-emulator')
        command = ['python', 'hdfs-command.py']
    _print(('Executing command %s\n' % command))
    parser = hdfs_rebalance.HdfsParser()

    def handle_new_line(line):
        _print(('[balancer] %s' % line))
        pl = parser.parseLine(line)
        if pl:
            res = pl.toJson()
            res['completePercent'] = calculateCompletePercent(parser.initialLine, pl)
            self.put_structured_out(res)
        elif (parser.state == 'PROCESS_FINISED'):
            _print(('[balancer] %s' % 'Process is finished'))
            self.put_structured_out({'completePercent': 1, })
            return
    Execute(command, on_new_line=handle_new_line, logoutput=False)

{
  AmbariManagementController managementController=createMock(AmbariManagementController.class);
  Clusters clusters=createNiceMock(Clusters.class);
  Cluster cluster=createNiceMock(Cluster.class);
  AmbariMetaInfo ambariMetaInfo=createNiceMock(AmbariMetaInfo.class);
  StackId stackId=createNiceMock(StackId.class);
  ComponentInfo componentInfo=createStrictMock(ComponentInfo.class);
  ServiceComponentHostResponse shr1=new ServiceComponentHostResponse("C1","YARN","RESOURCEMANAGER","Host100","INSTALLED","",null,null,null);
  shr1.setMaintenanceState(MaintenanceState.ON.toString());
  ServiceComponentHostResponse shr2=new ServiceComponentHostResponse("C1","YARN","RESOURCEMANAGER","Host101","INSTALLED","",null,null,null);
  shr2.setMaintenanceState(MaintenanceState.ON.toString());
  ServiceComponentHostResponse shr3=new ServiceComponentHostResponse("C1","YARN","NODEMANAGER","Host100","STARTED","",null,null,null);
  shr3.setMaintenanceState(MaintenanceState.ON.toString());
  ServiceComponentHostResponse shr4=new ServiceComponentHostResponse("C1","YARN","YARN_CLIENT","Host100","INSTALLED","",null,null,null);
  shr4.setMaintenanceState(MaintenanceState.ON.toString());
  Set<ServiceComponentHostResponse> responses=new LinkedHashSet<ServiceComponentHostResponse>();
  responses.add(shr1);
  responses.add(shr2);
  responses.add(shr3);
  responses.add(shr4);
  expect(managementController.getAmbariMetaInfo()).andReturn(ambariMetaInfo).anyTimes();
  expect(managementController.getClusters()).andReturn(clusters).anyTimes();
  expect(clusters.getCluster("C1")).andReturn(cluster).anyTimes();
  expect(managementController.getHostComponents((Set<ServiceComponentHostRequest>)anyObject())).andReturn(responses).anyTimes();
  expect(cluster.getDesiredStackVersion()).andReturn(stackId).anyTimes();
  expect(stackId.getStackName()).andReturn("S1").anyTimes();
  expect(stackId.getStackVersion()).andReturn("V1").anyTimes();
  expect(ambariMetaInfo.getComponent((String)anyObject(),(String)anyObject(),(String)anyObject(),(String)anyObject())).andReturn(componentInfo).anyTimes();
  expect(componentInfo.isClient()).andReturn(false);
  expect(componentInfo.isMaster()).andReturn(true);
  expect(componentInfo.isClient()).andReturn(false);
  expect(componentInfo.isMaster()).andReturn(true);
  expect(componentInfo.isClient()).andReturn(false);
  expect(componentInfo.isMaster()).andReturn(false);
  expect(componentInfo.isClient()).andReturn(false);
  expect(componentInfo.isClient()).andReturn(true);
  expect(componentInfo.isMaster()).andReturn(false);
  expect(componentInfo.isClient()).andReturn(true).times(2);
  replay(managementController,clusters,cluster,ambariMetaInfo,stackId,componentInfo);
  ServiceResourceProvider.ServiceState serviceState=new ServiceResourceProvider.DefaultServiceState();
  State state=serviceState.getState(managementController,"C1","YARN");
  Assert.assertEquals(State.STARTED,state);
  reset(componentInfo);
  responses.clear();
  shr1=new ServiceComponentHostResponse("C1","YARN","RESOURCEMANAGER","Host100","INSTALLED","",null,null,null);
  shr1.setMaintenanceState(MaintenanceState.ON.toString());
  shr2=new ServiceComponentHostResponse("C1","YARN","RESOURCEMANAGER","Host101","INSTALLED","",null,null,null);
  shr2.setMaintenanceState(MaintenanceState.ON.toString());
  shr3=new ServiceComponentHostResponse("C1","YARN","NODEMANAGER","Host100","INSTALLED","",null,null,null);
  shr3.setMaintenanceState(MaintenanceState.ON.toString());
  shr4=new ServiceComponentHostResponse("C1","YARN","YARN_CLIENT","Host100","INSTALLED","",null,null,null);
  shr4.setMaintenanceState(MaintenanceState.ON.toString());
  responses.add(shr1);
  responses.add(shr2);
  responses.add(shr3);
  responses.add(shr4);
  expect(componentInfo.isClient()).andReturn(false);
  expect(componentInfo.isMaster()).andReturn(true);
  expect(componentInfo.isClient()).andReturn(false);
  expect(componentInfo.isMaster()).andReturn(true);
  expect(componentInfo.isClient()).andReturn(false);
  expect(componentInfo.isMaster()).andReturn(false);
  expect(componentInfo.isClient()).andReturn(false);
  expect(componentInfo.isClient()).andReturn(true);
  expect(componentInfo.isMaster()).andReturn(false);
  expect(componentInfo.isClient()).andReturn(true).times(2);
  replay(componentInfo);
  state=serviceState.getState(managementController,"C1","YARN");
  Assert.assertEquals(State.INSTALLED,state);
}

{
  Collection<HostRoleStatus> stageStatuses=new HashSet<HostRoleStatus>();
  Collection<HostRoleStatus> taskStatuses=new ArrayList<HostRoleStatus>();
  HostRoleStatus displayStatus=null;
  for (  Long stageId : stageIds) {
    if (!stageDto.containsKey(stageId)) {
      continue;
    }
    HostRoleCommandStatusSummaryDTO summary=stageDto.get(stageId);
    int total=summary.getTaskTotal();
    boolean skip=summary.isStageSkippable();
    Map<HostRoleStatus,Integer> counts=calculateStatusCounts(summary.getTaskStatuses());
    HostRoleStatus stageStatus=calculateSummaryStatus(counts,total,skip);
    if (null == displayStatus) {
      displayStatus=stageStatus;
    }
    displayStatus=calculateDisplayStatus(counts,displayStatus);
    stageStatuses.add(stageStatus);
    taskStatuses.addAll(summary.getTaskStatuses());
  }
  HostRoleStatus status=calculateSummaryStatus(calculateStatusCounts(stageStatuses),stageStatuses.size(),false);
  double progressPercent=calculateProgressPercent(calculateStatusCounts(taskStatuses),taskStatuses.size());
  return new CalculatedStatus(status,displayStatus,progressPercent);
}

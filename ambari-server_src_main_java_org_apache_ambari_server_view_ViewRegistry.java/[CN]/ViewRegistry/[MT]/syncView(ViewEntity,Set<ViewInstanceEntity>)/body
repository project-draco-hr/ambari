{
  String viewName=view.getName();
  ViewEntity persistedView=viewDAO.findByName(viewName);
  ResourceTypeEntity resourceType=view.getResourceType();
  if (persistedView == null) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Creating View " + viewName + ".");
    }
    ResourceTypeEntity resourceTypeEntity=resourceTypeDAO.findByName(viewName);
    if (resourceTypeEntity == null) {
      resourceTypeEntity=resourceType;
      resourceTypeDAO.create(resourceTypeEntity);
    }
    for (    ViewInstanceEntity instance : view.getInstances()) {
      instance.setResource(createViewInstanceResource(resourceType));
    }
    persistedView=viewDAO.merge(view);
  }
  Map<String,ViewInstanceEntity> xmlInstanceEntityMap=new HashMap<String,ViewInstanceEntity>();
  for (  ViewInstanceEntity instance : view.getInstances()) {
    xmlInstanceEntityMap.put(instance.getName(),instance);
  }
  view.setResourceType(persistedView.getResourceType());
  view.setPermissions(persistedView.getPermissions());
  for (  ViewInstanceEntity persistedInstance : persistedView.getInstances()) {
    String instanceName=persistedInstance.getName();
    ViewInstanceEntity instance=view.getInstanceDefinition(instanceName);
    xmlInstanceEntityMap.remove(instanceName);
    if (instance == null) {
      if (persistedInstance.isXmlDriven()) {
        instanceDAO.remove(persistedInstance);
      }
 else {
        instanceDAO.merge(persistedInstance);
        bindViewInstance(view,persistedInstance);
        instanceDefinitions.add(persistedInstance);
      }
    }
 else {
      instance.setResource(persistedInstance.getResource());
    }
  }
  for (  ViewInstanceEntity instance : xmlInstanceEntityMap.values()) {
    instance.setResource(createViewInstanceResource(resourceType));
    instanceDAO.merge(instance);
  }
}

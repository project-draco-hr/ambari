{
  ViewInstanceDefinition viewInstanceDefinition=new ViewInstanceDefinition(viewDefinition,instanceConfig);
  List<PropertyConfig> propertyConfigs=instanceConfig.getProperties();
  for (  PropertyConfig propertyConfig : propertyConfigs) {
    viewInstanceDefinition.addProperty(propertyConfig.getKey(),propertyConfig.getValue());
  }
  ViewContext viewInstanceContext=new ViewContextImpl(viewInstanceDefinition);
  ViewExternalSubResourceService externalSubResourceService=new ViewExternalSubResourceService(viewDefinition.getExternalResourceType(),viewInstanceDefinition);
  viewInstanceDefinition.addService(ResourceConfig.EXTERNAL_RESOURCE_PLURAL_NAME,externalSubResourceService);
  Collection<ViewSubResourceDefinition> resourceDefinitions=viewDefinition.getResourceDefinitions().values();
  for (  ViewSubResourceDefinition resourceDefinition : resourceDefinitions) {
    Resource.Type type=resourceDefinition.getType();
    ResourceConfig resourceConfig=resourceDefinition.getResourceConfiguration();
    ViewResourceHandler viewResourceService=new ViewSubResourceService(type,viewDefinition.getName(),instanceConfig.getName());
    Object service=getService(resourceConfig.getServiceClass(cl),viewResourceService,viewInstanceContext);
    if (resourceConfig.isExternal()) {
      externalSubResourceService.addResourceService(resourceConfig.getName(),service);
    }
 else {
      viewInstanceDefinition.addService(viewDefinition.getResourceDefinition(type).getPluralName(),service);
      viewInstanceDefinition.addResourceProvider(type,getProvider(resourceConfig.getProviderClass(cl),viewInstanceContext));
    }
  }
  ViewConfig viewConfig=viewDefinition.getConfiguration();
  Map<String,Class<? extends HttpServlet>> servletPathMap=viewConfig.getServletPathMap(cl);
  Map<String,String> servletURLPatternMap=viewConfig.getServletURLPatternMap();
  for (  Map.Entry<String,Class<? extends HttpServlet>> entry : servletPathMap.entrySet()) {
    HttpServlet servlet=getServlet(entry.getValue(),viewInstanceContext);
    ServletHolder sh=new ServletHolder(servlet);
    String servletName=entry.getKey();
    String pathSpec="/views/" + viewDefinition.getName() + "/"+ viewInstanceDefinition.getName()+ servletURLPatternMap.get(servletName);
    root.addServlet(sh,pathSpec);
    viewInstanceDefinition.addServletMapping(servletName,pathSpec);
    if (configs.getApiAuthentication()) {
      root.addFilter(new FilterHolder(springSecurityFilter),pathSpec,1);
    }
  }
  viewDefinition.addInstanceDefinition(viewInstanceDefinition);
  ViewRegistry.getInstance().addInstanceDefinition(viewDefinition,viewInstanceDefinition);
}

{
  MasterKeyService masterKeyService;
  if (masterKey != null) {
    masterKeyService=new MasterKeyServiceImpl(masterKey);
  }
 else {
    if (isMasterKeyPersisted) {
      if ((masterKeyLocation == null) || masterKeyLocation.isEmpty()) {
        throw new IllegalArgumentException("The master key file location may not be null or empty if the master key is persisted");
      }
      masterKeyService=new MasterKeyServiceImpl(new File(masterKeyLocation));
    }
 else {
      masterKeyService=new MasterKeyServiceImpl();
    }
  }
  if (!masterKeyService.isMasterKeyInitialized()) {
    throw new AmbariException("Master key initialization failed.");
  }
  String storeDir=masterKeyLocation.substring(0,masterKeyLocation.indexOf(Configuration.MASTER_KEY_FILENAME_DEFAULT));
  this.keystoreService=new FileBasedCredentialStoreService(storeDir);
  this.keystoreService.setMasterKeyService(masterKeyService);
}

{
  Set<Resource> keepers=new HashSet<Resource>();
  Map<String,Set<Resource>> resourcesByCluster=new HashMap<String,Set<Resource>>();
  for (  Resource resource : resources) {
    String clusterName=(String)resource.getPropertyValue(clusterNamePropertyId);
    Set<Resource> resourceSet=resourcesByCluster.get(clusterName);
    if (resourceSet == null) {
      resourceSet=new HashSet<Resource>();
      resourcesByCluster.put(clusterName,resourceSet);
    }
    resourceSet.add(resource);
  }
  for (  Map.Entry<String,Set<Resource>> entry : resourcesByCluster.entrySet()) {
    String clusterName=entry.getKey();
    Set<Resource> resourceSet=entry.getValue();
    AbstractPropertyProvider provider=null;
    if (clusterName == null) {
      provider=defaultProvider;
    }
 else {
      PropertyHelper.MetricsVersion version=clusterVersions.get(clusterName);
      if (version != null) {
        provider=providers.get(version);
      }
    }
    if (provider != null) {
      keepers.addAll(provider.populateResources(resourceSet,request,predicate));
    }
  }
  return keepers;
}

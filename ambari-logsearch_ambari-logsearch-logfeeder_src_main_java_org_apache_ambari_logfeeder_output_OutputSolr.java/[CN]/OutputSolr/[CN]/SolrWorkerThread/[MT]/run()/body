{
  LOG.info("SolrWorker thread started");
  long lastDispatchTime=System.currentTimeMillis();
  while (true) {
    long currTimeMS=System.currentTimeMillis();
    OutputData outputData=null;
    try {
      long nextDispatchDuration=maxIntervalMS - (currTimeMS - lastDispatchTime);
      outputData=getOutputData(nextDispatchDuration);
      if (outputData != null) {
        createSolrDocument(outputData);
      }
 else {
        if (isDrain() && outgoingBuffer.size() == 0) {
          break;
        }
      }
      if (localBuffer.size() > 0 && ((outputData == null && isDrain()) || (nextDispatchDuration <= 0 || localBuffer.size() >= maxBufferSize))) {
        try {
          if (isComputeCurrentCollection) {
            addRouterField();
          }
          addToSolr(outputData);
          resetLocalBuffer();
          lastDispatchTime=System.currentTimeMillis();
        }
 catch (        IOException ioException) {
          waitForSolr();
        }
catch (        Throwable serverException) {
          resetLocalBuffer();
          String logMessageKey=this.getClass().getSimpleName() + "_SOLR_UPDATE_EXCEPTION";
          LogFeederUtil.logErrorMessageByInterval(logMessageKey,"Error sending log message to server. " + outputData,serverException,LOG,Level.ERROR);
        }
      }
    }
 catch (    InterruptedException e) {
    }
catch (    Throwable t) {
      String logMessageKey=this.getClass().getSimpleName() + "_SOLR_MAINLOOP_EXCEPTION";
      LogFeederUtil.logErrorMessageByInterval(logMessageKey,"Caught exception in main loop. " + outputData,t,LOG,Level.ERROR);
    }
  }
  closeSolrClient();
  resetLocalBuffer();
  LOG.info("Exiting Solr worker thread. output=" + getShortDescription());
}

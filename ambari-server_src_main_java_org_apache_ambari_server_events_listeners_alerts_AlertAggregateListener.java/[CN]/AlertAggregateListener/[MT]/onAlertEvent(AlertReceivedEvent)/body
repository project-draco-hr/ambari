{
  AlertDefinition aggregateDefinition=m_aggregateMapping.getAggregateDefinition(event.getClusterId(),event.getAlert().getName());
  if (null == aggregateDefinition || null == m_alertsDao) {
    return;
  }
  AggregateSource aggregateSource=(AggregateSource)aggregateDefinition.getSource();
  AlertSummaryDTO summary=m_alertsDao.findAggregateCounts(event.getClusterId(),aggregateSource.getAlertName());
  int okCount=summary.getOkCount();
  int warningCount=summary.getWarningCount();
  int criticalCount=summary.getCriticalCount();
  int unknownCount=summary.getUnknownCount();
  int totalCount=okCount + warningCount + criticalCount+ unknownCount;
  Alert alert=new Alert(aggregateDefinition.getName(),null,aggregateDefinition.getServiceName(),null,null,AlertState.UNKNOWN);
  alert.setLabel(aggregateDefinition.getLabel());
  alert.setTimestamp(System.currentTimeMillis());
  if (0 == totalCount) {
    alert.setText("There are no instances of the aggregated alert.");
  }
 else   if (summary.getUnknownCount() > 0) {
    alert.setText("There are alerts with a state of UNKNOWN.");
  }
 else {
    Reporting reporting=aggregateSource.getReporting();
    int numerator=summary.getCriticalCount() + summary.getWarningCount();
    int denominator=totalCount;
    double value=(double)(numerator) / denominator;
    if (value >= reporting.getCritical().getValue()) {
      alert.setState(AlertState.CRITICAL);
      alert.setText(MessageFormat.format(reporting.getCritical().getText(),denominator,numerator));
    }
 else     if (value >= reporting.getWarning().getValue()) {
      alert.setState(AlertState.WARNING);
      alert.setText(MessageFormat.format(reporting.getWarning().getText(),denominator,numerator));
    }
 else {
      alert.setState(AlertState.OK);
      alert.setText(MessageFormat.format(reporting.getOk().getText(),denominator,numerator));
    }
  }
  AlertReceivedEvent aggEvent=new AlertReceivedEvent(event.getClusterId(),alert);
  m_publisher.publish(aggEvent);
}

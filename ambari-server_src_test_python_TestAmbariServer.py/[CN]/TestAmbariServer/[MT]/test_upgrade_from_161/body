@patch.object(ambari_server, 'write_property')
@patch.object(ambari_server, 'find_properties_file')
@patch.object(ambari_server, 'is_root')
@patch.object(ambari_server, 'get_ambari_version')
@patch.object(ambari_server, 'get_ambari_properties')
def test_upgrade_from_161(self, get_ambari_properties_mock, get_ambari_version_mock, is_root_mock, find_properties_file_mock, write_property_mock):
    args = MagicMock()
    args.dbms = 'postgres'
    is_root_mock.return_value = True
    get_ambari_version_mock.return_value = '1.7.0'
    properties = ambari_server.Properties()
    properties.process_pair(ambari_server.PERSISTENCE_TYPE_PROPERTY, 'local')
    properties.process_pair(ambari_server.JDBC_DATABASE_PROPERTY, 'ambari')
    get_ambari_properties_mock.return_value = properties
    try:
        ambari_server.upgrade(args)
    except FatalException as fe:
        self.fail(('Did not expect failure: ' + str(fe)))
    else:
        self.assertTrue(write_property_mock.called)
    write_property_mock.reset_mock()
    properties = ambari_server.Properties()
    properties.process_pair(ambari_server.PERSISTENCE_TYPE_PROPERTY, 'remote')
    properties.process_pair(ambari_server.JDBC_DATABASE_PROPERTY, 'postgres')
    properties.process_pair('server.jdbc.schema', 'ambari')
    properties.process_pair(ambari_server.JDBC_URL_PROPERTY, 'jdbc:postgresql://c6410.ambari.apache.org:5432/ambari')
    get_ambari_properties_mock.return_value = properties
    try:
        ambari_server.upgrade(args)
    except FatalException as fe:
        self.fail(('Did not expect failure: ' + str(fe)))
    else:
        self.assertTrue(write_property_mock.called)
    write_property_mock.reset_mock()
    properties = ambari_server.Properties()
    properties.process_pair(ambari_server.PERSISTENCE_TYPE_PROPERTY, 'remote')
    properties.process_pair('server.jdbc.schema', 'ambari')
    properties.process_pair(ambari_server.JDBC_URL_PROPERTY, 'jdbc:postgresql://c6410.ambari.apache.org:5432/ambari')
    get_ambari_properties_mock.return_value = properties
    try:
        ambari_server.upgrade(args)
    except FatalException as fe:
        self.fail(('Did not expect failure: ' + str(fe)))
    else:
        self.assertTrue((write_property_mock.call_count == 2))
    write_property_mock.reset_mock()
    properties = ambari_server.Properties()
    properties.process_pair(ambari_server.PERSISTENCE_TYPE_PROPERTY, 'remote')
    properties.process_pair(ambari_server.JDBC_DATABASE_PROPERTY, 'mysql')
    properties.process_pair('server.jdbc.schema', 'ambari')
    properties.process_pair(ambari_server.JDBC_URL_PROPERTY, 'jdbc:mysql://c6409.ambari.apache.org:3306/ambari')
    get_ambari_properties_mock.return_value = properties
    try:
        ambari_server.upgrade(args)
    except FatalException as fe:
        self.fail(('Did not expect failure: ' + str(fe)))
    else:
        self.assertTrue(write_property_mock.called)
    write_property_mock.reset_mock()
    properties = ambari_server.Properties()
    properties.process_pair(ambari_server.PERSISTENCE_TYPE_PROPERTY, 'remote')
    properties.process_pair('server.jdbc.schema', 'ambari')
    properties.process_pair(ambari_server.JDBC_URL_PROPERTY, 'jdbc:mysql://c6409.ambari.apache.org:3306/ambari')
    get_ambari_properties_mock.return_value = properties
    try:
        ambari_server.upgrade(args)
    except FatalException as fe:
        self.fail(('Did not expect failure: ' + str(fe)))
    else:
        self.assertTrue((write_property_mock.call_count == 2))

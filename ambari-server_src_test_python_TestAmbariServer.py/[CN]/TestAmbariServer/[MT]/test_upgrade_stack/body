@patch.object(ambari_server, 'configure_database_username_password')
@patch.object(ambari_server, 'run_os_command')
@patch.object(ambari_server, 'is_root')
@patch.object(ambari_server, 'check_database_name_property')
@patch.object(ambari_server, 'parse_properties_file')
@patch.object(ambari_server, 'get_db_cli_tool')
@patch.object(ambari_server, 'remote_stack_upgrade')
def test_upgrade_stack(self, remote_stack_upgrade_mock, get_db_cli_tool_mock, parse_properties_file_mock, check_database_name_property_mock, is_root_mock, run_os_command_mock, configure_postgres_username_password_mock):
    args = MagicMock()
    args.persistence_type = 'local'
    is_root_mock.return_value = False
    try:
        ambari_server.upgrade_stack(args, 'HDP-2.0')
        self.fail('Should throw exception')
    except FatalException as fe:
        self.assertTrue(('root-level' in fe.reason))
        pass
    is_root_mock.return_value = True
    run_os_command_mock.return_value = (0, '', '')
    check_database_name_property_mock.return_value = 1
    ambari_server.upgrade_stack(args, 'HDP-2.0')
    self.assertTrue(configure_postgres_username_password_mock.called)
    self.assertTrue(run_os_command_mock.called)
    configure_postgres_username_password_mock.reset_mock()
    run_os_command_mock.reset_mock()
    args.persistence_type = 'remote'
    args.database = 'oracle'
    get_db_cli_tool_mock.return_value = 'psql'
    remote_stack_upgrade_mock.return_value = (0, 'test', 'test')
    ambari_server.upgrade_stack(args, 'HDP-2.0')
    self.assertTrue(get_db_cli_tool_mock.called)
    self.assertTrue(remote_stack_upgrade_mock.called)
    self.assertFalse(run_os_command_mock.called)
    get_db_cli_tool_mock.reset_mock()
    remote_stack_upgrade_mock.reset_mock()
    run_os_command_mock.reset_mock()
    args.database = 'mysql'
    get_db_cli_tool_mock.return_value = 'mysql'
    remote_stack_upgrade_mock.return_value = (0, 'test_mysql_stack_upgrade', 'test_mysql_stack_upgrade')
    ambari_server.upgrade_stack(args, 'HDP-2.0')
    self.assertTrue(get_db_cli_tool_mock.called)
    self.assertTrue(remote_stack_upgrade_mock.called)
    self.assertFalse(run_os_command_mock.called)

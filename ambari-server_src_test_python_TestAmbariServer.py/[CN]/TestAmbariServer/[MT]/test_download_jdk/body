@patch('os.stat')
@patch('os.path.isfile')
@patch('os.path.exists')
@patch.object(ambari_server, 'track_jdk')
@patch.object(ambari_server, 'get_YN_input')
@patch.object(ambari_server, 'run_os_command')
@patch.object(ambari_server, 'write_property')
@patch.object(ambari_server, 'remove_property')
@patch.object(ambari_server, 'get_validated_string_input')
@patch.object(ambari_server, 'print_info_msg')
@patch.object(ambari_server, 'get_JAVA_HOME')
@patch.object(ambari_server, 'get_ambari_properties')
@patch('shutil.copyfile')
@patch('sys.exit')
def test_download_jdk(self, exit_mock, copyfile_mock, get_ambari_properties_mock, get_JAVA_HOME_mock, print_info_msg_mock, get_validated_string_input_mock, remove_property_mock, write_property_mock, run_os_command_mock, get_YN_input_mock, track_jdk_mock, path_existsMock, path_isfileMock, statMock):
    args = MagicMock()
    args.java_home = 'somewhere'
    path_existsMock.return_value = False
    get_JAVA_HOME_mock.return_value = False
    get_ambari_properties_mock.return_value = (-1)
    try:
        ambari_server.download_jdk(args)
        self.fail('Should throw exception because of not found ambari.properties')
    except FatalException:
        self.assertTrue(get_ambari_properties_mock.called)
        pass
    p = MagicMock()
    get_ambari_properties_mock.return_value = p
    p.__getitem__.return_value = 'somewhere'
    get_JAVA_HOME_mock.return_value = True
    get_YN_input_mock.return_value = False
    path_existsMock.side_effect = [False, False]
    rcode = ambari_server.download_jdk(args)
    self.assertEqual(0, rcode)
    path_existsMock.side_effect = [True, False, False]
    get_JAVA_HOME_mock.return_value = False
    rcode = ambari_server.download_jdk(args)
    self.assertEqual(0, rcode)
    self.assertTrue(write_property_mock.called)
    self.assertTrue((remove_property_mock.call_count == 2))
    path_existsMock.side_effect = None
    path_existsMock.return_value = False
    p = MagicMock()
    get_ambari_properties_mock.return_value = p
    p.__getitem__.side_effect = KeyError('test exception')
    try:
        ambari_server.download_jdk(args)
        self.fail('Should throw exception')
    except FatalException:
        pass
    p.__getitem__.return_value = 'somewhere'
    p.__getitem__.side_effect = None
    path_existsMock.return_value = False
    get_YN_input_mock.return_value = True
    get_validated_string_input_mock.return_value = '1'
    run_os_command_mock.return_value = (0, 'Wrong out', None)
    try:
        ambari_server.download_jdk(args)
        self.fail('Should throw exception')
    except FatalException:
        pass
    ambari_server.JDK_INSTALL_DIR = os.getcwd()
    run_os_command_mock.return_value = (0, 'Creating jdk-1.2/jreContent-Length: 32000\r\n', None)
    statResult = MagicMock()
    statResult.st_size = 32000
    statMock.return_value = statResult
    rcode = ambari_server.download_jdk(args)
    self.assertEqual(0, rcode)
    p.__getitem__.return_value = 'somewhere'
    p.__getitem__.side_effect = None
    get_YN_input_mock.return_value = False
    ambari_server.download_jdk(MagicMock())
    self.assertTrue(exit_mock.called)
    exit_mock.reset_mock()
    write_property_mock.reset_mock()
    remove_property_mock.reset_mock()
    get_YN_input_mock.reset_mock()
    get_YN_input_mock.return_value = True
    args.jdk_location = '/existing/jdk/jdk-6u31-linux-x64.bin'
    path_existsMock.side_effect = [False, True]
    ambari_server.download_jdk(args)
    self.assertTrue((write_property_mock.call_count == 1))
    self.assertTrue((remove_property_mock.call_count == 2))
    self.assertTrue(copyfile_mock.called)
    copyfile_mock.reset_mock()
    p.__getitem__.return_value = 'somewhere'
    p.__getitem__.side_effect = None
    args.jdk_location = '/existing/jdk/file'
    path_existsMock.side_effect = [False, True]

    def copyfile_side_effect(s, d):
        raise Exception('TerribleException')
    copyfile_mock.side_effect = copyfile_side_effect
    try:
        ambari_server.download_jdk(args)
        self.fail('Should throw exception')
    except FatalException:
        self.assertTrue(copyfile_mock.called)
    copyfile_mock.reset_mock()
    p = MagicMock()
    get_ambari_properties_mock.return_value = p
    p.__getitem__.return_value = 'somewhere'
    get_JAVA_HOME_mock.return_value = True
    get_YN_input_mock.return_value = False
    path_existsMock.side_effect = [False, True]
    with patch.object(ambari_server, 'download_jce_policy') as download_jce_policy_mock:
        rcode = ambari_server.download_jdk(args)
        self.assertFalse(download_jce_policy_mock.called)
    write_property_mock.reset_mock()
    remove_property_mock.reset_mock()
    args.java_home = 'somewhere'
    path_existsMock.return_value = True
    path_existsMock.side_effect = [True, False, False]
    get_JAVA_HOME_mock.return_value = True
    ambari_server.download_jdk(args)
    self.assertTrue((write_property_mock.call_count == 1))
    self.assertTrue((remove_property_mock.call_count == 2))
    write_property_mock.reset_mock()
    args.java_home = 'somewhere'
    path_existsMock.side_effect = None
    path_existsMock.return_value = True
    get_JAVA_HOME_mock.return_value = True
    try:
        ambari_server.download_jdk(args)
        self.fail('Should throw exception')
    except FatalException as fe:
        self.assertFalse(write_property_mock.called)
    write_property_mock.reset_mock()
    remove_property_mock.reset_mock()
    path_existsMock.side_effect = [False, False, True]
    get_validated_string_input_mock.return_value = '3'
    get_JAVA_HOME_mock.return_value = False
    rcode = ambari_server.download_jdk(args)
    self.assertEqual(0, rcode)
    self.assertTrue(write_property_mock.called)
    self.assertTrue((remove_property_mock.call_count == 2))
    write_property_mock.reset_mock()
    remove_property_mock.reset_mock()
    path_existsMock.side_effect = [False, False, False]
    get_validated_string_input_mock.return_value = '3'
    get_JAVA_HOME_mock.return_value = False
    try:
        ambari_server.download_jdk(args)
        self.fail('Should throw exception')
    except FatalException as fe:
        pass

@not_for_platform(PLATFORM_WINDOWS)
@patch.object(OSCheck, 'os_distribution', new=MagicMock(return_value=os_distro_value))
@patch('ambari_server.dbConfiguration.get_ambari_properties')
@patch('ambari_server.dbConfiguration_linux.get_ambari_properties')
@patch('ambari_server.dbConfiguration_linux.print_error_msg')
@patch('ambari_server.dbConfiguration.print_error_msg')
@patch('ambari_server.dbConfiguration_linux.print_warning_msg')
@patch('__builtin__.raw_input')
@patch('glob.glob')
@patch('os.path.isdir')
@patch('os.path.lexists')
@patch('os.remove')
@patch('os.symlink')
@patch('shutil.copy')
def test_ensure_jdbc_drivers_installed(self, shutil_copy_mock, os_symlink_mock, os_remove_mock, lexists_mock, isdir_mock, glob_mock, raw_input_mock, print_warning_msg, print_error_msg_mock, print_error_msg_2_mock, get_ambari_properties_mock, get_ambari_properties_2_mock):
    out = StringIO.StringIO()
    sys.stdout = out

    def reset_mocks():
        get_ambari_properties_mock.reset_mock()
        get_ambari_properties_2_mock.reset_mock()
        shutil_copy_mock.reset_mock()
        print_error_msg_mock.reset_mock()
        print_warning_msg.reset_mock()
        raw_input_mock.reset_mock()
        args = MagicMock()
        del args.database_index
        del args.persistence_type
        del args.silent
        del args.sid_or_sname
        del args.jdbc_url
        args.dbms = 'oracle'
        return args
    drivers_list = [os.path.join(os.sep, 'usr', 'share', 'java', 'ojdbc6.jar')]
    resources_dir = (os.sep + 'tmp')
    props = Properties()
    props.process_pair(RESOURCES_DIR_PROPERTY, resources_dir)
    get_ambari_properties_2_mock.return_value = get_ambari_properties_mock.return_value = props
    factory = DBMSConfigFactory()
    args = reset_mocks()
    glob_mock.return_value = drivers_list
    isdir_mock.return_value = True
    lexists_mock.return_value = True
    dbms = factory.create(args, props)
    rcode = dbms.ensure_jdbc_driver_installed(props)
    self.assertEquals(os_symlink_mock.call_count, 1)
    self.assertEquals(os_symlink_mock.call_args_list[0][0][0], os.path.join(os.sep, 'tmp', 'ojdbc6.jar'))
    self.assertEquals(os_symlink_mock.call_args_list[0][0][1], os.path.join(os.sep, 'tmp', 'oracle-jdbc-driver.jar'))
    self.assertTrue(rcode)
    self.assertEquals(shutil_copy_mock.call_count, 1)
    self.assertEquals(shutil_copy_mock.call_args_list[0][0][0], drivers_list[0])
    self.assertEquals(shutil_copy_mock.call_args_list[0][0][1], resources_dir)
    set_silent(True)
    args = reset_mocks()
    glob_mock.return_value = []
    failed = False
    try:
        dbms = factory.create(args, props)
        rcode = dbms.ensure_jdbc_driver_installed(props)
    except FatalException:
        failed = True
    self.assertTrue(print_error_msg_mock.called)
    self.assertTrue(failed)
    set_silent(False)
    args = reset_mocks()
    glob_mock.return_value = []
    failed = False
    try:
        dbms = factory.create(args, props)
        rcode = dbms.ensure_jdbc_driver_installed(props)
    except FatalException:
        failed = True
    self.assertTrue(failed)
    self.assertTrue(print_error_msg_mock.called)
    args = reset_mocks()
    glob_mock.side_effect = [[], drivers_list, drivers_list]
    dbms = factory.create(args, props)
    rcode = dbms.ensure_jdbc_driver_installed(props)
    self.assertTrue(rcode)
    self.assertEquals(shutil_copy_mock.call_count, 1)
    self.assertEquals(shutil_copy_mock.call_args_list[0][0][0], drivers_list[0])
    self.assertEquals(shutil_copy_mock.call_args_list[0][0][1], resources_dir)
    args = reset_mocks()
    glob_mock.side_effect = [[], []]
    failed = False
    try:
        dbms = factory.create(args, props)
        rcode = dbms.ensure_jdbc_driver_installed(props)
    except FatalException:
        failed = True
    self.assertTrue(failed)
    self.assertTrue(print_error_msg_mock.called)
    args = reset_mocks()
    glob_mock.side_effect = [[], drivers_list, drivers_list]
    try:
        dbms = factory.create(args, props)
        rcode = dbms.ensure_jdbc_driver_installed(props)
    except FatalException:
        failed = True
    self.assertTrue(failed)
    sys.stdout = sys.__stdout__
    pass

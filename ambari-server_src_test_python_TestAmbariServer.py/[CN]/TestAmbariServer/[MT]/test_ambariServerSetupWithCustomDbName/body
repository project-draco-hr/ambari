@patch.object(OSCheck, 'os_distribution', new=MagicMock(return_value=os_distro_value))
@patch('ambari_commons.firewall.run_os_command')
@patch('ambari_server.dbConfiguration_linux.PGConfig._is_jdbc_user_changed')
@patch('ambari_server.serverSetup.verify_setup_allowed')
@patch('ambari_server.serverSetup.get_YN_input')
@patch('ambari_server.serverSetup.configure_os_settings')
@patch('ambari_server.serverSetup.download_and_install_jdk')
@patch.object(PGConfig, '_configure_postgres')
@patch.object(PGConfig, '_check_postgre_up')
@patch('ambari_server.serverSetup.check_ambari_user')
@patch('ambari_server.serverSetup.check_jdbc_drivers')
@patch('ambari_server.serverSetup.check_selinux')
@patch('ambari_server.serverSetup.is_root')
@patch.object(PGConfig, '_setup_db')
@patch('ambari_server.serverSetup.get_is_secure')
@patch('ambari_server.dbConfiguration_linux.store_password_file')
@patch('ambari_server.serverSetup.extract_views')
@patch('ambari_server.serverSetup.adjust_directory_permissions')
@patch('sys.exit')
@patch('__builtin__.raw_input')
@patch('ambari_server.serverSetup.expand_jce_zip_file')
def test_ambariServerSetupWithCustomDbName(self, expand_jce_zip_file_mock, raw_input, exit_mock, adjust_dirs_mock, extract_views_mock, store_password_file_mock, get_is_secure_mock, setup_db_mock, is_root_mock, check_selinux_mock, check_jdbc_drivers_mock, check_ambari_user_mock, check_postgre_up_mock, configure_postgres_mock, download_jdk_mock, configure_os_settings_mock, get_YN_input, verify_setup_allowed_method, is_jdbc_user_changed_mock, run_os_command_mock):
    args = MagicMock()
    raw_input.return_value = ''
    get_YN_input.return_value = False
    verify_setup_allowed_method.return_value = 0
    is_root_mock.return_value = True
    check_selinux_mock.return_value = 0
    check_ambari_user_mock.return_value = 0
    check_jdbc_drivers_mock.return_value = 0
    check_postgre_up_mock.return_value = ('running', 0, '', '')
    configure_postgres_mock.return_value = (0, '', '')
    download_jdk_mock.return_value = 0
    configure_os_settings_mock.return_value = 0
    is_jdbc_user_changed_mock.return_value = False
    setup_db_mock.return_value = (0, None, None)
    get_is_secure_mock.return_value = False
    store_password_file_mock.return_value = 'password'
    extract_views_mock.return_value = 0
    run_os_command_mock.return_value = (3, '', '')
    new_db = 'newDBName'
    args.dbms = 'postgres'
    args.database_name = new_db
    args.postgres_schema = new_db
    args.database_username = 'user'
    args.database_password = 'password'
    args.jdbc_driver = None
    args.jdbc_db = None
    args.must_set_database_options = True
    del args.database_index
    del args.persistence_type
    tempdir = tempfile.gettempdir()
    prop_file = os.path.join(tempdir, 'ambari.properties')
    with open(prop_file, 'w') as f:
        f.write('server.jdbc.database_name=oldDBName')
    f.close()
    os.environ[AMBARI_CONF_VAR] = tempdir
    try:
        result = setup(args)
    except FatalException as ex:
        self.fail('Setup should be successful')
    properties = get_ambari_properties()
    self.assertTrue((JDBC_DATABASE_NAME_PROPERTY in properties.keys()))
    value = properties[JDBC_DATABASE_NAME_PROPERTY]
    self.assertEqual(value, new_db)
    del os.environ[AMBARI_CONF_VAR]
    os.remove(prop_file)
    pass

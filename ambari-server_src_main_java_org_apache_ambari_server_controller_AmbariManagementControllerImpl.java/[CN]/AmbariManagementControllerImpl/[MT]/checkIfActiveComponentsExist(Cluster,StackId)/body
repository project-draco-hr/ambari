{
  String stackName=currentStackId.getStackName();
  String stackVersion=currentStackId.getStackVersion();
  StringBuilder sb=new StringBuilder("Upgrade needs all services to be stopped. ");
  for (  Service service : c.getServices().values()) {
    if (service.getDesiredState() != State.INSTALLED) {
      sb.append("Service " + service.getName() + " is not stopped.");
      throw new AmbariException(sb.toString());
    }
    for (    ServiceComponent component : service.getServiceComponents().values()) {
      if (component.getDesiredState() != State.INSTALLED) {
        sb.append("Component " + component.getName() + " of service "+ service.getName()+ " is not stopped.");
        throw new AmbariException(sb.toString());
      }
      for (      ServiceComponentHost componentHost : component.getServiceComponentHosts().values()) {
        if (componentHost.getDesiredState() != State.INSTALLED) {
          sb.append("Component " + component.getName() + " of service "+ service.getName()+ " on host "+ componentHost.getHostName()+ " is not stopped.");
          throw new AmbariException(sb.toString());
        }
        if (componentHost.getState() == State.STARTED) {
          ComponentInfo compInfo=ambariMetaInfo.getComponent(stackName,stackVersion,componentHost.getServiceName(),componentHost.getServiceComponentName());
          if (compInfo.isMaster()) {
            sb.append("Component " + component.getName() + " of service "+ service.getName()+ " on host "+ componentHost.getHostName()+ " is not yet stopped.");
            throw new AmbariException(sb.toString());
          }
        }
      }
    }
  }
}

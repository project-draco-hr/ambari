{
  if (requests.isEmpty()) {
    LOG.warn("Received an empty requests set");
    return;
  }
  Map<String,Map<String,Map<String,Set<String>>>> hostComponentNames=new HashMap<String,Map<String,Map<String,Set<String>>>>();
  Set<String> duplicates=new HashSet<String>();
  for (  ServiceComponentHostRequest request : requests) {
    if (request.getClusterName() == null || request.getClusterName().isEmpty() || request.getComponentName() == null || request.getComponentName().isEmpty() || request.getHostname() == null || request.getHostname().isEmpty()) {
      throw new IllegalArgumentException("Invalid arguments," + " clustername, componentname and hostname should not be null" + " when trying to create a hostcomponent");
    }
    Cluster cluster=clusters.getCluster(request.getClusterName());
    if (request.getServiceName() == null || request.getServiceName().isEmpty()) {
      StackId stackId=cluster.getDesiredStackVersion();
      String serviceName=ambariMetaInfo.getComponentToService(stackId.getStackName(),stackId.getStackVersion(),request.getComponentName());
      if (LOG.isDebugEnabled()) {
        LOG.debug("Looking up service name for component" + ", componentName=" + request.getComponentName() + ", serviceName="+ serviceName);
      }
      if (serviceName == null || serviceName.isEmpty()) {
        throw new AmbariException("Could not find service for component" + ", componentName=" + request.getComponentName() + ", clusterName="+ cluster.getClusterName()+ ", stackInfo="+ stackId.getStackId());
      }
      request.setServiceName(serviceName);
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("Received a createHostComponent request" + ", clusterName=" + request.getClusterName() + ", serviceName="+ request.getServiceName()+ ", componentName="+ request.getComponentName()+ ", hostname="+ request.getHostname()+ ", request="+ request);
    }
    if (!hostComponentNames.containsKey(request.getClusterName())) {
      hostComponentNames.put(request.getClusterName(),new HashMap<String,Map<String,Set<String>>>());
    }
    if (!hostComponentNames.get(request.getClusterName()).containsKey(request.getServiceName())) {
      hostComponentNames.get(request.getClusterName()).put(request.getServiceName(),new HashMap<String,Set<String>>());
    }
    if (!hostComponentNames.get(request.getClusterName()).get(request.getServiceName()).containsKey(request.getComponentName())) {
      hostComponentNames.get(request.getClusterName()).get(request.getServiceName()).put(request.getComponentName(),new HashSet<String>());
    }
    if (hostComponentNames.get(request.getClusterName()).get(request.getServiceName()).get(request.getComponentName()).contains(request.getHostname())) {
      duplicates.add(request.getServiceName() + "-" + request.getComponentName()+ "-"+ request.getHostname());
      continue;
    }
    hostComponentNames.get(request.getClusterName()).get(request.getServiceName()).get(request.getComponentName()).add(request.getHostname());
    if (request.getDesiredState() != null && !request.getDesiredState().isEmpty()) {
      State state=State.valueOf(request.getDesiredState());
      if (!state.isValidDesiredState() || state != State.INIT) {
        throw new IllegalArgumentException("Invalid desired state" + " only INIT state allowed during creation" + ", providedDesiredState="+ request.getDesiredState());
      }
    }
    Service s=cluster.getService(request.getServiceName());
    ServiceComponent sc=s.getServiceComponent(request.getComponentName());
    Host host=clusters.getHost(request.getHostname());
    Set<Cluster> mappedClusters=clusters.getClustersForHost(request.getHostname());
    boolean validCluster=false;
    if (LOG.isDebugEnabled()) {
      LOG.debug("Looking to match host to cluster" + ", hostnameViaReg=" + host.getHostName() + ", hostname="+ request.getHostname()+ ", clusterName="+ request.getClusterName()+ ", hostClusterMapCount="+ mappedClusters.size());
    }
    for (    Cluster mappedCluster : mappedClusters) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Host belongs to cluster" + ", hostname=" + request.getHostname() + ", clusterName="+ mappedCluster.getClusterName());
      }
      if (mappedCluster.getClusterName().equals(request.getClusterName())) {
        validCluster=true;
        break;
      }
    }
    if (!validCluster) {
      throw new AmbariException("Invalid request as host does not belong to" + " given cluster" + ", clusterName=" + request.getClusterName() + ", serviceName="+ request.getServiceName()+ ", componentName="+ request.getComponentName()+ ", hostname="+ request.getHostname());
    }
    try {
      ServiceComponentHost sch=sc.getServiceComponentHost(request.getHostname());
      if (sch != null) {
        duplicates.add(request.getServiceName() + "-" + request.getComponentName()+ "-"+ request.getHostname());
        continue;
      }
    }
 catch (    AmbariException e) {
    }
  }
  if (hostComponentNames.size() != 1) {
    throw new IllegalArgumentException("Invalid arguments - updates allowed" + " on only one cluster at a time");
  }
  if (!duplicates.isEmpty()) {
    StringBuilder names=new StringBuilder();
    boolean first=true;
    for (    String hName : duplicates) {
      if (!first) {
        names.append(",");
      }
      first=false;
      names.append(hName);
    }
    throw new IllegalArgumentException("Invalid request" + " contains duplicates within request or" + " already existing host components"+ ", duplicateServiceComponentHostNames="+ names.toString());
  }
  for (  ServiceComponentHostRequest request : requests) {
    Cluster cluster=clusters.getCluster(request.getClusterName());
    Service s=cluster.getService(request.getServiceName());
    ServiceComponent sc=s.getServiceComponent(request.getComponentName());
    StackId stackId=sc.getDesiredStackVersion();
    ComponentInfo compInfo=ambariMetaInfo.getComponentCategory(stackId.getStackName(),stackId.getStackVersion(),s.getName(),sc.getName());
    boolean isClient=compInfo.isClient();
    ServiceComponentHost sch=serviceComponentHostFactory.createNew(sc,request.getHostname(),isClient);
    if (request.getDesiredState() != null && !request.getDesiredState().isEmpty()) {
      State state=State.valueOf(request.getDesiredState());
      sch.setDesiredState(state);
    }
 else {
      sch.setDesiredState(sc.getDesiredState());
    }
    sch.setDesiredStackVersion(sc.getDesiredStackVersion());
    Map<String,Config> configs=new HashMap<String,Config>();
    if (request.getConfigVersions() != null) {
    }
    sch.updateDesiredConfigs(configs);
    sc.addServiceComponentHost(sch);
    sch.persist();
  }
}

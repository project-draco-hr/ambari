{
  final Map<String,List<String>> membersPerGroup=new HashMap<String,List<String>>();
  for (  MemberRequest request : requests) {
    if (StringUtils.isBlank(request.getGroupName()) || StringUtils.isBlank(request.getUserName())) {
      throw new AmbariException("Both group name and user name must be supplied.");
    }
    if (membersPerGroup.get(request.getGroupName()) == null) {
      membersPerGroup.put(request.getGroupName(),new ArrayList<String>());
    }
    membersPerGroup.get(request.getGroupName()).add(request.getUserName());
  }
  for (  Entry<String,List<String>> entry : membersPerGroup.entrySet()) {
    final String groupName=entry.getKey();
    final List<String> requiredMembers=entry.getValue();
    final List<String> currentMembers=users.getAllMembers(groupName);
    for (    String user : (Collection<String>)CollectionUtils.subtract(currentMembers,requiredMembers)) {
      users.removeMemberFromGroup(groupName,user);
    }
    for (    String user : (Collection<String>)CollectionUtils.subtract(requiredMembers,currentMembers)) {
      users.addMemberToGroup(groupName,user);
    }
  }
}

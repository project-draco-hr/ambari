{
  Set<String> services=new HashSet<String>();
  if (changedServices != null) {
    for (    Entry<State,List<Service>> entry : changedServices.entrySet()) {
      if (State.STARTED != entry.getKey()) {
        continue;
      }
      for (      Service s : entry.getValue()) {
        if (State.INSTALLED == s.getDesiredState()) {
          services.add(s.getName());
        }
      }
    }
  }
  if (services == null || services.isEmpty())   return;
  List<ServiceComponentHost> existingSchs=new ArrayList<ServiceComponentHost>();
  if (changedScHosts != null && !changedScHosts.isEmpty()) {
    for (    String sc : changedScHosts.keySet()) {
      for (      State s : changedScHosts.get(sc).keySet())       if (s == State.STARTED)       existingSchs.addAll(changedScHosts.get(sc).get(s));
    }
  }
  Map<String,List<ServiceComponentHost>> clientSchs=new HashMap<String,List<ServiceComponentHost>>();
  for (  String serviceName : services) {
    Service s=cluster.getService(serviceName);
    for (    String component : s.getServiceComponents().keySet()) {
      List<ServiceComponentHost> potentialHosts=null;
      ServiceComponent sc=s.getServiceComponents().get(component);
      if (sc.isClientComponent()) {
        potentialHosts=new ArrayList<ServiceComponentHost>();
        if (existingSchs != null && !existingSchs.isEmpty()) {
          for (          ServiceComponentHost potentialSch : sc.getServiceComponentHosts().values()) {
            boolean addSch=true;
            for (            ServiceComponentHost existingSch : existingSchs) {
              if (potentialSch.getHostName().equals(existingSch.getHostName()) && potentialSch.getServiceName().equals(existingSch.getServiceName())) {
                addSch=false;
              }
            }
            if (addSch)             potentialHosts.add(potentialSch);
          }
        }
      }
      if (potentialHosts != null && !potentialHosts.isEmpty()) {
        clientSchs.put(sc.getName(),potentialHosts);
      }
    }
  }
  LOG.info("Client hosts for reinstall : " + clientSchs.size());
  for (  String sc : clientSchs.keySet()) {
    Map<State,List<ServiceComponentHost>> schMap=new HashMap<State,List<ServiceComponentHost>>();
    schMap.put(State.INSTALLED,clientSchs.get(sc));
    changedScHosts.put(sc,schMap);
  }
}

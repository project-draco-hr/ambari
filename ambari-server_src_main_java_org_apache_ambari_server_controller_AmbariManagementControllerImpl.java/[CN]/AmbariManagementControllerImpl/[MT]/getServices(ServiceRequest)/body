{
  if (request.getClusterName() == null || request.getClusterName().isEmpty()) {
    throw new AmbariException("Invalid arguments");
  }
  final Cluster cluster=clusters.getCluster(request.getClusterName());
  Set<ServiceResponse> response=new HashSet<ServiceResponse>();
  if (request.getServiceName() != null) {
    Service s=cluster.getService(request.getServiceName());
    response.add(s.convertToResponse());
    return response;
  }
  boolean checkDesiredState=false;
  State desiredStateToCheck=null;
  if (request.getDesiredState() != null && !request.getDesiredState().isEmpty()) {
    desiredStateToCheck=State.valueOf(request.getDesiredState());
    if (!desiredStateToCheck.isValidDesiredState()) {
      throw new AmbariException("Invalid arguments");
    }
    checkDesiredState=true;
  }
  for (  Service s : cluster.getServices().values()) {
    if (checkDesiredState && (desiredStateToCheck != s.getDesiredState())) {
      continue;
    }
    response.add(s.convertToResponse());
  }
  return response;
}

{
  if (request.getClusterName() == null || request.getClusterName().isEmpty() || request.getServiceName() == null || request.getServiceName().isEmpty()) {
    throw new AmbariException("Invalid arguments");
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Received a updateService request" + ", clusterName=" + request.getClusterName() + ", serviceName="+ request.getServiceName()+ ", request="+ request);
  }
  final Cluster cluster=clusters.getCluster(request.getClusterName());
  final Service s=cluster.getService(request.getServiceName());
  if (request.getConfigVersions() != null) {
    throw new AmbariException("Unsupported operation - config updates not" + " allowed");
  }
  if (request.getDesiredState() == null) {
    return null;
  }
  State newState=State.valueOf(request.getDesiredState());
  if (!newState.isValidDesiredState()) {
    throw new AmbariException("Invalid desired state");
  }
  State oldState=s.getDesiredState();
  if (newState == oldState) {
    return null;
  }
  List<ServiceComponent> changedComps=new ArrayList<ServiceComponent>();
  Map<String,List<ServiceComponentHost>> changedScHosts=new HashMap<String,List<ServiceComponentHost>>();
  for (  ServiceComponent sc : s.getServiceComponents().values()) {
    State oldScState=sc.getDesiredState();
    if (newState == oldScState) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Ignoring ServiceComponent" + ", clusterName=" + request.getClusterName() + ", serviceName="+ s.getName()+ ", componentName="+ sc.getName()+ ", currentState="+ sc.getDesiredState()+ ", newState="+ newState);
      }
      continue;
    }
    LOG.debug("Handling update to ServiceComponent" + ", clusterName=" + request.getClusterName() + ", serviceName="+ s.getName()+ ", componentName="+ sc.getName()+ ", currentState="+ sc.getDesiredState()+ ", newState="+ newState);
    changedComps.add(sc);
    for (    ServiceComponentHost sch : sc.getServiceComponentHosts().values()) {
      if (newState == sch.getDesiredState()) {
        LOG.debug("Ignoring ServiceComponentHost" + ", clusterName=" + request.getClusterName() + ", serviceName="+ s.getName()+ ", componentName="+ sc.getName()+ ", hostname="+ sch.getHostName()+ ", currentState="+ sch.getDesiredState()+ ", newState="+ newState);
        continue;
      }
      if (!changedScHosts.containsKey(sc.getName())) {
        changedScHosts.put(sc.getName(),new ArrayList<ServiceComponentHost>());
      }
      LOG.debug("Handling update to ServiceComponentHost" + ", clusterName=" + request.getClusterName() + ", serviceName="+ s.getName()+ ", componentName="+ sc.getName()+ ", hostname="+ sch.getHostName()+ ", currentState="+ sch.getDesiredState()+ ", newState="+ newState);
      changedScHosts.get(sc.getName()).add(sch);
    }
  }
  List<String> orderedCompNames=new ArrayList<String>();
  orderedCompNames.add("NAMENODE");
  orderedCompNames.add("SECONDARY_NAMENODE");
  orderedCompNames.add("DATANODE");
  orderedCompNames.add("HDFS_CLIENT");
  long nowTimestamp=System.currentTimeMillis();
  long requestId=requestCounter.incrementAndGet();
  List<Stage> stages=new ArrayList<Stage>();
  long stageId=0;
  for (  String compName : orderedCompNames) {
    if (!changedScHosts.containsKey(compName) || changedScHosts.get(compName).isEmpty()) {
      continue;
    }
    Stage stage=createNewStage(cluster,requestId);
    stage.setStageId(++stageId);
    for (    ServiceComponentHost scHost : changedScHosts.get(compName)) {
      Map<String,Config> configs=null;
      ServiceComponentHostEvent event;
      State oldSchState=scHost.getDesiredState();
switch (newState) {
case INSTALLED:
        if (oldSchState == State.INIT || oldSchState == State.UNINSTALLED || oldSchState == State.INSTALLED) {
          event=new ServiceComponentHostInstallEvent(scHost.getServiceComponentName(),scHost.getHostName(),nowTimestamp);
        }
 else         if (oldSchState == State.STARTED) {
          event=new ServiceComponentHostStopEvent(scHost.getServiceComponentName(),scHost.getHostName(),nowTimestamp);
        }
 else {
          throw new AmbariException("Invalid transition" + ", oldDesiredState=" + oldSchState + ", newDesiredState"+ newState);
        }
      break;
case STARTED:
    if (oldSchState == State.INSTALLED) {
      event=new ServiceComponentHostStartEvent(scHost.getServiceComponentName(),scHost.getHostName(),nowTimestamp);
    }
 else {
      throw new AmbariException("Invalid transition" + ", oldDesiredState=" + oldSchState + ", newDesiredState"+ newState);
    }
  break;
default :
throw new AmbariException("Unsupported state change operation");
}
HostAction ha=createHostAction(stage,scHost,configs,event,nowTimestamp);
stage.addHostAction(scHost.getHostName(),ha);
}
if (LOG.isDebugEnabled()) {
LOG.debug("Adding new stage for updateService request" + ", clusterName=" + request.getClusterName() + ", serviceName="+ request.getServiceName()+ ", stage="+ stage);
}
stages.add(stage);
}
for (ServiceComponent sc : changedComps) {
sc.setDesiredState(newState);
}
for (List<ServiceComponentHost> schosts : changedScHosts.values()) {
for (ServiceComponentHost sch : schosts) {
sch.setDesiredState(newState);
}
}
if (LOG.isDebugEnabled()) {
LOG.debug("Triggering Action Manager" + ", clusterName=" + request.getClusterName() + ", serviceName="+ request.getServiceName()+ ", stagesCount="+ stages.size());
}
actionManager.sendActions(stages);
return new TrackActionResponse(requestId);
}

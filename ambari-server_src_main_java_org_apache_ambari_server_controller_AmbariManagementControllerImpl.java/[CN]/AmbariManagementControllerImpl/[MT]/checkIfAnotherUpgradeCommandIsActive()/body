{
  List<Long> requestIds=actionManager.getRequestsByStatus(RequestStatus.IN_PROGRESS);
  if (requestIds != null) {
    for (    Long requestId : requestIds) {
      List<HostRoleCommand> commands=actionManager.getRequestTasks(requestId);
      if (commands != null) {
        for (        HostRoleCommand command : commands) {
          if (command.getRoleCommand() == RoleCommand.UPGRADE && (command.getStatus() == HostRoleStatus.QUEUED || command.getStatus() == HostRoleStatus.PENDING || command.getStatus() == HostRoleStatus.IN_PROGRESS)) {
            throw new AmbariException("A prior upgrade request with id " + requestId + " is in progress. Upgrade can "+ "only be retried after the prior command has completed.");
          }
        }
      }
    }
  }
}

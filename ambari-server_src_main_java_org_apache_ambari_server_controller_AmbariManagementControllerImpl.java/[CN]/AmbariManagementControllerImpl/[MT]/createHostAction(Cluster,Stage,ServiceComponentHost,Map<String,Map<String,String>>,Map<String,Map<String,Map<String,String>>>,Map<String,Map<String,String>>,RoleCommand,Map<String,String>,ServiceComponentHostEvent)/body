{
  String serviceName=scHost.getServiceName();
  stage.addHostRoleExecutionCommand(scHost.getHostName(),Role.valueOf(scHost.getServiceComponentName()),roleCommand,event,scHost.getClusterName(),serviceName,false);
  String componentName=scHost.getServiceComponentName();
  String hostname=scHost.getHostName();
  String osFamily=clusters.getHost(hostname).getOsFamily();
  StackId stackId=cluster.getDesiredStackVersion();
  ServiceInfo serviceInfo=ambariMetaInfo.getService(stackId.getStackName(),stackId.getStackVersion(),serviceName);
  ComponentInfo componentInfo=ambariMetaInfo.getComponent(stackId.getStackName(),stackId.getStackVersion(),serviceName,componentName);
  StackInfo stackInfo=ambariMetaInfo.getStack(stackId.getStackName(),stackId.getStackVersion());
  ExecutionCommand execCmd=stage.getExecutionCommandWrapper(scHost.getHostName(),scHost.getServiceComponentName()).getExecutionCommand();
  Host host=clusters.getHost(scHost.getHostName());
  String jobtrackerHost=getJobTrackerHost(cluster);
  if (!scHost.getHostName().equals(jobtrackerHost)) {
    if (configTags.get(Configuration.GLOBAL_CONFIG_TAG) != null) {
      configHelper.applyCustomConfig(configurations,Configuration.GLOBAL_CONFIG_TAG,Configuration.RCA_ENABLED_PROPERTY,"false",false);
    }
  }
  execCmd.setConfigurations(configurations);
  execCmd.setConfigurationAttributes(configurationAttributes);
  execCmd.setConfigurationTags(configTags);
  if (commandParams == null) {
    commandParams=new TreeMap<String,String>();
  }
  boolean isInstallCommand=roleCommand.equals(RoleCommand.INSTALL);
  String agentDefaultCommandTimeout=configs.getDefaultAgentTaskTimeout(isInstallCommand);
  String scriptCommandTimeout="";
  CommandScriptDefinition script=componentInfo.getCommandScript();
  if (serviceInfo.getSchemaVersion().equals(AmbariMetaInfo.SCHEMA_VERSION_2)) {
    if (script != null) {
      commandParams.put(SCRIPT,script.getScript());
      commandParams.put(SCRIPT_TYPE,script.getScriptType().toString());
      ClusterVersionEntity currentClusterVersion=cluster.getCurrentClusterVersion();
      if (currentClusterVersion != null) {
        commandParams.put(VERSION,currentClusterVersion.getRepositoryVersion().getVersion());
      }
      if (script.getTimeout() > 0) {
        scriptCommandTimeout=String.valueOf(script.getTimeout());
      }
    }
 else {
      String message=String.format("Component %s of service %s has no " + "command script defined",componentName,serviceName);
      throw new AmbariException(message);
    }
  }
  String actualTimeout=(!scriptCommandTimeout.equals("") ? scriptCommandTimeout : agentDefaultCommandTimeout);
  if (roleCommand.equals(RoleCommand.INSTALL) && !agentDefaultCommandTimeout.equals("") && Integer.parseInt(actualTimeout) < Integer.parseInt(agentDefaultCommandTimeout)) {
    actualTimeout=agentDefaultCommandTimeout;
  }
  commandParams.put(COMMAND_TIMEOUT,actualTimeout);
  commandParams.put(SERVICE_PACKAGE_FOLDER,serviceInfo.getServicePackageFolder());
  commandParams.put(HOOKS_FOLDER,stackInfo.getStackHooksFolder());
  String clusterName=cluster.getClusterName();
  if (customCommandExecutionHelper.isTopologyRefreshRequired(roleCommand.name(),clusterName,serviceName)) {
    commandParams.put(ExecutionCommand.KeyNames.REFRESH_TOPOLOGY,"True");
  }
  execCmd.setCommandParams(commandParams);
  String repoInfo=customCommandExecutionHelper.getRepoInfo(cluster,host);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Sending repo information to agent" + ", hostname=" + scHost.getHostName() + ", clusterName="+ clusterName+ ", stackInfo="+ stackId.getStackId()+ ", repoInfo="+ repoInfo);
  }
  Map<String,String> hostParams=new TreeMap<String,String>();
  hostParams.put(REPO_INFO,repoInfo);
  hostParams.putAll(getRcaParameters());
  List<ServiceOsSpecific.Package> packages=getPackagesForServiceHost(serviceInfo,hostParams,osFamily);
  String packageList=gson.toJson(packages);
  hostParams.put(PACKAGE_LIST,packageList);
  Set<String> userSet=configHelper.getPropertyValuesWithPropertyType(stackId,PropertyType.USER,cluster);
  String userList=gson.toJson(userSet);
  hostParams.put(USER_LIST,userList);
  Set<String> groupSet=configHelper.getPropertyValuesWithPropertyType(stackId,PropertyType.GROUP,cluster);
  String groupList=gson.toJson(groupSet);
  hostParams.put(GROUP_LIST,groupList);
  DatabaseType databaseType=configs.getDatabaseType();
  if (databaseType == DatabaseType.ORACLE) {
    hostParams.put(DB_DRIVER_FILENAME,configs.getOjdbcJarName());
  }
 else   if (databaseType == DatabaseType.MYSQL) {
    hostParams.put(DB_DRIVER_FILENAME,configs.getMySQLJarName());
  }
  List<String> clientsToUpdateConfigsList=componentInfo.getClientsToUpdateConfigs();
  if (clientsToUpdateConfigsList == null) {
    clientsToUpdateConfigsList=new ArrayList<String>();
    clientsToUpdateConfigsList.add("*");
  }
  String clientsToUpdateConfigs=gson.toJson(clientsToUpdateConfigsList);
  hostParams.put(CLIENTS_TO_UPDATE_CONFIGS,clientsToUpdateConfigs);
  execCmd.setHostLevelParams(hostParams);
  Map<String,String> roleParams=new TreeMap<String,String>();
  execCmd.setRoleParams(roleParams);
}

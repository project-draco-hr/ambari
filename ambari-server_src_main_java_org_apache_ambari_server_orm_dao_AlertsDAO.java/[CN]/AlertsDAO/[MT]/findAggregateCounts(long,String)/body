{
  StringBuilder sb=new StringBuilder();
  sb.append("SELECT NEW %s (");
  sb.append("COUNT(history), ");
  sb.append("SUM(CASE WHEN history.alertState = %s.%s THEN 1 ELSE 0 END), ");
  sb.append("SUM(CASE WHEN history.alertState = %s.%s THEN 1 ELSE 0 END), ");
  sb.append("SUM(CASE WHEN history.alertState = %s.%s THEN 1 ELSE 0 END)) ");
  sb.append("FROM AlertCurrentEntity alert JOIN alert.alertHistory history WHERE history.clusterId = :clusterId");
  sb.append(" AND history.alertDefinition.definitionName = :definitionName");
  String str=String.format(sb.toString(),AlertSummaryDTO.class.getName(),AlertState.class.getName(),AlertState.WARNING.name(),AlertState.class.getName(),AlertState.CRITICAL.name(),AlertState.class.getName(),AlertState.UNKNOWN.name());
  TypedQuery<AlertSummaryDTO> query=entityManagerProvider.get().createQuery(str,AlertSummaryDTO.class);
  query.setParameter("clusterId",Long.valueOf(clusterId));
  query.setParameter("definitionName",alertName);
  return daoUtils.selectSingle(query);
}

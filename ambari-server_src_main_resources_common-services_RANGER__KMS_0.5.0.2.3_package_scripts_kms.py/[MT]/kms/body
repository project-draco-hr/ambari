def kms(upgrade_type=None):
    import params
    if params.has_ranger_admin:
        Directory(params.kms_conf_dir, owner=params.kms_user, group=params.kms_group, create_parents=True)
        if (upgrade_type is not None):
            copy_jdbc_connector(stack_version=params.version)
        File(format('/usr/lib/ambari-agent/{check_db_connection_jar_name}'), content=DownloadSource(format('{jdk_location}{check_db_connection_jar_name}')), mode=420)
        cp = format('{check_db_connection_jar}')
        cp = ((cp + os.pathsep) + format('{kms_home}/ews/webapp/lib/{jdbc_jar_name}'))
        db_connection_check_command = format("{java_home}/bin/java -cp {cp} org.apache.ambari.server.DBConnectionVerification '{ranger_kms_jdbc_connection_url}' {db_user} {db_password!p} {ranger_kms_jdbc_driver}")
        env_dict = {}
        if (params.db_flavor.lower() == 'sqla'):
            env_dict = {'LD_LIBRARY_PATH': params.ld_library_path, }
        Execute(db_connection_check_command, path='/usr/sbin:/sbin:/usr/local/bin:/bin:/usr/bin', tries=5, try_sleep=10, environment=env_dict)
        if params.xa_audit_db_is_enabled:
            File(params.downloaded_connector_path, content=DownloadSource(params.driver_source), mode=420)
            Execute(('cp', '--remove-destination', params.downloaded_connector_path, params.driver_target), path=['/bin', '/usr/bin/'], sudo=True)
            File(params.driver_target, mode=420)
        Directory(os.path.join(params.kms_home, 'ews', 'webapp', 'WEB-INF', 'classes', 'lib'), mode=493, owner=params.kms_user, group=params.kms_group)
        Execute(('cp', format('{kms_home}/ranger-kms-initd'), '/etc/init.d/ranger-kms'), not_if=format('ls /etc/init.d/ranger-kms'), only_if=format('ls {kms_home}/ranger-kms-initd'), sudo=True)
        File('/etc/init.d/ranger-kms', mode=493)
        Directory(format('{kms_home}/'), owner=params.kms_user, group=params.kms_group, recursive_ownership=True)
        Directory(params.kms_log_dir, owner=params.kms_user, group=params.kms_group)
        Execute(('ln', '-sf', format('{kms_home}/ranger-kms'), '/usr/bin/ranger-kms'), not_if=format('ls /usr/bin/ranger-kms'), only_if=format('ls {kms_home}/ranger-kms'), sudo=True)
        File('/usr/bin/ranger-kms', mode=493)
        Execute(('ln', '-sf', format('{kms_home}/ranger-kms'), '/usr/bin/ranger-kms-services.sh'), not_if=format('ls /usr/bin/ranger-kms-services.sh'), only_if=format('ls {kms_home}/ranger-kms'), sudo=True)
        File('/usr/bin/ranger-kms-services.sh', mode=493)
        Execute(('ln', '-sf', format('{kms_home}/ranger-kms-initd'), format('{kms_home}/ranger-kms-services.sh')), not_if=format('ls {kms_home}/ranger-kms-services.sh'), only_if=format('ls {kms_home}/ranger-kms-initd'), sudo=True)
        File(format('{kms_home}/ranger-kms-services.sh'), mode=493)
        Directory(params.kms_log_dir, owner=params.kms_user, group=params.kms_group, mode=509)
        do_keystore_setup(params.credential_provider_path, params.jdbc_alias, params.db_password)
        do_keystore_setup(params.credential_provider_path, params.masterkey_alias, params.kms_master_key_password)
        XmlConfig('dbks-site.xml', conf_dir=params.kms_conf_dir, configurations=params.config['configurations']['dbks-site'], configuration_attributes=params.config['configuration_attributes']['dbks-site'], owner=params.kms_user, group=params.kms_group, mode=420)
        XmlConfig('ranger-kms-site.xml', conf_dir=params.kms_conf_dir, configurations=params.config['configurations']['ranger-kms-site'], configuration_attributes=params.config['configuration_attributes']['ranger-kms-site'], owner=params.kms_user, group=params.kms_group, mode=420)
        XmlConfig('kms-site.xml', conf_dir=params.kms_conf_dir, configurations=params.config['configurations']['kms-site'], configuration_attributes=params.config['configuration_attributes']['kms-site'], owner=params.kms_user, group=params.kms_group, mode=420)
        File(os.path.join(params.kms_conf_dir, 'kms-log4j.properties'), owner=params.kms_user, group=params.kms_group, content=params.kms_log4j, mode=420)

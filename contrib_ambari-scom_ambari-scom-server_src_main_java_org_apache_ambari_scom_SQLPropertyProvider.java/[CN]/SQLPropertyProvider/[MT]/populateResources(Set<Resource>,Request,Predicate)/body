{
  Set<Resource> keepers=new HashSet<Resource>();
  try {
    Connection connection=connectionFactory.getConnection();
    try {
      PreparedStatement preparedStatement=connection.prepareStatement(GET_METRICS_STATEMENT);
      try {
        for (        Resource resource : resources) {
          if (populateResource(resource,request,predicate,preparedStatement)) {
            keepers.add(resource);
          }
        }
      }
  finally {
        preparedStatement.close();
      }
    }
  finally {
      connection.close();
    }
  }
 catch (  SQLException e) {
    if (LOG.isErrorEnabled()) {
      LOG.error("Error during populateResources call : caught exception",e);
    }
    throw new SystemException("Error during populateResources call : caught exception",e);
  }
  return keepers;
}

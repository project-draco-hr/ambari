{
  clusterGlobalLock.writeLock().lock();
  try {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Changing DesiredStackVersion of Cluster" + ", clusterName=" + getClusterName() + ", clusterId="+ getClusterId()+ ", currentDesiredStackVersion="+ desiredStackVersion+ ", newDesiredStackVersion="+ stackId);
    }
    desiredStackVersion=stackId;
    StackEntity stackEntity=stackDAO.find(stackId.getStackName(),stackId.getStackVersion());
    clusterEntity.setDesiredStack(stackEntity);
    clusterDAO.merge(clusterEntity);
    loadServiceConfigTypes();
  }
  finally {
    clusterGlobalLock.writeLock().unlock();
  }
}

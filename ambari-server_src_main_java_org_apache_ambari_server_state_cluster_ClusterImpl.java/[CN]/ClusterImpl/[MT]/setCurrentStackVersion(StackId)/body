{
  clusterGlobalLock.writeLock().lock();
  try {
    StackEntity stackEntity=stackDAO.find(stackId.getStackName(),stackId.getStackVersion());
    ClusterEntity clusterEntity=getClusterEntity();
    if (clusterEntity != null) {
      ClusterStateEntity clusterStateEntity=clusterStateDAO.findByPK(clusterEntity.getClusterId());
      if (clusterStateEntity == null) {
        clusterStateEntity=new ClusterStateEntity();
        clusterStateEntity.setClusterId(clusterEntity.getClusterId());
        clusterStateEntity.setCurrentStack(stackEntity);
        clusterStateEntity.setClusterEntity(clusterEntity);
        clusterStateDAO.create(clusterStateEntity);
        clusterStateEntity=clusterStateDAO.merge(clusterStateEntity);
        clusterEntity.setClusterStateEntity(clusterStateEntity);
        clusterDAO.merge(clusterEntity);
      }
 else {
        clusterStateEntity.setCurrentStack(stackEntity);
        clusterStateDAO.merge(clusterStateEntity);
        clusterDAO.merge(clusterEntity);
      }
    }
  }
 catch (  RollbackException e) {
    LOG.warn("Unable to set version " + stackId + " for cluster "+ getClusterName());
    throw new AmbariException("Unable to set" + " version=" + stackId + " for cluster "+ getClusterName(),e);
  }
 finally {
    clusterGlobalLock.writeLock().unlock();
  }
}

{
  clusterGlobalLock.readLock().lock();
  try {
    readWriteLock.readLock().lock();
    try {
      Map<String,DesiredConfig> map=new HashMap<String,DesiredConfig>();
      Collection<String> types=new HashSet<String>();
      for (      ClusterConfigMappingEntity e : clusterEntity.getConfigMappingEntities()) {
        if (e.isSelected() > 0) {
          DesiredConfig c=new DesiredConfig();
          c.setServiceName(null);
          c.setVersion(e.getVersion());
          c.setUser(e.getUser());
          map.put(e.getType(),c);
          types.add(e.getType());
        }
      }
      if (!map.isEmpty()) {
        Map<String,List<HostConfigMapping>> hostMappingsByType=hostConfigMappingDAO.findSelectedHostsByTypes(clusterEntity.getClusterId(),types);
        for (        Entry<String,DesiredConfig> entry : map.entrySet()) {
          List<DesiredConfig.HostOverride> hostOverrides=new ArrayList<DesiredConfig.HostOverride>();
          for (          HostConfigMapping mappingEntity : hostMappingsByType.get(entry.getKey())) {
            hostOverrides.add(new DesiredConfig.HostOverride(mappingEntity.getHostName(),mappingEntity.getVersion()));
          }
          entry.getValue().setHostOverrides(hostOverrides);
        }
      }
      return map;
    }
  finally {
      readWriteLock.readLock().unlock();
    }
  }
  finally {
    clusterGlobalLock.readLock().unlock();
  }
}

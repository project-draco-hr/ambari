{
  clusterGlobalLock.writeLock().lock();
  try {
    List<ClusterVersionEntity> clusterVersionEntities=clusterVersionDAO.findByCluster(getClusterName());
    StackId currentStackId=getCurrentStackVersion();
    for (    ClusterVersionEntity clusterVersionEntity : clusterVersionEntities) {
      if (clusterVersionEntity.getRepositoryVersion().getStack().equals(currentStackId.getStackId()) && clusterVersionEntity.getState() != RepositoryVersionState.CURRENT) {
        recalculateClusterVersionState(clusterVersionEntity.getRepositoryVersion().getStackId(),clusterVersionEntity.getRepositoryVersion().getVersion());
      }
    }
  }
  finally {
    clusterGlobalLock.writeLock().unlock();
  }
}

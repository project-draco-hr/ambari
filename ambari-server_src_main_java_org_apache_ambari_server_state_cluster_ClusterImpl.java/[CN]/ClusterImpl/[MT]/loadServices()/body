{
  if (services == null) {
    clusterGlobalLock.writeLock().lock();
    try {
      if (services == null) {
        ClusterEntity clusterEntity=getClusterEntity();
        if (clusterEntity != null) {
          services=new TreeMap<String,Service>();
          if (!clusterEntity.getClusterServiceEntities().isEmpty()) {
            for (            ClusterServiceEntity serviceEntity : clusterEntity.getClusterServiceEntities()) {
              StackId stackId=getCurrentStackVersion();
              try {
                if (ambariMetaInfo.getService(stackId.getStackName(),stackId.getStackVersion(),serviceEntity.getServiceName()) != null) {
                  services.put(serviceEntity.getServiceName(),serviceFactory.createExisting(this,serviceEntity));
                }
              }
 catch (              AmbariException e) {
                LOG.error(String.format("Can not get service info: stackName=%s, stackVersion=%s, serviceName=%s",stackId.getStackName(),stackId.getStackVersion(),serviceEntity.getServiceName()));
              }
            }
          }
        }
      }
    }
  finally {
      clusterGlobalLock.writeLock().unlock();
    }
  }
}

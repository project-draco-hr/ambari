{
  HostVersionEntity hostVersionEntity=hostVersionDAO.findByClusterStackVersionAndHost(getClusterName(),repositoryVersion.getStack(),repositoryVersion.getVersion(),host.getHostName());
  hostTransitionStateWriteLock.lock();
  try {
    if (hostVersionEntity == null) {
      hostVersionEntity=new HostVersionEntity(host.getHostName(),repositoryVersion,RepositoryVersionState.UPGRADING);
      hostVersionEntity.setHostEntity(host);
      hostVersionDAO.create(hostVersionEntity);
    }
    HostVersionEntity currentVersionEntity=hostVersionDAO.findByHostAndStateCurrent(getClusterName(),host.getHostName());
    boolean isCurrentPresent=(currentVersionEntity != null);
    final ServiceComponentHostSummary hostSummary=new ServiceComponentHostSummary(ambariMetaInfo,host,stack);
    if (!isCurrentPresent) {
      if (hostSummary.isUpgradeFinished() && hostVersionEntity.getState().equals(RepositoryVersionState.UPGRADING)) {
        hostVersionEntity.setState(RepositoryVersionState.CURRENT);
        hostVersionDAO.merge(hostVersionEntity);
      }
    }
 else {
      if (hostSummary.isUpgradeInProgress(currentVersionEntity.getRepositoryVersion().getVersion()) && hostVersionEntity.getState().equals(RepositoryVersionState.INSTALLED)) {
        hostVersionEntity.setState(RepositoryVersionState.UPGRADING);
        hostVersionDAO.merge(hostVersionEntity);
      }
      if (hostSummary.isUpgradeFinished() && hostVersionEntity.getState().equals(RepositoryVersionState.UPGRADING)) {
        hostVersionEntity.setState(RepositoryVersionState.UPGRADED);
        hostVersionDAO.merge(hostVersionEntity);
      }
    }
  }
  finally {
    hostTransitionStateWriteLock.unlock();
  }
  return hostVersionEntity;
}

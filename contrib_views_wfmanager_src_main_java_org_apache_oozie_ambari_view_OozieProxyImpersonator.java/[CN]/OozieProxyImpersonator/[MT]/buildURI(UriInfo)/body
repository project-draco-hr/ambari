{
  String uiURI=ui.getAbsolutePath().getPath();
  int index=uiURI.indexOf("proxy/") + 5;
  uiURI=uiURI.substring(index);
  String serviceURI=getServiceUri();
  serviceURI+=uiURI;
  MultivaluedMap<String,String> parameters=ui.getQueryParameters();
  StringBuilder urlBuilder=new StringBuilder(serviceURI);
  boolean firstEntry=true;
  for (  Map.Entry<String,List<String>> entry : parameters.entrySet()) {
    if ("user.name".equals(entry.getKey())) {
      ArrayList<String> vals=new ArrayList<String>();
      vals.add(viewContext.getUsername());
      entry.setValue(vals);
    }
    if (firstEntry) {
      urlBuilder.append("?");
    }
 else {
      urlBuilder.append("&");
    }
    boolean firstVal=true;
    for (    String val : entry.getValue()) {
      urlBuilder.append(firstVal ? "" : "&").append(entry.getKey()).append("=").append(val);
      firstVal=false;
    }
    firstEntry=false;
  }
  return urlBuilder.toString();
}

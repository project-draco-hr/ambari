{
  String clusterName=actionExecutionContext.getClusterName();
  final Cluster cluster=clusters.getCluster(clusterName);
  final String componentName=actionMetadata.getClient(resourceFilter.getServiceName());
  final String serviceName=resourceFilter.getServiceName();
  String smokeTestRole=actionMetadata.getServiceCheckAction(serviceName);
  if (null == smokeTestRole) {
    smokeTestRole=actionExecutionContext.getActionName();
  }
  long nowTimestamp=System.currentTimeMillis();
  Map<String,String> actionParameters=actionExecutionContext.getParameters();
  final Set<String> candidateHosts;
  final Map<String,ServiceComponentHost> serviceHostComponents;
  if (componentName != null) {
    serviceHostComponents=cluster.getService(serviceName).getServiceComponent(componentName).getServiceComponentHosts();
    if (serviceHostComponents.isEmpty()) {
      throw new AmbariException("Hosts not found, component=" + componentName + ", service = "+ serviceName+ ", cluster = "+ clusterName);
    }
    List<String> candidateHostsList=resourceFilter.getHostNames();
    if (candidateHostsList != null && !candidateHostsList.isEmpty()) {
      candidateHosts=new HashSet<String>(candidateHostsList);
    }
 else {
      candidateHosts=serviceHostComponents.keySet();
    }
  }
 else {
    Map<String,ServiceComponent> serviceComponents=cluster.getService(serviceName).getServiceComponents();
    Iterator<String> serviceComponentNameIterator=serviceComponents.keySet().iterator();
    while (serviceComponentNameIterator.hasNext()) {
      String componentToCheck=serviceComponentNameIterator.next();
      if (serviceComponents.get(componentToCheck).getServiceComponentHosts().isEmpty()) {
        serviceComponentNameIterator.remove();
      }
    }
    if (serviceComponents.isEmpty()) {
      throw new AmbariException("Components not found, service = " + serviceName + ", cluster = "+ clusterName);
    }
    ServiceComponent serviceComponent=serviceComponents.values().iterator().next();
    serviceHostComponents=serviceComponent.getServiceComponentHosts();
    candidateHosts=serviceHostComponents.keySet();
  }
  Set<String> hostsInMaintenanceMode=new HashSet<String>();
  if (actionExecutionContext.isMaintenanceModeHostExcluded()) {
    Iterator<String> iterator=candidateHosts.iterator();
    while (iterator.hasNext()) {
      String candidateHostName=iterator.next();
      ServiceComponentHost serviceComponentHost=serviceHostComponents.get(candidateHostName);
      Host host=serviceComponentHost.getHost();
      if (host.getMaintenanceState(cluster.getClusterId()) == MaintenanceState.ON) {
        hostsInMaintenanceMode.add(candidateHostName);
        iterator.remove();
      }
    }
  }
  String hostName=managementController.getHealthyHost(candidateHosts);
  if (hostName == null) {
    String message=MessageFormat.format("While building a service check command for {0}, there were no healthy eligible hosts: unhealthy[{1}], maintenance[{2}]",serviceName,StringUtils.join(candidateHosts,','),StringUtils.join(hostsInMaintenanceMode,','));
    throw new AmbariException(message);
  }
  addServiceCheckAction(stage,hostName,smokeTestRole,nowTimestamp,serviceName,componentName,actionParameters,actionExecutionContext.isRetryAllowed(),actionExecutionContext.isFailureAutoSkipped());
}

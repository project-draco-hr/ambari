def main():
    global config
    parser = OptionParser()
    parser.add_option('-v', '--verbose', dest='verbose', action='store_true', help='verbose log output', default=False)
    parser.add_option('-e', '--expected-hostname', dest='expected_hostname', action='store', help='expected hostname of current host. If hostname differs, agent will fail', default=None)
    (options, args) = parser.parse_args()
    expected_hostname = options.expected_hostname
    setup_logging(options.verbose)
    default_cfg = {'agent': {'prefix': '/home/ambari', }, }
    config = ConfigParser.RawConfigParser(default_cfg)
    bind_signal_handlers()
    if ((len(sys.argv) > 1) and (sys.argv[1] == 'stop')):
        stop_agent()
    config = resolve_ambari_config()
    data_cleaner = None
    if (int(config.get('agent', 'data_cleanup_interval')) > 0):
        data_cleaner = DataCleaner(config)
        data_cleaner.start()
    perform_prestart_checks(expected_hostname)
    daemonize()
    killstaleprocesses()
    update_log_level(config)
    server_url = ((('https://' + config.get('server', 'hostname')) + ':') + config.get('server', 'url_port'))
    print (('Connecting to the server at ' + server_url) + '...')
    logger.info(('Connecting to the server at: ' + server_url))
    netutil = NetUtil()
    netutil.try_to_connect(server_url, (-1), logger)
    controller = Controller(config)
    controller.start()
    controller.join()
    stop_agent()
    logger.info('finished')

{
  PrincipalTypeEntity principalTypeEntity=principalTypeDAO.findById(PrincipalTypeEntity.USER_PRINCIPAL_TYPE);
  if (principalTypeEntity == null) {
    principalTypeEntity=new PrincipalTypeEntity();
    principalTypeEntity.setId(PrincipalTypeEntity.USER_PRINCIPAL_TYPE);
    principalTypeEntity.setName(PrincipalTypeEntity.USER_PRINCIPAL_TYPE_NAME);
    principalTypeDAO.create(principalTypeEntity);
  }
  PrincipalEntity principalEntity=new PrincipalEntity();
  principalEntity.setPrincipalType(principalTypeEntity);
  principalDAO.create(principalEntity);
  UserEntity userEntity=new UserEntity();
  userEntity.setUserName(userName);
  userEntity.setUserPassword(passwordEncoder.encode(password));
  userEntity.setRoleEntities(new HashSet<RoleEntity>());
  userEntity.setPrincipal(principalEntity);
  if (active != null) {
    userEntity.setActive(active);
  }
  RoleEntity roleEntity=roleDAO.findByName(getUserRole());
  if (roleEntity == null) {
    createRole(getUserRole());
  }
  roleEntity=roleDAO.findByName(getUserRole());
  userEntity.getRoleEntities().add(roleEntity);
  userDAO.create(userEntity);
  if (admin != null && admin) {
    grantAdminPrivilege(userEntity.getUserId());
  }
  roleEntity.getUserEntities().add(userEntity);
  roleDAO.merge(roleEntity);
}

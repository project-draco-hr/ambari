{
  SecurityContext securityContext=SecurityContextHolder.getContext();
  String currentUserName=securityContext.getAuthentication().getName();
  if (currentUserName == null) {
    throw new AmbariException("Authentication required. Please sign in.");
  }
  UserEntity currentUserEntity=userDAO.findLocalUserByName(currentUserName);
  UserEntity userEntity=userDAO.findLocalUserByName(userName);
  if ((userEntity != null) && (currentUserEntity != null)) {
    if (passwordEncoder.matches(currentUserPassword,currentUserEntity.getUserPassword())) {
      userEntity.setUserPassword(passwordEncoder.encode(newPassword));
      userDAO.merge(userEntity);
    }
 else {
      throw new AmbariException("Wrong password provided");
    }
  }
 else {
    userEntity=userDAO.findLdapUserByName(userName);
    if (userEntity != null) {
      throw new AmbariException("Password of LDAP user cannot be modified");
    }
 else {
      throw new AmbariException("User " + userName + " not found");
    }
  }
}

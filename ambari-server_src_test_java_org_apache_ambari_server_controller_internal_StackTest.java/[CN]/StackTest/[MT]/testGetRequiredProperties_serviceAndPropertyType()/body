{
  AmbariManagementController controller=createNiceMock(AmbariManagementController.class);
  AmbariMetaInfo metaInfo=createNiceMock(AmbariMetaInfo.class);
  Capture<Set<StackServiceRequest>> stackServiceRequestCapture=new Capture<Set<StackServiceRequest>>();
  StackServiceResponse stackServiceResponse=createNiceMock(StackServiceResponse.class);
  Capture<Set<StackServiceComponentRequest>> stackComponentRequestCapture=new Capture<Set<StackServiceComponentRequest>>();
  StackServiceComponentResponse stackComponentResponse=createNiceMock(StackServiceComponentResponse.class);
  Capture<Set<StackConfigurationRequest>> stackConfigurationRequestCapture=new Capture<Set<StackConfigurationRequest>>();
  Capture<Set<StackLevelConfigurationRequest>> stackLevelConfigurationRequestCapture=new Capture<Set<StackLevelConfigurationRequest>>();
  StackConfigurationResponse stackConfigurationResponse=EasyMock.createNiceMock(StackConfigurationResponse.class);
  StackConfigurationResponse stackConfigurationResponse2=EasyMock.createNiceMock(StackConfigurationResponse.class);
  expect(controller.getStackServices(capture(stackServiceRequestCapture))).andReturn(Collections.singleton(stackServiceResponse)).anyTimes();
  expect(controller.getAmbariMetaInfo()).andReturn(metaInfo).anyTimes();
  expect(stackServiceResponse.getServiceName()).andReturn("service1").anyTimes();
  expect(stackServiceResponse.getExcludedConfigTypes()).andReturn(Collections.<String>emptySet());
  expect(stackServiceResponse.getConfigTypes()).andReturn(Collections.<String,Map<String,Map<String,String>>>emptyMap());
  expect(controller.getStackComponents(capture(stackComponentRequestCapture))).andReturn(Collections.singleton(stackComponentResponse)).anyTimes();
  expect(stackComponentResponse.getComponentName()).andReturn("component1").anyTimes();
  expect(stackComponentResponse.getComponentCategory()).andReturn("test-site.xml").anyTimes();
  expect(controller.getStackConfigurations(capture(stackConfigurationRequestCapture))).andReturn(new HashSet<StackConfigurationResponse>(Arrays.asList(stackConfigurationResponse,stackConfigurationResponse2))).anyTimes();
  expect(controller.getStackLevelConfigurations(capture(stackLevelConfigurationRequestCapture))).andReturn(Collections.<StackConfigurationResponse>emptySet()).anyTimes();
  expect(stackConfigurationResponse.getPropertyName()).andReturn("prop1").anyTimes();
  expect(stackConfigurationResponse.getPropertyValue()).andReturn(null).anyTimes();
  expect(stackConfigurationResponse.getType()).andReturn("test-site.xml").anyTimes();
  expect(stackConfigurationResponse.getPropertyType()).andReturn(Collections.singleton(PropertyInfo.PropertyType.PASSWORD)).anyTimes();
  expect(stackConfigurationResponse.getPropertyAttributes()).andReturn(Collections.<String,String>emptyMap()).anyTimes();
  expect(stackConfigurationResponse.isRequired()).andReturn(true).anyTimes();
  expect(stackConfigurationResponse2.getPropertyName()).andReturn("prop2").anyTimes();
  expect(stackConfigurationResponse2.getPropertyValue()).andReturn(null).anyTimes();
  expect(stackConfigurationResponse2.getType()).andReturn("test-site.xml").anyTimes();
  expect(stackConfigurationResponse2.getPropertyType()).andReturn(Collections.singleton(PropertyInfo.PropertyType.USER)).anyTimes();
  expect(stackConfigurationResponse2.getPropertyAttributes()).andReturn(Collections.<String,String>emptyMap()).anyTimes();
  expect(stackConfigurationResponse2.isRequired()).andReturn(true).anyTimes();
  expect(metaInfo.getComponentDependencies("test","1.0","service1","component1")).andReturn(Collections.<DependencyInfo>emptyList()).anyTimes();
  replay(controller,stackServiceResponse,stackComponentResponse,stackConfigurationResponse,stackConfigurationResponse2,metaInfo);
  Stack stack=new Stack("test","1.0",controller);
  Collection<Stack.ConfigProperty> requiredPasswordProperties=stack.getRequiredConfigurationProperties("service1",PropertyInfo.PropertyType.PASSWORD);
  assertEquals(1,requiredPasswordProperties.size());
  Stack.ConfigProperty requiredPasswordConfigProperty=requiredPasswordProperties.iterator().next();
  assertEquals("test-site",requiredPasswordConfigProperty.getType());
  assertEquals("prop1",requiredPasswordConfigProperty.getName());
  assertTrue(requiredPasswordConfigProperty.getPropertyTypes().contains(PropertyInfo.PropertyType.PASSWORD));
  StackServiceRequest stackServiceRequest=stackServiceRequestCapture.getValue().iterator().next();
  assertEquals("test",stackServiceRequest.getStackName());
  assertEquals("1.0",stackServiceRequest.getStackVersion());
  StackServiceComponentRequest stackComponentRequest=stackComponentRequestCapture.getValue().iterator().next();
  assertEquals("service1",stackComponentRequest.getServiceName());
  assertEquals("test",stackComponentRequest.getStackName());
  assertEquals("1.0",stackComponentRequest.getStackVersion());
  assertNull(stackComponentRequest.getComponentName());
}

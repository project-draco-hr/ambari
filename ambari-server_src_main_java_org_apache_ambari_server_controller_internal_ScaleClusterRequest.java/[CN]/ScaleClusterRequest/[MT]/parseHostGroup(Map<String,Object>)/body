{
  String blueprintName=String.valueOf(properties.get(HostResourceProvider.BLUEPRINT_PROPERTY_ID));
  if (blueprint == null) {
    blueprint=parseBlueprint(blueprintName);
  }
 else   if (!blueprintName.equals(blueprint.getName())) {
    throw new InvalidTopologyTemplateException("Currently, a scaling request may only refer to a single blueprint");
  }
  String hgName=String.valueOf(properties.get(HostResourceProvider.HOSTGROUP_PROPERTY_ID));
  HostGroupInfo hostGroupInfo=hostGroupInfoMap.get(hgName);
  if (hostGroupInfo == null) {
    if (blueprint.getHostGroup(hgName) == null) {
      throw new InvalidTopologyTemplateException("Invalid host group specified in request: " + hgName);
    }
    hostGroupInfo=new HostGroupInfo(hgName);
    hostGroupInfoMap.put(hgName,hostGroupInfo);
  }
  hostGroupInfo.setConfiguration(new Configuration(Collections.<String,Map<String,String>>emptyMap(),Collections.<String,Map<String,Map<String,String>>>emptyMap()));
  if (properties.containsKey("host_count")) {
    String predicate=String.valueOf(properties.get("host_predicate"));
    if (predicate != null && !predicate.isEmpty()) {
      try {
        hostGroupInfo.setPredicate(predicate);
      }
 catch (      InvalidQueryException e) {
        throw new InvalidTopologyTemplateException(String.format("Unable to compile host predicate '%s': %s",predicate,e),e);
      }
    }
    if (!hostGroupInfo.getHostNames().isEmpty()) {
      throw new InvalidTopologyTemplateException("Can't specify both host_name and host_count for the same hostgroup: " + hgName);
    }
    hostGroupInfo.setRequestedCount(Integer.valueOf(String.valueOf(properties.get("host_count"))));
  }
 else {
    if (hostGroupInfo.getRequestedHostCount() != hostGroupInfo.getHostNames().size()) {
      throw new InvalidTopologyTemplateException("Can't specify both host_name and host_count for the same hostgroup: " + hgName);
    }
    hostGroupInfo.addHost(getHostNameFromProperties(properties));
  }
}

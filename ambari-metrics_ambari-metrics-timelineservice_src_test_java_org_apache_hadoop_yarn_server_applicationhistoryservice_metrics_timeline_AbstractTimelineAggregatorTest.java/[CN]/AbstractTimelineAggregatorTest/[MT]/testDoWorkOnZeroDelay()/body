{
  clock.setTime(0);
  long sleep=agg.runOnce(sleepIntervalMillis);
  assertEquals("startTime should be zero",0,startTimeInDoWork.get());
  assertEquals("endTime  should be zero",0,endTimeInDoWork.get());
  assertEquals(0,checkPoint.get());
  assertEquals(sleep,sleepIntervalMillis);
  assertEquals("Do not aggregate on first run",0,actualRuns);
  clock.setTime(clock.getTime() + sleepIntervalMillis);
  sleep=agg.runOnce(sleepIntervalMillis);
  assertEquals("startTime",clock.getTime() - sleepIntervalMillis,startTimeInDoWork.get());
  assertEquals("endTime",clock.getTime(),endTimeInDoWork.get());
  assertEquals(clock.getTime(),checkPoint.get());
  assertEquals(sleep,sleepIntervalMillis);
  assertEquals(1,actualRuns);
  clock.setTime(clock.getTime() + sleepIntervalMillis);
  sleep=agg.runOnce(sleepIntervalMillis);
  assertEquals("startTime",clock.getTime() - sleepIntervalMillis,startTimeInDoWork.get());
  assertEquals("endTime",clock.getTime(),endTimeInDoWork.get());
  assertEquals(clock.getTime(),checkPoint.get());
  assertEquals(sleep,sleepIntervalMillis);
  assertEquals(2,actualRuns);
  clock.setTime(clock.getTime() + (checkpointCutOffMultiplier * sleepIntervalMillis));
  sleep=agg.runOnce(sleepIntervalMillis);
  assertEquals("startTime after 2xinterval",clock.getTime() - (checkpointCutOffMultiplier * sleepIntervalMillis),startTimeInDoWork.get());
  assertEquals("endTime after 2xinterval",clock.getTime() - sleepIntervalMillis,endTimeInDoWork.get());
  assertEquals("checkpoint after 2xinterval",clock.getTime() - sleepIntervalMillis,checkPoint.get());
  assertEquals(sleep,sleepIntervalMillis);
  assertEquals(3,actualRuns);
  clock.setTime(clock.getTime() + sleepIntervalMillis);
  sleep=agg.runOnce(sleepIntervalMillis);
  assertEquals("startTime ",clock.getTime() - (checkpointCutOffMultiplier * sleepIntervalMillis),startTimeInDoWork.get());
  assertEquals("endTime  ",clock.getTime() - sleepIntervalMillis,endTimeInDoWork.get());
  assertEquals("checkpoint ",clock.getTime() - sleepIntervalMillis,checkPoint.get());
  assertEquals(sleep,sleepIntervalMillis);
  assertEquals(4,actualRuns);
  clock.setTime(clock.getTime() + (checkpointCutOffMultiplier * sleepIntervalMillis));
  sleep=agg.runOnce(sleepIntervalMillis);
  assertEquals(4,actualRuns);
  assertEquals("checkpoint after too much lag is reset to " + "current clock time",clock.getTime(),checkPoint.get());
  assertEquals(sleep,sleepIntervalMillis);
}

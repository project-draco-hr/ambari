{
  ClusterEntity clusterEntity=clusterDAO.findByName("test_cluster1");
  if (clusterEntity.getClusterVersionEntities() != null && clusterEntity.getClusterVersionEntities().size() > 0) {
    ClusterVersionEntity installedClusterVersion=clusterVersionDAO.findByClusterAndStateCurrent(clusterEntity.getClusterName());
    installedClusterVersion.setState(RepositoryVersionState.INSTALLED);
    clusterVersionDAO.merge(installedClusterVersion);
  }
 else {
    Assert.fail("Cluster is expected to have at least one cluster version");
  }
  ClusterVersionEntity newClusterVersionEntity=new ClusterVersionEntity(clusterEntity,helper.getOrCreateRepositoryVersion(HDP_22_STACK,"2.2.0.1-996"),RepositoryVersionState.CURRENT,System.currentTimeMillis(),System.currentTimeMillis(),"admin");
  clusterEntity.addClusterVersionEntity(newClusterVersionEntity);
  clusterVersionDAO.create(newClusterVersionEntity);
  HostEntity[] hostEntities=clusterEntity.getHostEntities().toArray(new HostEntity[clusterEntity.getHostEntities().size()]);
  Arrays.sort(hostEntities);
  for (  HostEntity host : hostEntities) {
    HostVersionEntity hostVersionEntity=new HostVersionEntity(host,helper.getOrCreateRepositoryVersion(HDP_22_STACK,"2.2.0.1-996"),RepositoryVersionState.INSTALLED);
    hostVersionDAO.create(hostVersionEntity);
  }
  for (int i=0; i < hostEntities.length; i++) {
    RepositoryVersionState desiredState=null;
    if (i % 3 == 0) {
      desiredState=RepositoryVersionState.INSTALLED;
    }
    if (i % 3 == 1) {
      desiredState=RepositoryVersionState.UPGRADING;
    }
    if (i % 3 == 2) {
      desiredState=RepositoryVersionState.UPGRADE_FAILED;
    }
    HostVersionEntity hostVersionEntity=new HostVersionEntity(hostEntities[i],helper.getOrCreateRepositoryVersion(HDP_22_STACK,"2.2.1.0-500"),desiredState);
    hostVersionDAO.create(hostVersionEntity);
  }
}

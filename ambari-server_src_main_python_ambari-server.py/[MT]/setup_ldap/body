def setup_ldap():
    if (not is_root()):
        err = 'Ambari-server setup-ldap should be run with root-level privileges'
        raise FatalException(4, err)
    properties = get_ambari_properties()
    isSecure = get_is_secure(properties)
    ldap_property_list_reqd = [LDAP_PRIMARY_URL_PROPERTY, 'authentication.ldap.secondaryUrl', 'authentication.ldap.useSSL', 'authentication.ldap.userObjectClass', 'authentication.ldap.usernameAttribute', 'authentication.ldap.groupObjectClass', 'authentication.ldap.groupNamingAttr', 'authentication.ldap.groupMembershipAttr', 'authentication.ldap.baseDn', 'authentication.ldap.bindAnonymously']
    ldap_property_list_opt = ['authentication.ldap.managerDn', LDAP_MGR_PASSWORD_PROPERTY, SSL_TRUSTSTORE_TYPE_PROPERTY, SSL_TRUSTSTORE_PATH_PROPERTY, SSL_TRUSTSTORE_PASSWORD_PROPERTY]
    ldap_property_list_truststore = [SSL_TRUSTSTORE_TYPE_PROPERTY, SSL_TRUSTSTORE_PATH_PROPERTY, SSL_TRUSTSTORE_PASSWORD_PROPERTY]
    ldap_property_list_passwords = [LDAP_MGR_PASSWORD_PROPERTY, SSL_TRUSTSTORE_PASSWORD_PROPERTY]
    LDAP_PRIMARY_URL_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[0])
    LDAP_SECONDARY_URL_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[1])
    LDAP_USE_SSL_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[2], 'false')
    LDAP_USER_CLASS_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[3], 'posixAccount')
    LDAP_USER_ATT_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[4], 'uid')
    LDAP_GROUP_CLASS_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[5], 'posixGroup')
    LDAP_GROUP_ATT_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[6], 'cn')
    LDAP_GROUP_MEMBER_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[7], 'memberUid')
    LDAP_BASE_DN_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[8])
    LDAP_BIND_DEFAULT = get_value_from_properties(properties, ldap_property_list_reqd[9], 'false')
    LDAP_MGR_DN_DEFAULT = get_value_from_properties(properties, ldap_property_list_opt[0])
    SSL_TRUSTSTORE_TYPE_DEFAULT = get_value_from_properties(properties, SSL_TRUSTSTORE_TYPE_PROPERTY, 'jks')
    SSL_TRUSTSTORE_PATH_DEFAULT = get_value_from_properties(properties, SSL_TRUSTSTORE_PATH_PROPERTY)
    ldap_properties_map_reqd = {ldap_property_list_reqd[0]: (LDAP_PRIMARY_URL_DEFAULT, 'Primary URL* {{host:port}} {0}: '.format(get_prompt_default(LDAP_PRIMARY_URL_DEFAULT)), False), ldap_property_list_reqd[1]: (LDAP_SECONDARY_URL_DEFAULT, 'Secondary URL {{host:port}} {0}: '.format(get_prompt_default(LDAP_SECONDARY_URL_DEFAULT)), True), ldap_property_list_reqd[2]: (LDAP_USE_SSL_DEFAULT, 'Use SSL* [true/false] {0}: '.format(get_prompt_default(LDAP_USE_SSL_DEFAULT)), False), ldap_property_list_reqd[3]: (LDAP_USER_CLASS_DEFAULT, 'User object class* {0}: '.format(get_prompt_default(LDAP_USER_CLASS_DEFAULT)), False), ldap_property_list_reqd[4]: (LDAP_USER_ATT_DEFAULT, 'User name attribute* {0}: '.format(get_prompt_default(LDAP_USER_ATT_DEFAULT)), False), ldap_property_list_reqd[5]: (LDAP_GROUP_CLASS_DEFAULT, 'Group object class* {0}: '.format(get_prompt_default(LDAP_GROUP_CLASS_DEFAULT)), False), ldap_property_list_reqd[6]: (LDAP_GROUP_ATT_DEFAULT, 'Group name attribute* {0}: '.format(get_prompt_default(LDAP_GROUP_ATT_DEFAULT)), False), ldap_property_list_reqd[7]: (LDAP_GROUP_MEMBER_DEFAULT, 'Group member attribute* {0}: '.format(get_prompt_default(LDAP_GROUP_MEMBER_DEFAULT)), False), ldap_property_list_reqd[8]: (LDAP_BASE_DN_DEFAULT, 'Base DN* {0}: '.format(get_prompt_default(LDAP_BASE_DN_DEFAULT)), False), ldap_property_list_reqd[9]: (LDAP_BIND_DEFAULT, 'Bind anonymously* [true/false] {0}: '.format(get_prompt_default(LDAP_BIND_DEFAULT)), False), }
    ldap_property_value_map = {}
    for (idx, key) in enumerate(ldap_property_list_reqd):
        if (idx in [0, 1]):
            pattern = REGEX_HOSTNAME_PORT
        elif (idx in [2, 9]):
            pattern = REGEX_TRUE_FALSE
        else:
            pattern = REGEX_ANYTHING
        input = get_validated_string_input(ldap_properties_map_reqd[key][1], ldap_properties_map_reqd[key][0], pattern, 'Invalid characters in the input!', False, ldap_properties_map_reqd[key][2])
        if ((input is not None) and (input != '')):
            ldap_property_value_map[key] = input
    bindAnonymously = ldap_property_value_map['authentication.ldap.bindAnonymously']
    anonymous = (bindAnonymously and (bindAnonymously.lower() == 'true'))
    mgr_password = None
    if (not anonymous):
        username = get_validated_string_input('Manager DN* {0}: '.format(get_prompt_default(LDAP_MGR_DN_DEFAULT)), LDAP_MGR_DN_DEFAULT, '.*', 'Invalid characters in the input!', False, False)
        ldap_property_value_map[LDAP_MGR_USERNAME_PROPERTY] = username
        mgr_password = configure_ldap_password()
        ldap_property_value_map[LDAP_MGR_PASSWORD_PROPERTY] = mgr_password
    useSSL = ldap_property_value_map['authentication.ldap.useSSL']
    ldaps = (useSSL and (useSSL.lower() == 'true'))
    ts_password = None
    if ldaps:
        truststore_default = 'n'
        truststore_set = bool(SSL_TRUSTSTORE_PATH_DEFAULT)
        if truststore_set:
            truststore_default = 'y'
        custom_trust_store = get_YN_input('Do you want to provide custom TrustStore for Ambari [y/n] ({0})?'.format(truststore_default), truststore_set)
        if custom_trust_store:
            ts_type = get_validated_string_input('TrustStore type [jks/jceks/pkcs12] {0}:'.format(get_prompt_default(SSL_TRUSTSTORE_TYPE_DEFAULT)), SSL_TRUSTSTORE_TYPE_DEFAULT, '^(jks|jceks|pkcs12)?$', 'Wrong type', False)
            ts_path = None
            while True:
                ts_path = get_validated_string_input('Path to TrustStore file {0}:'.format(get_prompt_default(SSL_TRUSTSTORE_PATH_DEFAULT)), SSL_TRUSTSTORE_PATH_DEFAULT, '.*', False, False)
                if os.path.exists(ts_path):
                    break
                else:
                    print 'File not found.'
            ts_password = read_password('', '.*', 'Password for TrustStore:', 'Invalid characters in password')
            ldap_property_value_map[SSL_TRUSTSTORE_TYPE_PROPERTY] = ts_type
            ldap_property_value_map[SSL_TRUSTSTORE_PATH_PROPERTY] = ts_path
            ldap_property_value_map[SSL_TRUSTSTORE_PASSWORD_PROPERTY] = ts_password
            pass
        else:
            properties.removeOldProp(SSL_TRUSTSTORE_TYPE_PROPERTY)
            properties.removeOldProp(SSL_TRUSTSTORE_PATH_PROPERTY)
            properties.removeOldProp(SSL_TRUSTSTORE_PASSWORD_PROPERTY)
        pass
    pass
    print ('=' * 20)
    print 'Review Settings'
    print ('=' * 20)
    for property in ldap_property_list_reqd:
        if (property in ldap_property_value_map):
            print ('%s: %s' % (property, ldap_property_value_map[property]))
    for property in ldap_property_list_opt:
        if ldap_property_value_map.has_key(property):
            if (property not in ldap_property_list_passwords):
                print ('%s: %s' % (property, ldap_property_value_map[property]))
            else:
                print ('%s: %s' % (property, BLIND_PASSWORD))
    save_settings = get_YN_input('Save settings [y/n] (y)? ', True)
    if save_settings:
        ldap_property_value_map[CLIENT_SECURITY_KEY] = 'ldap'
        if isSecure:
            if mgr_password:
                encrypted_passwd = encrypt_password(LDAP_MGR_PASSWORD_ALIAS, mgr_password)
                if (mgr_password != encrypted_passwd):
                    ldap_property_value_map[LDAP_MGR_PASSWORD_PROPERTY] = encrypted_passwd
            pass
            if ts_password:
                encrypted_passwd = encrypt_password(SSL_TRUSTSTORE_PASSWORD_ALIAS, ts_password)
                if (ts_password != encrypted_passwd):
                    ldap_property_value_map[SSL_TRUSTSTORE_PASSWORD_PROPERTY] = encrypted_passwd
            pass
        pass
        ldap_property_value_map[IS_LDAP_CONFIGURED] = 'true'
        if mgr_password:
            ldap_property_value_map[LDAP_MGR_PASSWORD_PROPERTY] = store_password_file(mgr_password, LDAP_MGR_PASSWORD_FILENAME)
        update_properties(properties, ldap_property_value_map)
        print 'Saving...done'
    return 0

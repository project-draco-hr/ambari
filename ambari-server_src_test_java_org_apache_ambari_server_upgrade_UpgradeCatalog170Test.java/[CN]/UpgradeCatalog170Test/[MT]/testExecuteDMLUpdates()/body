{
  Configuration configuration=createNiceMock(Configuration.class);
  DBAccessor dbAccessor=createNiceMock(DBAccessor.class);
  Injector injector=createNiceMock(Injector.class);
  ConfigHelper configHelper=createNiceMock(ConfigHelper.class);
  AmbariManagementController amc=createNiceMock(AmbariManagementController.class);
  Cluster cluster=createStrictMock(Cluster.class);
  Clusters clusters=createStrictMock(Clusters.class);
  Config config=createStrictMock(Config.class);
  Method m=AbstractUpgradeCatalog.class.getDeclaredMethod("updateConfigurationProperties",String.class,Map.class,boolean.class,boolean.class);
  UpgradeCatalog170 upgradeCatalog=createMockBuilder(UpgradeCatalog170.class).addMockedMethod(m).createMock();
  Map<String,Cluster> clustersMap=new HashMap<String,Cluster>();
  clustersMap.put("c1",cluster);
  Map<String,String> globalConfigs=new HashMap<String,String>();
  globalConfigs.put("prop1","val1");
  globalConfigs.put("smokeuser_keytab","val2");
  Set<String> envDicts=new HashSet<String>();
  envDicts.add("hadoop-env");
  envDicts.add("global");
  Map<String,String> contentOfHadoopEnv=new HashMap<String,String>();
  contentOfHadoopEnv.put("content","env file contents");
  upgradeCatalog.updateConfigurationProperties("hadoop-env",globalConfigs,true,true);
  expectLastCall();
  upgradeCatalog.updateConfigurationProperties("hadoop-env",contentOfHadoopEnv,true,true);
  expectLastCall();
  upgradeCatalog.updateConfigurationProperties("hbase-env",Collections.singletonMap("hbase_regionserver_xmn_max","512"),false,false);
  expectLastCall();
  upgradeCatalog.updateConfigurationProperties("hbase-env",Collections.singletonMap("hbase_regionserver_xmn_ratio","0.2"),false,false);
  expectLastCall();
  expect(configuration.getDatabaseUrl()).andReturn(Configuration.JDBC_IN_MEMORY_URL).anyTimes();
  expect(injector.getInstance(ConfigHelper.class)).andReturn(configHelper).anyTimes();
  expect(injector.getInstance(AmbariManagementController.class)).andReturn(amc).anyTimes();
  expect(amc.getClusters()).andReturn(clusters).anyTimes();
  expect(clusters.getClusters()).andReturn(clustersMap).anyTimes();
  expect(cluster.getDesiredConfigByType("global")).andReturn(config).anyTimes();
  expect(config.getProperties()).andReturn(globalConfigs).anyTimes();
  expect(cluster.getCurrentStackVersion()).andReturn(new StackId("HDP","2.1")).anyTimes();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"prop1")).andReturn(envDicts).once();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"smokeuser_keytab")).andReturn(new HashSet<String>()).once();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"content")).andReturn(envDicts).once();
  expect(configHelper.getPropertyValueFromStackDefenitions(cluster,"hadoop-env","content")).andReturn("env file contents").once();
  replay(upgradeCatalog,dbAccessor,configuration,injector,cluster,clusters,amc,config,configHelper);
  Class<?> c=AbstractUpgradeCatalog.class;
  Field f=c.getDeclaredField("configuration");
  f.setAccessible(true);
  f.set(upgradeCatalog,configuration);
  f=c.getDeclaredField("dbAccessor");
  f.setAccessible(true);
  f.set(upgradeCatalog,dbAccessor);
  f=c.getDeclaredField("injector");
  f.setAccessible(true);
  f.set(upgradeCatalog,injector);
  upgradeCatalog.executeDMLUpdates();
  verify(upgradeCatalog,dbAccessor,configuration,injector,cluster,clusters,amc,config,configHelper);
}

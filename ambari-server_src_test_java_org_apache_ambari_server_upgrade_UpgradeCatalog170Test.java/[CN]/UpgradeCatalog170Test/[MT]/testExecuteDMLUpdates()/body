{
  Configuration configuration=createNiceMock(Configuration.class);
  DBAccessor dbAccessor=createNiceMock(DBAccessor.class);
  Injector injector=createNiceMock(Injector.class);
  ConfigHelper configHelper=createNiceMock(ConfigHelper.class);
  AmbariManagementController amc=createNiceMock(AmbariManagementController.class);
  Cluster cluster=createNiceMock(Cluster.class);
  Clusters clusters=createStrictMock(Clusters.class);
  Config config=createStrictMock(Config.class);
  Config pigConfig=createStrictMock(Config.class);
  ViewRegistry viewRegistry=createNiceMock(ViewRegistry.class);
  PermissionEntity adminPermission=createNiceMock(PermissionEntity.class);
  PermissionEntity viewUsePermission=createNiceMock(PermissionEntity.class);
  ClusterConfigEntity clusterConfigEntity=createNiceMock(ClusterConfigEntity.class);
  ConfigGroupConfigMappingDAO configGroupConfigMappingDAO=createNiceMock(ConfigGroupConfigMappingDAO.class);
  UserDAO userDAO=createNiceMock(UserDAO.class);
  PrincipalDAO principalDAO=createNiceMock(PrincipalDAO.class);
  PrincipalTypeDAO principalTypeDAO=createNiceMock(PrincipalTypeDAO.class);
  ClusterDAO clusterDAO=createNiceMock(ClusterDAO.class);
  ResourceTypeDAO resourceTypeDAO=createNiceMock(ResourceTypeDAO.class);
  ResourceDAO resourceDAO=createNiceMock(ResourceDAO.class);
  ViewDAO viewDAO=createNiceMock(ViewDAO.class);
  ViewInstanceDAO viewInstanceDAO=createNiceMock(ViewInstanceDAO.class);
  PermissionDAO permissionDAO=createNiceMock(PermissionDAO.class);
  PrivilegeDAO privilegeDAO=createNiceMock(PrivilegeDAO.class);
  KeyValueDAO keyValueDAO=createNiceMock(KeyValueDAO.class);
  EntityTransaction trans=createNiceMock(EntityTransaction.class);
  CriteriaBuilder cb=createNiceMock(CriteriaBuilder.class);
  CriteriaQuery<HostRoleCommandEntity> cq=createNiceMock(CriteriaQuery.class);
  Root<HostRoleCommandEntity> hrc=createNiceMock(Root.class);
  Path<Long> taskId=null;
  Path<String> outputLog=null;
  Path<String> errorLog=null;
  Order o=createNiceMock(Order.class);
  TypedQuery<HostRoleCommandEntity> q=createNiceMock(TypedQuery.class);
  List<HostRoleCommandEntity> r=new ArrayList<HostRoleCommandEntity>();
  ResultSet userRolesResultSet=createNiceMock(ResultSet.class);
  ClusterEntity clusterEntity=createNiceMock(ClusterEntity.class);
  ClusterConfigEntity configEntity=createNiceMock(ClusterConfigEntity.class);
  Method m=AbstractUpgradeCatalog.class.getDeclaredMethod("updateConfigurationProperties",String.class,Map.class,boolean.class,boolean.class);
  Method n=AbstractUpgradeCatalog.class.getDeclaredMethod("getEntityManagerProvider");
  Method l=AbstractUpgradeCatalog.class.getDeclaredMethod("addNewConfigurationsFromXml");
  Method newPropMap=UpgradeCatalog170.class.getDeclaredMethod("getNewPropertyName");
  UpgradeCatalog170 upgradeCatalog=createMockBuilder(UpgradeCatalog170.class).addMockedMethod(m).addMockedMethod(n).addMockedMethod(l).addMockedMethod(newPropMap).createMock();
  List<ConfigGroupConfigMappingEntity> configGroupConfigMappingEntities=new ArrayList<ConfigGroupConfigMappingEntity>();
  ConfigGroupConfigMappingEntity configGroupConfigMappingEntity=new ConfigGroupConfigMappingEntity();
  configGroupConfigMappingEntity.setConfigType(Configuration.GLOBAL_CONFIG_TAG);
  configGroupConfigMappingEntity.setClusterConfigEntity(clusterConfigEntity);
  configGroupConfigMappingEntity.setClusterId(1L);
  configGroupConfigMappingEntities.add(configGroupConfigMappingEntity);
  Map<String,Cluster> clustersMap=new HashMap<String,Cluster>();
  clustersMap.put("c1",cluster);
  Map<String,String> globalConfigs=new HashMap<String,String>();
  globalConfigs.put("prop1","val1");
  globalConfigs.put("smokeuser_keytab","val2");
  Map<String,String> pigSettings=new HashMap<String,String>();
  pigSettings.put("pig-content","foo");
  Set<String> envDicts=new HashSet<String>();
  envDicts.add("hadoop-env");
  envDicts.add("global");
  Set<String> configTypes=new HashSet<String>();
  configTypes.add("hadoop-env");
  Map<String,String> contentOfHadoopEnv=new HashMap<String,String>();
  contentOfHadoopEnv.put("content","env file contents");
  upgradeCatalog.updateConfigurationProperties("hadoop-env",globalConfigs,false,true);
  expectLastCall();
  upgradeCatalog.addNewConfigurationsFromXml();
  expectLastCall();
  expect(dbAccessor.executeSelect("SELECT role_name, user_id FROM user_roles")).andReturn(userRolesResultSet).once();
  expect(entityManager.getTransaction()).andReturn(trans).anyTimes();
  expect(entityManager.getCriteriaBuilder()).andReturn(cb).anyTimes();
  expect(entityManager.createQuery(cq)).andReturn(q).anyTimes();
  expect(trans.isActive()).andReturn(true).anyTimes();
  expect(upgradeCatalog.getEntityManagerProvider()).andReturn(entityManagerProvider).anyTimes();
  expect(upgradeCatalog.getNewPropertyName()).andReturn(new HashMap<String,String>()).anyTimes();
  expect(cb.createQuery(HostRoleCommandEntity.class)).andReturn(cq).anyTimes();
  expect(cb.desc(taskId)).andReturn(o).anyTimes();
  expect(cq.from(HostRoleCommandEntity.class)).andReturn(hrc).anyTimes();
  expect(cq.select(hrc)).andReturn(cq).anyTimes();
  expect(cq.where(anyObject(Predicate.class))).andReturn(cq).anyTimes();
  expect(hrc.get(isA(SingularAttribute.class))).andReturn(taskId).times(2);
  expect(hrc.get(isA(SingularAttribute.class))).andReturn(outputLog).once();
  expect(hrc.get(isA(SingularAttribute.class))).andReturn(errorLog).once();
  expect(q.setMaxResults(1000)).andReturn(q).anyTimes();
  expect(q.getResultList()).andReturn(r).anyTimes();
  expect(clusterConfigEntity.getData()).andReturn("{\"dtnode_heapsize\":\"1028m\"}");
  expect(configuration.getDatabaseUrl()).andReturn(Configuration.JDBC_IN_MEMORY_URL).anyTimes();
  expect(injector.getInstance(ConfigHelper.class)).andReturn(configHelper).anyTimes();
  expect(injector.getInstance(AmbariManagementController.class)).andReturn(amc).anyTimes();
  expect(amc.getClusters()).andReturn(clusters).anyTimes();
  expect(clusters.getClusters()).andReturn(clustersMap).anyTimes();
  expect(clusters.getClusterById(1L)).andReturn(clustersMap.values().iterator().next()).anyTimes();
  expect(clusters.getClusters()).andReturn(clustersMap).times(1);
  expect(cluster.getDesiredConfigByType("global")).andReturn(config).anyTimes();
  expect(cluster.getDesiredConfigByType("oozie-log4j")).andReturn(config).anyTimes();
  expect(cluster.getDesiredConfigByType("oozie-env")).andReturn(config).anyTimes();
  expect(cluster.getClusterId()).andReturn(1L);
  expect(cluster.getNextConfigVersion("hadoop-env")).andReturn(3L);
  expect(config.getProperties()).andReturn(globalConfigs).anyTimes();
  expect(cluster.getCurrentStackVersion()).andReturn(new StackId("HDP","2.1")).anyTimes();
  expect(cluster.getClusterName()).andReturn("c1").anyTimes();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"prop1","c1")).andReturn(envDicts).once();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"smokeuser_keytab","c1")).andReturn(new HashSet<String>()).once();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"content","c1")).andReturn(envDicts).once();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"dtnode_heapsize","c1")).andReturn(configTypes).once();
  expect(injector.getInstance(ConfigGroupConfigMappingDAO.class)).andReturn(configGroupConfigMappingDAO).anyTimes();
  expect(injector.getInstance(UserDAO.class)).andReturn(userDAO).anyTimes();
  expect(injector.getInstance(PrincipalDAO.class)).andReturn(principalDAO).anyTimes();
  expect(injector.getInstance(PrincipalTypeDAO.class)).andReturn(principalTypeDAO).anyTimes();
  expect(injector.getInstance(ClusterDAO.class)).andReturn(clusterDAO).anyTimes();
  expect(injector.getInstance(ResourceTypeDAO.class)).andReturn(resourceTypeDAO).anyTimes();
  expect(injector.getInstance(ResourceDAO.class)).andReturn(resourceDAO).anyTimes();
  expect(injector.getInstance(ViewDAO.class)).andReturn(viewDAO).anyTimes();
  expect(injector.getInstance(ViewInstanceDAO.class)).andReturn(viewInstanceDAO).anyTimes();
  expect(injector.getInstance(PermissionDAO.class)).andReturn(permissionDAO).anyTimes();
  expect(injector.getInstance(PrivilegeDAO.class)).andReturn(privilegeDAO).anyTimes();
  expect(injector.getInstance(KeyValueDAO.class)).andReturn(keyValueDAO).anyTimes();
  expect(injector.getInstance(ViewRegistry.class)).andReturn(viewRegistry).anyTimes();
  expect(userRolesResultSet.next()).andReturn(true).times(3);
  expect(userRolesResultSet.next()).andReturn(false).times(1);
  expect(userRolesResultSet.getString(1)).andReturn("admin").times(1);
  expect(userRolesResultSet.getString(1)).andReturn("user").times(2);
  expect(userRolesResultSet.getInt(2)).andReturn(1).times(2);
  expect(userRolesResultSet.getInt(2)).andReturn(2).times(1);
  UserEntity userEntity1=createNiceMock(UserEntity.class);
  UserEntity userEntity2=createNiceMock(UserEntity.class);
  PrincipalEntity userPrincipal1=createNiceMock(PrincipalEntity.class);
  PrincipalEntity userPrincipal2=createNiceMock(PrincipalEntity.class);
  Set<PrivilegeEntity> userPrivileges1=createNiceMock(Set.class);
  Set<PrivilegeEntity> userPrivileges2=createNiceMock(Set.class);
  expect(userEntity1.getPrincipal()).andReturn(userPrincipal1).anyTimes();
  expect(userEntity2.getPrincipal()).andReturn(userPrincipal2).anyTimes();
  expect(userPrincipal1.getPrivileges()).andReturn(userPrivileges1).anyTimes();
  expect(userPrincipal2.getPrivileges()).andReturn(userPrivileges2).anyTimes();
  expect(userPrivileges1.add(anyObject(PrivilegeEntity.class))).andReturn(true).once();
  expect(userDAO.findByPK(1)).andReturn(userEntity1).times(2);
  expect(userDAO.findByPK(2)).andReturn(userEntity2).once();
  expect(userDAO.merge(userEntity1)).andReturn(userEntity1).once();
  expect(userDAO.merge(userEntity2)).andReturn(userEntity2).once();
  expect(configGroupConfigMappingDAO.findAll()).andReturn(configGroupConfigMappingEntities).once();
  expect(userDAO.findAll()).andReturn(Collections.<UserEntity>emptyList()).times(1);
  expect(userDAO.findAll()).andReturn(Arrays.asList(userEntity1,userEntity2)).times(1);
  expect(clusterDAO.findAll()).andReturn(Collections.<ClusterEntity>emptyList()).times(2);
  String yarnConfig=String.format("{'%s':'%s', '%s':'%s'}",YARN_TIMELINE_SERVICE_WEBAPP_ADDRESS_PROPERTY,"timeline:8081",YARN_RESOURCEMANAGER_WEBAPP_ADDRESS_PROPERTY,"resource_man:8081");
  expect(configGroupConfigMappingDAO.findAll()).andReturn(configGroupConfigMappingEntities).once();
  expect(clusterDAO.findAll()).andReturn(Collections.singletonList(clusterEntity)).anyTimes();
  expect(configEntity.getData()).andReturn(yarnConfig);
  expect(clusterDAO.findConfig(1L,YARN_SITE,"version1")).andReturn(configEntity).anyTimes();
  expect(viewDAO.findAll()).andReturn(Collections.<ViewEntity>emptyList()).anyTimes();
  expect(viewInstanceDAO.findAll()).andReturn(Collections.<ViewInstanceEntity>emptyList()).anyTimes();
  expect(permissionDAO.findAmbariAdminPermission()).andReturn(adminPermission).anyTimes();
  expect(permissionDAO.findViewUsePermission()).andReturn(viewUsePermission).anyTimes();
  expect(permissionDAO.findClusterOperatePermission()).andReturn(null);
  expect(permissionDAO.findClusterReadPermission()).andReturn(null);
  expect(cluster.getDesiredConfigByType("pig-properties")).andReturn(pigConfig).anyTimes();
  expect(pigConfig.getProperties()).andReturn(pigSettings).anyTimes();
  ViewEntity jobsView=createNiceMock(ViewEntity.class);
  KeyValueEntity showJobsKeyValue=createNiceMock(KeyValueEntity.class);
  UserEntity user=createNiceMock(UserEntity.class);
  ClusterConfigMappingEntity configMappingEntity=createNiceMock(ClusterConfigMappingEntity.class);
  ClusterStateEntity clusterStateEntity=createNiceMock(ClusterStateEntity.class);
  expect(clusterEntity.getClusterId()).andReturn(1L).anyTimes();
  expect(clusterEntity.getConfigMappingEntities()).andReturn(Collections.singleton(configMappingEntity)).times(2);
  expect(clusterEntity.getClusterStateEntity()).andReturn(clusterStateEntity).anyTimes();
  expect(clusterStateEntity.getCurrentStackVersion()).andReturn(CLUSTER_STATE_STACK_HDP_2_1);
  expect(configMappingEntity.getType()).andReturn(YARN_SITE).anyTimes();
  expect(configMappingEntity.isSelected()).andReturn(1).anyTimes();
  expect(configMappingEntity.getTag()).andReturn("version1");
  expect(userDAO.findAll()).andReturn(Collections.singletonList(user));
  expect(jobsView.getCommonName()).andReturn(JOBS_VIEW_NAME);
  expect(jobsView.getVersion()).andReturn("1.0.0");
  expect(viewDAO.findByCommonName(JOBS_VIEW_NAME)).andReturn(jobsView).once();
  expect(showJobsKeyValue.getValue()).andReturn("true");
  expect(keyValueDAO.findByKey(SHOW_JOBS_FOR_NON_ADMIN_KEY)).andReturn(showJobsKeyValue);
  expect(privilegeDAO.findAllByPrincipal(anyObject(List.class))).andReturn(Collections.<PrivilegeEntity>emptyList());
  expect(viewDAO.merge(jobsView)).andReturn(jobsView);
  resourceDAO.create(anyObject(ResourceEntity.class));
  expect(adminPermission.getId()).andReturn(3);
  expect(viewUsePermission.getId()).andReturn(4);
  viewInstanceDAO.create(anyObject(ViewInstanceEntity.class));
  expectLastCall().andAnswer(new IAnswer<Object>(){
    @Override public Object answer() throws Throwable {
      ((ViewInstanceEntity)getCurrentArguments()[0]).getResource().setId(1L);
      return null;
    }
  }
);
  keyValueDAO.remove(showJobsKeyValue);
  privilegeDAO.create(anyObject(PrivilegeEntity.class));
  replay(entityManager,trans,upgradeCatalog,cb,cq,hrc,q,userRolesResultSet);
  replay(dbAccessor,configuration,injector,cluster,clusters,amc,config,configHelper,pigConfig);
  replay(userDAO,clusterDAO,viewDAO,viewInstanceDAO,permissionDAO,configGroupConfigMappingDAO);
  replay(resourceTypeDAO,resourceDAO,keyValueDAO,privilegeDAO,clusterConfigEntity);
  replay(jobsView,showJobsKeyValue,user);
  replay(userEntity1,userEntity2,userPrincipal1,userPrincipal2,userPrivileges1,userPrivileges2);
  replay(viewRegistry,viewUsePermission,adminPermission);
  replay(clusterEntity,configEntity,configMappingEntity,clusterStateEntity);
  Class<?> c=AbstractUpgradeCatalog.class;
  Field f=c.getDeclaredField("configuration");
  f.setAccessible(true);
  f.set(upgradeCatalog,configuration);
  f=c.getDeclaredField("dbAccessor");
  f.setAccessible(true);
  f.set(upgradeCatalog,dbAccessor);
  f=c.getDeclaredField("injector");
  f.setAccessible(true);
  f.set(upgradeCatalog,injector);
  upgradeCatalog.executeDMLUpdates();
  verify(upgradeCatalog,dbAccessor,configuration,injector,cluster,clusters,amc,config,configHelper,jobsView,showJobsKeyValue,privilegeDAO,viewDAO,viewInstanceDAO,resourceDAO,keyValueDAO,userRolesResultSet,userEntity1,userEntity2,userPrincipal1,userPrincipal2,userPrivileges1,userPrivileges2,viewRegistry,clusterEntity,configEntity,configMappingEntity,clusterStateEntity);
}

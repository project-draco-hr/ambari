{
  ConfigGroupEntity configGroupEntity=new ConfigGroupEntity();
  ResourceTypeEntity resourceTypeEntity=resourceTypeDAO.findById(ResourceTypeEntity.CLUSTER_RESOURCE_TYPE);
  if (resourceTypeEntity == null) {
    resourceTypeEntity=new ResourceTypeEntity();
    resourceTypeEntity.setId(ResourceTypeEntity.CLUSTER_RESOURCE_TYPE);
    resourceTypeEntity.setName(ResourceTypeEntity.CLUSTER_RESOURCE_TYPE_NAME);
    resourceTypeEntity=resourceTypeDAO.merge(resourceTypeEntity);
  }
  StackEntity stackEntity=stackDAO.find("HDP","0.1");
  ResourceEntity resourceEntity=new ResourceEntity();
  resourceEntity.setResourceType(resourceTypeEntity);
  ClusterEntity clusterEntity=new ClusterEntity();
  clusterEntity.setClusterName(clusterName);
  clusterEntity.setResource(resourceEntity);
  clusterEntity.setDesiredStack(stackEntity);
  clusterDAO.create(clusterEntity);
  configGroupEntity.setClusterEntity(clusterEntity);
  configGroupEntity.setClusterId(clusterEntity.getClusterId());
  configGroupEntity.setGroupName(groupName);
  configGroupEntity.setDescription(desc);
  configGroupEntity.setTag(tag);
  configGroupDAO.create(configGroupEntity);
  if (hosts != null && !hosts.isEmpty()) {
    List<ConfigGroupHostMappingEntity> hostMappingEntities=new ArrayList<ConfigGroupHostMappingEntity>();
    for (    HostEntity host : hosts) {
      host.setClusterEntities(Arrays.asList(clusterEntity));
      hostDAO.create(host);
      ConfigGroupHostMappingEntity hostMappingEntity=new ConfigGroupHostMappingEntity();
      hostMappingEntity.setHostId(host.getHostId());
      hostMappingEntity.setHostEntity(host);
      hostMappingEntity.setConfigGroupEntity(configGroupEntity);
      hostMappingEntity.setConfigGroupId(configGroupEntity.getGroupId());
      hostMappingEntities.add(hostMappingEntity);
      configGroupHostMappingDAO.create(hostMappingEntity);
    }
    configGroupEntity.setConfigGroupHostMappingEntities(hostMappingEntities);
    configGroupDAO.merge(configGroupEntity);
  }
  if (configs != null && !configs.isEmpty()) {
    List<ConfigGroupConfigMappingEntity> configMappingEntities=new ArrayList<ConfigGroupConfigMappingEntity>();
    for (    ClusterConfigEntity config : configs) {
      config.setClusterEntity(clusterEntity);
      config.setClusterId(clusterEntity.getClusterId());
      clusterDAO.createConfig(config);
      ConfigGroupConfigMappingEntity configMappingEntity=new ConfigGroupConfigMappingEntity();
      configMappingEntity.setClusterId(clusterEntity.getClusterId());
      configMappingEntity.setClusterConfigEntity(config);
      configMappingEntity.setConfigGroupEntity(configGroupEntity);
      configMappingEntity.setConfigGroupId(configGroupEntity.getGroupId());
      configMappingEntity.setVersionTag(config.getTag());
      configMappingEntity.setConfigType(config.getType());
      configMappingEntity.setTimestamp(System.currentTimeMillis());
      configMappingEntities.add(configMappingEntity);
      configGroupConfigMappingDAO.create(configMappingEntity);
    }
    configGroupEntity.setConfigGroupConfigMappingEntities(configMappingEntities);
    configGroupDAO.merge(configGroupEntity);
  }
  return configGroupEntity;
}

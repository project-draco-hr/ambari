{
  makeDowngradeCluster();
  Map<String,String> commandParams=new HashMap<String,String>();
  commandParams.put("upgrade_direction","downgrade");
  commandParams.put("version",DOWNGRADE_VERSION);
  ExecutionCommand executionCommand=new ExecutionCommand();
  executionCommand.setCommandParams(commandParams);
  executionCommand.setClusterName("c1");
  HostRoleCommand hostRoleCommand=hostRoleCommandFactory.create(null,null,null,null);
  hostRoleCommand.setExecutionCommandWrapper(new ExecutionCommandWrapper(executionCommand));
  FinalizeUpgradeAction action=m_injector.getInstance(FinalizeUpgradeAction.class);
  action.setExecutionCommand(executionCommand);
  action.setHostRoleCommand(hostRoleCommand);
  CommandReport report=action.execute(null);
  assertNotNull(report);
  assertEquals(HostRoleStatus.COMPLETED.name(),report.getStatus());
  for (  HostVersionEntity entity : hostVersionDAO.findByClusterAndHost("c1","h1")) {
    if (entity.getRepositoryVersion().getVersion().equals(DOWNGRADE_VERSION)) {
      assertEquals(RepositoryVersionState.CURRENT,entity.getState());
    }
 else     if (entity.getRepositoryVersion().getVersion().equals(UPGRADE_VERSION)) {
      assertEquals(RepositoryVersionState.INSTALLED,entity.getState());
    }
  }
  for (  ClusterVersionEntity entity : clusterVersionDAO.findByCluster("c1")) {
    if (entity.getRepositoryVersion().getVersion().equals(DOWNGRADE_VERSION)) {
      assertEquals(RepositoryVersionState.CURRENT,entity.getState());
    }
 else     if (entity.getRepositoryVersion().getVersion().equals(UPGRADE_VERSION)) {
      assertEquals(RepositoryVersionState.INSTALLED,entity.getState());
    }
  }
}

{
  makeCrossStackUpgradeCluster();
  Clusters clusters=m_injector.getInstance(Clusters.class);
  Cluster cluster=clusters.getCluster("c1");
  Service service=installService(cluster,"HDFS");
  addServiceComponent(cluster,service,"NAMENODE");
  addServiceComponent(cluster,service,"DATANODE");
  createNewServiceComponentHost(cluster,"HDFS","NAMENODE","h1");
  createNewServiceComponentHost(cluster,"HDFS","DATANODE","h1");
  createConfigs(cluster);
  cluster.setCurrentStackVersion(HDP_21_STACK);
  cluster.setDesiredStackVersion(HDP_22_STACK);
  createConfigs(cluster);
  cluster=clusters.getCluster("c1");
  Collection<Config> configs=cluster.getAllConfigs();
  assertEquals(6,configs.size());
  Map<String,String> commandParams=new HashMap<String,String>();
  commandParams.put(FinalizeUpgradeAction.UPGRADE_DIRECTION_KEY,"downgrade");
  commandParams.put(FinalizeUpgradeAction.VERSION_KEY,HDP_2_1_1_0);
  commandParams.put(FinalizeUpgradeAction.ORIGINAL_STACK_KEY,HDP_21_STACK.getStackId());
  commandParams.put(FinalizeUpgradeAction.TARGET_STACK_KEY,HDP_22_STACK.getStackId());
  ExecutionCommand executionCommand=new ExecutionCommand();
  executionCommand.setCommandParams(commandParams);
  executionCommand.setClusterName("c1");
  HostRoleCommand hostRoleCommand=hostRoleCommandFactory.create(null,null,null,null);
  hostRoleCommand.setExecutionCommandWrapper(new ExecutionCommandWrapper(executionCommand));
  FinalizeUpgradeAction action=m_injector.getInstance(FinalizeUpgradeAction.class);
  action.setExecutionCommand(executionCommand);
  action.setHostRoleCommand(hostRoleCommand);
  CommandReport report=action.execute(null);
  assertNotNull(report);
  assertEquals(HostRoleStatus.COMPLETED.name(),report.getStatus());
  StackId currentStackId=cluster.getCurrentStackVersion();
  StackId desiredStackId=cluster.getDesiredStackVersion();
  assertEquals(desiredStackId,currentStackId);
  assertEquals(HDP_21_STACK,currentStackId);
  assertEquals(HDP_21_STACK,desiredStackId);
  cluster=clusters.getCluster("c1");
  configs=cluster.getAllConfigs();
  assertEquals(3,configs.size());
}

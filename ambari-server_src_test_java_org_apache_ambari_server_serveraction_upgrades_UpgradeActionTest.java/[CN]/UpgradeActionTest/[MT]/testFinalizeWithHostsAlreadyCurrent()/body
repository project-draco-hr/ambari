{
  StackId sourceStack=HDP_21_STACK;
  StackId targetStack=HDP_21_STACK;
  String sourceRepo=HDP_2_1_1_0;
  String targetRepo=HDP_2_1_1_1;
  makeUpgradeCluster(sourceStack,sourceRepo,targetStack,targetRepo);
  List<HostVersionEntity> hostVersions=hostVersionDAO.findAll();
  for (  HostVersionEntity hostVersion : hostVersions) {
    if (hostVersion.getState() == RepositoryVersionState.CURRENT) {
      hostVersion.setState(RepositoryVersionState.INSTALLED);
    }
 else {
      hostVersion.setState(RepositoryVersionState.CURRENT);
    }
    hostVersionDAO.merge(hostVersion);
  }
  AmbariMetaInfo metaInfo=m_injector.getInstance(AmbariMetaInfo.class);
  AmbariCustomCommandExecutionHelper helper=m_injector.getInstance(AmbariCustomCommandExecutionHelper.class);
  Host host=clusters.getHost("h1");
  Cluster cluster=clusters.getCluster("c1");
  RepositoryInfo repo=metaInfo.getRepository(sourceStack.getStackName(),sourceStack.getStackVersion(),"redhat6",sourceStack.getStackId());
  assertEquals(HDP_211_CENTOS6_REPO_URL,repo.getBaseUrl());
  verifyBaseRepoURL(helper,cluster,host,HDP_211_CENTOS6_REPO_URL);
  Map<String,String> commandParams=new HashMap<String,String>();
  commandParams.put(FinalizeUpgradeAction.UPGRADE_DIRECTION_KEY,"upgrade");
  commandParams.put(FinalizeUpgradeAction.VERSION_KEY,targetRepo);
  ExecutionCommand executionCommand=new ExecutionCommand();
  executionCommand.setCommandParams(commandParams);
  executionCommand.setClusterName("c1");
  HostRoleCommand hostRoleCommand=hostRoleCommandFactory.create(null,null,null,null);
  hostRoleCommand.setExecutionCommandWrapper(new ExecutionCommandWrapper(executionCommand));
  FinalizeUpgradeAction action=m_injector.getInstance(FinalizeUpgradeAction.class);
  action.setExecutionCommand(executionCommand);
  action.setHostRoleCommand(hostRoleCommand);
  CommandReport report=action.execute(null);
  assertNotNull(report);
  assertEquals(HostRoleStatus.COMPLETED.name(),report.getStatus());
}

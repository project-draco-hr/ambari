{
  String clusterName="c1";
  String hostName="h1";
  StackId stackId=new StackId("HDP-2.1.1");
  Clusters clusters=m_injector.getInstance(Clusters.class);
  clusters.addCluster(clusterName,stackId);
  Cluster c=clusters.getCluster(clusterName);
  clusters.addHost(hostName);
  Host host=clusters.getHost(hostName);
  Map<String,String> hostAttributes=new HashMap<String,String>();
  hostAttributes.put("os_family","redhat");
  hostAttributes.put("os_release_version","6");
  host.setHostAttributes(hostAttributes);
  host.persist();
  OrmTestHelper helper=m_injector.getInstance(OrmTestHelper.class);
  helper.getOrCreateRepositoryVersion(stackId,DOWNGRADE_VERSION);
  helper.getOrCreateRepositoryVersion(stackId,UPGRADE_VERSION);
  RepositoryVersionDAO repoVersionDao=m_injector.getInstance(RepositoryVersionDAO.class);
  HostVersionDAO hostVersionDao=m_injector.getInstance(HostVersionDAO.class);
  c.createClusterVersion(stackId,DOWNGRADE_VERSION,"admin",RepositoryVersionState.UPGRADING);
  c.createClusterVersion(stackId,UPGRADE_VERSION,"admin",RepositoryVersionState.INSTALLING);
  c.transitionClusterVersion(stackId,DOWNGRADE_VERSION,RepositoryVersionState.CURRENT);
  c.transitionClusterVersion(stackId,UPGRADE_VERSION,RepositoryVersionState.INSTALLED);
  c.transitionClusterVersion(stackId,UPGRADE_VERSION,RepositoryVersionState.UPGRADING);
  c.mapHostVersions(Collections.singleton(hostName),c.getCurrentClusterVersion(),RepositoryVersionState.CURRENT);
  HostDAO hostDAO=m_injector.getInstance(HostDAO.class);
  HostVersionEntity entity=new HostVersionEntity();
  entity.setHostEntity(hostDAO.findByName(hostName));
  entity.setHostName(hostName);
  entity.setRepositoryVersion(repoVersionDao.findByStackAndVersion(stackId,UPGRADE_VERSION));
  entity.setState(RepositoryVersionState.UPGRADING);
  hostVersionDao.create(entity);
}

{
  String hostName="h1";
  clusters.addCluster(clusterName,sourceStack);
  StackEntity stackEntitySource=stackDAO.find(sourceStack.getStackName(),sourceStack.getStackVersion());
  StackEntity stackEntityTarget=stackDAO.find(targetStack.getStackName(),targetStack.getStackVersion());
  assertNotNull(stackEntitySource);
  assertNotNull(stackEntityTarget);
  Cluster c=clusters.getCluster(clusterName);
  c.setDesiredStackVersion(sourceStack);
  clusters.addHost(hostName);
  Host host=clusters.getHost(hostName);
  Map<String,String> hostAttributes=new HashMap<String,String>();
  hostAttributes.put("os_family","redhat");
  hostAttributes.put("os_release_version","6");
  host.setHostAttributes(hostAttributes);
  host.persist();
  clusters.mapHostsToCluster(Collections.singleton(hostName),clusterName);
  RepositoryVersionEntity repoEntity=m_helper.getOrCreateRepositoryVersion(sourceStack,sourceRepo);
  repoEntity.setOperatingSystems("[\n" + "   {\n" + "      \"repositories\":[\n"+ "         {\n"+ "            \"Repositories/base_url\":\"http://s3.amazonaws.com/dev.hortonworks.com/HDP/centos5/2.x/updates/2.2.0.0\",\n"+ "            \"Repositories/repo_name\":\"HDP\",\n"+ "            \"Repositories/repo_id\":\"HDP-2.2\"\n"+ "         }\n"+ "      ],\n"+ "      \"OperatingSystems/os_type\":\"redhat6\"\n"+ "   }\n"+ "]");
  repoVersionDAO.merge(repoEntity);
  c.createClusterVersion(sourceStack,sourceRepo,"admin",RepositoryVersionState.INSTALLING);
  c.transitionClusterVersion(sourceStack,sourceRepo,RepositoryVersionState.CURRENT);
  String urlInfo="[{'repositories':[" + "{'Repositories/base_url':'http://foo1','Repositories/repo_name':'HDP','Repositories/repo_id':'" + targetStack.getStackId() + "'}"+ "], 'OperatingSystems/os_type':'redhat6'}]";
  repoVersionDAO.create(stackEntityTarget,targetRepo,String.valueOf(System.currentTimeMillis()),urlInfo);
  c.createClusterVersion(targetStack,targetRepo,"admin",RepositoryVersionState.INSTALLING);
  c.transitionClusterVersion(targetStack,targetRepo,RepositoryVersionState.INSTALLED);
  c.setCurrentStackVersion(targetStack);
  c.mapHostVersions(Collections.singleton(hostName),c.getCurrentClusterVersion(),RepositoryVersionState.CURRENT);
  HostDAO hostDAO=m_injector.getInstance(HostDAO.class);
  RepositoryVersionEntity repositoryVersionEntity=repoVersionDAO.findByStackAndVersion(targetStack,targetRepo);
  HostVersionEntity entity=new HostVersionEntity(hostDAO.findByName(hostName),repositoryVersionEntity,RepositoryVersionState.INSTALLED);
  hostVersionDAO.create(entity);
  List<HostVersionEntity> hostVersions=hostVersionDAO.findByClusterStackAndVersion(clusterName,targetStack,targetRepo);
  assertEquals(1,hostVersions.size());
  assertEquals(RepositoryVersionState.INSTALLED,hostVersions.get(0).getState());
}

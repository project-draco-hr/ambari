{
  Request request=createNiceMock(Request.class);
  ResourceInstance resourceInstance=createNiceMock(ResourceInstance.class);
  ResourceDefinition resourceDefinition=createNiceMock(ResourceDefinition.class);
  ResourceInstanceFactory resourceInstanceFactory=createNiceMock(ResourceInstanceFactory.class);
  Query query=createNiceMock(Query.class);
  Predicate predicate=createNiceMock(Predicate.class);
  Result result=createNiceMock(Result.class);
  ResourceInstance subResource1=createNiceMock(ResourceInstance.class);
  ResourceInstance subResource2=createNiceMock(ResourceInstance.class);
  ResourceDefinition subResourceDefinition1=createNiceMock(ResourceDefinition.class);
  ResourceDefinition subResourceDefinition2=createNiceMock(ResourceDefinition.class);
  ClusterController controller=createNiceMock(ClusterController.class);
  Schema serviceSchema=createNiceMock(Schema.class);
  Schema subResSchema1=createNiceMock(Schema.class);
  Schema subResSchema2=createNiceMock(Schema.class);
  String resourceKeyProperty="resourceKeyProperty";
  String createKeyProperty="createKeyProperty";
  Resource resource1=createNiceMock(Resource.class);
  Resource resource2=createNiceMock(Resource.class);
  PersistenceManager pm=createNiceMock(PersistenceManager.class);
  ResourceInstance createResource=createNiceMock(ResourceInstance.class);
  RequestStatus status=createNiceMock(RequestStatus.class);
  Resource statusResource1=createNiceMock(Resource.class);
  Resource statusResource2=createNiceMock(Resource.class);
  RequestHandler readHandler=createStrictMock(RequestHandler.class);
  ResultStatus queryResultStatus=createNiceMock(ResultStatus.class);
  Map<Resource.Type,String> mapIds=new HashMap<Resource.Type,String>();
  Set<NamedPropertySet> setRequestProps=new HashSet<NamedPropertySet>();
  setRequestProps.add(new NamedPropertySet("foo",Collections.<String,Object>singletonMap(PropertyHelper.getPropertyId("ServiceComponentInfo","component_name"),"SECONDARY_NAMENODE")));
  setRequestProps.add(new NamedPropertySet("bar",Collections.<String,Object>singletonMap(PropertyHelper.getPropertyId("ServiceComponentInfo","component_name"),"HDFS_CLIENT")));
  Map<String,ResourceInstance> mapSubResources=new HashMap<String,ResourceInstance>();
  mapSubResources.put("foo",subResource1);
  mapSubResources.put("bar",subResource2);
  TreeNode<Resource> resultTree=new TreeNodeImpl<Resource>(null,null,"result");
  resultTree.addChild(resource1,"resource1");
  resultTree.addChild(resource2,"resource2");
  expect(readHandler.handleRequest(request)).andReturn(result);
  expect(result.getStatus()).andReturn(queryResultStatus).anyTimes();
  expect(queryResultStatus.isErrorState()).andReturn(false);
  expect(result.getResultTree()).andReturn(resultTree);
  expect(request.getResource()).andReturn(resourceInstance).anyTimes();
  expect(request.getHttpBodyProperties()).andReturn(setRequestProps).anyTimes();
  expect(resourceInstance.getResourceDefinition()).andReturn(resourceDefinition).anyTimes();
  expect(resourceInstance.getIds()).andReturn(mapIds).anyTimes();
  expect(resourceInstance.getSubResources()).andReturn(mapSubResources).anyTimes();
  expect(resourceDefinition.getType()).andReturn(Resource.Type.Service).anyTimes();
  expect(subResource1.getResourceDefinition()).andReturn(subResourceDefinition1).anyTimes();
  expect(subResourceDefinition1.getType()).andReturn(Resource.Type.Component).anyTimes();
  expect(subResource2.getResourceDefinition()).andReturn(subResourceDefinition2).anyTimes();
  expect(subResourceDefinition2.getType()).andReturn(Resource.Type.HostComponent).anyTimes();
  expect(controller.getSchema(Resource.Type.Service)).andReturn(serviceSchema).anyTimes();
  expect(controller.getSchema(Resource.Type.Component)).andReturn(subResSchema1).anyTimes();
  expect(controller.getSchema(Resource.Type.HostComponent)).andReturn(subResSchema2).anyTimes();
  expect(serviceSchema.getKeyPropertyId(Resource.Type.Service)).andReturn(resourceKeyProperty).anyTimes();
  expect(subResSchema1.getKeyPropertyId(Resource.Type.Service)).andReturn(createKeyProperty).anyTimes();
  expect(subResSchema2.getKeyPropertyId(Resource.Type.Service)).andReturn(createKeyProperty).anyTimes();
  expect(result.getResultTree()).andReturn(resultTree).anyTimes();
  expect(resource1.getPropertyValue(resourceKeyProperty)).andReturn("id1").anyTimes();
  expect(resource2.getPropertyValue(resourceKeyProperty)).andReturn("id2").anyTimes();
  replay(request,resourceInstance,resourceDefinition,query,predicate,result,subResource1,subResource2,subResourceDefinition1,subResourceDefinition2,controller,serviceSchema,subResSchema1,subResSchema2,resource1,resource2,pm,resourceInstanceFactory,createResource,status,statusResource1,statusResource2,readHandler,queryResultStatus);
  Result testResult=new TestQueryCreateHandler(resourceInstanceFactory,controller,pm,readHandler).handleRequest(request);
  ResultStatus resultStatus=testResult.getStatus();
  assertEquals(ResultStatus.STATUS.BAD_REQUEST,resultStatus.getStatus());
  assertEquals("Invalid Request: Multiple sub-resource types may not be created in the same request.",resultStatus.getMessage());
  verify(request,resourceInstance,resourceDefinition,query,predicate,result,subResource1,subResource2,subResourceDefinition1,subResourceDefinition2,controller,serviceSchema,subResSchema1,subResSchema2,resource1,resource2,pm,resourceInstanceFactory,createResource,status,statusResource1,statusResource2,readHandler,queryResultStatus);
}

{
  Set<Resource> results=new HashSet<Resource>();
  Set<String> requestPropertyIds=getRequestPropertyIds(request,predicate);
  for (  Map<String,Object> propertyMap : getPropertyMaps(predicate)) {
    String upgradeIdStr=(String)propertyMap.get(UPGRADE_ID);
    String groupIdStr=(String)propertyMap.get(UPGRADE_GROUP_ID);
    if (null == upgradeIdStr || upgradeIdStr.isEmpty()) {
      throw new IllegalArgumentException("The upgrade id is required when querying for upgrades");
    }
    if (null == groupIdStr || groupIdStr.isEmpty()) {
      throw new IllegalArgumentException("The upgrade id is required when querying for upgrades");
    }
    long upgradeId=Long.parseLong(upgradeIdStr);
    long groupId=Long.parseLong(groupIdStr);
    UpgradeGroupEntity group=m_dao.findUpgradeGroup(groupId);
    if (null == group || null == group.getItems()) {
      throw new NoSuchResourceException(String.format("Cannot load upgrade for %s",upgradeIdStr));
    }
    for (    UpgradeItemEntity entity : group.getItems()) {
      results.add(toResource(group.getUpgradeEntity(),entity,requestPropertyIds));
    }
  }
  return results;
}

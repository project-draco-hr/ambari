{
  AmbariManagementController controller=injector.getInstance(AmbariManagementController.class);
  String newTag="version" + System.currentTimeMillis();
  Clusters clusters=controller.getClusters();
  if (clusters == null) {
    return;
  }
  Map<String,Cluster> clusterMap=clusters.getClusters();
  if (clusterMap != null && !clusterMap.isEmpty()) {
    for (    Cluster cluster : clusterMap.values()) {
      Config oldConfig=cluster.getDesiredConfigByType(configType);
      if (properties != null) {
        Map<String,Config> all=cluster.getConfigsByType(configType);
        if (all == null || !all.containsKey(newTag) || properties.size() > 0) {
          Map<String,String> mergedProperties=mergeProperties(oldConfig.getProperties(),properties,updateIfExists);
          LOG.info("Applying configuration with tag ''{0}'' to " + "cluster ''{1}''",newTag,cluster.getClusterName());
          ConfigurationRequest cr=new ConfigurationRequest();
          cr.setClusterName(cluster.getClusterName());
          cr.setVersionTag(newTag);
          cr.setType(configType);
          cr.setProperties(mergedProperties);
          controller.createConfiguration(cr);
          Config baseConfig=cluster.getConfig(cr.getType(),cr.getVersionTag());
          if (baseConfig != null) {
            String authName="ambari-upgrade";
            if (cluster.addDesiredConfig(authName,baseConfig)) {
              LOG.info("cluster '" + cluster.getClusterName() + "' "+ "changed by: '"+ authName+ "'; "+ "type='"+ baseConfig.getType()+ "' "+ "tag='"+ baseConfig.getVersionTag()+ "'"+ " from='"+ oldConfig.getVersionTag()+ "'");
            }
          }
        }
      }
    }
  }
}

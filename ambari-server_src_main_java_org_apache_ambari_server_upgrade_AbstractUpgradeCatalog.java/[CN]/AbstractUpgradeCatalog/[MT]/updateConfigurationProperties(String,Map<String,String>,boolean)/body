{
  AmbariManagementController controller=injector.getInstance(AmbariManagementController.class);
  String newTag="version" + System.currentTimeMillis();
  Clusters clusters=controller.getClusters();
  if (clusters == null) {
    return;
  }
  Map<String,Cluster> clusterMap=clusters.getClusters();
  if (clusterMap != null && !clusterMap.isEmpty()) {
    for (    Cluster cluster : clusterMap.values()) {
      Config oldConfig=cluster.getDesiredConfigByType(configType);
      if (oldConfig == null) {
        LOG.info("Config " + configType + " not found. Assuming service not installed. "+ "Skipping configuration properties update");
        return;
      }
      if (properties != null) {
        Map<String,Config> all=cluster.getConfigsByType(configType);
        if (all == null || !all.containsKey(newTag) || properties.size() > 0) {
          Map<String,String> oldConfigProperties=oldConfig.getProperties();
          Map<String,String> mergedProperties=mergeProperties(oldConfigProperties,properties,updateIfExists);
          if (!Maps.difference(oldConfigProperties,mergedProperties).areEqual()) {
            LOG.info("Applying configuration with tag '%s' to " + "cluster '%s'",newTag,cluster.getClusterName());
            ConfigurationRequest cr=new ConfigurationRequest();
            cr.setClusterName(cluster.getClusterName());
            cr.setVersionTag(newTag);
            cr.setType(configType);
            cr.setProperties(mergedProperties);
            controller.createConfiguration(cr);
            Config baseConfig=cluster.getConfig(cr.getType(),cr.getVersionTag());
            if (baseConfig != null) {
              String authName="ambari-upgrade";
              if (cluster.addDesiredConfig(authName,baseConfig)) {
                LOG.info("cluster '" + cluster.getClusterName() + "' "+ "changed by: '"+ authName+ "'; "+ "type='"+ baseConfig.getType()+ "' "+ "tag='"+ baseConfig.getVersionTag()+ "'"+ " from='"+ oldConfig.getVersionTag()+ "'");
              }
            }
          }
 else {
            LOG.info("No changes detected to config " + configType + ". Skipping configuration properties update");
          }
        }
      }
    }
  }
}

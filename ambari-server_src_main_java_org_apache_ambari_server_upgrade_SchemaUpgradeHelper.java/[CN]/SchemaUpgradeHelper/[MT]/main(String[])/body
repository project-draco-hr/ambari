{
  try {
    Injector injector=Guice.createInjector(new UpgradeHelperModule());
    SchemaUpgradeHelper schemaUpgradeHelper=injector.getInstance(SchemaUpgradeHelper.class);
    String targetVersion=schemaUpgradeHelper.getAmbariServerVersion();
    LOG.info("Upgrading schema to target version = " + targetVersion);
    UpgradeCatalog targetUpgradeCatalog=AbstractUpgradeCatalog.getUpgradeCatalog(targetVersion);
    LOG.debug("Target upgrade catalog. " + targetUpgradeCatalog);
    String sourceVersion=schemaUpgradeHelper.readSourceVersion();
    LOG.info("Upgrading schema from source version = " + sourceVersion);
    List<UpgradeCatalog> upgradeCatalogs=schemaUpgradeHelper.getUpgradePath(sourceVersion,targetVersion);
    schemaUpgradeHelper.validateUpgradePath(upgradeCatalogs,targetVersion);
    schemaUpgradeHelper.executeUpgrade(upgradeCatalogs);
    schemaUpgradeHelper.startPersistenceService();
    schemaUpgradeHelper.executeDMLUpdates(upgradeCatalogs);
    schemaUpgradeHelper.executeOnPostUpgrade(upgradeCatalogs);
    schemaUpgradeHelper.resetUIState();
    LOG.info("Upgrade successful.");
    schemaUpgradeHelper.stopPersistenceService();
  }
 catch (  Throwable e) {
    if (e instanceof AmbariException) {
      LOG.error("Exception occurred during upgrade, failed",e);
      throw (AmbariException)e;
    }
 else {
      LOG.error("Unexpected error, upgrade failed",e);
      throw new Exception("Unexpected error, upgrade failed",e);
    }
  }
}

{
  final Set<Resource> resources=new HashSet<Resource>();
  final Set<String> requestedIds=getRequestPropertyIds(request,predicate);
  final Set<Map<String,Object>> propertyMaps=getPropertyMaps(predicate);
  List<ClusterVersionEntity> requestedEntities=new ArrayList<ClusterVersionEntity>();
  for (  Map<String,Object> propertyMap : propertyMaps) {
    final String clusterName=propertyMap.get(CLUSTER_STACK_VERSION_CLUSTER_NAME_PROPERTY_ID).toString();
    final Long id;
    if (propertyMap.get(CLUSTER_STACK_VERSION_ID_PROPERTY_ID) == null && propertyMaps.size() == 1) {
      requestedEntities=clusterVersionDAO.findByCluster(clusterName);
    }
 else {
      try {
        id=Long.parseLong(propertyMap.get(CLUSTER_STACK_VERSION_ID_PROPERTY_ID).toString());
      }
 catch (      Exception ex) {
        throw new SystemException("Stack version should have numerical id");
      }
      final ClusterVersionEntity entity=clusterVersionDAO.findByPK(id);
      if (entity == null) {
        throw new NoSuchResourceException("There is no stack version with id " + id);
      }
 else {
        requestedEntities.add(entity);
      }
    }
  }
  for (  ClusterVersionEntity entity : requestedEntities) {
    final Resource resource=new ResourceImpl(Resource.Type.ClusterStackVersion);
    final RepositoryVersionEntity repositoryVersionEntity=repositoryVersionDAO.findByStackAndVersion(entity.getStack(),entity.getVersion());
    final Map<RepositoryVersionState,List<String>> hosts=new HashMap<RepositoryVersionState,List<String>>();
    for (    RepositoryVersionState state : RepositoryVersionState.values()) {
      hosts.put(state,new ArrayList<String>());
    }
    for (    HostVersionEntity hostVersionEntity : hostVersionDAO.findByClusterStackAndVersion(entity.getClusterEntity().getClusterName(),entity.getStack(),entity.getVersion())) {
      hosts.get(hostVersionEntity.getState()).add(hostVersionEntity.getHostName());
    }
    setResourceProperty(resource,CLUSTER_STACK_VERSION_CLUSTER_NAME_PROPERTY_ID,entity.getClusterEntity().getClusterName(),requestedIds);
    setResourceProperty(resource,CLUSTER_STACK_VERSION_CURRENT_HOSTS_PROPERTY_ID,hosts.get(RepositoryVersionState.CURRENT),requestedIds);
    setResourceProperty(resource,CLUSTER_STACK_VERSION_ID_PROPERTY_ID,entity.getId(),requestedIds);
    setResourceProperty(resource,CLUSTER_STACK_VERSION_INSTALLED_HOSTS_PROPERTY_ID,hosts.get(RepositoryVersionState.INSTALLED),requestedIds);
    if (repositoryVersionEntity != null) {
      setResourceProperty(resource,CLUSTER_STACK_VERSION_REPOSITORIES_PROPERTY_ID,repositoryVersionEntity.getRepositories(),requestedIds);
    }
    setResourceProperty(resource,CLUSTER_STACK_VERSION_STACK_PROPERTY_ID,entity.getStack(),requestedIds);
    setResourceProperty(resource,CLUSTER_STACK_VERSION_STATE_PROPERTY_ID,entity.getState().name(),requestedIds);
    setResourceProperty(resource,CLUSTER_STACK_VERSION_VERSION_PROPERTY_ID,entity.getVersion(),requestedIds);
    if (predicate == null || predicate.evaluate(resource)) {
      resources.add(resource);
    }
  }
  return resources;
}

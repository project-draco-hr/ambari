{
  CommandReport commandReport=null;
  boolean processPrincipal;
  boolean regenerateKeytabs="true".equalsIgnoreCase(getCommandParameterValue(getCommandParameters(),REGENERATE_ALL));
  if (regenerateKeytabs) {
    processPrincipal=true;
  }
 else {
    KerberosPrincipalEntity kerberosPrincipalEntity=kerberosPrincipalDAO.find(evaluatedPrincipal);
    if (kerberosPrincipalEntity == null) {
      processPrincipal=true;
    }
 else     if (!StringUtils.isEmpty(kerberosPrincipalEntity.getCachedKeytabPath())) {
      processPrincipal=false;
    }
 else     if (kerberosPrincipalHostDAO.exists(evaluatedPrincipal)) {
      processPrincipal=false;
    }
 else {
      processPrincipal=true;
    }
  }
  if (processPrincipal) {
    Map<String,String> principalPasswordMap=getPrincipalPasswordMap(requestSharedDataContext);
    Map<String,Integer> principalKeyNumberMap=getPrincipalKeyNumberMap(requestSharedDataContext);
    String password=principalPasswordMap.get(evaluatedPrincipal);
    if (password == null) {
      boolean servicePrincipal="service".equalsIgnoreCase(identityRecord.get(KerberosIdentityDataFileReader.PRINCIPAL_TYPE));
      CreatePrincipalResult result=createPrincipal(evaluatedPrincipal,servicePrincipal,kerberosConfiguration,operationHandler,actionLog);
      if (result == null) {
        commandReport=createCommandReport(1,HostRoleStatus.FAILED,"{}",actionLog.getStdOut(),actionLog.getStdErr());
      }
 else {
        principalPasswordMap.put(evaluatedPrincipal,result.getPassword());
        principalKeyNumberMap.put(evaluatedPrincipal,result.getKeyNumber());
      }
    }
  }
  return commandReport;
}

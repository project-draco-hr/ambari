{
  ActionQueue aq=new ActionQueue();
  Clusters fsm=mock(Clusters.class);
  Cluster oneClusterMock=mock(Cluster.class);
  Service serviceObj=mock(Service.class);
  ServiceComponent scomp=mock(ServiceComponent.class);
  ServiceComponentHost sch=mock(ServiceComponentHost.class);
  when(fsm.getCluster(anyString())).thenReturn(oneClusterMock);
  when(oneClusterMock.getService(anyString())).thenReturn(serviceObj);
  when(serviceObj.getServiceComponent(anyString())).thenReturn(scomp);
  when(scomp.getServiceComponentHost(anyString())).thenReturn(sch);
  when(serviceObj.getCluster()).thenReturn(oneClusterMock);
  ActionDBAccessor db=mock(ActionDBAccessorImpl.class);
  List<Stage> stages=new ArrayList<Stage>();
  Stage s=new Stage(1,"/bogus","clusterName");
  s.setStageId(977);
  stages.add(s);
  String hostname="ahost.ambari.apache.org";
  HostAction ha=new HostAction(hostname);
  HostRoleCommand hrc=new HostRoleCommand("HDFS",Role.DATANODE,new ServiceComponentHostInstallEvent(Role.DATANODE.toString(),hostname,35678901));
  ha.addHostRoleCommand(hrc);
  s.addHostAction(hostname,ha);
  when(db.getStagesInProgress()).thenReturn(stages);
  ActionScheduler scheduler=new ActionScheduler(1000,100,db,aq,fsm,10000);
  scheduler.start();
  Thread.sleep(1000);
  List<AgentCommand> ac=aq.dequeueAll(hostname);
  assertEquals(1,ac.size());
  assertTrue(ac.get(0) instanceof ExecutionCommand);
  assertEquals("1-977",((ExecutionCommand)(ac.get(0))).getCommandId());
  Thread.sleep(1000);
  ac=aq.dequeueAll(hostname);
  assertEquals(1,ac.size());
  assertTrue(ac.get(0) instanceof ExecutionCommand);
  assertEquals("1-977",((ExecutionCommand)(ac.get(0))).getCommandId());
  hrc.setStatus(HostRoleStatus.COMPLETED);
  ac=aq.dequeueAll(hostname);
  Thread.sleep(1000);
  ac=aq.dequeueAll(hostname);
  assertEquals(0,ac.size());
}

{
  String hostname=heartbeat.getHostname();
  Date heartbeatTime=new Date(System.currentTimeMillis());
  nodes.checkAndUpdateNode(hostname,heartbeatTime);
  ControllerResponse prevResponse=agentToHeartbeatResponseMap.get(heartbeat.getHostname());
  if (prevResponse != null) {
    if (prevResponse.getResponseId() != heartbeat.getResponseId()) {
      return prevResponse;
    }
  }
  short responseId=(short)(heartbeat.getResponseId() + 1);
  String clusterName=null;
  int clusterRev=0;
  List<Action> allActions=new ArrayList<Action>();
  if (heartbeat.getIdle()) {
    List<ClusterNameAndRev> clustersNodeBelongsTo=getClustersNodeBelongsTo(hostname);
    if (clustersNodeBelongsTo.isEmpty()) {
      return createResponse(responseId,allActions,heartbeat);
    }
    String script=clusters.getInstallAndConfigureScript(clustersNodeBelongsTo.get(0).getClusterName(),clustersNodeBelongsTo.get(0).getRevision());
    getInstallAndConfigureAction(script,allActions);
    if (!installAndConfigDone(script,heartbeat)) {
      return createResponse(responseId,allActions,heartbeat);
    }
    for (    ClusterNameAndRev clusterIdAndRev : clustersNodeBelongsTo) {
      clusterName=clusterIdAndRev.getClusterName();
      clusterRev=clusterIdAndRev.getRevision();
      Cluster cluster=clusters.getClusterByName(clusterName);
      ClusterFSM clusterFsm=driver.getFSMClusterInstance(clusterName);
      List<ServiceFSM> clusterServices=clusterFsm.getServices();
      for (      ServiceFSM service : clusterServices) {
        List<RoleFSM> roles=service.getRoles();
        for (        RoleFSM role : roles) {
          boolean nodePlayingRole=nodePlayingRole(hostname,role.getRoleName());
          if (nodePlayingRole) {
            ComponentPlugin plugin=cluster.getComponentDefinition(service.getServiceName());
            if (role.shouldStart()) {
              Action action=plugin.startServer(cluster.getName(),role.getRoleName());
              fillDetailsAndAddAction(action,allActions,clusterName,clusterRev,service.getServiceName(),role.getRoleName());
              if (wasStartRoleSuccessful(clusterIdAndRev,service.getServiceName(),role.getRoleName(),prevResponse,heartbeat)) {
                stateMachineInvoker.getAMBARIEventHandler().handle(new RoleEvent(RoleEventType.START_SUCCESS,role));
              }
            }
            if (role.shouldStop()) {
              if (wasStopRoleSuccessful(clusterIdAndRev,service.getServiceName(),role.getRoleName(),prevResponse,heartbeat)) {
                stateMachineInvoker.getAMBARIEventHandler().handle(new RoleEvent(RoleEventType.STOP_SUCCESS,role));
              }
            }
          }
        }
        checkAndCreateActions(cluster,clusterFsm,clusterIdAndRev,service,heartbeat,allActions);
      }
    }
  }
  return createResponse(responseId,allActions,heartbeat);
}

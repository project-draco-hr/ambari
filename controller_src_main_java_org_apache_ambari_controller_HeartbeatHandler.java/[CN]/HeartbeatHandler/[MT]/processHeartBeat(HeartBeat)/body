{
  String hostname=heartbeat.getHostname();
  Date heartbeatTime=new Date(System.currentTimeMillis());
  Nodes.getInstance().checkAndUpdateNode(hostname,heartbeatTime);
  ControllerResponse response=agentToHeartbeatResponseMap.get(heartbeat.getHostname());
  if (response != null) {
    if (response.getResponseId() == heartbeat.getResponseId()) {
      return response;
    }
  }
  short responseId=(short)(heartbeat.getResponseId() + 1);
  String clusterName=null;
  int clusterRev=0;
  List<Action> allActions=new ArrayList<Action>();
  if (heartbeat.getIdle()) {
    List<ClusterNameAndRev> clustersNodeBelongsTo=getClustersNodeBelongsTo(hostname);
    for (    ClusterNameAndRev clusterIdAndRev : clustersNodeBelongsTo) {
      String script=Clusters.getInstance().getInstallAndConfigureScript(clusterName,clusterRev);
      getInstallAndConfigureAction(script,clusterIdAndRev,allActions);
      Cluster cluster=Clusters.getInstance().getClusterByName(clusterName);
      ClusterFSM clusterFsm=StateMachineInvoker.getStateMachineClusterInstance(clusterName);
      List<ServiceFSM> clusterServices=clusterFsm.getServices();
      for (      ServiceFSM service : clusterServices) {
        List<RoleFSM> roles=service.getRoles();
        for (        RoleFSM role : roles) {
          boolean nodePlayingRole=nodePlayingRole(hostname,role.getRoleName());
          if (nodePlayingRole) {
            ComponentPlugin plugin=cluster.getComponentDefinition(service.getServiceName());
            if (role.shouldStart()) {
              Action action=plugin.startServer(cluster.getName(),role.getRoleName());
              fillDetailsAndAddAction(action,allActions,clusterName,clusterRev,service.getServiceName(),role.getRoleName());
              if (wasStartRoleSuccessful(clusterIdAndRev,role.getRoleName(),response,heartbeat)) {
                StateMachineInvoker.getAMBARIEventHandler().handle(new RoleEvent(RoleEventType.START_SUCCESS,role));
              }
            }
            if (role.shouldStop()) {
              if (wasStopRoleSuccessful(clusterIdAndRev,role.getRoleName(),response,heartbeat)) {
                StateMachineInvoker.getAMBARIEventHandler().handle(new RoleEvent(RoleEventType.STOP_SUCCESS,role));
              }
            }
          }
        }
        checkAndCreateActions(cluster,clusterFsm,clusterIdAndRev,service,heartbeat,allActions);
      }
    }
  }
  ControllerResponse r=new ControllerResponse();
  r.setResponseId(responseId);
  r.setActions(allActions);
  agentToHeartbeatResponseMap.put(heartbeat.getHostname(),r);
  return r;
}

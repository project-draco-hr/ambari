{
  ControllerResponse response=agentToHeartbeatResponseMap.get(heartbeat.getHostname());
  if (response != null) {
    if (response.getResponseId() == heartbeat.getResponseId()) {
      return response;
    }
  }
  short responseId=(short)(Short.parseShort(response.getResponseId()) + 1);
  String hostname=heartbeat.getHostname();
  Node node=Nodes.getInstance().getNodes().get(hostname);
  NodeState state=node.getNodeState();
  GregorianCalendar c=new GregorianCalendar();
  c.setTime(new Date());
  state.setLastHeartbeatTime(DatatypeFactory.newInstance().newXMLGregorianCalendar(c));
  Cluster cluster=Clusters.getInstance().getClusterByID(state.getClusterID());
  ClusterContext clusterContext=new ClusterContextImpl(cluster,node);
  List<Action> allActions=new ArrayList<Action>();
  if (heartbeat.getIdle()) {
    String desiredClusterId=cluster.getID();
    InstalledOrStartedComponents componentServers=new InstalledOrStartedComponents();
    ClusterFSM clusterFsm=StateMachineInvoker.getStateMachineClusterInstance(desiredClusterId);
    allActions=inspectAgentState(heartbeat,clusterContext,componentServers,clusterFsm);
    List<ServiceFSM> clusterServices=clusterFsm.getServices();
    for (    ServiceFSM service : clusterServices) {
      List<RoleFSM> roles=service.getRoles();
      for (      RoleFSM role : roles) {
        boolean roleInstalled=componentServers.isInstalled(role.getAssociatedService().getServiceName(),role.getRoleName());
        boolean roleServerRunning=componentServers.isStarted(role.getAssociatedService().getServiceName(),role.getRoleName());
        HDFSPluginImpl plugin=new HDFSPluginImpl();
        if (role.shouldStart()) {
          if (!roleInstalled) {
            allActions.addAll(plugin.install(clusterContext));
            continue;
          }
          if (!roleServerRunning) {
            short retryCount=retryCountForRole.get(hostname,role.getRoleName());
            if (retryCount > MAX_RETRY_COUNT) {
              StateMachineInvoker.getAMBARIEventHandler().handle(new RoleEvent(RoleEventType.START_FAILURE,role));
              retryCountForRole.resetAttemptCount(hostname,role.getRoleName());
              continue;
            }
            List<Action> actions=plugin.startRoleServer(clusterContext,role.getRoleName());
            allActions.addAll(actions);
            retryCountForRole.incrAttemptCount(hostname,role.getRoleName());
          }
          if (roleServerRunning) {
            retryCountForRole.resetAttemptCount(hostname,role.getRoleName());
            StateMachineInvoker.getAMBARIEventHandler().handle(new RoleEvent(RoleEventType.START_SUCCESS,role));
          }
        }
        if (role.shouldStop()) {
          if (roleServerRunning) {
            short retryCount=retryCountForRole.get(hostname,role.getRoleName());
            if (retryCount > MAX_RETRY_COUNT) {
              StateMachineInvoker.getAMBARIEventHandler().handle(new RoleEvent(RoleEventType.STOP_FAILURE,role));
              retryCountForRole.resetAttemptCount(hostname,role.getRoleName());
              continue;
            }
            List<Action> actions=plugin.stopRoleServer(clusterContext,role.getRoleName());
            allActions.addAll(actions);
            retryCountForRole.incrAttemptCount(hostname,role.getRoleName());
          }
          if (!roleServerRunning) {
            retryCountForRole.resetAttemptCount(hostname,role.getRoleName());
            StateMachineInvoker.getAMBARIEventHandler().handle(new RoleEvent(RoleEventType.STOP_SUCCESS,role));
          }
          if (roleInstalled && clusterFsm.getClusterState().equals(ClusterState.CLUSTER_STATE_ATTIC)) {
            allActions.addAll(plugin.uninstall(clusterContext));
          }
        }
      }
      checkActionResults(service,cluster,heartbeat,allActions);
    }
  }
  ControllerResponse r=new ControllerResponse();
  r.setResponseId(String.valueOf(responseId));
  r.setActions(allActions);
  agentToHeartbeatResponseMap.put(heartbeat.getHostname(),r);
  return r;
}

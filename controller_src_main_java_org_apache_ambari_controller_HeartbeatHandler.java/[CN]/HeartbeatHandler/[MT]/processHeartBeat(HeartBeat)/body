{
  ControllerResponse response=agentToHeartbeatResponseMap.get(heartbeat.getHostname());
  if (response != null) {
    if (response.getResponseId() == heartbeat.getResponseId()) {
      return response;
    }
  }
  Node node=Nodes.getInstance().getNodes().get(heartbeat.getHostname());
  NodeState state=node.getNodeState();
  GregorianCalendar c=new GregorianCalendar();
  c.setTime(new Date());
  state.setLastHeartbeatTime(DatatypeFactory.newInstance().newXMLGregorianCalendar(c));
  Cluster cluster=Clusters.getInstance().getClusterByName(state.getClusterName());
  ClusterContext clusterContext=new ClusterContextImpl(cluster,node);
  List<ServerStatus> servers=heartbeat.getServersStatus();
  org.apache.ambari.resource.statemachine.Cluster stateMachineCluster=StateMachineInvoker.getStateMachineClusterInstance(state.getClusterName());
  List<Action> actions=new ArrayList<Action>();
synchronized (this) {
    actions=responseMap.get(node.getName());
  }
  ControllerResponse r=new ControllerResponse();
  r.setActions(actions);
  agentToHeartbeatResponseMap.put(heartbeat.getHostname(),r);
  return r;
}

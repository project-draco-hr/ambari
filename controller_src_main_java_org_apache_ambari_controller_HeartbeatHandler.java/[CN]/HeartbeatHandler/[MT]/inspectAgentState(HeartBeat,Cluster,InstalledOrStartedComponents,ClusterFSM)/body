{
  List<AgentRoleState> agentRoleStates=heartbeat.getInstalledRoleStates();
  List<Action> killAndUninstallCmds=new ArrayList<Action>();
  for (  AgentRoleState agentRoleState : agentRoleStates) {
    boolean stopRole=false;
    boolean uninstall=false;
    ClusterFSM clusterFSM=StateMachineInvoker.getStateMachineClusterInstance(agentRoleState.getClusterId());
    if (clusterFSM == null) {
      stopRole=true;
      uninstall=true;
    }
    if (clusterFSM != null) {
      if (clusterFSM.getClusterState().getState().equals(ClusterState.CLUSTER_STATE_INACTIVE)) {
        stopRole=true;
        uninstall=false;
      }
 else       if (clusterFSM.getClusterState().getState().equals(ClusterState.CLUSTER_STATE_ATTIC)) {
        stopRole=true;
        uninstall=true;
      }
    }
    if (stopRole && agentRoleState.getServerStatus() == AgentRoleState.State.STARTED) {
      addAction(getStopRoleAction(agentRoleState.getClusterId(),agentRoleState.getClusterDefinitionRevision(),agentRoleState.getComponentName(),agentRoleState.getRoleName()),killAndUninstallCmds);
    }
    if (uninstall) {
      ComponentPlugin plugin=cluster.getComponentDefinition(agentRoleState.getComponentName());
      Action uninstallAction=plugin.uninstall(cluster.getName(),agentRoleState.getRoleName());
      addAction(uninstallAction,killAndUninstallCmds);
    }
    if (!stopRole && !uninstall) {
      componentServers.roleInstalled(agentRoleState.getComponentName(),agentRoleState.getRoleName());
      if (agentRoleState.getServerStatus() == AgentRoleState.State.STARTED) {
        componentServers.roleServerStarted(agentRoleState.getComponentName(),agentRoleState.getRoleName());
      }
    }
  }
  return killAndUninstallCmds;
}

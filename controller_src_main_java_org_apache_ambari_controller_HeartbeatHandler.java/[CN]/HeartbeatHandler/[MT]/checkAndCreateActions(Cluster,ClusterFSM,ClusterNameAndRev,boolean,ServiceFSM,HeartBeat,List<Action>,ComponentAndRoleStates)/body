{
  if (service.getServiceState() == ServiceState.STARTED) {
    String id=getSpecialActionID(clusterIdAndRev,service,true,false);
    ActionResult result=installedOrStartedComponents.getActionResult(id);
    if (result != null) {
      if (result.getCommandResult().getExitCode() == 0) {
        StateMachineInvoker.getAMBARIEventHandler().handle(new ServiceEvent(ServiceEventType.AVAILABLE_CHECK_SUCCESS,service));
      }
 else {
        StateMachineInvoker.getAMBARIEventHandler().handle(new ServiceEvent(ServiceEventType.AVAILABLE_CHECK_FAILURE,service));
      }
    }
 else {
      ComponentPlugin plugin=cluster.getComponentDefinition(service.getServiceName());
      String role=plugin.runCheckRole();
      if (installedOrStartedComponents.isRoleInstalled(clusterIdAndRev,role)) {
        Action action=plugin.checkService(cluster.getName(),role);
        fillActionDetails(action,clusterIdAndRev.getClusterName(),clusterIdAndRev.getRevision(),service.getServiceName(),role);
        action.setId(id);
        action.setKind(Action.Kind.RUN_ACTION);
        addAction(action,allActions);
      }
    }
  }
  if (service.getServiceState() == ServiceState.PRESTART) {
    String id=getSpecialActionID(clusterIdAndRev,service,false,true);
    ActionResult result=installedOrStartedComponents.getActionResult(id);
    if (result != null) {
      if (result.getCommandResult().getExitCode() == 0) {
        StateMachineInvoker.getAMBARIEventHandler().handle(new ServiceEvent(ServiceEventType.PRESTART_SUCCESS,service));
      }
 else {
        StateMachineInvoker.getAMBARIEventHandler().handle(new ServiceEvent(ServiceEventType.PRESTART_FAILURE,service));
      }
    }
 else {
      ComponentPlugin plugin=cluster.getComponentDefinition(service.getServiceName());
      String role=plugin.runPreStartRole();
      if (nodePlayingRole(heartbeat.getHostname(),role)) {
        if (newNode || !installedOrStartedComponents.isRoleInstalled(clusterIdAndRev,role)) {
          createInstallAction(clusterIdAndRev,cluster.getName(),service.getServiceName(),role,plugin,allActions);
        }
      }
      Action action=plugin.preStartAction(cluster.getName(),role);
      fillActionDetails(action,clusterIdAndRev.getClusterName(),clusterIdAndRev.getRevision(),service.getServiceName(),role);
      action.setId(id);
      action.setKind(Action.Kind.RUN_ACTION);
      addAction(action,allActions);
    }
  }
}

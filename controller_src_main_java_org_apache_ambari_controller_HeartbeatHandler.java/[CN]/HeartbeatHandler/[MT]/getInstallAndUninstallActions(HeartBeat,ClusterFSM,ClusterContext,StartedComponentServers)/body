{
  List<AgentRoleState> agentRoleStates=heartbeat.getInstalledRoleStates();
  List<Action> killAndUninstallCmds=new ArrayList<Action>();
  for (  AgentRoleState agentRoleState : agentRoleStates) {
    boolean stopRole=false;
    boolean uninstall=false;
    ClusterFSM clusterFSM=StateMachineInvoker.getStateMachineClusterInstance(agentRoleState.getClusterId(),agentRoleState.getBluePrintName(),agentRoleState.getBluePrintRevision());
    if (clusterFSM == null) {
      stopRole=true;
      uninstall=true;
    }
    if (clusterFSM != null) {
      if (clusterFSM.getClusterState().getState().equals(ClusterState.CLUSTER_STATE_INACTIVE)) {
        stopRole=true;
        uninstall=false;
      }
 else       if (clusterFSM.getClusterState().getState().equals(ClusterState.CLUSTER_STATE_ATTIC)) {
        stopRole=true;
        uninstall=true;
      }
    }
    if (stopRole && agentRoleState.getServerStatus() == AgentRoleState.State.STARTED) {
      Action action=new Action();
      action.setClusterId(agentRoleState.getClusterId());
      action.setBluePrintName(agentRoleState.getBluePrintName());
      action.setBluePrintRevision(agentRoleState.getBluePrintRevision());
      action.setRole(agentRoleState.getRoleName());
      action.setComponent(agentRoleState.getComponentName());
      action.setKind(Kind.STOP_ACTION);
      action.setSignal(Signal.KILL);
      killAndUninstallCmds.add(action);
    }
    if (uninstall) {
      HDFSPluginImpl plugin=new HDFSPluginImpl();
      List<Action> uninstallAction=plugin.uninstall(context);
      killAndUninstallCmds.addAll(uninstallAction);
    }
    if (!stopRole && !uninstall) {
      componentServers.roleServerStarted(agentRoleState.getComponentName(),agentRoleState.getRoleName());
    }
  }
  return killAndUninstallCmds;
}

{
  ComponentPlugin plugin=cluster.getComponentDefinition(service.getServiceName());
  if (service.getServiceState() == ServiceState.STARTED) {
    String role=plugin.runCheckRole();
    if (nodePlayingRole(heartbeat.getHostname(),role)) {
      String id=getSpecialActionID(clusterIdAndRev,service.getServiceName(),role,SpecialServiceIDs.SERVICE_AVAILABILITY_CHECK_ID);
      ActionResult result=getActionResult(heartbeat,id);
      if (result != null) {
        if (result.getCommandResult().getExitCode() == 0) {
          stateMachineInvoker.getAMBARIEventHandler().handle(new ServiceEvent(ServiceEventType.AVAILABLE_CHECK_SUCCESS,service));
        }
 else {
          stateMachineInvoker.getAMBARIEventHandler().handle(new ServiceEvent(ServiceEventType.AVAILABLE_CHECK_FAILURE,service));
        }
      }
 else {
        Action action=plugin.checkService(cluster.getName(),role);
        fillActionDetails(action,clusterIdAndRev.getClusterName(),clusterIdAndRev.getRevision(),service.getServiceName(),role);
        action.setId(id);
        action.setKind(Action.Kind.RUN_ACTION);
        addAction(action,allActions);
      }
    }
  }
  if (service.getServiceState() == ServiceState.PRESTART) {
    String role=plugin.runPreStartRole();
    if (nodePlayingRole(heartbeat.getHostname(),role)) {
      String id=getSpecialActionID(clusterIdAndRev,service.getServiceName(),role,SpecialServiceIDs.SERVICE_PRESTART_CHECK_ID);
      ActionResult result=getActionResult(heartbeat,id);
      if (result != null) {
        if (result.getCommandResult().getExitCode() == 0) {
          stateMachineInvoker.getAMBARIEventHandler().handle(new ServiceEvent(ServiceEventType.PRESTART_SUCCESS,service));
        }
 else {
          stateMachineInvoker.getAMBARIEventHandler().handle(new ServiceEvent(ServiceEventType.PRESTART_FAILURE,service));
        }
      }
 else {
        Action action=plugin.preStartAction(cluster.getName(),role);
        fillActionDetails(action,clusterIdAndRev.getClusterName(),clusterIdAndRev.getRevision(),service.getServiceName(),role);
        action.setId(id);
        action.setKind(Action.Kind.RUN_ACTION);
        addAction(action,allActions);
      }
    }
  }
}

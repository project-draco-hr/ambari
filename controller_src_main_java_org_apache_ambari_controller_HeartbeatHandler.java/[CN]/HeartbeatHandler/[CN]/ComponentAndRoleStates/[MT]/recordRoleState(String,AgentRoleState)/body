{
  ClusterIdAndRev clusterIdAndRev=new ClusterIdAndRev(state.getClusterId(),state.getClusterDefinitionRevision());
  clusterNodeBelongsTo.add(clusterIdAndRev);
  recordState(clusterIdAndRev,state.getComponentName(),state.getRoleName(),state);
  List<AgentRoleState> agentRoleStates=null;
  boolean alreadyPresent=false;
  if ((agentRoleStates=previousStateMap.get(host)) != null) {
    for (    AgentRoleState agentRoleState : agentRoleStates) {
      if (agentRoleState.roleAttributesEqual(state)) {
        alreadyPresent=true;
        if (agentRoleState.getServerStatus() != state.getServerStatus()) {
          setStateChanged(clusterIdAndRev,state.getComponentName(),state.getRoleName());
          agentRoleState.setServerStatus(state.getServerStatus());
        }
      }
    }
  }
 else {
    agentRoleStates=new ArrayList<AgentRoleState>();
    previousStateMap.put(host,agentRoleStates);
  }
  if (!alreadyPresent) {
    agentRoleStates.add(state);
  }
}

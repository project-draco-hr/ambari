{
  FilterChain chain=createNiceMock(FilterChain.class);
  HttpServletRequest request=createNiceMock(HttpServletRequest.class);
  HttpServletResponse response=createNiceMock(HttpServletResponse.class);
  AmbariAuthorizationFilter filter=createMockBuilder(AmbariAuthorizationFilter.class).addMockedMethod("getSecurityContext").withConstructor().createMock();
  SecurityContext securityContext=createNiceMock(SecurityContext.class);
  Authentication authentication=createNiceMock(Authentication.class);
  AmbariGrantedAuthority authority=createNiceMock(AmbariGrantedAuthority.class);
  PrivilegeEntity privilegeEntity=createNiceMock(PrivilegeEntity.class);
  PermissionEntity permission=createNiceMock(PermissionEntity.class);
  FilterConfig filterConfig=createNiceMock(FilterConfig.class);
  expect(filterConfig.getInitParameter("realm")).andReturn("AuthFilter");
  expect(authentication.isAuthenticated()).andReturn(true);
  expect(request.getRequestURI()).andReturn("/api/v1/persist/some_val");
  expect(authority.getPrivilegeEntity()).andReturn(privilegeEntity);
  expect(privilegeEntity.getPermission()).andReturn(permission);
  EasyMock.<Collection<? extends GrantedAuthority>>expect(authentication.getAuthorities()).andReturn(Collections.singletonList(authority));
  expect(filter.getSecurityContext()).andReturn(securityContext);
  expect(securityContext.getAuthentication()).andReturn(authentication);
  expect(request.getMethod()).andReturn("POST").anyTimes();
  expect(permission.getId()).andReturn(PermissionEntity.VIEW_USER_PERMISSION);
  response.setHeader("WWW-Authenticate","Basic realm=\"AuthFilter\"");
  response.sendError(HttpServletResponse.SC_FORBIDDEN,"You do not have permissions to access this resource.");
  response.flushBuffer();
  replay(request,response,chain,filter,securityContext,authentication,authority,privilegeEntity,permission,filterConfig);
  filter.init(filterConfig);
  filter.doFilter(request,response,chain);
  verify(request,response,chain,filter,securityContext,authentication,authority,privilegeEntity,permission,filterConfig);
}

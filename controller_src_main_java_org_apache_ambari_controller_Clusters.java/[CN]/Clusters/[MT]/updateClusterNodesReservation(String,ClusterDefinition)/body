{
  ConcurrentHashMap<String,Node> all_nodes=Nodes.getInstance().getNodes();
  List<String> cluster_node_range=new ArrayList<String>();
  cluster_node_range.addAll(getHostnamesFromRangeExpressions(clsDef.getNodes()));
  List<String> nodes_currently_allocated_to_cluster=new ArrayList<String>();
  for (  Node n : Nodes.getInstance().getNodes().values()) {
    if (n.getNodeState().getClusterName() != null && n.getNodeState().getClusterName().equals(clusterName)) {
      nodes_currently_allocated_to_cluster.add(n.getName());
    }
  }
  List<String> nodes_to_allocate=new ArrayList<String>(cluster_node_range);
  nodes_to_allocate.removeAll(nodes_currently_allocated_to_cluster);
  List<String> nodes_to_deallocate=new ArrayList<String>(nodes_currently_allocated_to_cluster);
  nodes_to_deallocate.removeAll(cluster_node_range);
  List<String> preallocatedhosts=new ArrayList<String>();
  for (  String n : nodes_to_allocate) {
    if (all_nodes.containsKey(n) && (all_nodes.get(n).getNodeState().getClusterName() != null || all_nodes.get(n).getNodeState().getAllocatedToCluster())) {
      preallocatedhosts.add(n);
    }
  }
  if (!preallocatedhosts.isEmpty()) {
    String msg="Some of the nodes specified for the cluster roles are allocated to other cluster: [" + preallocatedhosts + "]";
    throw new WebApplicationException((new ExceptionResponse(msg,Response.Status.CONFLICT)).get());
  }
  for (  String node_name : nodes_to_allocate) {
    if (all_nodes.containsKey(node_name)) {
synchronized (all_nodes.get(node_name)) {
        all_nodes.get(node_name).reserveNodeForCluster(clusterName,true);
      }
    }
 else {
      Date epoch=new Date(0);
      Nodes.getInstance().checkAndUpdateNode(node_name,epoch);
      Node node=Nodes.getInstance().getNode(node_name);
      node.reserveNodeForCluster(clusterName,true);
    }
  }
  for (  String node_name : nodes_to_deallocate) {
    if (all_nodes.containsKey(node_name)) {
synchronized (all_nodes.get(node_name)) {
        all_nodes.get(node_name).releaseNodeFromCluster();
      }
    }
  }
}

{
  validateClusterDefinition(cdef);
  setNewClusterDefaults(cdef);
  Date requestTime=new Date();
  ClusterState clsState=new ClusterState();
  clsState.setCreationTime(Util.getXMLGregorianCalendar(requestTime));
  clsState.setLastUpdateTime(Util.getXMLGregorianCalendar(requestTime));
  clsState.setDeployTime(Util.getXMLGregorianCalendar((Date)null));
  if (cdef.getGoalState().equals(ClusterDefinition.GOAL_STATE_ATTIC)) {
    clsState.setState(ClusterState.CLUSTER_STATE_ATTIC);
  }
 else {
    clsState.setState(ClusterDefinition.GOAL_STATE_INACTIVE);
  }
  if (cdef.getRoleToNodes() == null) {
    List<RoleToNodes> role2NodesList=generateRoleToNodesListBasedOnNodeAttributes(cdef);
    cdef.setRoleToNodesMap(role2NodesList);
  }
  if (dry_run) {
    return cdef;
  }
  Cluster cls=this.addClusterEntry(cdef,clsState);
  if (cdef.getNodes() != null && !cdef.getGoalState().equals(ClusterDefinition.GOAL_STATE_ATTIC)) {
    updateClusterNodesReservation(cls.getName(),cdef);
  }
  if (!cdef.getGoalState().equals(ClusterDefinition.GOAL_STATE_ATTIC)) {
    updateNodeToRolesAssociation(cdef.getNodes(),cdef.getRoleToNodes());
  }
  if (cdef.getGoalState().equals(ClusterDefinition.GOAL_STATE_ACTIVE)) {
    org.apache.ambari.resource.statemachine.ClusterFSM cs=StateMachineInvoker.createCluster(cls,cls.getLatestRevisionNumber(),cls.getClusterState());
    cs.activate();
  }
  return cdef;
}

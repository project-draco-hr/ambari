@patch('socket.getfqdn', new=(lambda : 'test-mock-ambari-server-hostname1'))
def test_recommendHadoopProxyUsers(self):
    configurations = {'hadoop-env': {'properties': {'hdfs_user': 'hdfs-user', }, }, 'yarn-env': {'properties': {'yarn_user': 'yarn-user', }, }, 'oozie-env': {'properties': {'oozie_user': 'oozie-user', }, }, 'hive-env': {'properties': {'hive_user': 'hive-user', 'webhcat_user': 'webhcat-user', }, }, 'falcon-env': {'properties': {'falcon_user': 'falcon-user', }, }, 'livy-env': {'properties': {'livy_user': 'livy-user', }, }, }
    services = {'services': [{'StackServices': {'service_name': 'HDFS', }, }, {'StackServices': {'service_name': 'FALCON', }, }, {'StackServices': {'service_name': 'SPARK', }, }, {'StackServices': {'service_name': 'YARN', }, 'components': [{'StackServiceComponents': {'component_name': 'RESOURCEMANAGER', 'hostnames': ['host1', 'host2'], }, }], }, {'StackServices': {'service_name': 'OOZIE', }, 'components': [{'StackServiceComponents': {'component_name': 'OOZIE_SERVER', 'hostnames': ['host2'], }, }], }, {'StackServices': {'service_name': 'HIVE', }, 'components': [{'StackServiceComponents': {'component_name': 'HIVE_SERVER', 'hostnames': ['host1'], }, }, {'StackServiceComponents': {'component_name': 'HIVE_SERVER_INTERACTIVE', 'hostnames': ['host3'], }, }, {'StackServiceComponents': {'component_name': 'WEBHCAT_SERVER', 'hostnames': ['host4'], }, }], }], 'ambari-server-properties': {'ambari-server.user': 'ambari-user', }, 'configurations': configurations, }
    hosts = {'items': [{'Hosts': {'host_name': 'host1', }, }, {'Hosts': {'host_name': 'host2', }, }, {'Hosts': {'host_name': 'host3', }, }, {'Hosts': {'host_name': 'host4', }, }], }
    expected = {'hadoop.proxyuser.ambari-user.groups': '*', 'hadoop.proxyuser.ambari-user.hosts': 'test-mock-ambari-server-hostname1', 'hadoop.proxyuser.falcon-user.groups': '*', 'hadoop.proxyuser.falcon-user.hosts': '*', 'hadoop.proxyuser.hdfs-user.groups': '*', 'hadoop.proxyuser.hdfs-user.hosts': '*', 'hadoop.proxyuser.hive-user.groups': '*', 'hadoop.proxyuser.hive-user.hosts': 'host1,host3', 'hadoop.proxyuser.livy-user.groups': '*', 'hadoop.proxyuser.livy-user.hosts': '*', 'hadoop.proxyuser.oozie-user.groups': '*', 'hadoop.proxyuser.oozie-user.hosts': 'host2', 'hadoop.proxyuser.webhcat-user.groups': '*', 'hadoop.proxyuser.webhcat-user.hosts': 'host4', 'hadoop.proxyuser.yarn-user.hosts': 'host1,host2', }
    self.stackAdvisor.recommendHadoopProxyUsers(configurations, services, hosts)
    self.assertEquals(expected, configurations['core-site']['properties'])

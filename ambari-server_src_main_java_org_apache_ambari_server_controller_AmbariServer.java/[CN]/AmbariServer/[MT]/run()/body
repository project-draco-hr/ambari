{
  ambariMetaInfo.init();
  LOG.info("********* Meta Info initialized **********");
  performStaticInjection();
  initDB();
  server=new Server();
  Server serverForAgent=new Server();
  checkDBVersion();
  try {
    ClassPathXmlApplicationContext parentSpringAppContext=new ClassPathXmlApplicationContext();
    parentSpringAppContext.refresh();
    ConfigurableListableBeanFactory factory=parentSpringAppContext.getBeanFactory();
    factory.registerSingleton("guiceInjector",injector);
    factory.registerSingleton("passwordEncoder",injector.getInstance(PasswordEncoder.class));
    factory.registerSingleton("ambariLocalUserService",injector.getInstance(AmbariLocalUserDetailsService.class));
    factory.registerSingleton("ambariLdapAuthenticationProvider",injector.getInstance(AmbariLdapAuthenticationProvider.class));
    factory.registerSingleton("ambariLdapDataPopulator",injector.getInstance(AmbariLdapDataPopulator.class));
    factory.registerSingleton("ambariAuthorizationFilter",injector.getInstance(AmbariAuthorizationFilter.class));
    factory.registerSingleton("ambariInternalAuthenticationProvider",injector.getInstance(AmbariInternalAuthenticationProvider.class));
    String[] contextLocations={SPRING_CONTEXT_LOCATION};
    ClassPathXmlApplicationContext springAppContext=new ClassPathXmlApplicationContext(contextLocations,parentSpringAppContext);
    ServletContextHandler root=new ServletContextHandler(ServletContextHandler.SECURITY | ServletContextHandler.SESSIONS);
    root.setContextPath(CONTEXT_PATH);
    root.setErrorHandler(injector.getInstance(AmbariErrorHandler.class));
    root.getSessionHandler().getSessionManager().setSessionCookie("AMBARISESSIONID");
    GenericWebApplicationContext springWebAppContext=new GenericWebApplicationContext();
    springWebAppContext.setServletContext(root.getServletContext());
    springWebAppContext.setParent(springAppContext);
    root.setResourceBase(configs.getWebAppDir());
    root.getServletContext().setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE,springWebAppContext);
    certMan.initRootCert();
    ServletContextHandler agentroot=new ServletContextHandler(serverForAgent,"/",ServletContextHandler.SESSIONS);
    ServletHolder rootServlet=root.addServlet(DefaultServlet.class,"/");
    rootServlet.setInitParameter("dirAllowed","false");
    rootServlet.setInitOrder(1);
    rootServlet=agentroot.addServlet(DefaultServlet.class,"/");
    rootServlet.setInitOrder(1);
    DelegatingFilterProxy springSecurityFilter=new DelegatingFilterProxy();
    springSecurityFilter.setTargetBeanName("springSecurityFilterChain");
    root.addFilter(new FilterHolder(injector.getInstance(AmbariPersistFilter.class)),"/api/*",1);
    root.addFilter(new FilterHolder(injector.getInstance(AmbariPersistFilter.class)),"/proxy/*",1);
    root.addFilter(new FilterHolder(new MethodOverrideFilter()),"/api/*",1);
    root.addFilter(new FilterHolder(new MethodOverrideFilter()),"/proxy/*",1);
    agentroot.addFilter(new FilterHolder(injector.getInstance(AmbariPersistFilter.class)),"/agent/*",1);
    agentroot.addFilter(SecurityFilter.class,"/*",1);
    if (configs.getApiAuthentication()) {
      root.addFilter(new FilterHolder(springSecurityFilter),"/api/*",1);
      root.addFilter(new FilterHolder(springSecurityFilter),"/proxy/*",1);
    }
    SslSelectChannelConnector sslConnectorTwoWay=new SslSelectChannelConnector();
    sslConnectorTwoWay.setPort(configs.getTwoWayAuthPort());
    Map<String,String> configsMap=configs.getConfigsMap();
    String keystore=configsMap.get(Configuration.SRVR_KSTR_DIR_KEY) + File.separator + configsMap.get(Configuration.KSTR_NAME_KEY);
    String srvrCrtPass=configsMap.get(Configuration.SRVR_CRT_PASS_KEY);
    sslConnectorTwoWay.setKeystore(keystore);
    sslConnectorTwoWay.setTruststore(keystore);
    sslConnectorTwoWay.setPassword(srvrCrtPass);
    sslConnectorTwoWay.setKeyPassword(srvrCrtPass);
    sslConnectorTwoWay.setTrustPassword(srvrCrtPass);
    sslConnectorTwoWay.setKeystoreType("PKCS12");
    sslConnectorTwoWay.setTruststoreType("PKCS12");
    sslConnectorTwoWay.setNeedClientAuth(configs.getTwoWaySsl());
    SslContextFactory contextFactory=new SslContextFactory(true);
    contextFactory.setKeyStorePath(keystore);
    contextFactory.setTrustStore(keystore);
    contextFactory.setKeyStorePassword(srvrCrtPass);
    contextFactory.setKeyManagerPassword(srvrCrtPass);
    contextFactory.setTrustStorePassword(srvrCrtPass);
    contextFactory.setKeyStoreType("PKCS12");
    contextFactory.setTrustStoreType("PKCS12");
    contextFactory.setNeedClientAuth(false);
    SslSelectChannelConnector sslConnectorOneWay=new SslSelectChannelConnector(contextFactory);
    sslConnectorOneWay.setPort(configs.getOneWayAuthPort());
    sslConnectorOneWay.setAcceptors(2);
    sslConnectorTwoWay.setAcceptors(2);
    serverForAgent.setConnectors(new Connector[]{sslConnectorOneWay,sslConnectorTwoWay});
    ServletHolder sh=new ServletHolder(ServletContainer.class);
    sh.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    sh.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.api.rest;" + "org.apache.ambari.server.api.services;" + "org.apache.ambari.eventdb.webservice;"+ "org.apache.ambari.server.api");
    sh.setInitParameter("com.sun.jersey.api.json.POJOMappingFeature","true");
    root.addServlet(sh,"/api/v1/*");
    sh.setInitOrder(2);
    try {
      for (      ViewInstanceEntity entity : viewRegistry.readViewArchives(configs)) {
        handlerList.addViewInstance(entity);
      }
    }
 catch (    SystemException e) {
      LOG.error("Caught exception deploying views.",e);
    }
    handlerList.addHandler(root);
    server.setHandler(handlerList);
    ServletHolder agent=new ServletHolder(ServletContainer.class);
    agent.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    agent.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.agent.rest;" + "org.apache.ambari.server.api");
    agent.setInitParameter("com.sun.jersey.api.json.POJOMappingFeature","true");
    agentroot.addServlet(agent,"/agent/v1/*");
    agent.setInitOrder(3);
    ServletHolder cert=new ServletHolder(ServletContainer.class);
    cert.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    cert.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.security.unsecured.rest;" + "org.apache.ambari.server.api");
    cert.setInitParameter("com.sun.jersey.api.json.POJOMappingFeature","true");
    agentroot.addServlet(cert,"/*");
    cert.setInitOrder(4);
    ServletHolder proxy=new ServletHolder(ServletContainer.class);
    proxy.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    proxy.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.proxy");
    proxy.setInitParameter("com.sun.jersey.api.json.POJOMappingFeature","true");
    root.addServlet(proxy,"/proxy/*");
    proxy.setInitOrder(5);
    ServletHolder resources=new ServletHolder(ServletContainer.class);
    resources.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    resources.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.resources.api.rest;");
    root.addServlet(resources,"/resources/*");
    resources.setInitOrder(6);
    if (configs.csrfProtectionEnabled()) {
      sh.setInitParameter("com.sun.jersey.spi.container.ContainerRequestFilters","org.apache.ambari.server.api.AmbariCsrfProtectionFilter");
      proxy.setInitParameter("com.sun.jersey.spi.container.ContainerRequestFilters","com.sun.jersey.api.container.filter.AmbariCsrfProtectionFilter");
    }
    serverForAgent.setThreadPool(new QueuedThreadPool(configs.getAgentThreadPoolSize()));
    server.setThreadPool(new QueuedThreadPool(configs.getClientThreadPoolSize()));
    SelectChannelConnector apiConnector;
    if (configs.getApiSSLAuthentication()) {
      String httpsKeystore=configsMap.get(Configuration.CLIENT_API_SSL_KSTR_DIR_NAME_KEY) + File.separator + configsMap.get(Configuration.CLIENT_API_SSL_KSTR_NAME_KEY);
      LOG.info("API SSL Authentication is turned on. Keystore - " + httpsKeystore);
      String httpsCrtPass=configsMap.get(Configuration.CLIENT_API_SSL_CRT_PASS_KEY);
      SslSelectChannelConnector sapiConnector=new SslSelectChannelConnector();
      sapiConnector.setPort(configs.getClientSSLApiPort());
      sapiConnector.setKeystore(httpsKeystore);
      sapiConnector.setTruststore(httpsKeystore);
      sapiConnector.setPassword(httpsCrtPass);
      sapiConnector.setKeyPassword(httpsCrtPass);
      sapiConnector.setTrustPassword(httpsCrtPass);
      sapiConnector.setKeystoreType("PKCS12");
      sapiConnector.setTruststoreType("PKCS12");
      sapiConnector.setMaxIdleTime(configs.getConnectionMaxIdleTime());
      apiConnector=sapiConnector;
    }
 else {
      apiConnector=new SelectChannelConnector();
      apiConnector.setPort(configs.getClientApiPort());
      apiConnector.setMaxIdleTime(configs.getConnectionMaxIdleTime());
    }
    server.addConnector(apiConnector);
    server.setStopAtShutdown(true);
    serverForAgent.setStopAtShutdown(true);
    springAppContext.start();
    String osType=getServerOsType();
    if (osType == null || osType.isEmpty()) {
      throw new RuntimeException(Configuration.OS_VERSION_KEY + " is not " + " set in the ambari.properties file");
    }
    LOG.info("********* Initializing Clusters **********");
    Clusters clusters=injector.getInstance(Clusters.class);
    StringBuilder clusterDump=new StringBuilder();
    clusters.debugDump(clusterDump);
    LOG.info("********* Current Clusters State *********");
    LOG.info(clusterDump.toString());
    LOG.info("********* Reconciling Alert Definitions **********");
    ambariMetaInfo.reconcileAlertDefinitions(clusters);
    LOG.info("********* Initializing ActionManager **********");
    ActionManager manager=injector.getInstance(ActionManager.class);
    LOG.info("********* Initializing Controller **********");
    AmbariManagementController controller=injector.getInstance(AmbariManagementController.class);
    LOG.info("********* Initializing Scheduled Request Manager **********");
    ExecutionScheduleManager executionScheduleManager=injector.getInstance(ExecutionScheduleManager.class);
    clusterController=controller;
    server.start();
    serverForAgent.start();
    LOG.info("********* Started Server **********");
    manager.start();
    LOG.info("********* Started ActionManager **********");
    executionScheduleManager.start();
    LOG.info("********* Started Scheduled Request Manager **********");
    server.join();
    LOG.info("Joined the Server");
  }
 catch (  BadPaddingException bpe) {
    LOG.error("Bad keystore or private key password. " + "HTTPS certificate re-importing may be required.");
    throw bpe;
  }
catch (  BindException bindException) {
    LOG.error("Could not bind to server port - instance may already be running. " + "Terminating this instance.",bindException);
    throw bindException;
  }
}

{
  server=new Server(CLIENT_API_PORT);
  serverForAgent=new Server();
  try {
    ClassPathXmlApplicationContext parentSpringAppContext=new ClassPathXmlApplicationContext();
    parentSpringAppContext.refresh();
    ConfigurableListableBeanFactory factory=parentSpringAppContext.getBeanFactory();
    factory.registerSingleton("guiceInjector",injector);
    String[] contextLocations={SPRING_CONTEXT_LOCATION};
    ClassPathXmlApplicationContext springAppContext=new ClassPathXmlApplicationContext(contextLocations,parentSpringAppContext);
    Context root=new Context(server,CONTEXT_PATH,Context.ALL);
    GenericWebApplicationContext springWebAppContext=new GenericWebApplicationContext();
    springWebAppContext.setServletContext(root.getServletContext());
    springWebAppContext.setParent(springAppContext);
    root.getServletContext().setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE,springWebAppContext);
    certMan.initRootCert();
    Context agentroot=new Context(serverForAgent,"/",Context.SESSIONS);
    ServletHolder rootServlet=root.addServlet(DefaultServlet.class,"/");
    rootServlet.setInitOrder(1);
    rootServlet=agentroot.addServlet(DefaultServlet.class,"/");
    rootServlet.setInitOrder(1);
    DelegatingFilterProxy springSecurityFilter=new DelegatingFilterProxy();
    springSecurityFilter.setTargetBeanName("springSecurityFilterChain");
    root.addFilter(new FilterHolder(springSecurityFilter),"/*",1);
    SslSocketConnector sslConnectorTwoWay=new SslSocketConnector();
    sslConnectorTwoWay.setPort(CLIENT_TWO_WAY);
    Map<String,String> configsMap=configs.getConfigsMap();
    String keystore=configsMap.get(Configuration.SRVR_KSTR_DIR_KEY) + File.separator + configsMap.get(Configuration.KSTR_NAME_KEY);
    String srvrCrtPass=configsMap.get(Configuration.SRVR_CRT_PASS_KEY);
    sslConnectorTwoWay.setKeystore(keystore);
    sslConnectorTwoWay.setTruststore(keystore);
    sslConnectorTwoWay.setPassword(srvrCrtPass);
    sslConnectorTwoWay.setKeyPassword(srvrCrtPass);
    sslConnectorTwoWay.setTrustPassword(srvrCrtPass);
    sslConnectorTwoWay.setKeystoreType("PKCS12");
    sslConnectorTwoWay.setTruststoreType("PKCS12");
    sslConnectorTwoWay.setNeedClientAuth(true);
    SslSocketConnector sslConnectorOneWay=new SslSocketConnector();
    sslConnectorOneWay.setPort(CLIENT_ONE_WAY);
    sslConnectorOneWay.setKeystore(keystore);
    sslConnectorOneWay.setTruststore(keystore);
    sslConnectorOneWay.setPassword(srvrCrtPass);
    sslConnectorOneWay.setKeyPassword(srvrCrtPass);
    sslConnectorOneWay.setTrustPassword(srvrCrtPass);
    sslConnectorOneWay.setKeystoreType("PKCS12");
    sslConnectorOneWay.setTruststoreType("PKCS12");
    sslConnectorOneWay.setNeedClientAuth(false);
    serverForAgent.addConnector(sslConnectorOneWay);
    serverForAgent.addConnector(sslConnectorTwoWay);
    ServletHolder sh=new ServletHolder(ServletContainer.class);
    sh.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    sh.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.api.rest");
    root.addServlet(sh,"/api/*");
    sh.setInitOrder(2);
    ServletHolder agent=new ServletHolder(ServletContainer.class);
    agent.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    agent.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.agent.rest");
    agent.setInitParameter("com.sun.jersey.api.json.POJOMappingFeature","true");
    agentroot.addServlet(agent,"/agent/*");
    agent.setInitOrder(3);
    ServletHolder cert=new ServletHolder(ServletContainer.class);
    cert.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    cert.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.security.unsecured.rest");
    agentroot.addServlet(cert,"/*");
    cert.setInitOrder(4);
    ServletHolder resources=new ServletHolder(ServletContainer.class);
    resources.setInitParameter("com.sun.jersey.config.property.resourceConfigClass","com.sun.jersey.api.core.PackagesResourceConfig");
    resources.setInitParameter("com.sun.jersey.config.property.packages","org.apache.ambari.server.resources.api.rest");
    root.addServlet(resources,"/resources/*");
    resources.setInitOrder(6);
    server.setStopAtShutdown(true);
    serverForAgent.setStopAtShutdown(true);
    springAppContext.start();
    LOG.info("********* Initializing Clusters **********");
    Clusters clusters=injector.getInstance(Clusters.class);
    LOG.info("********* Initializing ActionManager **********");
    ActionManager manager=injector.getInstance(ActionManager.class);
    LOG.info("********* Initializing Controller **********");
    AmbariManagementController controller=injector.getInstance(AmbariManagementController.class);
    server.start();
    serverForAgent.start();
    LOG.info("********* Started Server **********");
    manager.start();
    LOG.info("********* Started ActionManager **********");
    server.join();
    LOG.info("Joined the Server");
  }
 catch (  Exception e) {
    LOG.error("Error in the server",e);
  }
}

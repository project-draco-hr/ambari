def test_flume_env_with_22(self):
    self.executeScript((self.COMMON_SERVICES_PACKAGE_DIR + '/scripts/flume_handler.py'), classname='FlumeHandler', command='configure', config_file='flume_22.json', hdp_stack_version=self.STACK_VERSION, target=RMFTestCase.TARGET_COMMON_SERVICES)
    self.assertResourceCalled('Directory', '/var/run/flume')
    self.assertResourceCalled('Directory', '/usr/hdp/current/flume-server/conf', owner='flume', recursive=True)
    self.assertResourceCalled('Directory', '/var/log/flume', owner='flume')
    self.assertResourceCalled('Directory', '/usr/hdp/current/flume-server/conf/a1', owner='flume')
    self.assertResourceCalled('PropertiesFile', '/usr/hdp/current/flume-server/conf/a1/flume.conf', owner='flume', mode=420, properties=build_flume(self.getConfig()['configurations']['flume-conf']['content'])['a1'])
    self.assertResourceCalled('File', '/usr/hdp/current/flume-server/conf/a1/log4j.properties', content=Template('log4j.properties.j2', agent_name='a1'), owner='flume', mode=420)
    self.assertResourceCalled('File', '/usr/hdp/current/flume-server/conf/a1/ambari-meta.json', content='{"channels_count": 1, "sinks_count": 1, "sources_count": 1}', owner='flume', mode=420)
    content = InlineTemplate(self.getConfig()['configurations']['flume-env']['content'])
    self.assertTrue((content.get_content().find('/usr/hdp/current/hive-metastore') > (-1)))
    self.assertResourceCalled('File', '/usr/hdp/current/flume-server/conf/a1/flume-env.sh', owner='flume', content=content)

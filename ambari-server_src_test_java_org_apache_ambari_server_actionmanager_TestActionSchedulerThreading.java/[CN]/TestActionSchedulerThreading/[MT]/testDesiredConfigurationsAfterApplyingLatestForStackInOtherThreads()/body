{
  long clusterId=ormTestHelper.createCluster(UUID.randomUUID().toString());
  Cluster cluster=clusters.getCluster(clusterId);
  ormTestHelper.addHost(clusters,cluster,"h1");
  StackId stackId=cluster.getCurrentStackVersion();
  StackId newStackId=new StackId("HDP-2.2.0");
  Assert.assertFalse(stackId.equals(newStackId));
  Map<String,String> properties=new HashMap<String,String>();
  Map<String,Map<String,String>> propertiesAttributes=new HashMap<String,Map<String,String>>();
  properties.put("foo-property-1","foo-value-1");
  Config c1=new ConfigImpl(cluster,"foo-type",properties,propertiesAttributes,injector);
  c1.setTag("version-1");
  c1.setStackId(stackId);
  c1.setVersion(1L);
  cluster.addConfig(c1);
  c1.persist();
  cluster.addDesiredConfig("admin",Sets.newHashSet(c1),"note-1");
  cluster.setDesiredStackVersion(newStackId);
  properties.put("foo-property-2","foo-value-2");
  Config c2=new ConfigImpl(cluster,"foo-type",properties,propertiesAttributes,injector);
  c2.setTag("version-2");
  c2.setStackId(newStackId);
  c2.setVersion(2L);
  cluster.addConfig(c2);
  c2.persist();
  cluster.addDesiredConfig("admin",Sets.newHashSet(c2),"note-2");
  Map<String,DesiredConfig> desiredConfigs=cluster.getDesiredConfigs();
  DesiredConfig desiredConfig=desiredConfigs.get("foo-type");
  desiredConfig=desiredConfigs.get("foo-type");
  assertNotNull(desiredConfig);
  assertEquals(Long.valueOf(2),desiredConfig.getVersion());
  assertEquals("version-2",desiredConfig.getTag());
  final String hostName=cluster.getHosts().iterator().next().getHostName();
  cluster.setDesiredStackVersion(stackId);
  Semaphore applyLatestConfigsSemaphore=new Semaphore(1,true);
  Semaphore threadInitialCachingSemaphore=new Semaphore(1,true);
  threadInitialCachingSemaphore.acquire();
  applyLatestConfigsSemaphore.acquire();
  final InstrumentedActionScheduler runnable=new InstrumentedActionScheduler(clusterId,hostName,threadInitialCachingSemaphore,applyLatestConfigsSemaphore);
  injector.injectMembers(runnable);
  final Thread thread=new Thread(runnable);
  thread.start();
  threadInitialCachingSemaphore.acquire();
  cluster.applyLatestConfigurations(stackId);
  applyLatestConfigsSemaphore.release();
  thread.join();
  runnable.validateAssertions();
}

def test_recommendDruidConfigurations_withMysql(self):
    hosts = {'items': [{'Hosts': {'cpu_count': 4, 'total_mem': 50331648, 'disk_info': [{'mountpoint': '/', }, {'mountpoint': '/dev/shm', }, {'mountpoint': '/vagrant', }, {'mountpoint': '/', }, {'mountpoint': '/dev/shm', }, {'mountpoint': '/vagrant', }], 'public_host_name': 'c6401.ambari.apache.org', 'host_name': 'c6401.ambari.apache.org', }, }], }
    services = {'Versions': {'parent_stack_version': '2.5', 'stack_name': 'HDP', 'stack_version': '2.6', 'stack_hierarchy': {'stack_name': 'HDP', 'stack_versions': ['2.5', '2.4', '2.3', '2.2', '2.1', '2.0.6'], }, }, 'services': [{'StackServices': {'service_name': 'DRUID', }, 'components': [{'StackServiceComponents': {'component_name': 'DRUID_COORDINATOR', 'hostnames': ['c6401.ambari.apache.org'], }, }, {'StackServiceComponents': {'component_name': 'DRUID_OVERLORD', 'hostnames': ['c6401.ambari.apache.org'], }, }, {'StackServiceComponents': {'component_name': 'DRUID_BROKER', 'hostnames': ['c6401.ambari.apache.org'], }, }, {'StackServiceComponents': {'component_name': 'DRUID_HISTORICAL', 'hostnames': ['c6401.ambari.apache.org'], }, }, {'StackServiceComponents': {'component_name': 'DRUID_MIDDLEMANAGER', 'hostnames': ['c6401.ambari.apache.org'], }, }], }], 'configurations': {'druid-common': {'properties': {'database_name': 'druid', 'metastore_hostname': 'c6401.ambari.apache.org', 'druid.metadata.storage.type': 'mysql', 'druid.extensions.loadList': '["postgresql-metadata-storage"]', 'druid.extensions.pullList': '[]', }, }, }, }
    clusterData = {'cpu': 4, 'mapMemory': 30000, 'amMemory': 20000, 'reduceMemory': 20560, 'containers': 30, 'ramPerContainer': 512, 'referenceNodeManagerHost': {'total_mem': (10240 * 1024), }, }
    configurations = {}
    self.stackAdvisor.recommendDruidConfigurations(configurations, clusterData, services, hosts)
    self.assertEquals(configurations, {'druid-historical': {'properties': {'druid.processing.numThreads': '3', 'druid.server.http.numThreads': '40', }, }, 'druid-broker': {'properties': {'druid.processing.numThreads': '3', 'druid.server.http.numThreads': '40', }, }, 'druid-common': {'properties': {'druid.extensions.loadList': '["mysql-metadata-storage"]', 'druid.metadata.storage.connector.port': '3306', 'druid.metadata.storage.connector.connectURI': 'jdbc:mysql://c6401.ambari.apache.org:3306/druid?createDatabaseIfNotExist=true', 'druid.zk.service.host': '', 'druid.extensions.pullList': '["io.druid.extensions:mysql-metadata-storage"]', }, }, 'druid-env': {'properties': {}, 'property_attributes': {'druid.coordinator.jvm.heap.memory': {'maximum': '49152', }, 'druid.overlord.jvm.heap.memory': {'maximum': '49152', }, 'druid.middlemanager.jvm.heap.memory': {'maximum': '49152', }, 'druid.historical.jvm.heap.memory': {'maximum': '49152', }, 'druid.broker.jvm.heap.memory': {'maximum': '49152', }, }, }, })

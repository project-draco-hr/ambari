{
  String clusterName=(String)requestMap.get(UPGRADE_CLUSTER_NAME);
  String version=(String)requestMap.get(UPGRADE_VERSION);
  if (null == clusterName) {
    throw new AmbariException(String.format("%s is required",UPGRADE_CLUSTER_NAME));
  }
  if (null == version) {
    throw new AmbariException(String.format("%s is required",UPGRADE_VERSION));
  }
  Cluster cluster=getManagementController().getClusters().getCluster(clusterName);
  StackId stack=cluster.getDesiredStackVersion();
  RepositoryVersionEntity versionEntity=m_repoVersionDAO.findByStackAndVersion(stack.getStackId(),version);
  if (null == versionEntity) {
    throw new AmbariException(String.format("Version %s for stack %s was not found",version,stack.getStackVersion()));
  }
  Map<String,UpgradePack> packs=m_metaProvider.get().getUpgradePacks(stack.getStackName(),stack.getStackVersion());
  UpgradePack up=packs.get(versionEntity.getUpgradePackage());
  if (null == up) {
    throw new AmbariException(String.format("Upgrade pack %s not found",versionEntity.getUpgradePackage()));
  }
  return up;
}

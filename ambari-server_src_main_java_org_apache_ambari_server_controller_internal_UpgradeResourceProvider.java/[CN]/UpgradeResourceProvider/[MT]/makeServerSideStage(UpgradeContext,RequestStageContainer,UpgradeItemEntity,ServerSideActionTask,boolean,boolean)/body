{
  Cluster cluster=context.getCluster();
  Map<String,String> commandParams=new HashMap<String,String>();
  commandParams.put(COMMAND_PARAM_CLUSTER_NAME,cluster.getClusterName());
  commandParams.put(COMMAND_PARAM_VERSION,context.getVersion());
  commandParams.put(COMMAND_PARAM_DIRECTION,context.getDirection().name().toLowerCase());
  commandParams.put(COMMAND_PARAM_ORIGINAL_STACK,context.getOriginalStackId().getStackId());
  commandParams.put(COMMAND_PARAM_TARGET_STACK,context.getTargetStackId().getStackId());
  String itemDetail=entity.getText();
  String stageText=StringUtils.abbreviate(entity.getText(),255);
  String hostName=null;
  Collection<Long> hostIds=cluster.getAllHostsDesiredConfigs().keySet();
  if (!hostIds.isEmpty()) {
    Long hostId=hostIds.iterator().next();
    HostEntity hostEntity=s_hostDAO.findById(hostId);
    if (hostEntity != null) {
      hostName=hostEntity.getHostName();
    }
  }
  if (StringUtils.isBlank(hostName)) {
    throw new AmbariException("Could not retrieve an arbitrary host name to use for the server-side command.");
  }
switch (task.getType()) {
case MANUAL:
{
      ManualTask mt=(ManualTask)task;
      itemDetail=mt.message;
      if (null != mt.summary) {
        stageText=mt.summary;
      }
      entity.setText(itemDetail);
      if (null != mt.structuredOut) {
        commandParams.put(COMMAND_PARAM_STRUCT_OUT,mt.structuredOut);
      }
      break;
    }
case CONFIGURE:
{
    ConfigureTask ct=(ConfigureTask)task;
    Map<String,String> configProperties=ct.getConfigurationProperties(cluster);
    List<ConfigureTask.Transfer> transfers=ct.getTransfers();
    if (configProperties.isEmpty() && transfers.isEmpty()) {
      stageText="No conditions were met for this configuration task.";
      itemDetail=stageText;
    }
 else {
      commandParams.putAll(configProperties);
      commandParams.put(ConfigureTask.PARAMETER_TRANSFERS,s_gson.toJson(transfers));
      String configType=configProperties.get(ConfigureTask.PARAMETER_CONFIG_TYPE);
      String key=configProperties.get(ConfigureTask.PARAMETER_KEY);
      String value=configProperties.get(ConfigureTask.PARAMETER_VALUE);
      StringBuilder detail=new StringBuilder(String.format("Updating config %s",configType));
      if (null != key && null != value) {
        detail.append(String.format("/%s to %s",key,value));
      }
      itemDetail=detail.toString();
      if (null != ct.summary) {
        stageText=ct.summary;
      }
 else {
        stageText=String.format("Updating Config %s",configType);
      }
    }
    entity.setText(itemDetail);
    break;
  }
default :
break;
}
ActionExecutionContext actionContext=new ActionExecutionContext(cluster.getClusterName(),Role.AMBARI_SERVER_ACTION.toString(),Collections.<RequestResourceFilter>emptyList(),commandParams);
actionContext.setTimeout(Short.valueOf((short)-1));
actionContext.setIgnoreMaintenance(true);
ExecuteCommandJson jsons=s_commandExecutionHelper.get().getCommandJson(actionContext,cluster);
Stage stage=s_stageFactory.get().createNew(request.getId().longValue(),"/tmp/ambari",cluster.getClusterName(),cluster.getClusterId(),stageText,jsons.getClusterHostInfo(),jsons.getCommandParamsForStage(),jsons.getHostParamsForStage());
stage.setSkippable(skippable);
long stageId=request.getLastStageId() + 1;
if (0L == stageId) {
stageId=1L;
}
stage.setStageId(stageId);
entity.setStageId(Long.valueOf(stageId));
stage.addServerActionCommand(task.getImplementationClass(),getManagementController().getAuthName(),Role.AMBARI_SERVER_ACTION,RoleCommand.EXECUTE,cluster.getClusterName(),hostName,new ServiceComponentHostServerActionEvent(StageUtils.getHostName(),System.currentTimeMillis()),commandParams,itemDetail,null,Integer.valueOf(1200),allowRetry);
request.addStages(Collections.singletonList(stage));
}

{
  RepositoryVersionEntity targetRve=s_repoVersionDAO.findMaxByVersion(version);
  if (null == targetRve) {
    LOG.info("Could not find version entity for {}; not setting new configs",version);
    return;
  }
  StackEntity targetStack=targetRve.getStack();
  StackId currentStackId=cluster.getCurrentStackVersion();
  StackId desiredStackId=cluster.getDesiredStackVersion();
  StackId targetStackId=new StackId(targetStack);
switch (direction) {
case UPGRADE:
    if (currentStackId.equals(targetStackId)) {
      return;
    }
  break;
case DOWNGRADE:
if (desiredStackId.equals(targetStackId)) {
  return;
}
break;
}
Map<String,Map<String,String>> newConfigurationsByType=null;
ConfigHelper configHelper=getManagementController().getConfigHelper();
if (direction == Direction.UPGRADE) {
Map<String,Map<String,String>> oldStackDefaultConfigurationsByType=configHelper.getDefaultProperties(currentStackId,cluster);
newConfigurationsByType=configHelper.getDefaultProperties(targetStackId,cluster);
Map<String,DesiredConfig> existingDesiredConfigurationsByType=cluster.getDesiredConfigs();
for (Map.Entry<String,DesiredConfig> existingEntry : existingDesiredConfigurationsByType.entrySet()) {
String configurationType=existingEntry.getKey();
Config currentClusterConfig=cluster.getDesiredConfigByType(configurationType);
if (null == currentClusterConfig) {
continue;
}
Map<String,String> existingConfigurations=currentClusterConfig.getProperties();
Map<String,String> newDefaultConfigurations=newConfigurationsByType.get(configurationType);
if (null == newDefaultConfigurations) {
newConfigurationsByType.put(configurationType,existingConfigurations);
continue;
}
for (Map.Entry<String,String> existingConfigurationEntry : existingConfigurations.entrySet()) {
String existingConfigurationKey=existingConfigurationEntry.getKey();
String existingConfigurationValue=existingConfigurationEntry.getValue();
if (newDefaultConfigurations.containsKey(existingConfigurationKey)) {
  String newDefaultConfigurationValue=newDefaultConfigurations.get(existingConfigurationKey);
  if (!StringUtils.equals(existingConfigurationValue,newDefaultConfigurationValue)) {
    Map<String,String> configurationTypeDefaultConfigurations=oldStackDefaultConfigurationsByType.get(configurationType);
    if (null != configurationTypeDefaultConfigurations) {
      String oldDefaultValue=configurationTypeDefaultConfigurations.get(existingConfigurationKey);
      if (!StringUtils.equals(existingConfigurationValue,oldDefaultValue)) {
        newDefaultConfigurations.put(existingConfigurationKey,existingConfigurationValue);
      }
    }
  }
}
 else {
  newDefaultConfigurations.put(existingConfigurationKey,existingConfigurationValue);
}
}
}
}
 else {
cluster.applyLatestConfigurations(cluster.getCurrentStackVersion());
}
cluster.setDesiredStackVersion(new StackId(targetStack.getStackName(),targetStack.getStackVersion()),true);
if (null != newConfigurationsByType) {
configHelper.createConfigTypes(cluster,getManagementController(),newConfigurationsByType,getManagementController().getAuthName(),"Configuration created for Upgrade");
}
}

{
  String clusterName=(String)requestMap.get(UPGRADE_CLUSTER_NAME);
  String version=(String)requestMap.get(UPGRADE_VERSION);
  String versionForUpgradePack=(String)requestMap.get(UPGRADE_FROM_VERSION);
  String preferredUpgradePackName=(String)requestMap.get(UPGRADE_PACK);
  UpgradeType upgradeType=UpgradeType.ROLLING;
  if (requestMap.containsKey(UPGRADE_TYPE)) {
    try {
      upgradeType=UpgradeType.valueOf(requestMap.get(UPGRADE_TYPE).toString());
    }
 catch (    Exception e) {
      throw new AmbariException(String.format("Property %s has an incorrect value of %s.",UPGRADE_TYPE,requestMap.get(UPGRADE_TYPE)));
    }
  }
  if (null == clusterName) {
    throw new AmbariException(String.format("%s is required",UPGRADE_CLUSTER_NAME));
  }
  if (null == version) {
    throw new AmbariException(String.format("%s is required",UPGRADE_VERSION));
  }
  Cluster cluster=getManagementController().getClusters().getCluster(clusterName);
  UpgradePack pack=s_upgradeHelper.suggestUpgradePack(clusterName,versionForUpgradePack,version,direction,upgradeType,preferredUpgradePackName);
  validatePreRequest(cluster,direction,version,requestMap);
  return pack;
}

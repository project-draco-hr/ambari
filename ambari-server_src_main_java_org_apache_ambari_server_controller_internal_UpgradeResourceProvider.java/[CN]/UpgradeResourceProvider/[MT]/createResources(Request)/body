{
  Set<Map<String,Object>> requestMaps=request.getProperties();
  if (requestMaps.size() > 1) {
    throw new SystemException("Can only initiate one upgrade per request.");
  }
  final Map<String,Object> requestMap=requestMaps.iterator().next();
  final Map<String,String> requestInfoProps=request.getRequestInfoProperties();
  UpgradeEntity entity=createResources(new Command<UpgradeEntity>(){
    @Override public UpgradeEntity invoke() throws AmbariException, AuthorizationException {
      String forceDowngrade=requestInfoProps.get(UpgradeResourceDefinition.DOWNGRADE_DIRECTIVE);
      Direction direction=Boolean.parseBoolean(forceDowngrade) ? Direction.DOWNGRADE : Direction.UPGRADE;
      UpgradePack up=validateRequest(direction,requestMap);
      return createUpgrade(direction,up,requestMap);
    }
  }
);
  if (null == entity) {
    throw new SystemException("Could not load upgrade");
  }
  notifyCreate(Resource.Type.Upgrade,request);
  Resource res=new ResourceImpl(Resource.Type.Upgrade);
  res.setProperty(UPGRADE_REQUEST_ID,entity.getRequestId());
  return new RequestStatusImpl(null,Collections.singleton(res));
}

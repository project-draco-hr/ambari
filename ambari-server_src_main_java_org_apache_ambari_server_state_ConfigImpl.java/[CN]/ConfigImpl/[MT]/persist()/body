{
  ClusterEntity clusterEntity=clusterDAO.findById(cluster.getClusterId());
  if (this.version == null) {
    this.version=cluster.getNextConfigVersion(type);
  }
  if (this.tag == null) {
    tag=GENERATED_TAG_PREFIX + version;
  }
  ClusterConfigEntity entity=new ClusterConfigEntity();
  entity.setClusterEntity(clusterEntity);
  entity.setClusterId(cluster.getClusterId());
  entity.setType(type);
  entity.setVersion(version);
  entity.setTag(getTag());
  entity.setTimestamp(new Date().getTime());
  entity.setData(gson.toJson(getProperties()));
  if (null != getPropertiesAttributes()) {
    entity.setAttributes(gson.toJson(getPropertiesAttributes()));
  }
  clusterDAO.createConfig(entity);
  clusterEntity.getClusterConfigEntities().add(entity);
  clusterDAO.merge(clusterEntity);
  cluster.refresh();
}

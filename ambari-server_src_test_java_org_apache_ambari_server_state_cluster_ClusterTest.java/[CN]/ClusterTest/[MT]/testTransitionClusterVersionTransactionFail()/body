{
  helper.getOrCreateRepositoryVersion("HDP","0.2");
  c1.createClusterVersion("HDP","0.2","admin",RepositoryVersionState.INSTALLING);
  c1.transitionClusterVersion("HDP","0.2",RepositoryVersionState.INSTALLED);
  c1.transitionClusterVersion("HDP","0.2",RepositoryVersionState.UPGRADING);
  c1.transitionClusterVersion("HDP","0.2",RepositoryVersionState.UPGRADED);
  try {
    ClusterVersionDAOMock.failOnCurrentVersionState=true;
    c1.transitionClusterVersion("HDP","0.2",RepositoryVersionState.CURRENT);
    Assert.fail();
  }
 catch (  AmbariException e) {
  }
 finally {
    ClusterVersionDAOMock.failOnCurrentVersionState=false;
  }
  assertNotNull(c1.getCurrentClusterVersion());
}

{
  createDefaultCluster();
  Cluster cluster=clusters.getCluster("c1");
  StackId stackId=cluster.getCurrentStackVersion();
  StackId newStackId=new StackId("HDP-2.2.0");
  ConfigHelper configHelper=injector.getInstance(ConfigHelper.class);
  Assert.assertFalse(stackId.equals(newStackId));
  Map<String,String> properties=new HashMap<String,String>();
  Map<String,Map<String,String>> propertiesAttributes=new HashMap<String,Map<String,String>>();
  properties.put("foo-property-1","foo-value-1");
  Config c1=new ConfigImpl(cluster,"foo-type",properties,propertiesAttributes,injector);
  c1.setTag("version-1");
  c1.setStackId(stackId);
  c1.setVersion(1L);
  cluster.addConfig(c1);
  c1.persist();
  cluster.addDesiredConfig("admin",Sets.newHashSet(c1),"note-1");
  cluster.setDesiredStackVersion(newStackId);
  properties.put("foo-property-2","foo-value-2");
  Config c2=new ConfigImpl(cluster,"foo-type",properties,propertiesAttributes,injector);
  c2.setTag("version-2");
  c2.setStackId(newStackId);
  c2.setVersion(2L);
  cluster.addConfig(c2);
  c2.persist();
  cluster.addDesiredConfig("admin",Sets.newHashSet(c2),"note-2");
  Map<String,DesiredConfig> desiredConfigs=cluster.getDesiredConfigs();
  DesiredConfig desiredConfig=desiredConfigs.get("foo-type");
  desiredConfig=desiredConfigs.get("foo-type");
  assertNotNull(desiredConfig);
  assertEquals(Long.valueOf(2),desiredConfig.getVersion());
  assertEquals("version-2",desiredConfig.getTag());
  String hostName=cluster.getHosts().iterator().next().getHostName();
  Map<String,Map<String,String>> effectiveDesiredTags=configHelper.getEffectiveDesiredTags(cluster,hostName);
  assertEquals("version-2",effectiveDesiredTags.get("foo-type").get("tag"));
  cluster.setDesiredStackVersion(stackId);
  cluster.applyLatestConfigurations(stackId);
  effectiveDesiredTags=configHelper.getEffectiveDesiredTags(cluster,hostName);
  assertEquals("version-1",effectiveDesiredTags.get("foo-type").get("tag"));
  desiredConfigs=cluster.getDesiredConfigs();
  desiredConfig=desiredConfigs.get("foo-type");
  assertNotNull(desiredConfig);
  assertEquals(Long.valueOf(1),desiredConfig.getVersion());
  assertEquals("version-1",desiredConfig.getTag());
}

{
  createDefaultCluster();
  Cluster cluster=clusters.getCluster("c1");
  ClusterEntity clusterEntity=clusterDAO.findByName("c1");
  StackId stackId=cluster.getCurrentStackVersion();
  StackId newStackId=new StackId("HDP-2.0.6");
  StackEntity currentStack=stackDAO.find(stackId.getStackName(),stackId.getStackVersion());
  StackEntity newStack=stackDAO.find(newStackId.getStackName(),newStackId.getStackVersion());
  Assert.assertFalse(stackId.equals(newStackId));
  String configType="foo-type";
  ClusterConfigEntity clusterConfig=new ClusterConfigEntity();
  clusterConfig.setClusterEntity(clusterEntity);
  clusterConfig.setConfigId(1L);
  clusterConfig.setStack(currentStack);
  clusterConfig.setTag("version-1");
  clusterConfig.setData("{}");
  clusterConfig.setType(configType);
  clusterConfig.setTimestamp(1L);
  clusterConfig.setVersion(1L);
  clusterDAO.createConfig(clusterConfig);
  clusterEntity.getClusterConfigEntities().add(clusterConfig);
  clusterEntity=clusterDAO.merge(clusterEntity);
  ClusterConfigEntity newClusterConfig=new ClusterConfigEntity();
  newClusterConfig.setClusterEntity(clusterEntity);
  newClusterConfig.setConfigId(2L);
  newClusterConfig.setStack(newStack);
  newClusterConfig.setTag("version-2");
  newClusterConfig.setData("{}");
  newClusterConfig.setType(configType);
  newClusterConfig.setTimestamp(2L);
  newClusterConfig.setVersion(2L);
  clusterDAO.createConfig(newClusterConfig);
  clusterEntity.getClusterConfigEntities().add(newClusterConfig);
  clusterEntity=clusterDAO.merge(clusterEntity);
  ClusterConfigMappingEntity configMapping=new ClusterConfigMappingEntity();
  configMapping.setClusterEntity(clusterEntity);
  configMapping.setCreateTimestamp(1L);
  configMapping.setSelected(1);
  configMapping.setTag("version-1");
  configMapping.setType(configType);
  configMapping.setUser("admin");
  ClusterConfigMappingEntity newConfigMapping=new ClusterConfigMappingEntity();
  newConfigMapping.setClusterEntity(clusterEntity);
  newConfigMapping.setCreateTimestamp(2L);
  newConfigMapping.setSelected(0);
  newConfigMapping.setTag("version-2");
  newConfigMapping.setType(configType);
  newConfigMapping.setUser("admin");
  clusterDAO.persistConfigMapping(configMapping);
  clusterDAO.persistConfigMapping(newConfigMapping);
  clusterEntity.getConfigMappingEntities().add(configMapping);
  clusterEntity.getConfigMappingEntities().add(newConfigMapping);
  clusterEntity=clusterDAO.merge(clusterEntity);
  List<ClusterConfigEntity> clusterConfigs=clusterDAO.getAllConfigurations(cluster.getClusterId(),newStackId);
  Assert.assertEquals(1,clusterConfigs.size());
  cluster.removeConfigurations(newStackId);
  clusterConfigs=clusterDAO.getAllConfigurations(cluster.getClusterId(),newStackId);
  Assert.assertEquals(0,clusterConfigs.size());
}

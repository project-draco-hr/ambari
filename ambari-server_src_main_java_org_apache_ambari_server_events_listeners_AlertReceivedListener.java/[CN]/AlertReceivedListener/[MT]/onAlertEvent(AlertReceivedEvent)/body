{
  if (LOG.isDebugEnabled()) {
    LOG.debug(event.toString());
  }
  long clusterId=event.getClusterId();
  Alert alert=event.getAlert();
  AlertCurrentEntity current=null;
  if (null == alert.getHost()) {
    current=m_alertsDao.findCurrentByNameNoHost(clusterId,alert.getName());
  }
 else {
    current=m_alertsDao.findCurrentByHostAndName(clusterId,alert.getHost(),alert.getName());
  }
  if (null == current) {
    AlertDefinitionEntity definition=m_definitionDao.findByName(clusterId,alert.getName());
    AlertHistoryEntity history=createHistory(clusterId,definition,alert);
    current=new AlertCurrentEntity();
    current.setAlertHistory(history);
    current.setLatestTimestamp(Long.valueOf(alert.getTimestamp()));
    current.setOriginalTimestamp(Long.valueOf(alert.getTimestamp()));
    m_alertsDao.create(current);
  }
 else   if (alert.getState() == current.getAlertHistory().getAlertState()) {
    current.setLatestTimestamp(Long.valueOf(alert.getTimestamp()));
    current.setLatestText(alert.getText());
    current=m_alertsDao.merge(current);
  }
 else {
    LOG.debug("Alert State Changed: CurrentId {}, CurrentTimestamp {}, HistoryId {}, HistoryState {}",current.getAlertId(),current.getLatestTimestamp(),current.getAlertHistory().getAlertId(),current.getAlertHistory().getAlertState());
    AlertHistoryEntity oldHistory=current.getAlertHistory();
    AlertState oldState=oldHistory.getAlertState();
    AlertHistoryEntity history=createHistory(clusterId,oldHistory.getAlertDefinition(),alert);
    m_alertsDao.create(history);
    current.setAlertHistory(history);
    current.setLatestTimestamp(Long.valueOf(alert.getTimestamp()));
    current.setOriginalTimestamp(Long.valueOf(alert.getTimestamp()));
    current=m_alertsDao.merge(current);
    LOG.debug("Alert State Merged: CurrentId {}, CurrentTimestamp {}, HistoryId {}, HistoryState {}",current.getAlertId(),current.getLatestTimestamp(),current.getAlertHistory().getAlertId(),current.getAlertHistory().getAlertState());
    AlertStateChangeEvent alertChangedEvent=new AlertStateChangeEvent(event.getClusterId(),event.getAlert(),current.getAlertHistory(),oldState);
    m_alertEventPublisher.publish(alertChangedEvent);
  }
}

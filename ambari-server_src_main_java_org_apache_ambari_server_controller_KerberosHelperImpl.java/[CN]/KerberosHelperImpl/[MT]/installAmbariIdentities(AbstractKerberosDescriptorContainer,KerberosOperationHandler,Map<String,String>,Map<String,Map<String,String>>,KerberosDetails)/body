{
  String ambariServerHostname=StageUtils.getHostName();
  KerberosIdentityDescriptor identity;
  identity=kerberosDescriptor.getIdentity(KerberosHelper.AMBARI_IDENTITY_NAME);
  if (identity != null) {
    KerberosPrincipalDescriptor principal=identity.getPrincipalDescriptor();
    if (principal != null) {
      Keytab keytab=createIdentity(identity,principal.getType(),kerberosEnvProperties,kerberosOperationHandler,configurations,ambariServerHostname);
      installAmbariIdentity(identity,keytab,configurations,ambariServerHostname,kerberosDetails,true);
      try {
        KerberosChecker.checkJaasConfiguration();
      }
 catch (      AmbariException e) {
        LOG.error("Error in Ambari JAAS configuration: " + e.getLocalizedMessage(),e);
      }
    }
  }
  identity=kerberosDescriptor.getIdentity(KerberosHelper.SPNEGO_IDENTITY_NAME);
  if (identity != null) {
    KerberosPrincipalDescriptor principal=identity.getPrincipalDescriptor();
    if (principal != null) {
      Keytab keytab=createIdentity(identity,principal.getType(),kerberosEnvProperties,kerberosOperationHandler,configurations,ambariServerHostname);
      installAmbariIdentity(identity,keytab,configurations,ambariServerHostname,kerberosDetails,false);
    }
  }
}

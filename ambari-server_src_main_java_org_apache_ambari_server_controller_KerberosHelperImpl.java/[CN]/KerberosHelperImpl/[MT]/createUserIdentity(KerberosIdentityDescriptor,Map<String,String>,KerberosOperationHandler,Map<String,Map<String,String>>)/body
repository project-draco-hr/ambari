{
  boolean created=false;
  if (identityDescriptor != null) {
    KerberosPrincipalDescriptor principalDescriptor=identityDescriptor.getPrincipalDescriptor();
    if (principalDescriptor != null) {
      if (KerberosPrincipalType.USER == principalDescriptor.getType()) {
        String principal=variableReplacementHelper.replaceVariables(principalDescriptor.getValue(),configurations);
        if (!kerberosPrincipalDAO.exists(principal)) {
          CreatePrincipalsServerAction.CreatePrincipalResult result;
          result=injector.getInstance(CreatePrincipalsServerAction.class).createPrincipal(principal,false,kerberosEnvProperties,kerberosOperationHandler,false,null);
          if (result == null) {
            throw new AmbariException("Failed to create the account for " + principal);
          }
 else {
            KerberosKeytabDescriptor keytabDescriptor=identityDescriptor.getKeytabDescriptor();
            if (keytabDescriptor != null) {
              Keytab keytab=injector.getInstance(CreateKeytabFilesServerAction.class).createKeytab(principal,result.getPassword(),result.getKeyNumber(),kerberosOperationHandler,true,true,null);
              if (keytab == null) {
                throw new AmbariException("Failed to create the keytab for " + principal);
              }
            }
            created=true;
          }
        }
      }
    }
  }
  return created;
}

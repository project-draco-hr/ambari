{
  if (kerberosDetails == null) {
    kerberosDetails=getKerberosDetails(cluster,null);
  }
  if (kerberosDetails.manageIdentities()) {
    KerberosCredential kerberosCredentials=getKDCCredentials();
    if (kerberosCredentials == null) {
      throw new KerberosMissingAdminCredentialsException("Missing KDC administrator credentials.\n" + "The KDC administrator credentials must be set in session by updating the relevant Cluster resource." + "This may be done by issuing a PUT to the api/v1/clusters/(cluster name) API entry point with the following payload:\n"+ "{\n"+ "  \"session_attributes\" : {\n"+ "    \"kerberos_admin\" : {\"principal\" : \"(PRINCIPAL)\", \"password\" : \"(PASSWORD)\"}\n"+ "  }\n"+ "}");
    }
 else {
      KerberosOperationHandler operationHandler=kerberosOperationHandlerFactory.getKerberosOperationHandler(kerberosDetails.getKdcType());
      if (operationHandler == null) {
        throw new AmbariException("Failed to get an appropriate Kerberos operation handler.");
      }
 else {
        boolean missingCredentials=false;
        try {
          operationHandler.open(kerberosCredentials,kerberosDetails.getDefaultRealm(),kerberosDetails.getKerberosEnvProperties());
          missingCredentials=!operationHandler.testAdministratorCredentials();
        }
 catch (        KerberosAdminAuthenticationException e) {
          throw new KerberosAdminAuthenticationException("Invalid KDC administrator credentials.\n" + "The KDC administrator credentials must be set in session by updating the relevant Cluster resource." + "This may be done by issuing a PUT to the api/v1/clusters/(cluster name) API entry point with the following payload:\n"+ "{\n"+ "  \"session_attributes\" : {\n"+ "    \"kerberos_admin\" : {\"principal\" : \"(PRINCIPAL)\", \"password\" : \"(PASSWORD)\"}\n"+ "  }\n"+ "}",e);
        }
catch (        KerberosKDCConnectionException e) {
          throw new KerberosInvalidConfigurationException("Failed to connect to KDC - " + e.getMessage() + "\n"+ "Update the KDC settings in krb5-conf and kerberos-env configurations to correct this issue.",e);
        }
catch (        KerberosRealmException e) {
          throw new KerberosInvalidConfigurationException("Failed to find a KDC for the specified realm - " + e.getMessage() + "\n"+ "Update the KDC settings in krb5-conf and kerberos-env configurations to correct this issue.",e);
        }
catch (        KerberosLDAPContainerException e) {
          throw new KerberosInvalidConfigurationException("The principal container was not specified\n" + "Set the 'container_dn' value in the kerberos-env configuration to correct this issue.",e);
        }
catch (        KerberosOperationException e) {
          throw new AmbariException(e.getMessage(),e);
        }
 finally {
          try {
            operationHandler.close();
          }
 catch (          KerberosOperationException e) {
          }
        }
        if (missingCredentials) {
          throw new KerberosMissingAdminCredentialsException("Invalid KDC administrator credentials.\n" + "The KDC administrator credentials must be set in session by updating the relevant Cluster resource." + "This may be done by issuing a PUT to the api/v1/clusters/(cluster name) API entry point with the following payload:\n"+ "{\n"+ "  \"session_attributes\" : {\n"+ "    \"kerberos_admin\" : {\"principal\" : \"(PRINCIPAL)\", \"password\" : \"(PASSWORD)\"}\n"+ "  }\n"+ "}");
        }
      }
    }
  }
}

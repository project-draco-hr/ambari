'\nLicensed to the Apache Software Foundation (ASF) under one\nor more contributor license agreements.  See the NOTICE file\ndistributed with this work for additional information\nregarding copyright ownership.  The ASF licenses this file\nto you under the Apache License, Version 2.0 (the\n"License"); you may not use this file except in compliance\nwith the License.  You may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'
import optparse
from pprint import pprint
import sys
import datetime
import os.path
import logging
import shutil
import json
import subprocess
import urllib
import time
GET_MR_MAPPING_ACTION = 'save-mr-mapping'
DELETE_MR_ACTION = 'delete-mr'
ADD_YARN_MR2_ACTION = 'add-yarn-mr2'
MODIFY_CONFIG_ACTION = 'update-configs'
BACKUP_CONFIG_ACTION = 'backup-configs'
INSTALL_YARN_MR2_ACTION = 'install-yarn-mr2'
VALID_ACTIONS = ', '.join([GET_MR_MAPPING_ACTION, DELETE_MR_ACTION, ADD_YARN_MR2_ACTION, MODIFY_CONFIG_ACTION, INSTALL_YARN_MR2_ACTION, BACKUP_CONFIG_ACTION])
MR_MAPPING_FILE = 'mr_mapping'
UPGRADE_LOG_FILE = 'upgrade_log'
CAPACITY_SCHEDULER_TAG = 'capacity-scheduler'
MAPRED_QUEUE_ACLS_TAG = 'mapred-queue-acls'
MAPRED_SITE_TAG = 'mapred-site'
GLOBAL_TAG = 'global'
HDFS_SITE_TAG = 'hdfs-site'
CORE_SITE_TAG = 'core-site'
YARN_SITE_TAG = 'yarn-site'
REPLACE_JH_HOST_NAME_TAG = 'REPLACE_JH_HOST'
REPLACE_RM_HOST_NAME_TAG = 'REPLACE_RM_HOST'
REPLACE_WITH_TAG = 'REPLACE_WITH_'
DELETE_OLD_TAG = 'DELETE_OLD'
AUTH_FORMAT = '{0}:{1}'
URL_FORMAT = 'http://{0}:8080/api/v1/clusters/{1}'
logger = logging.getLogger()
CAPACITY_SCHEDULER = {'yarn.scheduler.capacity.maximum-am-resource-percent': '0.2', 'yarn.scheduler.capacity.maximum-applications': '10000', 'yarn.scheduler.capacity.root.acl_administer_queues': '*', 'yarn.scheduler.capacity.root.capacity': '100', 'yarn.scheduler.capacity.root.default.acl_administer_jobs': '*', 'yarn.scheduler.capacity.root.default.acl_submit_jobs': '*', 'yarn.scheduler.capacity.root.default.capacity': '100', 'yarn.scheduler.capacity.root.default.maximum-capacity': '100', 'yarn.scheduler.capacity.root.default.state': 'RUNNING', 'yarn.scheduler.capacity.root.default.user-limit-factor': '1', 'yarn.scheduler.capacity.root.queues': 'default', 'yarn.scheduler.capacity.root.unfunded.capacity': '50', }
MAPRED_QUEUE_ACLS = {'mapred.queue.default.acl-administer-jobs': '*', 'mapred.queue.default.acl-submit-job': '*', }
MAPRED_SITE = {'hadoop.job.history.user.location': 'DELETE_OLD', 'io.sort.factor': 'DELETE_OLD', 'io.sort.mb': 'DELETE_OLD', 'io.sort.record.percent': 'DELETE_OLD', 'io.sort.spill.percent': 'DELETE_OLD', 'jetty.connector': 'DELETE_OLD', 'mapred.child.java.opts': 'DELETE_OLD', 'mapred.child.root.logger': 'DELETE_OLD', 'mapred.cluster.map.memory.mb': 'DELETE_OLD', 'mapred.cluster.max.map.memory.mb': 'DELETE_OLD', 'mapred.cluster.max.reduce.memory.mb': 'DELETE_OLD', 'mapred.cluster.reduce.memory.mb': 'DELETE_OLD', 'mapred.healthChecker.interval': 'DELETE_OLD', 'mapred.healthChecker.script.path': 'DELETE_OLD', 'mapred.healthChecker.script.timeout': 'DELETE_OLD', 'mapred.inmem.merge.threshold': 'DELETE_OLD', 'mapred.job.map.memory.mb': 'DELETE_OLD', 'mapred.job.reduce.input.buffer.percent': 'DELETE_OLD', 'mapred.job.reduce.memory.mb': 'DELETE_OLD', 'mapred.job.reuse.jvm.num.tasks': 'DELETE_OLD', 'mapred.job.shuffle.input.buffer.percent': 'DELETE_OLD', 'mapred.job.shuffle.merge.percent': 'DELETE_OLD', 'mapred.job.tracker': 'DELETE_OLD', 'mapred.job.tracker.handler.count': 'DELETE_OLD', 'mapred.job.tracker.history.completed.location': 'DELETE_OLD', 'mapred.job.tracker.http.address': 'DELETE_OLD', 'mapred.job.tracker.persist.jobstatus.active': 'DELETE_OLD', 'mapred.job.tracker.persist.jobstatus.dir': 'DELETE_OLD', 'mapred.job.tracker.persist.jobstatus.hours': 'DELETE_OLD', 'mapred.jobtracker.blacklist.fault-bucket-width': 'DELETE_OLD', 'mapred.jobtracker.blacklist.fault-timeout-window': 'DELETE_OLD', 'mapred.jobtracker.completeuserjobs.maximum': 'DELETE_OLD', 'mapred.jobtracker.maxtasks.per.job': 'DELETE_OLD', 'mapred.jobtracker.restart.recover': 'DELETE_OLD', 'mapred.jobtracker.retirejob.check': 'DELETE_OLD', 'mapred.jobtracker.retirejob.interval': 'DELETE_OLD', 'mapred.jobtracker.taskScheduler': 'DELETE_OLD', 'mapred.local.dir': 'DELETE_OLD', 'mapred.map.output.compression.codec': 'DELETE_OLD', 'mapred.map.tasks.speculative.execution': 'DELETE_OLD', 'mapred.max.tracker.blacklists': 'DELETE_OLD', 'mapred.output.compression.type': 'DELETE_OLD', 'mapred.queue.names': 'DELETE_OLD', 'mapred.reduce.parallel.copies': 'DELETE_OLD', 'mapred.reduce.slowstart.completed.maps': 'DELETE_OLD', 'mapred.reduce.tasks.speculative.execution': 'DELETE_OLD', 'mapred.system.dir': 'DELETE_OLD', 'mapred.task.timeout': 'DELETE_OLD', 'mapred.tasktracker.map.tasks.maximum': 'DELETE_OLD', 'mapred.tasktracker.reduce.tasks.maximum': 'DELETE_OLD', 'mapred.tasktracker.tasks.sleeptime-before-sigkill': 'DELETE_OLD', 'mapred.userlog.retain.hours': 'DELETE_OLD', 'mapreduce.admin.map.child.java.opts': '-Djava.net.preferIPv4Stack=true -Dhadoop.metrics.log.level=WARN', 'mapreduce.admin.reduce.child.java.opts': '-Djava.net.preferIPv4Stack=true -Dhadoop.metrics.log.level=WARN', 'mapreduce.admin.user.env': 'LD_LIBRARY_PATH=/usr/lib/hadoop/lib/native:/usr/lib/hadoop/lib/native/`$JAVA_HOME/bin/java -d32 -version &amp;&gt; /dev/null;if [ $? -eq 0 ]; then echo Linux-i386-32; else echo Linux-amd64-64;fi`', 'mapreduce.am.max-attempts': '2', 'mapreduce.application.classpath': '$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/*,$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/lib/*', 'mapreduce.fileoutputcommitter.marksuccessfuljobs': 'DELETE_OLD', 'mapreduce.framework.name': 'yarn', 'mapreduce.history.server.embedded': 'DELETE_OLD', 'mapreduce.history.server.http.address': 'DELETE_OLD', 'mapreduce.job.reduce.slowstart.completedmaps': 'REPLACE_WITH_mapred.reduce.slowstart.completed.maps', 'mapreduce.jobhistory.address': 'REPLACE_JH_HOST:10020', 'mapreduce.jobhistory.done-dir': 'REPLACE_WITH_mapred.job.tracker.history.completed.location', 'mapreduce.jobhistory.intermediate-done-dir': '/mr-history/tmp', 'mapreduce.jobhistory.webapp.address': 'REPLACE_JH_HOST:19888', 'mapreduce.jobtracker.split.metainfo.maxsize': 'DELETE_OLD', 'mapreduce.jobtracker.staging.root.dir': 'DELETE_OLD', 'mapreduce.jobtracker.system.dir': 'REPLACE_WITH_mapred.system.dir', 'mapreduce.map.java.opts': '-Xmx320m', 'mapreduce.map.log.level': 'INFO', 'mapreduce.map.memory.mb': 'REPLACE_WITH_mapred.job.map.memory.mb', 'mapreduce.map.sort.spill.percent': '0.1', 'mapreduce.map.speculative': 'REPLACE_WITH_mapred.map.tasks.speculative.execution', 'mapreduce.output.fileoutputformat.compress.type': 'REPLACE_WITH_mapred.output.compression.type', 'mapreduce.reduce.input.buffer.percent': 'REPLACE_WITH_mapred.job.reduce.input.buffer.percent', 'mapreduce.reduce.input.limit': 'DELETE_OLD', 'mapreduce.reduce.java.opts': '-Xmx756m', 'mapreduce.reduce.log.level': 'INFO', 'mapreduce.reduce.memory.mb': 'REPLACE_WITH_mapred.job.reduce.memory.mb', 'mapreduce.reduce.shuffle.input.buffer.percent': 'REPLACE_WITH_mapred.job.shuffle.input.buffer.percent', 'mapreduce.reduce.shuffle.merge.percent': 'REPLACE_WITH_mapred.job.shuffle.merge.percent', 'mapreduce.reduce.shuffle.parallelcopies': 'REPLACE_WITH_mapred.reduce.parallel.copies', 'mapreduce.reduce.speculative': 'REPLACE_WITH_mapred.reduce.tasks.speculative.execution', 'mapreduce.shuffle.port': '13562', 'mapreduce.task.io.sort.factor': 'REPLACE_WITH_io.sort.factor', 'mapreduce.task.io.sort.mb': 'REPLACE_WITH_io.sort.mb', 'mapreduce.task.timeout': 'REPLACE_WITH_mapred.task.timeout', 'mapreduce.tasktracker.group': 'DELETE_OLD', 'mapreduce.tasktracker.healthchecker.script.path': 'REPLACE_WITH_mapred.healthChecker.script.path', 'tasktracker.http.threads': 'DELETE_OLD', 'yarn.app.mapreduce.am.admin-command-opts': '-Djava.net.preferIPv4Stack=true -Dhadoop.metrics.log.level=WARN', 'yarn.app.mapreduce.am.command-opts': '-Xmx756m', 'yarn.app.mapreduce.am.log.level': 'INFO', 'yarn.app.mapreduce.am.resource.mb': '1024', 'yarn.app.mapreduce.am.staging-dir': 'REPLACE_WITH_mapreduce.jobtracker.staging.root.dir', }
GLOBAL = {'datanode_du_reserved': '1', 'dfs_datanode_data_dir': 'REPLACE_WITH_dfs_data_dir', 'dfs_exclude': 'dfs.exclude', 'dfs_include': 'DELETE_OLD', 'dfs_namenode_checkpoint_dir': 'REPLACE_WITH_fs_checkpoint_dir', 'dfs_namenode_checkpoint_period': 'REPLACE_WITH_fs_checkpoint_period', 'dfs_namenode_name_dir': 'REPLACE_WITH_dfs_name_dir', 'fs_checkpoint_size': '0.5', 'io_sort_spill_percent': 'DELETE_OLD', 'jtnode_heapsize': 'DELETE_OLD', 'jtnode_opt_maxnewsize': 'DELETE_OLD', 'jtnode_opt_newsize': 'DELETE_OLD', 'lzo_enabled': 'DELETE_OLD', 'mapred_child_java_opts_sz': 'DELETE_OLD', 'mapred_cluster_map_mem_mb': 'DELETE_OLD', 'mapred_cluster_max_map_mem_mb': 'DELETE_OLD', 'mapred_cluster_max_red_mem_mb': 'DELETE_OLD', 'mapred_cluster_red_mem_mb': 'DELETE_OLD', 'mapred_hosts_exclude': 'mapred.exclude', 'mapred_hosts_include': 'mapred.include', 'mapred_local_dir': 'DELETE_OLD', 'mapred_log_dir_prefix': '/var/log/hadoop-mapreduce', 'mapred_map_tasks_max': 'DELETE_OLD', 'mapred_pid_dir_prefix': '/var/run/hadoop-mapreduce', 'mapred_red_tasks_max': 'DELETE_OLD', 'mapreduce_jobtracker_system_dir': 'REPLACE_WITH_mapred_system_dir', 'mapreduce_map_memory_mb': 'REPLACE_WITH_mapred_job_map_mem_mb', 'mapreduce_reduce_memory_mb': 'REPLACE_WITH_mapred_job_red_mem_mb', 'mapreduce_task_io_sort_mb': 'REPLACE_WITH_io_sort_mb', 'maxtasks_per_job': 'DELETE_OLD', 'nodemanager_heapsize': '1024', 'rca_enabled': 'DELETE_OLD', 'resourcemanager_heapsize': '1024', 'scheduler_name': 'DELETE_OLD', 'snappy_enabled': 'DELETE_OLD', 'task_controller': 'org.apache.hadoop.mapred.DefaultTaskController', 'yarn_heapsize': '1024', 'yarn_log_dir_prefix': '/var/log/hadoop-yarn', 'yarn_nodemanager_local-dirs': '/var/log/hadoop/yarn', 'yarn_pid_dir_prefix': '/var/run/hadoop-yarn', 'yarn_user': 'yarn', }
HDFS_SITE = {'dfs.blocksize': 'REPLACE_WITH_dfs.block.size', 'dfs.client.read.shortcircuit': 'true', 'dfs.client.read.shortcircuit.streams.cache.size': '4096', 'dfs.datanode.balance.bandwidthPerSec': 'REPLACE_WITH_dfs.balance.bandwidthPerSec', 'dfs.datanode.data.dir': 'REPLACE_WITH_dfs.data.dir', 'dfs.datanode.du.pct': 'DELETE_OLD', 'dfs.datanode.max.transfer.threads': 'REPLACE_WITH_dfs.datanode.max.xcievers', 'dfs.datanode.socket.write.timeout': 'DELETE_OLD', 'dfs.domain.socket.path': '/var/lib/hadoop-hdfs/dn_socket', 'dfs.hosts': 'DELETE_OLD', 'dfs.journalnode.http-address': '0.0.0.0:8480', 'dfs.namenode.https-address': 'REPLACE_WITH_dfs.https.address', 'dfs.namenode.accesstime.precision': 'REPLACE_WITH_dfs.access.time.precision', 'dfs.namenode.http-address': 'REPLACE_WITH_dfs.http.address', 'dfs.namenode.name.dir': 'REPLACE_WITH_dfs.name.dir', 'dfs.namenode.safemode.threshold-pct': 'REPLACE_WITH_dfs.safemode.threshold.pct', 'dfs.namenode.secondary.http-address': 'REPLACE_WITH_dfs.secondary.http.address', 'dfs.permissions.enabled': 'REPLACE_WITH_dfs.permissions', 'dfs.permissions.superusergroup': 'REPLACE_WITH_dfs.permissions.supergroup', 'dfs.secondary.https.port': 'DELETE_OLD', 'dfs.web.ugi': 'DELETE_OLD', 'fs.permissions.umask-mode': '022', 'ipc.server.max.response.size': 'DELETE_OLD', 'ipc.server.read.threadpool.size': 'DELETE_OLD', }
CORE_SITE = {'dfs.namenode.checkpoint.dir': 'REPLACE_WITH_fs.checkpoint.dir', 'dfs.namenode.checkpoint.edits.dir': '${dfs.namenode.checkpoint.dir}', 'dfs.namenode.checkpoint.period': 'REPLACE_WITH_fs.checkpoint.period', 'fs.checkpoint.size': '0.5', 'fs.defaultFS': 'REPLACE_WITH_fs.default.name', 'hadoop.security.auth_to_local': '\n        RULE:[2:$1@$0]([rn]m@.*)s/.*/yarn/\n        RULE:[2:$1@$0](jhs@.*)s/.*/mapred/\n        RULE:[2:$1@$0]([nd]n@.*)s/.*/hdfs/\n        RULE:[2:$1@$0](hm@.*)s/.*/hbase/\n        RULE:[2:$1@$0](rs@.*)s/.*/hbase/\n        DEFAULT\n    ', 'hadoop.security.authentication': 'simple', 'hadoop.security.authorization': 'false', 'io.compression.codec.lzo.class': 'DELETE_OLD', 'io.compression.codecs': 'org.apache.hadoop.io.compress.GzipCodec,org.apache.hadoop.io.compress.DefaultCodec', 'mapreduce.jobtracker.webinterface.trusted': 'REPLACE_WITH_webinterface.private.actions', }
YARN_SITE = {'yarn.application.classpath': '/etc/hadoop/conf,/usr/lib/hadoop/*,/usr/lib/hadoop/lib/*,/usr/lib/hadoop-hdfs/*,/usr/lib/hadoop-hdfs/lib/*,/usr/lib/hadoop-yarn/*,/usr/lib/hadoop-yarn/lib/*,/usr/lib/hadoop-mapreduce/*,/usr/lib/hadoop-mapreduce/lib/*', 'yarn.log-aggregation-enable': 'true', 'yarn.log-aggregation.retain-seconds': '2592000', 'yarn.log.server.url': 'http://REPLACE_JH_HOST:19888/jobhistory/logs', 'yarn.nodemanager.address': '0.0.0.0:45454', 'yarn.nodemanager.admin-env': 'MALLOC_ARENA_MAX=$MALLOC_ARENA_MAX', 'yarn.nodemanager.aux-services': 'mapreduce_shuffle', 'yarn.nodemanager.aux-services.mapreduce_shuffle.class': 'org.apache.hadoop.mapred.ShuffleHandler', 'yarn.nodemanager.container-executor.class': 'org.apache.hadoop.yarn.server.nodemanager.DefaultContainerExecutor', 'yarn.nodemanager.container-monitor.interval-ms': '3000', 'yarn.nodemanager.delete.debug-delay-sec': '0', 'yarn.nodemanager.disk-health-checker.min-healthy-disks': '0.25', 'yarn.nodemanager.health-checker.interval-ms': '135000', 'yarn.nodemanager.health-checker.script.timeout-ms': '60000', 'yarn.nodemanager.linux-container-executor.group': 'hadoop', 'yarn.nodemanager.local-dirs': '/var/log/hadoop/yarn', 'yarn.nodemanager.log-aggregation.compression-type': 'gz', 'yarn.nodemanager.log-dirs': '/var/log/hadoop/yarn', 'yarn.nodemanager.log.retain-second': '604800', 'yarn.nodemanager.remote-app-log-dir': '/app-logs', 'yarn.nodemanager.remote-app-log-dir-suffix': 'logs', 'yarn.nodemanager.resource.memory-mb': '10240', 'yarn.nodemanager.vmem-check-enabled': 'false', 'yarn.nodemanager.vmem-pmem-ratio': '2.1', 'yarn.resourcemanager.address': 'REPLACE_RM_HOST:8050', 'yarn.resourcemanager.admin.address': 'REPLACE_RM_HOST:8141', 'yarn.resourcemanager.am.max-attempts': '2', 'yarn.resourcemanager.hostname': 'REPLACE_RM_HOST', 'yarn.resourcemanager.resource-tracker.address': 'REPLACE_RM_HOST:8025', 'yarn.resourcemanager.scheduler.address': 'REPLACE_RM_HOST:8030', 'yarn.resourcemanager.scheduler.class': 'org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler', 'yarn.resourcemanager.webapp.address': 'REPLACE_RM_HOST:8088', 'yarn.scheduler.maximum-allocation-mb': '6144', 'yarn.scheduler.minimum-allocation-mb': '512', }
if (__name__ == '__main__'):
    try:
        main()
    except (KeyboardInterrupt, EOFError):
        print '\nAborting ... Keyboard Interrupt.'
        sys.exit(1)

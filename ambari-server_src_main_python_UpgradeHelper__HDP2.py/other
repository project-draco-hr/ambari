'\nLicensed to the Apache Software Foundation (ASF) under one\nor more contributor license agreements.  See the NOTICE file\ndistributed with this work for additional information\nregarding copyright ownership.  The ASF licenses this file\nto you under the Apache License, Version 2.0 (the\n"License"); you may not use this file except in compliance\nwith the License.  You may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'
import optparse
from pprint import pprint
import sys
import datetime
import os.path
import logging
import shutil
import json
import subprocess
import urllib
import time
GET_MR_MAPPING_ACTION = 'save-mr-mapping'
DELETE_MR_ACTION = 'delete-mr'
ADD_YARN_MR2_ACTION = 'add-yarn-mr2'
MODIFY_CONFIG_ACTION = 'update-configs'
BACKUP_CONFIG_ACTION = 'backup-configs'
INSTALL_YARN_MR2_ACTION = 'install-yarn-mr2'
VALID_ACTIONS = ', '.join([GET_MR_MAPPING_ACTION, DELETE_MR_ACTION, ADD_YARN_MR2_ACTION, MODIFY_CONFIG_ACTION, INSTALL_YARN_MR2_ACTION, BACKUP_CONFIG_ACTION])
MR_MAPPING_FILE = 'mr_mapping'
UPGRADE_LOG_FILE = 'upgrade_log'
CAPACITY_SCHEDULER_TAG = 'capacity-scheduler'
MAPRED_QUEUE_ACLS_TAG = 'mapred-queue-acls'
MAPRED_SITE_TAG = 'mapred-site'
GLOBAL_TAG = 'global'
HDFS_SITE_TAG = 'hdfs-site'
CORE_SITE_TAG = 'core-site'
YARN_SITE_TAG = 'yarn-site'
REPLACE_JH_HOST_NAME_TAG = 'REPLACE_JH_HOST'
REPLACE_RM_HOST_NAME_TAG = 'REPLACE_RM_HOST'
REPLACE_WITH_TAG = 'REPLACE_WITH_'
AUTH_FORMAT = '{0}:{1}'
URL_FORMAT = 'http://{0}:8080/api/v1/clusters/{1}'
logger = logging.getLogger()
CAPACITY_SCHEDULER = {'yarn.scheduler.capacity.maximum-am-resource-percent': '0.2', 'yarn.scheduler.capacity.maximum-applications': '10000', 'yarn.scheduler.capacity.root.acl_administer_queues': '*', 'yarn.scheduler.capacity.root.capacity': '100', 'yarn.scheduler.capacity.root.default.acl_administer_jobs': '*', 'yarn.scheduler.capacity.root.default.acl_submit_jobs': '*', 'yarn.scheduler.capacity.root.default.capacity': '100', 'yarn.scheduler.capacity.root.default.maximum-capacity': '100', 'yarn.scheduler.capacity.root.default.state': 'RUNNING', 'yarn.scheduler.capacity.root.default.user-limit-factor': '1', 'yarn.scheduler.capacity.root.queues': 'default', 'yarn.scheduler.capacity.root.unfunded.capacity': '50', }
MAPRED_QUEUE_ACLS = {'mapred.queue.default.acl-administer-jobs': '*', 'mapred.queue.default.acl-submit-job': '*', }
MAPRED_SITE = {'mapred.hosts': '/etc/hadoop/conf/mapred.include', 'mapred.hosts.exclude': '/etc/hadoop/conf/mapred.exclude', 'mapred.jobtracker.maxtasks.per.job': '-1', 'mapred.jobtracker.taskScheduler': 'org.apache.hadoop.mapred.CapacityTaskScheduler', 'mapred.task.tracker.task-controller': 'org.apache.hadoop.mapred.DefaultTaskController', 'mapred.userlog.retain.hours': '24', 'mapreduce.admin.map.child.java.opts': '-Djava.net.preferIPv4Stack=true -Dhadoop.metrics.log.level=WARN', 'mapreduce.admin.reduce.child.java.opts': '-Djava.net.preferIPv4Stack=true -Dhadoop.metrics.log.level=WARN', 'mapreduce.admin.user.env': 'LD_LIBRARY_PATH=/usr/lib/hadoop/lib/native:/usr/lib/hadoop/lib/native/`$JAVA_HOME/bin/java -d32 -version &amp;&gt; /dev/null;if [ $? -eq 0 ]; then echo Linux-i386-32; else echo Linux-amd64-64;fi`', 'mapreduce.am.max-attempts': '2', 'mapreduce.application.classpath': '$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/*,$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/lib/*', 'mapreduce.framework.name': 'yarn', 'mapreduce.job.reduce.slowstart.completedmaps': '0.05', 'mapreduce.jobhistory.address': 'REPLACE_JH_HOST:10020', 'mapreduce.jobhistory.done-dir': '/mr-history/done', 'mapreduce.jobhistory.intermediate-done-dir': '/mr-history/tmp', 'mapreduce.jobhistory.webapp.address': 'REPLACE_JH_HOST:19888', 'mapreduce.jobtracker.system.dir': '/mapred/system', 'mapreduce.map.java.opts': '-Xmx320m', 'mapreduce.map.log.level': 'INFO', 'mapreduce.map.memory.mb': '1536', 'mapreduce.map.sort.spill.percent': '0.1', 'mapreduce.map.speculative': 'false', 'mapreduce.output.fileoutputformat.compress.type': 'BLOCK', 'mapreduce.reduce.input.buffer.percent': '0.0', 'mapreduce.reduce.java.opts': '-Xmx756m', 'mapreduce.reduce.log.level': 'INFO', 'mapreduce.reduce.memory.mb': '2048', 'mapreduce.reduce.shuffle.input.buffer.percent': '0.7', 'mapreduce.reduce.shuffle.merge.percent': '0.66', 'mapreduce.reduce.shuffle.parallelcopies': '30', 'mapreduce.reduce.speculative': 'false', 'mapreduce.shuffle.port': '13562', 'mapreduce.task.io.sort.factor': '100', 'mapreduce.task.io.sort.mb': '200', 'mapreduce.task.timeout': '600000', 'mapreduce.tasktracker.healthchecker.script.path': 'file:////mapred/jobstatus', 'mapreduce.tasktracker.map.tasks.maximum': '4', 'yarn.app.mapreduce.am.admin-command-opts': '-Djava.net.preferIPv4Stack=true -Dhadoop.metrics.log.level=WARN', 'yarn.app.mapreduce.am.command-opts': '-Xmx756m', 'yarn.app.mapreduce.am.log.level': 'INFO', 'yarn.app.mapreduce.am.resource.mb': '1024', 'yarn.app.mapreduce.am.staging-dir': '/user', }
GLOBAL = {'apache_artifacts_download_url': '', 'datanode_du_reserved': '1', 'dfs_block_local_path_access_user': 'hbase', 'dfs_datanode_address': 'REPLACE_WITH_dfs_datanode_address', 'dfs_datanode_data_dir': 'REPLACE_WITH_dfs_data_dir', 'dfs_datanode_data_dir_perm': '750', 'dfs_datanode_failed_volume_tolerated': '0', 'dfs_datanode_http_address': 'REPLACE_WITH_', 'dfs_exclude': 'dfs.exclude', 'dfs_namenode_checkpoint_dir': 'REPLACE_WITH_fs_checkpoint_dir', 'dfs_namenode_checkpoint_period': '21600', 'dfs_namenode_name_dir': 'REPLACE_WITH_dfs_name_dir', 'dfs_replication': '3', 'dfs_webhdfs_enabled': 'true', 'dtnode_heapsize': '1024m', 'fs_checkpoint_size': '0.5', 'ganglia_runtime_dir': 'REPLACE_WITH_', 'gmetad_user': 'REPLACE_WITH_', 'gmond_user': 'REPLACE_WITH_', 'gpl_artifacts_download_url': '', 'hadoop_conf_dir': 'REPLACE_WITH_', 'hadoop_heapsize': '1024', 'hadoop_pid_dir_prefix': 'REPLACE_WITH_', 'hbase_conf_dir': 'REPLACE_WITH_', 'hbase_user': 'REPLACE_WITH_', 'hcat_conf_dir': 'REPLACE_WITH_', 'hcat_user': 'REPLACE_WITH_', 'hdfs_enable_shortcircuit_read': 'true', 'hdfs_log_dir_prefix': 'REPLACE_WITH_', 'hdfs_user': 'REPLACE_WITH_', 'hive_user': 'REPLACE_WITH_', 'java64_home': 'REPLACE_WITH_', 'mapred_hosts_exclude': 'mapred.exclude', 'mapred_hosts_include': 'mapred.include', 'mapred_jobstatus_dir': 'REPLACE_WITH_', 'mapred_log_dir_prefix': '/var/log/hadoop-mapreduce', 'mapred_pid_dir_prefix': '/var/run/hadoop-mapreduce', 'mapred_user': 'REPLACE_WITH_', 'mapreduce_jobtracker_system_dir': 'REPLACE_WITH_mapred_system_dir', 'mapreduce_map_memory_mb': '1536', 'mapreduce_reduce_memory_mb': '2048', 'mapreduce_task_io_sort_mb': '200', 'mapreduce_tasktracker_map_tasks_maximum': '4', 'mapreduce_userlog_retainhours': '24', 'maxtasks_per_job': '-1', 'nagios_contact': 'REPLACE_WITH_', 'nagios_group': 'REPLACE_WITH_', 'nagios_user': 'REPLACE_WITH_', 'nagios_web_login': 'REPLACE_WITH_', 'nagios_web_password': 'REPLACE_WITH_', 'namenode_formatted_mark_dir': 'REPLACE_WITH_', 'namenode_heapsize': '1024m', 'namenode_opt_maxnewsize': '640m', 'namenode_opt_newsize': '200m', 'nodemanager_heapsize': '1024', 'oozie_user': 'REPLACE_WITH_', 'proxyuser_group': 'REPLACE_WITH_', 'resourcemanager_heapsize': '1024', 'rrdcached_base_dir': 'REPLACE_WITH_', 'run_dir': 'REPLACE_WITH_', 'scheduler_name': 'org.apache.hadoop.mapred.CapacityTaskScheduler', 'security_enabled': 'false', 'smokeuser': 'REPLACE_WITH_', 'task_controller': 'org.apache.hadoop.mapred.DefaultTaskController', 'user_group': 'REPLACE_WITH_', 'webhcat_user': 'REPLACE_WITH_', 'yarn_heapsize': '1024', 'yarn_log_dir_prefix': '/var/log/hadoop-yarn', 'yarn_nodemanager_local-dirs': '/var/log/hadoop/yarn', 'yarn_nodemanager_log-dirs': '/var/log/hadoop/yarn', 'yarn_pid_dir_prefix': '/var/run/hadoop-yarn', 'yarn_user': 'yarn', 'zk_user': 'REPLACE_WITH_', }
HDFS_SITE = {'dfs.block.access.token.enable': 'REPLACE_WITH_', 'dfs.block.local-path-access.user': 'REPLACE_WITH_', 'dfs.blockreport.initialDelay': 'REPLACE_WITH_', 'dfs.blocksize': 'REPLACE_WITH_dfs.block.size', 'dfs.client.read.shortcircuit': 'true', 'dfs.client.read.shortcircuit.streams.cache.size': '4096', 'dfs.cluster.administrators': 'REPLACE_WITH_', 'dfs.datanode.address': 'REPLACE_WITH_', 'dfs.datanode.balance.bandwidthPerSec': 'REPLACE_WITH_dfs.balance.bandwidthPerSec', 'dfs.datanode.data.dir': 'REPLACE_WITH_dfs.data.dir', 'dfs.datanode.data.dir.perm': 'REPLACE_WITH_', 'dfs.datanode.du.reserved': 'REPLACE_WITH_', 'dfs.datanode.failed.volumes.tolerated': 'REPLACE_WITH_', 'dfs.datanode.http.address': 'REPLACE_WITH_', 'dfs.datanode.ipc.address': 'REPLACE_WITH_', 'dfs.datanode.max.transfer.threads': 'REPLACE_WITH_dfs.datanode.max.xcievers', 'dfs.domain.socket.path': '/var/lib/hadoop-hdfs/dn_socket', 'dfs.heartbeat.interval': 'REPLACE_WITH_', 'dfs.hosts.exclude': 'REPLACE_WITH_', 'dfs.https.namenode.https-address': 'REPLACE_WITH_dfs.https.address', 'dfs.namenode.accesstime.precision': '0', 'dfs.namenode.avoid.read.stale.datanode': 'REPLACE_WITH_', 'dfs.namenode.avoid.write.stale.datanode': 'REPLACE_WITH_', 'dfs.namenode.handler.count': 'REPLACE_WITH_', 'dfs.namenode.http-address': 'REPLACE_WITH_dfs.http.address', 'dfs.namenode.name.dir': 'REPLACE_WITH_dfs.name.dir', 'dfs.namenode.safemode.threshold-pct': 'REPLACE_WITH_dfs.safemode.threshold.pct', 'dfs.namenode.secondary.http-address': 'REPLACE_WITH_dfs.secondary.http.address', 'dfs.namenode.stale.datanode.interval': 'REPLACE_WITH_', 'dfs.namenode.write.stale.datanode.ratio': 'REPLACE_WITH_', 'dfs.permissions.enabled': 'REPLACE_WITH_dfs.permissions', 'dfs.permissions.superusergroup': 'REPLACE_WITH_dfs.permissions.supergroup', 'dfs.replication': 'REPLACE_WITH_', 'dfs.replication.max': 'REPLACE_WITH_', 'dfs.webhdfs.enabled': 'REPLACE_WITH_', 'fs.permissions.umask-mode': '022', }
CORE_SITE = {'dfs.namenode.checkpoint.dir': 'REPLACE_WITH_fs.checkpoint.dir', 'dfs.namenode.checkpoint.edits.dir': '${dfs.namenode.checkpoint.dir}', 'dfs.namenode.checkpoint.period': 'REPLACE_WITH_fs.checkpoint.period', 'fs.checkpoint.edits.dir': 'REPLACE_WITH_', 'fs.checkpoint.size': '0.5', 'fs.defaultFS': 'REPLACE_WITH_fs.default.name', 'fs.trash.interval': 'REPLACE_WITH_', 'hadoop.security.auth_to_local': '\n        RULE:[2:$1@$0]([rn]m@.*)s/.*/yarn/\n        RULE:[2:$1@$0](jhs@.*)s/.*/mapred/\n        RULE:[2:$1@$0]([nd]n@.*)s/.*/hdfs/\n        RULE:[2:$1@$0](hm@.*)s/.*/hbase/\n        RULE:[2:$1@$0](rs@.*)s/.*/hbase/\n        DEFAULT\n    ', 'hadoop.security.authentication': 'simple', 'hadoop.security.authorization': 'false', 'io.compression.codecs': 'org.apache.hadoop.io.compress.GzipCodec,org.apache.hadoop.io.compress.DefaultCodec', 'io.file.buffer.size': 'REPLACE_WITH_', 'io.serializations': 'org.apache.hadoop.io.serializer.WritableSerialization', 'ipc.client.connect.max.retries': 'REPLACE_WITH_', 'ipc.client.connection.maxidletime': 'REPLACE_WITH_', 'ipc.client.idlethreshold': 'REPLACE_WITH_', 'mapreduce.jobtracker.webinterface.trusted': 'REPLACE_WITH_webinterface.private.actions', }
YARN_SITE = {'yarn.application.classpath': '/etc/hadoop/conf,/usr/lib/hadoop/*,/usr/lib/hadoop/lib/*,/usr/lib/hadoop-hdfs/*,/usr/lib/hadoop-hdfs/lib/*,/usr/lib/hadoop-yarn/*,/usr/lib/hadoop-yarn/lib/*,/usr/lib/hadoop-mapreduce/*,/usr/lib/hadoop-mapreduce/lib/*', 'yarn.log-aggregation-enable': 'true', 'yarn.log-aggregation.retain-seconds': '2592000', 'yarn.log.server.url': 'http://REPLACE_JH_HOST:19888/jobhistory/logs', 'yarn.nodemanager.address': '0.0.0.0:45454', 'yarn.nodemanager.admin-env': 'MALLOC_ARENA_MAX=$MALLOC_ARENA_MAX', 'yarn.nodemanager.aux-services': 'mapreduce.shuffle', 'yarn.nodemanager.aux-services.mapreduce.shuffle.class': 'org.apache.hadoop.mapred.ShuffleHandler', 'yarn.nodemanager.container-executor.class': 'org.apache.hadoop.yarn.server.nodemanager.DefaultContainerExecutor', 'yarn.nodemanager.container-monitor.interval-ms': '3000', 'yarn.nodemanager.delete.debug-delay-sec': '0', 'yarn.nodemanager.disk-health-checker.min-healthy-disks': '0.25', 'yarn.nodemanager.health-checker.interval-ms': '135000', 'yarn.nodemanager.health-checker.script.timeout-ms': '60000', 'yarn.nodemanager.linux-container-executor.group': 'hadoop', 'yarn.nodemanager.local-dirs': '/var/log/hadoop/yarn', 'yarn.nodemanager.log-aggregation.compression-type': 'gz', 'yarn.nodemanager.log-dirs': '/var/log/hadoop/yarn', 'yarn.nodemanager.log.retain-second': '604800', 'yarn.nodemanager.remote-app-log-dir': '/app-logs', 'yarn.nodemanager.remote-app-log-dir-suffix': 'logs', 'yarn.nodemanager.resource.memory-mb': '10240', 'yarn.nodemanager.vmem-check-enabled': 'false', 'yarn.nodemanager.vmem-pmem-ratio': '2.1', 'yarn.resourcemanager.address': 'REPLACE_RM_HOST:8050', 'yarn.resourcemanager.admin.address': 'REPLACE_RM_HOST:8141', 'yarn.resourcemanager.am.max-attempts': '2', 'yarn.resourcemanager.hostname': 'REPLACE_RM_HOST', 'yarn.resourcemanager.resource-tracker.address': 'REPLACE_RM_HOST:8025', 'yarn.resourcemanager.scheduler.address': 'REPLACE_RM_HOST:8030', 'yarn.resourcemanager.scheduler.class': 'org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler', 'yarn.resourcemanager.webapp.address': 'REPLACE_RM_HOST:8088', 'yarn.scheduler.maximum-allocation-mb': '6144', 'yarn.scheduler.minimum-allocation-mb': '512', }
if (__name__ == '__main__'):
    try:
        main()
    except (KeyboardInterrupt, EOFError):
        print '\nAborting ... Keyboard Interrupt.'
        sys.exit(1)

{
  LinkedList<StackInfo> parents=(LinkedList<StackInfo>)stackParentsMap.get(stackInfo.getVersion());
  if (parents == null || parents.isEmpty()) {
    return stackInfo.getServices();
  }
  parents.addFirst(stackInfo);
  ListIterator<StackInfo> lt=parents.listIterator(parents.size());
  Map<String,ServiceInfo> serviceInfoMap=new HashMap<String,ServiceInfo>();
  List<ServiceInfo> serviceInfoList=null;
  StackInfo parentStack=null;
  while (lt.hasPrevious()) {
    if (parentStack == null) {
      parentStack=lt.previous();
      serviceInfoList=parentStack.getServices();
      for (      ServiceInfo service : serviceInfoList) {
        if (!service.isDeleted()) {
          serviceInfoMap.put(service.getName(),service);
        }
      }
      continue;
    }
    StackInfo currentStackInfo=lt.previous();
    serviceInfoList=currentStackInfo.getServices();
    mergeStacks(parentStack,currentStackInfo);
    for (    ServiceInfo service : serviceInfoList) {
      ServiceInfo existingService=serviceInfoMap.get(service.getName());
      if (service.isDeleted()) {
        serviceInfoMap.remove(service.getName());
        continue;
      }
      if (existingService == null && !service.isDeleted()) {
        serviceInfoMap.put(service.getName(),service);
      }
 else {
        ServiceInfo newServiceInfo=mergeServices(existingService,service);
        serviceInfoMap.put(service.getName(),newServiceInfo);
      }
      ServiceInfo serviceInfo=serviceInfoMap.get(service.getName());
      if (serviceInfo.getExcludedConfigTypes() != null) {
        Iterator<Map.Entry<String,Map<String,Map<String,String>>>> configTypesItetator=serviceInfo.getConfigTypes().entrySet().iterator();
        while (configTypesItetator.hasNext()) {
          Map.Entry<String,Map<String,Map<String,String>>> configTypeMap=configTypesItetator.next();
          if (serviceInfo.getExcludedConfigTypes().contains(configTypeMap.getKey())) {
            configTypesItetator.remove();
          }
        }
      }
    }
    parentStack=currentStackInfo;
  }
  return new ArrayList<ServiceInfo>(serviceInfoMap.values());
}

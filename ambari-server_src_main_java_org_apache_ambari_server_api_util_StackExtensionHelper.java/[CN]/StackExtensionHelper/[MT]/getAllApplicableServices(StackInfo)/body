{
  LinkedList<StackInfo> parents=(LinkedList<StackInfo>)stackParentsMap.get(stackInfo.getVersion());
  if (parents == null || parents.isEmpty()) {
    return stackInfo.getServices();
  }
  parents.addFirst(stackInfo);
  ListIterator<StackInfo> lt=parents.listIterator(parents.size());
  Map<String,ServiceInfo> serviceInfoMap=new HashMap<String,ServiceInfo>();
  while (lt.hasPrevious()) {
    StackInfo parentStack=lt.previous();
    List<ServiceInfo> serviceInfoList=parentStack.getServices();
    mergeStacks(parentStack,stackInfo);
    for (    ServiceInfo service : serviceInfoList) {
      ServiceInfo existingService=serviceInfoMap.get(service.getName());
      if (service.isDeleted()) {
        serviceInfoMap.remove(service.getName());
        continue;
      }
      if (existingService == null) {
        serviceInfoMap.put(service.getName(),service);
      }
 else {
        ServiceInfo newServiceInfo=mergeServices(existingService,service);
        serviceInfoMap.put(service.getName(),newServiceInfo);
      }
      ServiceInfo serviceInfo=serviceInfoMap.get(service.getName());
      if (serviceInfo.getExcludedConfigTypes() != null) {
        Iterator<Map.Entry<String,Map<String,Map<String,String>>>> configTypesItetator=serviceInfo.getConfigTypes().entrySet().iterator();
        while (configTypesItetator.hasNext()) {
          Map.Entry<String,Map<String,Map<String,String>>> configTypeMap=configTypesItetator.next();
          if (serviceInfo.getExcludedConfigTypes().contains(configTypeMap.getKey())) {
            configTypesItetator.remove();
          }
        }
      }
      if (serviceInfo.getCommandScript() != null) {
        actionMetadata.addServiceCheckAction(serviceInfo.getName());
      }
    }
  }
  return new ArrayList<ServiceInfo>(serviceInfoMap.values());
}

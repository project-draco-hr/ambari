{
  Configuration configuration=createNiceMock(Configuration.class);
  Users users=createNiceMock(Users.class);
  LdapTemplate ldapTemplate=createNiceMock(LdapTemplate.class);
  LdapServerProperties ldapServerProperties=createNiceMock(LdapServerProperties.class);
  Capture<ContextMapper> contextMapperCapture=new Capture<ContextMapper>();
  Capture<SearchControls> searchControlsCapture=new Capture<SearchControls>();
  PagedResultsDirContextProcessor processor=createNiceMock(PagedResultsDirContextProcessor.class);
  PagedResultsCookie cookie=createNiceMock(PagedResultsCookie.class);
  LdapUserDto dto=new LdapUserDto();
  List<LdapUserDto> list=new LinkedList<LdapUserDto>();
  list.add(dto);
  expect(configuration.getLdapServerProperties()).andReturn(ldapServerProperties).anyTimes();
  expect(ldapServerProperties.getUserObjectClass()).andReturn("objectClass").anyTimes();
  expect(ldapServerProperties.getDnAttribute()).andReturn("dn").anyTimes();
  expect(ldapServerProperties.getBaseDN()).andReturn("baseDN").anyTimes();
  expect(processor.getCookie()).andReturn(cookie).anyTimes();
  expect(cookie.getCookie()).andReturn(null).anyTimes();
  expect(ldapTemplate.lookup(eq("uid=foo,dc=example,dc=com"),capture(contextMapperCapture))).andReturn(dto);
  expect(ldapTemplate.lookup(eq("foo"),capture(contextMapperCapture))).andReturn(null);
  expect(ldapTemplate.search(eq("baseDN"),eq("(&(objectClass=objectClass)(|(dn=foo)(uid=foo)))"),anyObject(SearchControls.class),capture(contextMapperCapture),eq(processor))).andReturn(list);
  replay(ldapTemplate,ldapServerProperties,users,configuration,processor,cookie);
  AmbariLdapDataPopulatorTestInstance populator=new AmbariLdapDataPopulatorTestInstance(configuration,users);
  populator.setLdapTemplate(ldapTemplate);
  populator.setProcessor(processor);
  assertEquals(dto,populator.getLdapUserByMemberAttr("uid=foo,dc=example,dc=com"));
  assertEquals(dto,populator.getLdapUserByMemberAttr("foo"));
  verify(ldapTemplate,ldapServerProperties,users,configuration,processor,cookie);
}

{
  User user1=createNiceMock(User.class);
  User user2=createNiceMock(User.class);
  expect(user1.getUserName()).andReturn("user1").anyTimes();
  expect(user2.getUserName()).andReturn("user2").anyTimes();
  expect(user1.isLdapUser()).andReturn(false).anyTimes();
  expect(user2.isLdapUser()).andReturn(false).anyTimes();
  List<User> userList=Arrays.asList(user1,user2);
  Configuration configuration=createNiceMock(Configuration.class);
  Users users=createNiceMock(Users.class);
  LdapTemplate ldapTemplate=createNiceMock(LdapTemplate.class);
  LdapServerProperties ldapServerProperties=createNiceMock(LdapServerProperties.class);
  expect(users.getAllUsers()).andReturn(userList);
  replay(ldapTemplate,ldapServerProperties,users,configuration);
  replay(user1,user2);
  AmbariLdapDataPopulatorTestInstance populator=createMockBuilder(AmbariLdapDataPopulatorTestInstance.class).addMockedMethod("getExternalLdapUserInfo").withConstructor(configuration,users).createNiceMock();
  LdapUserDto externalUser1=createNiceMock(LdapUserDto.class);
  LdapUserDto externalUser2=createNiceMock(LdapUserDto.class);
  expect(externalUser1.getUserName()).andReturn("user3").anyTimes();
  expect(externalUser2.getUserName()).andReturn("user4").anyTimes();
  replay(externalUser1,externalUser2);
  expect(populator.getExternalLdapUserInfo()).andReturn(createSet(externalUser1,externalUser2));
  replay(populator);
  populator.setLdapTemplate(ldapTemplate);
  populator.setLdapServerProperties(ldapServerProperties);
  LdapBatchDto result=populator.synchronizeAllLdapUsers(new LdapBatchDto());
  assertEquals(2,result.getUsersToBeCreated().size());
  assertTrue(result.getUsersToBeCreated().contains("user3"));
  assertTrue(result.getUsersToBeCreated().contains("user4"));
  assertTrue(result.getUsersToBecomeLdap().isEmpty());
  assertTrue(result.getUsersToBeRemoved().isEmpty());
  assertTrue(result.getGroupsToBeRemoved().isEmpty());
  assertTrue(result.getGroupsToBeCreated().isEmpty());
  assertTrue(result.getGroupsToBecomeLdap().isEmpty());
  assertTrue(result.getMembershipToAdd().isEmpty());
  assertTrue(result.getMembershipToRemove().isEmpty());
  verify(populator.loadLdapTemplate(),populator);
}

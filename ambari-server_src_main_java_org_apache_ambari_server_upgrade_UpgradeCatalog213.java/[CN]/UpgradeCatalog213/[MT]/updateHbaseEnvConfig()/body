{
  AmbariManagementController ambariManagementController=injector.getInstance(AmbariManagementController.class);
  for (  final Cluster cluster : getCheckedClusterMap(ambariManagementController.getClusters()).values()) {
    StackId stackId=cluster.getCurrentStackVersion();
    if (stackId != null && stackId.getStackName().equals("HDP") && VersionUtils.compareVersions(stackId.getStackVersion(),"2.2") >= 0) {
      Config hbaseEnvConfig=cluster.getDesiredConfigByType(HBASE_ENV_CONFIG);
      if (hbaseEnvConfig != null) {
        String content=hbaseEnvConfig.getProperties().get(CONTENT_PROPERTY);
        if (content != null && content.indexOf("MaxDirectMemorySize={{hbase_max_direct_memory_size}}m") < 0) {
          String newPartOfContent="\n\nexport HBASE_REGIONSERVER_OPTS=\"$HBASE_REGIONSERVER_OPTS {% if hbase_max_direct_memory_size %} -XX:MaxDirectMemorySize={{hbase_max_direct_memory_size}}m {% endif %}\"\n\n";
          content+=newPartOfContent;
          Map<String,String> updates=Collections.singletonMap(CONTENT_PROPERTY,content);
          updateConfigurationPropertiesForCluster(cluster,HBASE_ENV_CONFIG,updates,true,false);
        }
      }
    }
  }
}

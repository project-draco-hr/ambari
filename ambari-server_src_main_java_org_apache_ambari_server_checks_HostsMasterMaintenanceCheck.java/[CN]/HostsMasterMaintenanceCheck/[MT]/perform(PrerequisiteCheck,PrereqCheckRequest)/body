{
  final String clusterName=request.getClusterName();
  final Cluster cluster=clustersProvider.get().getCluster(clusterName);
  final StackId stackId=cluster.getDesiredStackVersion();
  final Set<String> hostsWithMasterComponent=new HashSet<String>();
  final String upgradePackName=repositoryVersionHelper.get().getUpgradePackageName(stackId.getStackName(),stackId.getStackVersion(),request.getRepositoryVersion());
  if (upgradePackName == null) {
    prerequisiteCheck.setStatus(PrereqCheckStatus.FAIL);
    prerequisiteCheck.setFailReason("Could not find suitable upgrade pack for " + stackId.getStackName() + " "+ stackId.getStackVersion()+ " to version "+ request.getRepositoryVersion());
    return;
  }
  final UpgradePack upgradePack=ambariMetaInfo.get().getUpgradePacks(stackId.getStackName(),stackId.getStackVersion()).get(upgradePackName);
  if (upgradePack == null) {
    prerequisiteCheck.setStatus(PrereqCheckStatus.FAIL);
    prerequisiteCheck.setFailReason("Could not find upgrade pack named " + upgradePackName);
    return;
  }
  final Set<String> componentsFromUpgradePack=new HashSet<String>();
  for (  Map<String,ProcessingComponent> task : upgradePack.getTasks().values()) {
    componentsFromUpgradePack.addAll(task.keySet());
  }
  for (  Service service : cluster.getServices().values()) {
    for (    ServiceComponent serviceComponent : service.getServiceComponents().values()) {
      if (serviceComponent.isMasterComponent() && componentsFromUpgradePack.contains(serviceComponent.getName())) {
        hostsWithMasterComponent.addAll(serviceComponent.getServiceComponentHosts().keySet());
      }
    }
  }
  final Map<String,Host> clusterHosts=clustersProvider.get().getHostsForCluster(clusterName);
  for (  Map.Entry<String,Host> hostEntry : clusterHosts.entrySet()) {
    final Host host=hostEntry.getValue();
    if (host.getMaintenanceState(cluster.getClusterId()) == MaintenanceState.ON && hostsWithMasterComponent.contains(host.getHostName())) {
      prerequisiteCheck.getFailedOn().add(host.getHostName());
    }
  }
  if (!prerequisiteCheck.getFailedOn().isEmpty()) {
    prerequisiteCheck.setStatus(PrereqCheckStatus.FAIL);
    prerequisiteCheck.setFailReason("Some hosts with master components are in Maintenance Mode");
  }
}

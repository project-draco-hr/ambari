{
  if (subResourceSet == null) {
    subResourceSet=new HashMap<String,QueryImpl>();
    Set<SubResourceDefinition> setSubResourceDefs=getResourceDefinition().getSubResourceDefinitions();
    ClusterController controller=clusterController;
    for (    SubResourceDefinition subResDef : setSubResourceDefs) {
      Resource.Type type=subResDef.getType();
      Map<Resource.Type,String> valueMap=getKeyValueMap();
      QueryImpl resource=new QueryImpl(valueMap,ResourceInstanceFactoryImpl.getResourceDefinition(type,valueMap),controller);
      resource.setMinimal(minimal);
      Schema schema=controller.getSchema(type);
      resource.addLocalProperty(schema.getKeyPropertyId(type));
      if (!minimal) {
        for (        Resource.Type fkType : subResDef.getAdditionalForeignKeys()) {
          resource.addLocalProperty(schema.getKeyPropertyId(fkType));
        }
      }
      String subResourceName=subResDef.isCollection() ? resource.getResourceDefinition().getPluralName() : resource.getResourceDefinition().getSingularName();
      subResourceSet.put(subResourceName,resource);
    }
  }
  return subResourceSet;
}

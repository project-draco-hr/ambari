{
  if (subResourceSet == null) {
    subResourceSet=new HashMap<String,QueryImpl>();
    Set<SubResourceDefinition> setSubResourceDefs=getResourceDefinition().getSubResourceDefinitions();
    ClusterController controller=clusterController;
    for (    SubResourceDefinition subResDef : setSubResourceDefs) {
      Resource.Type type=subResDef.getType();
      Map<Resource.Type,String> ids=getIds();
      QueryImpl resource=new QueryImpl(ids,ResourceInstanceFactoryImpl.getResourceDefinition(type,ids),controller);
      resource.addLocalProperty(controller.getSchema(type).getKeyPropertyId(type));
      for (      Resource.Type fkType : subResDef.getAdditionalForeignKeys()) {
        resource.addLocalProperty(controller.getSchema(type).getKeyPropertyId(fkType));
      }
      String subResourceName=subResDef.isCollection() ? resource.getResourceDefinition().getPluralName() : resource.getResourceDefinition().getSingularName();
      subResourceSet.put(subResourceName,resource);
    }
  }
  return subResourceSet;
}

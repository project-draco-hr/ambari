{
  Result result=createStrictMock(Result.class);
  TreeNode<Resource> tree=createStrictMock(TreeNode.class);
  TreeNode<Resource> componentNode=createStrictMock(TreeNode.class);
  ResourceDefinition componentResourceDef=createMock(ResourceDefinition.class);
  ResourceDefinition hostComponentResourceDef=createStrictMock(ResourceDefinition.class);
  Schema componentSchema=createMock(Schema.class);
  Resource componentResource=createStrictMock(Resource.class);
  PropertyId componentPropertyId=PropertyHelper.getPropertyId("componentId","");
  Query hostComponentQuery=createStrictMock(Query.class);
  Result hostComponentQueryResult=createStrictMock(Result.class);
  TreeNode<Resource> hostComponentResultTree=createMock(TreeNode.class);
  List<Resource> listResources=Collections.singletonList(componentResource);
  Map<Resource.Type,String> mapResourceIds=new HashMap<Resource.Type,String>();
  mapResourceIds.put(Resource.Type.Cluster,"clusterName");
  mapResourceIds.put(Resource.Type.Service,"serviceName");
  mapResourceIds.put(Resource.Type.Component,"componentName");
  Map<String,ResourceDefinition> mapChildren=new HashMap<String,ResourceDefinition>();
  mapChildren.put("host_components",hostComponentResourceDef);
  PredicateBuilder pb=new PredicateBuilder();
  Predicate predicate=pb.property("clusterId","").equals("clusterName").and().property("serviceId","").equals("serviceName").and().property("componentId","").equals("componentName").toPredicate();
  expect(componentResourceDef.getId()).andReturn("componentName").atLeastOnce();
  expect(m_controller.getSchema(Resource.Type.Component)).andReturn(componentSchema).atLeastOnce();
  expect(componentSchema.getCategories()).andReturn(Collections.<String,Set<String>>emptyMap());
  expect(componentResourceDef.getSubResources()).andReturn(mapChildren);
  expect(componentResourceDef.getType()).andReturn(Resource.Type.Component).atLeastOnce();
  expect(componentResourceDef.getResourceIds()).andReturn(mapResourceIds);
  expect(componentSchema.getKeyPropertyId(Resource.Type.Cluster)).andReturn(new PropertyIdImpl("clusterId","",false));
  expect(componentSchema.getKeyPropertyId(Resource.Type.Service)).andReturn(new PropertyIdImpl("serviceId","",false));
  expect(componentSchema.getKeyPropertyId(Resource.Type.Component)).andReturn(componentPropertyId).atLeastOnce();
  expect(m_controller.getResources(eq(Resource.Type.Component),eq(PropertyHelper.getReadRequest(Collections.<PropertyId>emptySet())),eq(predicate))).andReturn(listResources);
  expect(result.getResultTree()).andReturn(tree);
  expect(tree.addChild(componentResource,null)).andReturn(componentNode);
  expect(componentNode.addChild(hostComponentResultTree)).andReturn(hostComponentResultTree);
  expect(componentResource.getPropertyValue(componentPropertyId)).andReturn("componentName");
  hostComponentResourceDef.setParentId(Resource.Type.Component,"componentName");
  expect(hostComponentResourceDef.getQuery()).andReturn(hostComponentQuery);
  expect(hostComponentQuery.execute()).andReturn(hostComponentQueryResult);
  expect(hostComponentQueryResult.getResultTree()).andReturn(hostComponentResultTree);
  hostComponentResultTree.setName("host_components");
  hostComponentResultTree.setProperty("isCollection","false");
  replay(m_controller,result,tree,componentNode,componentResourceDef,hostComponentResourceDef,componentSchema,componentResource,hostComponentQuery,hostComponentQueryResult,hostComponentResultTree);
  QueryImpl query=new TestQuery(componentResourceDef,result);
  query.execute();
  verify(m_controller,result,tree,componentNode,componentResourceDef,hostComponentResourceDef,componentSchema,componentResource,hostComponentQuery,hostComponentQueryResult,hostComponentResultTree);
}

{
  LOG.debug("Received event {}",event);
  Cluster cluster=event.getCluster();
  ServiceComponentHost sch=event.getServiceComponentHost();
  String newVersion=event.getVersion();
  if (StringUtils.isEmpty(newVersion)) {
    return;
  }
  m_stackVersionLock.lock();
  if (null != event.getRepositoryVersionId() && null == cluster.getUpgradeInProgress()) {
    RepositoryVersionEntity rve=repositoryVersionDAO.findByPK(event.getRepositoryVersionId());
    if (null != rve) {
      String currentRepoVersion=rve.getVersion();
      if (!StringUtils.equals(currentRepoVersion,newVersion)) {
        rve.setVersion(newVersion);
        repositoryVersionDAO.merge(rve);
      }
    }
  }
  try {
    ServiceComponent sc=cluster.getService(sch.getServiceName()).getServiceComponent(sch.getServiceComponentName());
    if (UNKNOWN_VERSION.equals(sc.getDesiredVersion())) {
      processUnknownDesiredVersion(cluster,sc,sch,newVersion);
    }
 else     if (StringUtils.isNotBlank(newVersion)) {
      String previousVersion=sch.getVersion();
      if (previousVersion == null || UNKNOWN_VERSION.equalsIgnoreCase(previousVersion)) {
        sch.setUpgradeState(UpgradeState.NONE);
        sch.setVersion(newVersion);
        bootstrapVersion(cluster,sch);
      }
 else       if (!StringUtils.equals(previousVersion,newVersion)) {
        processComponentVersionChange(cluster,sc,sch,newVersion);
      }
    }
  }
 catch (  Exception e) {
    LOG.error("Unable to propagate version for ServiceHostComponent on component: {}, host: {}. Error: {}",sch.getServiceComponentName(),sch.getHostName(),e.getMessage());
  }
 finally {
    m_stackVersionLock.unlock();
  }
}

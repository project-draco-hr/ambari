{
  if (requestStageContainer == null) {
    requestStageContainer=new RequestStageContainer(actionManager.getNextRequestId(),null,requestFactory,actionManager);
  }
  Map<String,String> commandParameters=new HashMap<String,String>();
  commandParameters.put(KerberosServerAction.DATA_DIRECTORY,dataDirectory.getAbsolutePath());
  commandParameters.put(KerberosServerAction.DEFAULT_REALM,kerberosDetails.getDefaultRealm());
  commandParameters.put(KerberosServerAction.KDC_TYPE,kerberosDetails.getKdcType().name());
  commandParameters.put(KerberosServerAction.ADMINISTRATOR_CREDENTIAL,getEncryptedAdministratorCredentials(cluster));
  if (!kerberosConfigurations.isEmpty()) {
    File configFile=new File(dataDirectory,KerberosConfigDataFile.DATA_FILE_NAME);
    KerberosConfigDataFileBuilder kerberosConfDataFileBuilder=null;
    if (serviceComponentHosts != null) {
      Set<String> visitedServices=new HashSet<String>();
      for (      ServiceComponentHost sch : serviceComponentHosts) {
        String serviceName=sch.getServiceName();
        if (!visitedServices.contains(serviceName)) {
          StackId stackVersion=sch.getStackVersion();
          visitedServices.add(serviceName);
          if (stackVersion != null) {
            Set<PropertyInfo> serviceProperties=configHelper.getServiceProperties(stackVersion,serviceName,true);
            if (serviceProperties != null) {
              for (              PropertyInfo propertyInfo : serviceProperties) {
                String filename=propertyInfo.getFilename();
                if (filename != null) {
                  Map<String,String> kerberosConfiguration=kerberosConfigurations.get(ConfigHelper.fileNameToConfigType(filename));
                  if ((kerberosConfiguration != null) && (kerberosConfiguration.containsKey(propertyInfo.getName()))) {
                    kerberosConfiguration.put(propertyInfo.getName(),propertyInfo.getValue());
                  }
                }
              }
            }
          }
        }
      }
    }
    try {
      kerberosConfDataFileBuilder=new KerberosConfigDataFileBuilder(configFile);
      for (      Map.Entry<String,Map<String,String>> entry : kerberosConfigurations.entrySet()) {
        String type=entry.getKey();
        Map<String,String> properties=entry.getValue();
        if (properties != null) {
          for (          Map.Entry<String,String> configTypeEntry : properties.entrySet()) {
            kerberosConfDataFileBuilder.addRecord(type,configTypeEntry.getKey(),configTypeEntry.getValue());
          }
        }
      }
    }
 catch (    IOException e) {
      String message=String.format("Failed to write kerberos configurations file - %s",configFile.getAbsolutePath());
      LOG.error(message);
      throw new AmbariException(message,e);
    }
 finally {
      if (kerberosConfDataFileBuilder != null) {
        try {
          kerberosConfDataFileBuilder.close();
        }
 catch (        IOException e) {
          LOG.warn("Failed to close the kerberos configurations file writer",e);
        }
      }
    }
  }
  addUpdateConfigurationsStage(cluster,clusterHostInfoJson,hostParamsJson,event,commandParameters,roleCommandOrder,requestStageContainer);
  addDestroyPrincipalsStage(cluster,clusterHostInfoJson,hostParamsJson,event,commandParameters,roleCommandOrder,requestStageContainer);
  return requestStageContainer.getLastStageId();
}

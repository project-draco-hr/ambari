{
  final String clusterName=request.getClusterName();
  final Cluster cluster=clustersProvider.get().getCluster(clusterName);
  final Map<String,Host> clusterHosts=clustersProvider.get().getHostsForCluster(clusterName);
  for (  Map.Entry<String,Host> hostEntry : clusterHosts.entrySet()) {
    final Host host=hostEntry.getValue();
    if (host.getMaintenanceState(cluster.getClusterId()) == MaintenanceState.OFF) {
      final RepositoryVersionEntity repositoryVersion=repositoryVersionDaoProvider.get().findByDisplayName(request.getRepositoryVersion());
      final HostVersionEntity hostVersion=hostVersionDaoProvider.get().findByClusterStackVersionAndHost(clusterName,repositoryVersion.getStack(),repositoryVersion.getVersion(),host.getHostName());
      if (hostVersion == null || hostVersion.getState() != RepositoryVersionState.INSTALLED) {
        prerequisiteCheck.getFailedOn().add(host.getHostName());
      }
    }
  }
  if (!prerequisiteCheck.getFailedOn().isEmpty()) {
    prerequisiteCheck.setStatus(PrereqCheckStatus.FAIL);
    prerequisiteCheck.setFailReason("Some hosts do not have repository version " + request.getRepositoryVersion() + " installed");
  }
}

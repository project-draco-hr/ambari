@patch('resource_management.libraries.script.Script.put_structured_out')
@patch('os.system')
def test_rebalance_secured_hdfs(self, pso, system_mock):
    system_mock.return_value = (-1)
    self.executeScript((self.COMMON_SERVICES_PACKAGE_DIR + '/scripts/namenode.py'), classname='NameNode', command='rebalancehdfs', config_file='rebalancehdfs_secured.json', stack_version=self.STACK_VERSION, target=RMFTestCase.TARGET_COMMON_SERVICES, call_mocks=[(1, 'no kinit')])
    tempdir = tempfile.gettempdir()
    ccache_path = os.path.join(tempfile.gettempdir(), 'hdfs_rebalance_cc_7add60ca651f1bd1ed909a6668937ba9')
    kinit_cmd = '/usr/bin/kinit -c {0} -kt /etc/security/keytabs/hdfs.headless.keytab hdfs@EXAMPLE.COM'.format(ccache_path)
    rebalance_cmd = "ambari-sudo.sh su hdfs -l -s /bin/bash -c 'export  PATH=/bin:/usr/bin KRB5CCNAME={0} ; hdfs --config /etc/hadoop/conf balancer -threshold -1'".format(ccache_path)
    self.assertResourceCalled('Execute', kinit_cmd, user='hdfs')
    self.assertResourceCalled('Execute', rebalance_cmd, logoutput=False, on_new_line=FunctionMock('handle_new_line'))
    self.assertResourceCalled('File', ccache_path, action=['delete'])
    self.assertNoMoreResources()

{
  SecurityContextHolder.getContext().setAuthentication(TestAuthenticationFactory.createClusterAdministrator("jdoe",2L));
  PrincipalTypeEntity rolePrincipalTypeEntity=createMock(PrincipalTypeEntity.class);
  expect(rolePrincipalTypeEntity.getName()).andReturn("ROLE").atLeastOnce();
  PrincipalEntity rolePrincipalEntity=createMock(PrincipalEntity.class);
  expect(rolePrincipalEntity.getPrincipalType()).andReturn(rolePrincipalTypeEntity).atLeastOnce();
  PermissionEntity permissionEntity=createMock(PermissionEntity.class);
  expect(permissionEntity.getPrincipal()).andReturn(rolePrincipalEntity).atLeastOnce();
  expect(permissionEntity.getPermissionName()).andReturn("CLUSTER.ADMINISTRATOR").atLeastOnce();
  expect(permissionEntity.getPermissionLabel()).andReturn("Cluster Administrator").atLeastOnce();
  PrincipalTypeEntity principalTypeEntity=createMock(PrincipalTypeEntity.class);
  expect(principalTypeEntity.getName()).andReturn("USER").atLeastOnce();
  PrincipalEntity principalEntity=createMock(PrincipalEntity.class);
  expect(principalEntity.getPrincipalType()).andReturn(principalTypeEntity).atLeastOnce();
  ViewEntity viewEntity=createMock(ViewEntity.class);
  expect(viewEntity.getCommonName()).andReturn("TestView").atLeastOnce();
  expect(viewEntity.getVersion()).andReturn("1.2.3.4").atLeastOnce();
  ResourceTypeEntity resourceTypeEntity=createMock(ResourceTypeEntity.class);
  expect(resourceTypeEntity.getName()).andReturn("TestView{1.2.3.4}").atLeastOnce();
  ResourceEntity resourceEntity=createMock(ResourceEntity.class);
  expect(resourceEntity.getId()).andReturn(1L).anyTimes();
  expect(resourceEntity.getResourceType()).andReturn(resourceTypeEntity).anyTimes();
  ViewInstanceEntity viewInstanceEntity=createMock(ViewInstanceEntity.class);
  expect(viewInstanceEntity.getViewEntity()).andReturn(viewEntity).atLeastOnce();
  expect(viewInstanceEntity.getName()).andReturn("Test View").atLeastOnce();
  PrivilegeEntity explicitPrivilegeEntity=createMock(PrivilegeEntity.class);
  expect(explicitPrivilegeEntity.getId()).andReturn(1).atLeastOnce();
  expect(explicitPrivilegeEntity.getPermission()).andReturn(permissionEntity).atLeastOnce();
  expect(explicitPrivilegeEntity.getPrincipal()).andReturn(principalEntity).atLeastOnce();
  expect(explicitPrivilegeEntity.getResource()).andReturn(resourceEntity).atLeastOnce();
  PrivilegeEntity implicitPrivilegeEntity=createMock(PrivilegeEntity.class);
  expect(implicitPrivilegeEntity.getId()).andReturn(2).atLeastOnce();
  expect(implicitPrivilegeEntity.getPermission()).andReturn(permissionEntity).atLeastOnce();
  expect(implicitPrivilegeEntity.getPrincipal()).andReturn(rolePrincipalEntity).atLeastOnce();
  expect(implicitPrivilegeEntity.getResource()).andReturn(resourceEntity).atLeastOnce();
  UserEntity userEntity=createMock(UserEntity.class);
  expect(userEntity.getUserName()).andReturn("jdoe").atLeastOnce();
  expect(userEntity.getPrincipal()).andReturn(principalEntity).atLeastOnce();
  ClusterDAO clusterDAO=createMock(ClusterDAO.class);
  GroupDAO groupDAO=createMock(GroupDAO.class);
  ViewInstanceDAO viewInstanceDAO=createMock(ViewInstanceDAO.class);
  expect(viewInstanceDAO.findByResourceId(1L)).andReturn(viewInstanceEntity).atLeastOnce();
  final UserDAO userDAO=createNiceMock(UserDAO.class);
  expect(userDAO.findLocalUserByName("jdoe")).andReturn(userEntity).anyTimes();
  expect(userDAO.findUserByPrincipal(anyObject(PrincipalEntity.class))).andReturn(userEntity).anyTimes();
  expect(userDAO.findAll()).andReturn(Collections.<UserEntity>emptyList()).anyTimes();
  final PrivilegeDAO privilegeDAO=createMock(PrivilegeDAO.class);
  final MemberDAO memberDAO=createMock(MemberDAO.class);
  final TestUsers users=new TestUsers();
  users.setPrivilegeDAO(privilegeDAO);
  users.setMemberDAO(memberDAO);
  List<PrincipalEntity> rolePrincipals=new LinkedList<PrincipalEntity>();
  rolePrincipals.add(rolePrincipalEntity);
  List<PrincipalEntity> userPrincipals=new LinkedList<PrincipalEntity>();
  userPrincipals.add(principalEntity);
  expect(privilegeDAO.findAllByPrincipal(userPrincipals)).andReturn(Collections.singletonList(explicitPrivilegeEntity)).once();
  expect(privilegeDAO.findAllByPrincipal(rolePrincipals)).andReturn(Collections.singletonList(implicitPrivilegeEntity)).once();
  expect(memberDAO.findAllMembersByUser(userEntity)).andReturn(Collections.<MemberEntity>emptyList()).atLeastOnce();
  replayAll();
  final Set<String> propertyIds=new HashSet<String>();
  propertyIds.add(UserPrivilegeResourceProvider.PRIVILEGE_USER_NAME_PROPERTY_ID);
  final Predicate predicate=new PredicateBuilder().property(UserPrivilegeResourceProvider.PRIVILEGE_USER_NAME_PROPERTY_ID).equals("jdoe").toPredicate();
  TestAuthenticationFactory.createClusterAdministrator("jdoe",2L);
  Request request=PropertyHelper.getReadRequest(propertyIds);
  UserPrivilegeResourceProvider.init(userDAO,clusterDAO,groupDAO,viewInstanceDAO,users);
  UserPrivilegeResourceProvider provider=new UserPrivilegeResourceProvider();
  Set<Resource> resources=provider.getResources(request,predicate);
  Assert.assertEquals(1,resources.size());
  for (  Resource resource : resources) {
    String userName=(String)resource.getPropertyValue(UserPrivilegeResourceProvider.PRIVILEGE_USER_NAME_PROPERTY_ID);
    Assert.assertEquals("jdoe",userName);
  }
  verifyAll();
}

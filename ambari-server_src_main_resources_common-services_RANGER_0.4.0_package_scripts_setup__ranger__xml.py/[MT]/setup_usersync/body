def setup_usersync(rolling_upgrade=False):
    import params
    usersync_home = params.usersync_home
    ranger_ugsync_conf = params.ranger_ugsync_conf
    if ((not is_empty(params.ranger_usersync_ldap_ldapbindpassword)) and (params.ug_sync_source == 'org.apache.ranger.ldapusersync.process.LdapUserGroupBuilder')):
        password_validation(params.ranger_usersync_ldap_ldapbindpassword)
    if rolling_upgrade:
        usersync_home = format('/usr/hdp/{version}/ranger-usersync')
        ranger_ugsync_conf = format('/usr/hdp/{version}/ranger-usersync/conf')
    Directory(params.ranger_pid_dir, mode=488, owner=params.unix_user, group=params.unix_group)
    Directory(params.usersync_log_dir, owner=params.unix_user, group=params.unix_group)
    Directory(format('{ranger_ugsync_conf}/'), owner=params.unix_user)
    if rolling_upgrade:
        src_file = format('{usersync_home}/conf.dist/ranger-ugsync-default.xml')
        dst_file = format('{usersync_home}/conf/ranger-ugsync-default.xml')
        Execute(('cp', '-f', src_file, dst_file), sudo=True)
        src_file = format('{usersync_home}/conf.dist/log4j.xml')
        dst_file = format('{usersync_home}/conf/log4j.xml')
        Execute(('cp', '-f', src_file, dst_file), sudo=True)
    XmlConfig('ranger-ugsync-site.xml', conf_dir=ranger_ugsync_conf, configurations=params.config['configurations']['ranger-ugsync-site'], configuration_attributes=params.config['configuration_attributes']['ranger-ugsync-site'], owner=params.unix_user, group=params.unix_group, mode=420)
    if os.path.isfile(params.ranger_ugsync_default_file):
        File(params.ranger_ugsync_default_file, owner=params.unix_user, group=params.unix_group)
    if os.path.isfile(params.usgsync_log4j_file):
        File(params.usgsync_log4j_file, owner=params.unix_user, group=params.unix_group)
    if os.path.isfile(params.cred_validator_file):
        File(params.cred_validator_file, group=params.unix_group, mode=2413)
    cred_lib = os.path.join(usersync_home, 'lib', '*')
    cred_setup_prefix = (format('{usersync_home}/ranger_credential_helper.py'), '-l', cred_lib)
    cred_setup = (cred_setup_prefix + ('-f', params.ugsync_jceks_path, '-k', 'usersync.ssl.key.password', '-v', PasswordString(params.ranger_usersync_keystore_password), '-c', '1'))
    Execute(cred_setup, environment={'JAVA_HOME': params.java_home, }, logoutput=True, sudo=True)
    cred_setup = (cred_setup_prefix + ('-f', params.ugsync_jceks_path, '-k', 'ranger.usersync.ldap.bindalias', '-v', PasswordString(params.ranger_usersync_ldap_ldapbindpassword), '-c', '1'))
    Execute(cred_setup, environment={'JAVA_HOME': params.java_home, }, logoutput=True, sudo=True)
    cred_setup = (cred_setup_prefix + ('-f', params.ugsync_jceks_path, '-k', 'usersync.ssl.truststore.password', '-v', PasswordString(params.ranger_usersync_truststore_password), '-c', '1'))
    Execute(cred_setup, environment={'JAVA_HOME': params.java_home, }, logoutput=True, sudo=True)
    File(params.ugsync_jceks_path, owner=params.unix_user, group=params.unix_group, mode=416)
    File([params.usersync_start, params.usersync_stop], owner=params.unix_user, group=params.unix_group)
    File(params.usersync_services_file, mode=493)
    Execute(('ln', '-sf', format('{usersync_services_file}'), '/usr/bin/ranger-usersync'), not_if=format('ls /usr/bin/ranger-usersync'), only_if=format('ls {usersync_services_file}'), sudo=True)
    if (not os.path.isfile(params.ranger_usersync_keystore_file)):
        cmd = format("{java_home}/bin/keytool -genkeypair -keyalg RSA -alias selfsigned -keystore '{ranger_usersync_keystore_file}' -keypass {ranger_usersync_keystore_password!p} -storepass {ranger_usersync_keystore_password!p} -validity 3600 -keysize 2048 -dname '{default_dn_name}'")
        Execute(cmd, logoutput=True, user=params.unix_user)
        File(params.ranger_usersync_keystore_file, owner=params.unix_user, group=params.unix_group, mode=416)

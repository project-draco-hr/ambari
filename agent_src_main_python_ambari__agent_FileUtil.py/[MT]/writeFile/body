def writeFile(action, result):
    fileInfo = action['file']
    try:
        path = os.path.join(AmbariConfig.config.get('agent', 'prefix'), 'clusters', ((action['clusterId'] + '-') + action['role']))
        logger.info(('path: %s' % path))
        user = fileInfo['owner']
        if (user is None):
            user = getpass.getuser()
        group = fileInfo['group']
        if (group is None):
            group = getpass.getgroup()
        filename = os.path.join(path, fileInfo['path'])
        content = fileInfo['data']
        try:
            if (isinstance(user, int) != True):
                user = getpwnam(user)[2]
            if (isinstance(group, int) != True):
                group = getgrnam(group)[2]
        except Exception:
            logger.warn(('can not find user uid/gid: (%s/%s) for writing %s' % (user, group, filename)))
        if (fileInfo['permission'] is not None):
            permission = fileInfo['permission']
        else:
            permission = 488
        oldMask = os.umask(0)
        if (fileInfo['umask'] is not None):
            umask = int(fileInfo['umask'])
        else:
            umask = oldMask
        os.umask(int(umask))
        prefix = os.path.dirname(filename)
        try:
            os.makedirs(prefix)
        except OSError as err:
            if (err.errno == errno.EEXIST):
                pass
            else:
                raise
        f = open(filename, 'w')
        f.write(content)
        f.close()
        if (os.getuid() == 0):
            os.chmod(filename, permission)
            os.chown(filename, user, group)
        os.umask(oldMask)
        result['exitCode'] = 0
    except Exception as err:
        traceback.print_exc()
        result['exitCode'] = 1
        result['stderr'] = traceback.format_exc()
    return result

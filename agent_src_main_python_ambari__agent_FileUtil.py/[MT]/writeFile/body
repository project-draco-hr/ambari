def writeFile(action, result):
    global config
    oldCwd = os.getcwd()
    fileInfo = action['file']
    try:
        path = ((((config.get('agent', 'prefix') + '/clusters/') + action['clusterId']) + '-') + action['role'])
        os.chdir(path)
        user = fileInfo['owner']
        group = fileInfo['group']
        filename = fileInfo['path']
        content = fileInfo['data']
        try:
            if (isinstance(user, int) != True):
                user = getpwnam(user)[2]
            if (isinstance(group, int) != True):
                group = getgrnam(group)[2]
        except Exception:
            logger.warn(('can not find user uid/gid: (%s/%s) for writing %s' % (user, group, filename)))
        permission = int(fileInfo['permission'])
        umask = int(fileInfo['umask'])
        oldMask = os.umask(0)
        os.umask(int(umask))
        prefix = os.path.dirname(filename)
        try:
            os.makedirs(prefix)
        except OSError as err:
            if (err.errno == errno.EEXIST):
                pass
            else:
                raise
        f = open(filename, 'w')
        f.write(content)
        f.close()
        if (os.getuid() == 0):
            os.chmod(filename, permission)
            os.chown(filename, user, group)
        os.umask(oldMask)
        result['exitCode'] = 0
    except Exception as err:
        result['exitCode'] = 1
        result['stderr'] = traceback.format_exc()
    os.chdir(oldCwd)
    return result

@patch('urllib2.build_opener')
@patch('urllib2.install_opener')
@patch.object(ActionQueue.ActionQueue, 'run')
@patch.object(ActionDependencyManager, 'read_dependencies')
@patch.object(ActionDependencyManager, 'dump_info')
def test_repeatRegistration(self, dump_info_mock, read_dependencies_mock, run_mock, installMock, buildMock):
    registerAndHeartbeat = MagicMock(name='registerAndHeartbeat')
    self.controller.registerAndHeartbeat = registerAndHeartbeat
    self.controller.run()
    self.assertTrue(installMock.called)
    self.assertTrue(buildMock.called)
    self.controller.registerAndHeartbeat.assert_called_once_with()
    calls = []

    def switchBool():
        if (len(calls) == 0):
            self.controller.repeatRegistration = True
            calls.append(1)
        self.controller.repeatRegistration = False
    registerAndHeartbeat.side_effect = switchBool
    self.controller.run()
    self.assertEqual(2, registerAndHeartbeat.call_count)
    self.controller.registerAndHeartbeat = Controller.Controller.registerAndHeartbeat

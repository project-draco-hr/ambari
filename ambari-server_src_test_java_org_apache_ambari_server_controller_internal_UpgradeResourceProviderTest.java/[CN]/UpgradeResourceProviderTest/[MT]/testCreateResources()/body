{
  Cluster cluster=clusters.getCluster("c1");
  List<UpgradeEntity> upgrades=upgradeDao.findUpgrades(cluster.getClusterId());
  assertEquals(0,upgrades.size());
  AmbariManagementController amc=injector.getInstance(AmbariManagementController.class);
  UpgradeResourceProvider provider=createProvider(amc);
  Map<String,Object> requestProps=new HashMap<String,Object>();
  requestProps.put(UpgradeResourceProvider.UPGRADE_CLUSTER_NAME,"c1");
  requestProps.put(UpgradeResourceProvider.UPGRADE_VERSION,"2.2.2.2");
  Request request=PropertyHelper.getCreateRequest(Collections.singleton(requestProps),null);
  provider.createResources(request);
  upgrades=upgradeDao.findUpgrades(cluster.getClusterId());
  assertEquals(1,upgrades.size());
  UpgradeEntity entity=upgrades.get(0);
  assertEquals(cluster.getClusterId(),entity.getClusterId().longValue());
  assertEquals(3,entity.getUpgradeItems().size());
  assertTrue(entity.getUpgradeItems().get(0).getText().contains("Preparing"));
  assertTrue(entity.getUpgradeItems().get(1).getText().contains("Restarting"));
  assertTrue(entity.getUpgradeItems().get(2).getText().contains("Finalizing"));
  ActionManager am=injector.getInstance(ActionManager.class);
  List<Long> requests=am.getRequestsByStatus(RequestStatus.IN_PROGRESS,100,true);
  assertEquals(1,requests.size());
  assertEquals(requests.get(0),entity.getRequestId());
  List<Stage> stages=am.getRequestStatus(requests.get(0).longValue());
  assertEquals(3,stages.size());
  for (int i=0; i < stages.size(); i++) {
    Stage stage=stages.get(i);
    UpgradeItemEntity upgradeItem=entity.getUpgradeItems().get(i);
    assertEquals(stage.getStageId(),upgradeItem.getStageId().longValue());
    assertEquals(UpgradeState.NONE,upgradeItem.getState());
  }
  List<HostRoleCommand> tasks=am.getRequestTasks(requests.get(0).longValue());
  assertEquals(3,tasks.size());
}

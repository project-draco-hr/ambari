{
  Resource.Type type=Resource.Type.User;
  Injector injector=createInjector();
  SecurityHelper securityHelper=injector.getInstance(SecurityHelper.class);
  Users users=injector.getInstance(Users.class);
  User user=createMock(User.class);
  AmbariManagementController managementController=injector.getInstance(AmbariManagementController.class);
  RequestStatusResponse response=createNiceMock(RequestStatusResponse.class);
  expect(users.getAnyUser("User100")).andReturn(user).once();
  users.modifyPassword("User100","old_password","password");
  expectLastCall().once();
  expect(user.getUserName()).andReturn("User100").once();
  securityHelper.getCurrentAuthorities();
  expectLastCall().andReturn(Collections.emptyList()).anyTimes();
  replay(securityHelper,user,users,response);
  ResourceProvider provider=AbstractControllerResourceProvider.getResourceProvider(type,PropertyHelper.getPropertyIds(type),PropertyHelper.getKeyPropertyIds(type),managementController);
  Map<String,Object> properties=new LinkedHashMap<String,Object>();
  properties.put(UserResourceProvider.USER_PASSWORD_PROPERTY_ID,"password");
  properties.put(UserResourceProvider.USER_OLD_PASSWORD_PROPERTY_ID,"old_password");
  Request request=PropertyHelper.getUpdateRequest(properties,null);
  Predicate predicate=new PredicateBuilder().property(UserResourceProvider.USER_USERNAME_PROPERTY_ID).equals("User100").toPredicate();
  provider.updateResources(request,predicate);
  verify(securityHelper,user,users,response);
}

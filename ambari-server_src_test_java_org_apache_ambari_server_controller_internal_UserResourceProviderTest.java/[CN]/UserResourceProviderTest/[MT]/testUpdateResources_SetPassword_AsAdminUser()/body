{
  Resource.Type type=Resource.Type.User;
  Injector injector=createInjector();
  SecurityHelper securityHelper=injector.getInstance(SecurityHelper.class);
  Users users=injector.getInstance(Users.class);
  User user=createMock(User.class);
  PrivilegeEntity privilegeEntity=createMock(PrivilegeEntity.class);
  PermissionEntity permissionEntity=createMock(PermissionEntity.class);
  AmbariManagementController managementController=injector.getInstance(AmbariManagementController.class);
  RequestStatusResponse response=createNiceMock(RequestStatusResponse.class);
  Collection<? extends GrantedAuthority> currentAuthorities=Collections.singleton(new AmbariGrantedAuthority(privilegeEntity));
  expect(users.getAnyUser("User100")).andReturn(user).once();
  users.modifyPassword("User100","old_password","password");
  expectLastCall().once();
  expect(user.getUserName()).andReturn("User100").once();
  expect(privilegeEntity.getPermission()).andReturn(permissionEntity).anyTimes();
  expect(permissionEntity.getId()).andReturn(PermissionEntity.AMBARI_ADMINISTRATOR_PERMISSION).anyTimes();
  securityHelper.getCurrentAuthorities();
  expectLastCall().andReturn(currentAuthorities).anyTimes();
  replay(securityHelper,user,users,privilegeEntity,permissionEntity,response);
  ResourceProvider provider=AbstractControllerResourceProvider.getResourceProvider(type,PropertyHelper.getPropertyIds(type),PropertyHelper.getKeyPropertyIds(type),managementController);
  Map<String,Object> properties=new LinkedHashMap<String,Object>();
  properties.put(UserResourceProvider.USER_PASSWORD_PROPERTY_ID,"password");
  properties.put(UserResourceProvider.USER_OLD_PASSWORD_PROPERTY_ID,"old_password");
  Request request=PropertyHelper.getUpdateRequest(properties,null);
  Predicate predicate=new PredicateBuilder().property(UserResourceProvider.USER_USERNAME_PROPERTY_ID).equals("User100").toPredicate();
  provider.updateResources(request,predicate);
  verify(securityHelper,user,users,privilegeEntity,permissionEntity,response);
}

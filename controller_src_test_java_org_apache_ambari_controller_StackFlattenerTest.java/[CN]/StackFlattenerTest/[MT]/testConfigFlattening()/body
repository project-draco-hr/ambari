{
  Configuration parentConfiguration=new Configuration();
  parentStack.setConfiguration(parentConfiguration);
  Configuration childConfiguration=new Configuration();
  childStack.setConfiguration(childConfiguration);
  Configuration grandchildConfiguration=new Configuration();
  grandchildStack.setConfiguration(grandchildConfiguration);
  Configuration parentHdfsConfig=parentHdfs.getConfiguration();
  Configuration parentMapredConfig=parentMapreduce.getConfiguration();
  List<Role> hdfsRoles=new ArrayList<Role>();
  Configuration childHdfsConfig=new Configuration();
  childStack.getComponents().add(new Component("hdfs",null,null,null,null,childHdfsConfig,hdfsRoles));
  Configuration nnConf=new Configuration();
  hdfsRoles.add(new Role("namenode",nnConf));
  setConfigParam(parentConfiguration,"cat1","b","parent");
  setConfigParam(parentConfiguration,"cat1","a","a-value");
  setConfigParam(parentConfiguration,"cat2","b","cat2-value");
  setConfigParam(childConfiguration,"cat1","b","child");
  setConfigParam(parentHdfsConfig,"cat1","b","parent-hdfs");
  setConfigParam(parentHdfsConfig,"cat1","d","d-value");
  setConfigParam(parentMapredConfig,"cat1","b","parent-mapred");
  setConfigParam(grandchildConfiguration,"cat1","b","grandchild");
  setConfigParam(childHdfsConfig,"cat1","b","child-hdfs");
  setConfigParam(nnConf,"cat1","b","nn");
  setConfigParam(nnConf,"cat1","c","nn-c");
  Stack flat=flattener.flattenStack("grandchild",0);
  Configuration conf=flat.getConfiguration();
  assertEquals("a-value",getConfigParam(conf,"cat1","a"));
  assertEquals("cat2-value",getConfigParam(conf,"cat2","b"));
  assertEquals("grandchild",getConfigParam(conf,"cat1","b"));
  assertEquals(null,getConfigParam(conf,"cat1","c"));
  assertEquals(null,getConfigParam(conf,"cat1","d"));
  Component comp=flat.getComponents().get(0);
  assertEquals("hdfs",comp.getName());
  assertEquals(null,comp.getConfiguration());
  Role role=comp.getRoles().get(0);
  assertEquals("namenode",role.getName());
  conf=role.getConfiguration();
  assertEquals("a-value",getConfigParam(conf,"cat1","a"));
  assertEquals("cat2-value",getConfigParam(conf,"cat2","b"));
  assertEquals("grandchild",getConfigParam(conf,"cat1","b"));
  assertEquals("nn-c",getConfigParam(conf,"cat1","c"));
  assertEquals("d-value",getConfigParam(conf,"cat1","d"));
  role=comp.getRoles().get(1);
  assertEquals("datanode",role.getName());
  conf=role.getConfiguration();
  assertEquals("a-value",getConfigParam(conf,"cat1","a"));
  assertEquals("cat2-value",getConfigParam(conf,"cat2","b"));
  assertEquals("grandchild",getConfigParam(conf,"cat1","b"));
  assertEquals(null,getConfigParam(conf,"cat1","c"));
  assertEquals("d-value",getConfigParam(conf,"cat1","d"));
}

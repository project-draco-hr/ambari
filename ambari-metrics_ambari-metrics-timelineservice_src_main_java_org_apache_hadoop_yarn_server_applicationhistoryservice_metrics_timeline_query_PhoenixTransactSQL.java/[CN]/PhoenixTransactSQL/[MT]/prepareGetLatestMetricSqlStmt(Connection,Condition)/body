{
  validateConditionIsNotEmpty(condition);
  if (condition.getMetricNames() == null || condition.getMetricNames().size() == 0) {
    throw new IllegalArgumentException("Point in time query without " + "metric names not supported ");
  }
  String stmtStr;
  if (condition.getStatement() != null) {
    stmtStr=condition.getStatement();
  }
 else {
    if (condition.getHostnames().size() > 1 && condition.getMetricNames().size() > 1) {
      stmtStr=String.format(GET_LATEST_METRIC_SQL,METRICS_RECORD_TABLE_NAME,METRICS_RECORD_TABLE_NAME,condition.getConditionClause());
    }
 else {
      StringBuilder sb=new StringBuilder(String.format(GET_METRIC_SQL,"",METRICS_RECORD_TABLE_NAME));
      sb.append(" WHERE ");
      sb.append(condition.getConditionClause());
      String orderByClause=condition.getOrderByClause(false);
      if (orderByClause != null) {
        sb.append(orderByClause);
      }
 else {
        sb.append(" ORDER BY METRIC_NAME DESC, HOSTNAME DESC, SERVER_TIME DESC ");
      }
      stmtStr=sb.toString();
    }
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("SQL: " + stmtStr + ", condition: "+ condition);
  }
  PreparedStatement stmt=connection.prepareStatement(stmtStr);
  int pos=1;
  if (condition.getMetricNames() != null) {
    for (; pos <= condition.getMetricNames().size(); pos++) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Setting pos: " + pos + ", value = "+ condition.getMetricNames().get(pos - 1));
      }
      stmt.setString(pos,condition.getMetricNames().get(pos - 1));
    }
  }
  if (condition.getHostnames() != null) {
    for (    String hostname : condition.getHostnames()) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Setting pos: " + pos + ", value: "+ hostname);
      }
      stmt.setString(pos++,hostname);
    }
  }
  if (condition.getAppId() != null) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Setting pos: " + pos + ", value: "+ condition.getAppId());
    }
    stmt.setString(pos++,condition.getAppId());
  }
  if (condition.getInstanceId() != null) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Setting pos: " + pos + ", value: "+ condition.getInstanceId());
    }
    stmt.setString(pos,condition.getInstanceId());
  }
  if (condition.getFetchSize() != null) {
    stmt.setFetchSize(condition.getFetchSize());
  }
  return stmt;
}

def test_recommendHBASEConfigurations(self):
    configurations = {}
    clusterData = {'totalAvailableRam': 2048, 'hBaseInstalled': True, 'hbaseRam': 112, 'reservedRam': 128, }
    expected = {'hbase-site': {'properties': {'hbase.bucketcache.size': '92160', 'hbase.bucketcache.percentage.in.combinedcache': '0.8519', 'hbase.regionserver.global.memstore.size': '0.4', 'hfile.block.cache.size': '0.4', 'hbase.coprocessor.region.classes': 'org.apache.hadoop.hbase.security.access.SecureBulkLoadEndpoint', 'hbase.coprocessor.master.classes': '', 'hbase.coprocessor.regionserver.classes': '', 'hbase.rpc.controllerfactory.class': 'org.apache.hadoop.hbase.ipc.controller.ServerRpcControllerFactory', 'hbase.region.server.rpc.scheduler.factory.class': 'org.apache.hadoop.hbase.ipc.PhoenixRpcSchedulerFactory', 'hbase.regionserver.wal.codec': 'org.apache.hadoop.hbase.regionserver.wal.IndexedWALEditCodec', 'hbase.bucketcache.ioengine': 'offheap', 'phoenix.functions.allowUserDefinedFunctions': 'true', }, 'property_attributes': {'hbase.coprocessor.regionserver.classes': {'delete': 'true', }, 'hbase.bucketcache.percentage.in.combinedcache': {'delete': 'true', }, }, }, 'hbase-env': {'properties': {'hbase_master_heapsize': '114688', 'hbase_max_direct_memory_size': '94208', 'hbase_regionserver_heapsize': '20480', }, }, }
    services = {'services': [{'StackServices': {'service_name': 'HDFS', 'service_version': '2.6.0.2.2', }, 'components': [{'href': '/api/v1/stacks/HDP/versions/2.2/services/HDFS/components/DATANODE', 'StackServiceComponents': {'advertise_version': 'true', 'cardinality': '1+', 'component_category': 'SLAVE', 'component_name': 'DATANODE', 'custom_commands': [], 'display_name': 'DataNode', 'is_client': 'false', 'is_master': 'false', 'service_name': 'HDFS', 'stack_name': 'HDP', 'stack_version': '2.2', 'hostnames': ['host1'], }, 'dependencies': [], }, {'href': '/api/v1/stacks/HDP/versions/2.2/services/HDFS/components/JOURNALNODE', 'StackServiceComponents': {'advertise_version': 'true', 'cardinality': '0+', 'component_category': 'SLAVE', 'component_name': 'JOURNALNODE', 'custom_commands': [], 'display_name': 'JournalNode', 'is_client': 'false', 'is_master': 'false', 'service_name': 'HDFS', 'stack_name': 'HDP', 'stack_version': '2.2', 'hostnames': ['host1'], }, 'dependencies': [{'href': '/api/v1/stacks/HDP/versions/2.2/services/HDFS/components/JOURNALNODE/dependencies/HDFS_CLIENT', 'Dependencies': {'component_name': 'HDFS_CLIENT', 'dependent_component_name': 'JOURNALNODE', 'dependent_service_name': 'HDFS', 'stack_name': 'HDP', 'stack_version': '2.2', }, }], }, {'href': '/api/v1/stacks/HDP/versions/2.2/services/HDFS/components/NAMENODE', 'StackServiceComponents': {'advertise_version': 'true', 'cardinality': '1-2', 'component_category': 'MASTER', 'component_name': 'NAMENODE', 'custom_commands': ['DECOMMISSION', 'REBALANCEHDFS'], 'display_name': 'NameNode', 'is_client': 'false', 'is_master': 'true', 'service_name': 'HDFS', 'stack_name': 'HDP', 'stack_version': '2.2', 'hostnames': ['host2'], }, 'dependencies': [], }], }], 'Versions': {'stack_version': '2.3', }, 'configurations': {'yarn-site': {'properties': {'yarn.scheduler.minimum-allocation-mb': '256', 'yarn.scheduler.maximum-allocation-mb': '2048', }, }, 'hbase-env': {'properties': {'phoenix_sql_enabled': 'true', }, }, 'hbase-site': {'properties': {'hbase.coprocessor.regionserver.classes': '', }, }, }, }
    self.stackAdvisor.recommendHBASEConfigurations(configurations, clusterData, services, None)
    self.assertEquals(configurations, expected)
    clusterData['hbaseRam'] = '4'
    expected['hbase-site']['property_attributes']['hbase.bucketcache.size'] = {'delete': 'true', }
    expected['hbase-site']['property_attributes']['hbase.bucketcache.ioengine'] = {'delete': 'true', }
    expected['hbase-site']['property_attributes']['hbase.bucketcache.percentage.in.combinedcache'] = {'delete': 'true', }
    expected['hbase-env']['property_attributes'] = {'hbase_max_direct_memory_size': {'delete': 'true', }, }
    expected['hbase-env']['properties']['hbase_master_heapsize'] = '4096'
    expected['hbase-env']['properties']['hbase_regionserver_heapsize'] = '4096'
    self.stackAdvisor.recommendHBASEConfigurations(configurations, clusterData, services, None)
    self.assertEquals(configurations, expected)
    services['configurations'] = {'hbase-site': {'properties': {'phoenix.functions.allowUserDefinedFunctions': '', 'hbase.rpc.controllerfactory.class': '', 'hbase.region.server.rpc.scheduler.factory.class': '', }, }, }
    configurations = {}
    self.stackAdvisor.recommendHBASEConfigurations(configurations, clusterData, services, None)
    self.assertEquals(configurations['hbase-site']['property_attributes']['phoenix.functions.allowUserDefinedFunctions'], {'delete': 'true', })
    self.assertEquals(configurations['hbase-site']['property_attributes']['hbase.rpc.controllerfactory.class'], {'delete': 'true', })
    self.assertEquals(configurations['hbase-site']['property_attributes']['hbase.region.server.rpc.scheduler.factory.class'], {'delete': 'true', })
    self.assertEquals(configurations['hbase-site']['properties']['hbase.regionserver.wal.codec'], 'org.apache.hadoop.hbase.regionserver.wal.WALCellCodec')

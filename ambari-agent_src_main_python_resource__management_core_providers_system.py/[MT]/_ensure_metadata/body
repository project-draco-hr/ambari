def _ensure_metadata(path, user, group, mode=None, log=None):
    stat = os.stat(path)
    if mode:
        existing_mode = (stat.st_mode & 4095)
        if (existing_mode != mode):
            (log and log.info(('Changing permission for %s from %o to %o' % (path, existing_mode, mode))))
            os.chmod(path, mode)
    if user:
        uid = _coerce_uid(user)
        if (stat.st_uid != uid):
            (log and log.info(('Changing owner for %s from %d to %s' % (path, stat.st_uid, user))))
            os.chown(path, uid, (-1))
    if group:
        gid = _coerce_gid(group)
        if (stat.st_gid != gid):
            (log and log.info(('Changing group for %s from %d to %s' % (path, stat.st_gid, group))))
            os.chown(path, (-1), gid)

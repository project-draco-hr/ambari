{
  ResourceDefinition resource=createMock(ResourceDefinition.class);
  ClusterController controller=createMock(ClusterController.class);
  Schema schema=createMock(Schema.class);
  PropertyId clusterId=createStrictMock(PropertyId.class);
  PropertyId serviceId=createStrictMock(PropertyId.class);
  org.apache.ambari.server.controller.spi.Request serverRequest=createStrictMock(org.apache.ambari.server.controller.spi.Request.class);
  Map<Resource.Type,String> mapResourceIds=new HashMap<Resource.Type,String>();
  mapResourceIds.put(Resource.Type.Cluster,"clusterId");
  mapResourceIds.put(Resource.Type.Service,"serviceId");
  Map<PropertyId,Object> mapProperties=new HashMap<PropertyId,Object>();
  mapProperties.put(clusterId,"clusterId");
  mapProperties.put(serviceId,"serviceId");
  mapProperties.put(PropertyHelper.getPropertyId("bar","foo"),"value");
  expect(resource.getResourceIds()).andReturn(mapResourceIds);
  expect(resource.getType()).andReturn(Resource.Type.Component);
  expect(controller.getSchema(Resource.Type.Component)).andReturn(schema);
  expect(schema.getKeyPropertyId(Resource.Type.Cluster)).andReturn(clusterId);
  resource.setProperty(clusterId,"clusterId");
  expect(schema.getKeyPropertyId(Resource.Type.Service)).andReturn(serviceId);
  resource.setProperty(serviceId,"serviceId");
  expect(resource.getProperties()).andReturn(mapProperties);
  controller.createResources(Resource.Type.Component,serverRequest);
  replay(resource,controller,schema,clusterId,serviceId,serverRequest);
  new TestCreatePersistenceManager(controller,mapProperties,serverRequest).persist(resource);
  verify(resource,controller,schema,clusterId,serviceId,serverRequest);
}

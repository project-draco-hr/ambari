{
  writeLock.lock();
  try {
    if (!persisted) {
      persistEntities();
      refresh();
      for (      ClusterEntity clusterEntity : hostEntity.getClusterEntities()) {
        try {
          clusters.getClusterById(clusterEntity.getClusterId()).refresh();
        }
 catch (        AmbariException e) {
          LOG.error("Error while looking up the cluster",e);
          throw new RuntimeException("Cluster '" + clusterEntity.getClusterId() + "' was removed",e);
        }
      }
      persisted=true;
    }
 else {
      getHostEntity();
      getHostStateEntity();
      saveIfPersisted();
    }
  }
  finally {
    writeLock.unlock();
  }
}

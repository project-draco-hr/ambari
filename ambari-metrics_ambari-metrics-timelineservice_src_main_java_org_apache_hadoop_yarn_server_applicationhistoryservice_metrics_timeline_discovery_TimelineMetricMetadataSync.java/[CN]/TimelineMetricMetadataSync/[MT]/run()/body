{
  List<TimelineMetricMetadata> metadataToPersist=new ArrayList<>();
  for (  TimelineMetricMetadata metadata : cacheManager.getMetadataCache().values()) {
    if (!metadata.isPersisted()) {
      metadataToPersist.add(metadata);
    }
  }
  boolean markSuccess=false;
  if (!metadataToPersist.isEmpty()) {
    try {
      cacheManager.persistMetadata(metadataToPersist);
      markSuccess=true;
    }
 catch (    SQLException e) {
      LOG.warn("Error persisting metadata.",e);
    }
  }
  if (markSuccess) {
    for (    TimelineMetricMetadata metadata : metadataToPersist) {
      TimelineMetricMetadataKey key=new TimelineMetricMetadataKey(metadata.getMetricName(),metadata.getAppId());
      metadata.setIsPersisted(true);
      cacheManager.getMetadataCache().put(key,metadata);
    }
  }
  if (cacheManager.syncHostedAppsMetadata()) {
    Map<String,Set<String>> persistedData=null;
    try {
      persistedData=cacheManager.getPersistedHostedAppsData();
    }
 catch (    SQLException e) {
      LOG.warn("Failed on fetching hosted apps data from store.",e);
      return;
    }
    Map<String,Set<String>> cachedData=cacheManager.getHostedAppsCache();
    Map<String,Set<String>> dataToSync=new HashMap<>();
    if (cachedData != null && !cachedData.isEmpty()) {
      for (      Map.Entry<String,Set<String>> cacheEntry : cachedData.entrySet()) {
        if (persistedData == null || persistedData.isEmpty() || !persistedData.containsKey(cacheEntry.getKey()) || !persistedData.get(cacheEntry.getKey()).containsAll(cacheEntry.getValue())) {
          dataToSync.put(cacheEntry.getKey(),cacheEntry.getValue());
        }
      }
      try {
        cacheManager.persistHostedAppsMetadata(dataToSync);
        cacheManager.markSuccessOnSyncHostedAppsMetadata();
      }
 catch (      SQLException e) {
        LOG.warn("Error persisting hosted apps metadata.",e);
      }
    }
  }
}

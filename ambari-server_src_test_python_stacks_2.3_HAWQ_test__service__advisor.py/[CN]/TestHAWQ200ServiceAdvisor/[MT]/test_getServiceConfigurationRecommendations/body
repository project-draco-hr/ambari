def test_getServiceConfigurationRecommendations(self):
    configurations = {'hawq-sysctl-env': {'properties': {'vm.overcommit_memory': 1, 'vm.overcommit_ratio': 50, }, }, 'hawq-site': {'properties': {'hawq_rm_memory_limit_perseg': '67108864KB', }, }, }
    services = {'services': [{'StackServices': {'service_name': 'HAWQ', 'service_version': '2.0', 'stack_name': 'HDP', 'stack_version': '2.3', }, 'components': [{'StackServiceComponents': {'component_name': 'HAWQMASTER', 'hostnames': ['c6401.ambari.apache.org'], }, }, {'StackServiceComponents': {'component_name': 'HAWQSEGMENT', 'hostnames': ['c6402.ambari.apache.org', 'c6404.ambari.apache.org'], }, }], }], 'configurations': configurations, }
    hosts = {'items': [{'Hosts': {'host_name': 'c6401.ambari.apache.org', 'total_mem': 33554432, }, }, {'Hosts': {'host_name': 'c6402.ambari.apache.org', 'total_mem': 33554433, }, }, {'Hosts': {'host_name': 'c6403.ambari.apache.org', 'total_mem': 33554434, }, }, {'Hosts': {'host_name': 'c6404.ambari.apache.org', 'total_mem': 33554435, }, }], }
    self.serviceAdvisor.getServiceConfigurationRecommendations(self.stackAdvisor, configurations, None, services, hosts)
    self.assertEquals(configurations['hawq-sysctl-env']['properties']['vm.overcommit_memory'], '2')
    hosts['items'][0]['Hosts']['total_mem'] = 33554431
    services['configurations']['hawq-site']['properties']['hawq_rm_memory_limit_perseg'] = '67108864KB'
    self.serviceAdvisor.getServiceConfigurationRecommendations(self.stackAdvisor, configurations, None, services, hosts)
    self.assertEquals(configurations['hawq-sysctl-env']['properties']['vm.overcommit_memory'], '1')
    hosts['items'][0]['Hosts']['total_mem'] = 2097152
    self.serviceAdvisor.getServiceConfigurationRecommendations(self.stackAdvisor, configurations, None, services, hosts)
    self.assertEqual(configurations['hawq-site']['properties']['hawq_rm_memory_limit_perseg'], '1536MB')
    hosts['items'][0]['Hosts']['total_mem'] = 16777216
    hosts['items'][1]['Hosts']['total_mem'] = 26777216
    hosts['items'][3]['Hosts']['total_mem'] = 36777216
    self.serviceAdvisor.getServiceConfigurationRecommendations(self.stackAdvisor, configurations, None, services, hosts)
    self.assertEqual(configurations['hawq-site']['properties']['hawq_rm_memory_limit_perseg'], '12GB')
    hosts['items'][0]['Hosts']['total_mem'] = 67108864
    hosts['items'][1]['Hosts']['total_mem'] = 77108864
    hosts['items'][3]['Hosts']['total_mem'] = 87108864
    services['configurations']['hawq-site']['properties']['hawq_rm_memory_limit_perseg'] = '67108864KB'
    self.serviceAdvisor.getServiceConfigurationRecommendations(self.stackAdvisor, configurations, None, services, hosts)
    self.assertEqual(configurations['hawq-site']['properties']['hawq_rm_memory_limit_perseg'], '24GB')
    hosts['items'][0]['Hosts']['total_mem'] = 536870912
    hosts['items'][1]['Hosts']['total_mem'] = 636870912
    hosts['items'][3]['Hosts']['total_mem'] = 736870912
    self.serviceAdvisor.getServiceConfigurationRecommendations(self.stackAdvisor, configurations, None, services, hosts)
    self.assertEquals(configurations['hawq-site']['properties']['hawq_rm_memory_limit_perseg'], '218GB')
    hosts['items'][0]['Hosts']['total_mem'] = 1073741824
    hosts['items'][1]['Hosts']['total_mem'] = 2073741824
    hosts['items'][3]['Hosts']['total_mem'] = 3073741824
    self.serviceAdvisor.getServiceConfigurationRecommendations(self.stackAdvisor, configurations, None, services, hosts)
    self.assertEqual(configurations['hawq-site']['properties']['hawq_rm_memory_limit_perseg'], '436GB')
    hosts['items'][0]['Hosts']['total_mem'] = 1073741824
    hosts['items'][1]['Hosts']['total_mem'] = 2073741824
    hosts['items'][3]['Hosts']['total_mem'] = 3073741824
    services['configurations']['hawq-sysctl-env']['properties']['vm.overcommit_ratio'] = 75
    self.serviceAdvisor.getServiceConfigurationRecommendations(self.stackAdvisor, configurations, None, services, hosts)
    self.assertEqual(configurations['hawq-site']['properties']['hawq_rm_memory_limit_perseg'], '730GB')

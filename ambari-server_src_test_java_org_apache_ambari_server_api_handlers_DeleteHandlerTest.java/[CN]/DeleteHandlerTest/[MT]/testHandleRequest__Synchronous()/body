{
  Request request=createMock(Request.class);
  ResourceInstance resource=createMock(ResourceInstance.class);
  PersistenceManager pm=createStrictMock(PersistenceManager.class);
  RequestStatus status=createMock(RequestStatus.class);
  Resource resource1=createMock(Resource.class);
  Resource resource2=createMock(Resource.class);
  Predicate userPredicate=createNiceMock(Predicate.class);
  Query query=createNiceMock(Query.class);
  Set<Resource> setResources=new HashSet<Resource>();
  setResources.add(resource1);
  setResources.add(resource2);
  Set<NamedPropertySet> setResourceProperties=new HashSet<NamedPropertySet>();
  Map<String,Object> mapProps=new HashMap<String,Object>();
  mapProps.put("foo","bar");
  NamedPropertySet namedPropSet=new NamedPropertySet("name",mapProps);
  setResourceProperties.add(namedPropSet);
  Set<Map<String,Object>> setProps=new HashSet<Map<String,Object>>();
  setProps.add(mapProps);
  expect(request.getResource()).andReturn(resource).atLeastOnce();
  expect(request.getHttpBodyProperties()).andReturn(setResourceProperties).atLeastOnce();
  expect(request.getQueryPredicate()).andReturn(userPredicate).atLeastOnce();
  expect(resource.getQuery()).andReturn(query).atLeastOnce();
  query.setUserPredicate(userPredicate);
  expect(pm.delete(eq(resource),eq(setProps))).andReturn(status);
  expect(status.getStatus()).andReturn(RequestStatus.Status.Complete);
  expect(status.getAssociatedResources()).andReturn(setResources);
  expect(resource1.getType()).andReturn(Resource.Type.Cluster).anyTimes();
  expect(resource2.getType()).andReturn(Resource.Type.Cluster).anyTimes();
  replay(request,resource,pm,status,resource1,resource2,userPredicate,query);
  Result result=new TestDeleteHandler(pm).handleRequest(request);
  assertNotNull(result);
  TreeNode<Resource> tree=result.getResultTree();
  assertEquals(1,tree.getChildren().size());
  TreeNode<Resource> resourcesNode=tree.getChild("resources");
  assertEquals(2,resourcesNode.getChildren().size());
  boolean foundResource1=false;
  boolean foundResource2=false;
  for (  TreeNode<Resource> child : resourcesNode.getChildren()) {
    Resource r=child.getObject();
    if (r == resource1 && !foundResource1) {
      foundResource1=true;
    }
 else     if (r == resource2 && !foundResource2) {
      foundResource2=true;
    }
 else {
      fail();
    }
  }
  assertEquals(ResultStatus.STATUS.OK,result.getStatus().getStatus());
  verify(request,resource,pm,status,resource1,resource2,userPredicate,query);
}

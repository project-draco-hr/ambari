@patch.object(ambari_server, 'save_master_key')
@patch('os.chmod', autospec=True)
@patch.object(ambari_server, 'get_validated_string_input')
@patch('os.environ')
@patch.object(ambari_server, 'get_ambari_properties')
@patch('os.kill')
@patch('os.path.exists')
@patch('__builtin__.open')
@patch('subprocess.Popen')
@patch.object(ambari_server, 'print_info_msg')
@patch.object(ambari_server, 'search_file')
@patch.object(ambari_server, 'find_jdk')
@patch.object(ambari_server, 'print_error_msg')
@patch.object(ambari_server, 'check_postgre_up')
@patch.object(ambari_server, 'check_iptables')
@patch.object(ambari_server, 'parse_properties_file')
@patch.object(ambari_server, 'read_ambari_user')
@patch.object(ambari_server, 'is_root')
@patch('getpass.getuser')
@patch('os.chdir')
def test_start(self, chdir_mock, getuser_mock, is_root_mock, read_ambari_user_mock, parse_properties_file_mock, check_iptables_mock, check_postgre_up_mock, print_error_msg_mock, find_jdk_mock, search_file_mock, print_info_msg_mock, popenMock, openMock, pexistsMock, killMock, get_ambari_properties_mock, os_environ_mock, get_validated_string_input_method, os_chmod_method, save_master_key_method):
    args = MagicMock()
    f = MagicMock()
    f.readline.return_value = 42
    openMock.return_value = f
    get_ambari_properties_mock.return_value = {ambari_server.SECURITY_KEY_IS_PERSISTED: 'True', }
    pexistsMock.return_value = True
    try:
        ambari_server.start(args)
        self.fail("Should fail with 'Server is running'")
    except FatalException:
        pass
    self.assertTrue(killMock.called)
    pexistsMock.return_value = False
    read_ambari_user_mock.return_value = None
    try:
        ambari_server.start(args)
        self.fail("Should fail with 'Can not detect a system user for Ambari'")
    except FatalException as e:
        self.assertTrue(('Can not detect a system user' in e.reason))
    read_ambari_user_mock.return_value = 'dummy-user'
    getuser_mock.return_value = 'non_custom_user'
    is_root_mock.return_value = False
    try:
        ambari_server.start(args)
        self.fail("Should fail with 'Can not start ambari-server as user...'")
    except FatalException as e:
        self.assertTrue(('Can not start ambari-server as user' in e.reason))
    is_root_mock.return_value = True
    find_jdk_mock.return_value = None
    try:
        ambari_server.start(args)
        self.fail("Should fail with 'No JDK found'")
    except FatalException as e:
        self.assertTrue(('No JDK found' in e.reason))
    find_jdk_mock.return_value = 'somewhere'
    is_root_mock.return_value = True
    args.persistence_type = 'remote'
    check_iptables_mock.return_value = (0, None)
    try:
        ambari_server.start(args)
    except FatalException as e:
        pass
    self.assertFalse(('Unable to start PostgreSQL server' in e.reason))
    self.assertFalse(check_postgre_up_mock.called)
    check_postgre_up_mock.reset_mock()
    args.persistence_type = 'local'
    check_postgre_up_mock.return_value = 1
    try:
        ambari_server.start(args)
        self.fail("Should fail with 'Unable to start PostgreSQL server'")
    except FatalException as e:
        self.assertTrue(('Unable to start PostgreSQL server' in e.reason))
        self.assertTrue(check_postgre_up_mock.called)
    check_postgre_up_mock.return_value = 0
    check_iptables_mock.return_value = (1, ambari_server.IP_TBLS_ENABLED)
    try:
        ambari_server.start(args)
        self.fail("Should fail with 'Failed to stop iptables'")
    except FatalException as e:
        self.assertTrue(('Failed to stop iptables' in e.reason))
    check_iptables_mock.return_value = (0, None)
    read_ambari_user_mock.return_value = 'root'
    ambari_server.start(args)
    self.assertTrue(popenMock.called)
    popen_arg = popenMock.call_args[0][0]
    self.assertTrue((popen_arg[0] == '/bin/sh'))
    popenMock.reset_mock()
    read_ambari_user_mock.return_value = 'not-root-user'
    ambari_server.start(args)
    self.assertTrue(chdir_mock.called)
    self.assertTrue(popenMock.called)
    popen_arg = popenMock.call_args[0][0]
    self.assertTrue((popen_arg[0] == '/bin/su'))
    check_postgre_up_mock.reset_mock()
    popenMock.reset_mock()
    is_root_mock.return_value = False
    read_ambari_user_mock.return_value = 'not-root-user'
    getuser_mock.return_value = read_ambari_user_mock.return_value
    args.persistence_type = 'local'
    ambari_server.start(args)
    self.assertFalse(check_postgre_up_mock.called)
    args.persistence_type = 'remote'
    ambari_server.start(args)
    self.assertFalse(check_postgre_up_mock.called)
    check_iptables_mock.reset_mock()
    check_iptables_mock.return_value = (0, None)
    ambari_server.start(args)
    self.assertTrue(popenMock.called)
    popen_arg = popenMock.call_args[0][0]
    self.assertTrue((popen_arg[0] == '/bin/sh'))
    self.assertFalse(check_iptables_mock.called)
    read_ambari_user_mock.return_value = 'not-root-user'
    getuser_mock.return_value = 'non_custom_user'
    try:
        ambari_server.start(args)
        self.fail('Can not start ambari-server as user non_custom_user.')
    except FatalException as e:
        self.assertTrue(('Can not start ambari-server as user' in e.reason))
    popenMock.reset_mock()
    get_ambari_properties_mock.return_value = {ambari_server.SECURITY_KEY_IS_PERSISTED: 'False', }
    os_environ_mock.copy.return_value = {'a': 'b', ambari_server.SECURITY_KEY_ENV_VAR_NAME: 'masterkey', }
    args.persistence_type = 'local'
    read_ambari_user_mock.return_value = 'root'
    is_root_mock.return_value = True
    ambari_server.start(args)
    self.assertFalse(get_validated_string_input_method.called)
    self.assertFalse(save_master_key_method.called)
    popen_arg = popenMock.call_args[1]['env']
    self.assertEquals(os_environ_mock.copy.return_value, popen_arg)
    popenMock.reset_mock()
    os_environ_mock.reset_mock()
    get_ambari_properties_mock.return_value = {ambari_server.SECURITY_KEY_IS_PERSISTED: 'False', }
    os_environ_mock.copy.return_value = {'a': 'b', }
    args.persistence_type = 'local'
    read_ambari_user_mock.return_value = 'root'
    is_root_mock.return_value = True
    get_validated_string_input_method.return_value = 'masterkey'
    os_chmod_method.return_value = None
    ambari_server.start(args)
    self.assertTrue(get_validated_string_input_method.called)
    self.assertTrue(save_master_key_method.called)
    popen_arg = popenMock.call_args[1]['env']
    self.assertEquals(os_environ_mock.copy.return_value, popen_arg)

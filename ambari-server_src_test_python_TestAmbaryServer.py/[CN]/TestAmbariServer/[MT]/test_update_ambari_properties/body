@patch.object(ambari_server, 'get_conf_dir')
def test_update_ambari_properties(self, get_conf_dir_mock):
    properties = ['server.jdbc.user.name=ambari-server\n', 'server.jdbc.user.passwd=/etc/ambari-server/conf/password.dat\n', 'java.home=/usr/jdk64/jdk1.6.0_31\n', 'server.os_type=redhat6\n', 'ambari-server.user=ambari\n', 'agent.fqdn.service.url=URL\n']
    NEW_PROPERTY = 'some_new_property=some_value\n'
    CHANGED_VALUE_PROPERTY = 'server.os_type=should_not_overwrite_value\n'
    get_conf_dir_mock.return_value = '/etc/ambari-server/conf'
    (tf1, fn1) = tempfile.mkstemp()
    (tf2, fn2) = tempfile.mkstemp()
    ambari_server.AMBARI_PROPERTIES_RPMSAVE_FILE = fn1
    ambari_server.AMBARI_PROPERTIES_FILE = fn2
    with open(ambari_server.AMBARI_PROPERTIES_FILE, 'w') as f:
        f.write(NEW_PROPERTY)
        f.write(CHANGED_VALUE_PROPERTY)
    with open(ambari_server.AMBARI_PROPERTIES_RPMSAVE_FILE, 'w') as f:
        for line in properties:
            f.write(line)
    ambari_server.update_ambari_properties()
    timestamp = datetime.datetime.now()
    self.assertFalse(os.path.exists(ambari_server.AMBARI_PROPERTIES_RPMSAVE_FILE))
    self.assertTrue(os.path.exists(((ambari_server.AMBARI_PROPERTIES_RPMSAVE_FILE + '.') + timestamp.strftime('%Y%m%d%H%M%S'))))
    with open(ambari_server.AMBARI_PROPERTIES_FILE, 'r') as f:
        ambari_properties_content = f.readlines()
    for line in properties:
        if (line == 'agent.fqdn.service.url=URL\n'):
            if ((not ((ambari_server.GET_FQDN_SERVICE_URL + '=URL\n') in ambari_properties_content)) and (line in ambari_properties_content)):
                self.fail()
        elif (not (line in ambari_properties_content)):
            self.fail()
    if (not (NEW_PROPERTY in ambari_properties_content)):
        self.fail()
    if (CHANGED_VALUE_PROPERTY in ambari_properties_content):
        self.fail()
    result = ambari_server.update_ambari_properties()
    self.assertEquals(result, 0)
    os.unlink(fn2)
    (tf, fn) = tempfile.mkstemp()
    ambari_server.AMBARI_PROPERTIES_RPMSAVE_FILE = fn
    result = ambari_server.update_ambari_properties()
    self.assertNotEquals(result, 0)

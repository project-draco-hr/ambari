{
  DynamicClassLoader classLoader=new DynamicClassLoader(DataStoreImplTest.class.getClassLoader());
  EntityManagerFactory entityManagerFactory=createMock(EntityManagerFactory.class);
  EntityManager entityManager=createMock(EntityManager.class);
  JPADynamicHelper jpaDynamicHelper=createNiceMock(JPADynamicHelper.class);
  SchemaManager schemaManager=createNiceMock(SchemaManager.class);
  EntityTransaction transaction=createMock(EntityTransaction.class);
  Capture<DynamicType> typeCapture=new Capture<DynamicType>();
  Capture<DynamicType> typeCapture2=new Capture<DynamicType>();
  jpaDynamicHelper.addTypes(eq(true),eq(true),capture(typeCapture),capture(typeCapture2));
  expect(entityManagerFactory.createEntityManager()).andReturn(entityManager);
  expect(entityManager.getTransaction()).andReturn(transaction).anyTimes();
  entityManager.close();
  transaction.begin();
  expect(transaction.isActive()).andReturn(true);
  transaction.rollback();
  replay(entityManagerFactory,entityManager,jpaDynamicHelper,transaction,schemaManager);
  DataStoreImpl dataStore=getDataStore(entityManagerFactory,jpaDynamicHelper,classLoader,schemaManager);
  try {
    dataStore.store(new TestLargeEntity(99));
    Assert.fail("Expected PersistenceException.");
  }
 catch (  PersistenceException e) {
  }
  verify(entityManagerFactory,entityManager,jpaDynamicHelper,transaction,schemaManager);
}

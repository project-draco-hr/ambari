@patch('resource_management.libraries.functions.ranger_functions_v2.RangeradminV2.check_ranger_login_curl', new=MagicMock(return_value=(200, '', '')))
@patch('resource_management.libraries.functions.ranger_functions_v2.RangeradminV2.get_repository_by_name_curl', new=MagicMock(return_value={'name': 'c1_kms', }))
@patch('resource_management.libraries.functions.ranger_functions_v2.RangeradminV2.create_repository_curl', new=MagicMock(return_value={'name': 'c1_kms', }))
@patch('os.path.isfile')
def test_start_secured(self, isfile_mock):
    self.executeScript((self.COMMON_SERVICES_PACKAGE_DIR + '/scripts/kms_server.py'), classname='KmsServer', command='start', config_file='ranger-kms-secured.json', stack_version=self.STACK_VERSION, target=RMFTestCase.TARGET_COMMON_SERVICES)
    self.assert_configure_secured()
    current_datetime = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    self.assertResourceCalled('File', '/usr/hdp/current/ranger-kms/conf/ranger-security.xml', owner='kms', group='kms', content='<ranger>\n<enabled>{0}</enabled>\n</ranger>'.format(current_datetime), mode=420)
    self.assertResourceCalled('Directory', '/etc/ranger/c1_kms', owner='kms', group='kms', mode=509, create_parents=True)
    self.assertResourceCalled('Directory', '/etc/ranger/c1_kms/policycache', owner='kms', group='kms', mode=509, create_parents=True)
    self.assertResourceCalled('File', '/etc/ranger/c1_kms/policycache/kms_c1_kms.json', owner='kms', group='kms', mode=420)
    self.assertResourceCalled('XmlConfig', 'ranger-kms-audit.xml', mode=484, owner='kms', group='kms', conf_dir='/usr/hdp/current/ranger-kms/conf', configurations=self.getConfig()['configurations']['ranger-kms-audit'], configuration_attributes=self.getConfig()['configuration_attributes']['ranger-kms-audit'])
    self.assertResourceCalled('XmlConfig', 'ranger-kms-security.xml', mode=484, owner='kms', group='kms', conf_dir='/usr/hdp/current/ranger-kms/conf', configurations=self.getConfig()['configurations']['ranger-kms-security'], configuration_attributes=self.getConfig()['configuration_attributes']['ranger-kms-security'])
    self.assertResourceCalled('XmlConfig', 'ranger-policymgr-ssl.xml', mode=484, owner='kms', group='kms', conf_dir='/usr/hdp/current/ranger-kms/conf', configurations=self.getConfig()['configurations']['ranger-kms-policymgr-ssl'], configuration_attributes=self.getConfig()['configuration_attributes']['ranger-kms-policymgr-ssl'])
    self.assertResourceCalled('Execute', ('/usr/hdp/current/ranger-kms/ranger_credential_helper.py', '-l', '/usr/hdp/current/ranger-kms/cred/lib/*', '-f', '/etc/ranger/c1_kms/cred.jceks', '-k', 'sslKeyStore', '-v', 'myKeyFilePassword', '-c', '1'), environment={'JAVA_HOME': u'/usr/jdk64/jdk1.7.0_45', }, logoutput=True, sudo=True)
    self.assertResourceCalled('Execute', ('/usr/hdp/current/ranger-kms/ranger_credential_helper.py', '-l', '/usr/hdp/current/ranger-kms/cred/lib/*', '-f', '/etc/ranger/c1_kms/cred.jceks', '-k', 'sslTrustStore', '-v', 'changeit', '-c', '1'), environment={'JAVA_HOME': u'/usr/jdk64/jdk1.7.0_45', }, logoutput=True, sudo=True)
    self.assertResourceCalled('File', '/etc/ranger/c1_kms/cred.jceks', owner='kms', group='kms', mode=416)
    self.assertResourceCalled('Directory', '/tmp/jce_dir', create_parents=True)
    self.assertResourceCalled('File', '/tmp/jce_dir/UnlimitedJCEPolicyJDK7.zip', content=DownloadSource('http://c6401.ambari.apache.org:8080/resources//UnlimitedJCEPolicyJDK7.zip'), mode=420)
    self.assertResourceCalled('File', '/usr/jdk64/jdk1.7.0_45/jre/lib/security/local_policy.jar', action=['delete'])
    self.assertResourceCalled('File', '/usr/jdk64/jdk1.7.0_45/jre/lib/security/US_export_policy.jar', action=['delete'])
    self.assertResourceCalled('Execute', ('unzip', '-o', '-j', '-q', '/tmp/jce_dir/UnlimitedJCEPolicyJDK7.zip', '-d', '/usr/jdk64/jdk1.7.0_45/jre/lib/security'), only_if='test -e /usr/jdk64/jdk1.7.0_45/jre/lib/security && test -f /tmp/jce_dir/UnlimitedJCEPolicyJDK7.zip', path=['/bin/', '/usr/bin'], sudo=True)
    self.assertResourceCalled('Execute', '/usr/hdp/current/ranger-kms/ranger-kms start', environment={'JAVA_HOME': u'/usr/jdk64/jdk1.7.0_45', }, not_if='ps -ef | grep proc_rangerkms | grep -v grep', user='kms')
    self.assertTrue(isfile_mock.called)
    self.assertNoMoreResources()

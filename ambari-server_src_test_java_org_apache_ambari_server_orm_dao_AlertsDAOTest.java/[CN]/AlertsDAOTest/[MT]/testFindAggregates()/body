{
  AlertDefinitionEntity definition=new AlertDefinitionEntity();
  definition.setDefinitionName("many_per_cluster");
  definition.setServiceName("YARN");
  definition.setComponentName(null);
  definition.setClusterId(m_cluster.getClusterId());
  definition.setHash(UUID.randomUUID().toString());
  definition.setScheduleInterval(Integer.valueOf(60));
  definition.setScope(Scope.SERVICE);
  definition.setSource("{\"type\" : \"SCRIPT\"}");
  definition.setSourceType(SourceType.SCRIPT);
  m_definitionDao.create(definition);
  AlertHistoryEntity history=new AlertHistoryEntity();
  history.setAlertDefinition(definition);
  history.setAlertInstance(null);
  history.setAlertLabel("");
  history.setAlertState(AlertState.OK);
  history.setAlertText("");
  history.setAlertTimestamp(Long.valueOf(1L));
  history.setClusterId(m_cluster.getClusterId());
  history.setComponentName("");
  history.setHostName("h1");
  history.setServiceName("ServiceName");
  AlertCurrentEntity current=new AlertCurrentEntity();
  current.setAlertHistory(history);
  current.setLatestTimestamp(Long.valueOf(1L));
  current.setOriginalTimestamp(Long.valueOf(1L));
  m_dao.merge(current);
  history=new AlertHistoryEntity();
  history.setAlertDefinition(definition);
  history.setAlertInstance(null);
  history.setAlertLabel("");
  history.setAlertState(AlertState.OK);
  history.setAlertText("");
  history.setAlertTimestamp(Long.valueOf(1L));
  history.setClusterId(m_cluster.getClusterId());
  history.setComponentName("");
  history.setHostName("h2");
  history.setServiceName("ServiceName");
  m_dao.create(history);
  current=new AlertCurrentEntity();
  current.setAlertHistory(history);
  current.setLatestTimestamp(Long.valueOf(1L));
  current.setOriginalTimestamp(Long.valueOf(1L));
  m_dao.merge(current);
  AlertSummaryDTO summary=m_dao.findAggregateCounts(m_cluster.getClusterId(),"many_per_cluster");
  assertEquals(2,summary.getOkCount());
  assertEquals(0,summary.getWarningCount());
  assertEquals(0,summary.getCriticalCount());
  assertEquals(0,summary.getUnknownCount());
  AlertCurrentEntity c=m_dao.findCurrentByHostAndName(m_cluster.getClusterId(),"h2","many_per_cluster");
  AlertHistoryEntity h=c.getAlertHistory();
  h.setAlertState(AlertState.CRITICAL);
  m_dao.merge(h);
  summary=m_dao.findAggregateCounts(m_cluster.getClusterId(),"many_per_cluster");
  assertEquals(1,summary.getOkCount());
  assertEquals(0,summary.getWarningCount());
  assertEquals(1,summary.getCriticalCount());
  assertEquals(0,summary.getUnknownCount());
  summary=m_dao.findAggregateCounts(m_cluster.getClusterId(),"foo");
  assertEquals(0,summary.getOkCount());
  assertEquals(0,summary.getWarningCount());
  assertEquals(0,summary.getCriticalCount());
  assertEquals(0,summary.getUnknownCount());
}

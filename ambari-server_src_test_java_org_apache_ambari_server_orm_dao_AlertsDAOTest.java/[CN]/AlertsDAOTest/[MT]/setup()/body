{
  injector=Guice.createInjector(new InMemoryDefaultTestModule());
  injector.getInstance(GuiceJpaInitializer.class);
  helper=injector.getInstance(OrmTestHelper.class);
  clusterId=helper.createCluster();
  dao=injector.getInstance(AlertsDAO.class);
  definitionDao=injector.getInstance(AlertDefinitionDAO.class);
  for (int i=0; i < 5; i++) {
    AlertDefinitionEntity definition=new AlertDefinitionEntity();
    definition.setDefinitionName("Alert Definition " + i);
    definition.setServiceName("Service " + i);
    definition.setComponentName(null);
    definition.setClusterId(clusterId);
    definition.setHash(UUID.randomUUID().toString());
    definition.setScheduleInterval(60);
    definition.setScope(Scope.SERVICE);
    definition.setSource("Source " + i);
    definition.setSourceType("SCRIPT");
    definitionDao.create(definition);
  }
  List<AlertDefinitionEntity> definitions=definitionDao.findAll();
  assertNotNull(definitions);
  assertEquals(5,definitions.size());
  calendar.clear();
  calendar.set(2014,Calendar.JANUARY,1);
  for (  AlertDefinitionEntity definition : definitions) {
    for (int i=0; i < 10; i++) {
      AlertHistoryEntity history=new AlertHistoryEntity();
      history.setServiceName(definition.getServiceName());
      history.setClusterId(clusterId);
      history.setAlertDefinition(definition);
      history.setAlertLabel(definition.getDefinitionName() + " " + i);
      history.setAlertText(definition.getDefinitionName() + " " + i);
      history.setAlertTimestamp(calendar.getTimeInMillis());
      history.setAlertState(AlertState.OK);
      if (i == 0 || i == 5) {
        history.setAlertState(AlertState.CRITICAL);
      }
      calendar.add(Calendar.DATE,1);
      dao.create(history);
    }
  }
  for (  AlertDefinitionEntity definition : definitions) {
    List<AlertHistoryEntity> alerts=dao.findAll();
    AlertHistoryEntity history=null;
    for (    AlertHistoryEntity alert : alerts) {
      if (definition.equals(alert.getAlertDefinition())) {
        history=alert;
      }
    }
    assertNotNull(history);
    AlertCurrentEntity current=new AlertCurrentEntity();
    current.setAlertHistory(history);
    current.setLatestTimestamp(new Date().getTime());
    current.setOriginalTimestamp(new Date().getTime() - 10800000);
    current.setMaintenanceState(MaintenanceState.OFF);
    dao.create(current);
  }
}

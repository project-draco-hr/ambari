{
  if (!isOpen()) {
    throw new KerberosOperationException("This operation handler has not been opened");
  }
  if ((principal == null) || principal.isEmpty()) {
    throw new KerberosOperationException("Failed to create new principal - no principal specified");
  }
 else   if ((password == null) || password.isEmpty()) {
    throw new KerberosOperationException("Failed to create new principal - no password specified");
  }
 else {
    ShellCommandUtil.Result result=invokeKAdmin(String.format("add_principal -pw \"%s\" %s",password,principal));
    String stdOut=result.getStdout();
    if ((stdOut != null) && stdOut.contains(String.format("Principal \"%s\" created",principal))) {
      return getKeyNumber(principal);
    }
 else {
      throw new KerberosOperationException(String.format("Failed to create service principal for %s\nSTDOUT: %s\nSTDERR: %s",principal,stdOut,result.getStderr()));
    }
  }
}

{
  long now=System.currentTimeMillis();
  String roleStr=cmd.getRole().toString();
  String hostname=cmd.getHostname();
  LOG.info("Going to schedule: " + s.toString());
  if (s.getStartTime(hostname,roleStr) < 0) {
    LOG.info("Update state machine for first attempt");
    try {
      Cluster c=fsmObject.getCluster(s.getClusterName());
      Service svc=c.getService(cmd.getServiceName());
      ServiceComponent svcComp=svc.getServiceComponent(roleStr);
      ServiceComponentHost svcCompHost=svcComp.getServiceComponentHost(hostname);
      svcCompHost.handleEvent(s.getFsmEvent(hostname,roleStr));
      s.setStartTime(hostname,roleStr,now);
      s.setHostRoleStatus(hostname,roleStr,HostRoleStatus.QUEUED);
    }
 catch (    InvalidStateTransitionException e) {
      LOG.info("Transition failed for host: " + hostname + ", role: "+ roleStr,e);
      throw e;
    }
catch (    AmbariException e) {
      LOG.info("Exception in fsm: " + hostname + ", role: "+ roleStr,e);
      throw e;
    }
  }
  s.setLastAttemptTime(hostname,roleStr,now);
  s.incrementAttemptCount(hostname,roleStr);
  LOG.info("Enqueueing in action queue for host: " + hostname);
  try {
    LOG.info("Command string = " + StageUtils.jaxbToString(cmd));
  }
 catch (  Exception e) {
    throw new AmbariException("Could not get string from jaxb",e);
  }
  actionQueue.enqueue(hostname,cmd);
  db.hostRoleScheduled(s,hostname,roleStr);
}

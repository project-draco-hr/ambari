{
  for (  String host : hrcMap.keySet()) {
    HostRoleCommand hrc=hrcMap.get(host);
    if ((hrc.getStatus() != HostRoleStatus.PENDING) && (hrc.getStatus() != HostRoleStatus.QUEUED)) {
      continue;
    }
    long now=System.currentTimeMillis();
    if (now > stage.getLastAttemptTime(host) + actionTimeout) {
      LOG.info("Host:" + host + ", role:"+ hrc.getRole()+ ", actionId:"+ stage.getActionId()+ " timed out");
      if (stage.getAttemptCount(host) >= maxAttempts) {
        LOG.warn("Host:" + host + ", role:"+ hrc.getRole()+ ", actionId:"+ stage.getActionId()+ " expired");
        ServiceComponentHostOpFailedEvent timeoutEvent=new ServiceComponentHostOpFailedEvent(hrc.getRole().toString(),host,now);
        try {
          fsmObject.getCluster(stage.getClusterName()).handleServiceComponentHostEvent("",hrc.getRole().toString(),host,timeoutEvent);
        }
 catch (        InvalidStateTransitonException e) {
          LOG.info("Transition failed for host: " + host + ", role: "+ hrc.getRole(),e);
        }
        db.timeoutHostRole(host,stage.getRequestId(),stage.getStageId(),hrc.getRole());
      }
 else {
        try {
          scheduleHostRole(stage,host,hrc);
        }
 catch (        InvalidStateTransitonException ex) {
          LOG.info("Cannot make this transition..aborting host role",ex);
          db.abortHostRole(host,stage.getRequestId(),stage.getStageId(),hrc.getRole());
        }
      }
    }
  }
}
